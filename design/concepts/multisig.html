<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Multi-signatures - Cardano Wallet</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cardano Wallet</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="multi-signature-wallet"><a class="header" href="#multi-signature-wallet">Multi-signature wallet</a></h1>
<p>Multisig wallet, aka shared wallet, allows several participants to jointly control the wallet’s funds.
The control is exercised over the spending, delegation and minting/burning of assets and is regulated by native scripts
which specify what is the required set of witnesses and time conditions to be obeyed to
make a transaction valid upon managing the shared resources.</p>
<h2 id="contents"><a class="header" href="#contents">Contents</a></h2>
<ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#overview-of-a-wallet-lifecycle">Overview of a wallet lifecycle</a></li>
<li><a href="#staking-and-spending-are-ortogonal">Staking and spending are ortogonal</a></li>
<li><a href="#creating-of-a-shared-wallet">Creating of a shared wallet</a></li>
<li><a href="#resources-of-a-shared-wallet">Resources of a shared wallet</a></li>
<li><a href="#making-a-transaction-in-a-shared-wallet">Making a transaction in a shared wallet</a></li>
<li><a href="#summary">Summary</a></li>
</ol>
<h3 id="introduction"><a class="header" href="#introduction">Introduction</a></h3>
<p>Typically the native script can enforce that all or some parties must agree, i.e. sign a given transaction,
in order to make the transaction valid, and hence spend from the wallet. For example, three out of four parties, or any party.
The transaction could be also required to be sent before or after some point in time in order to be valid.
As rules can be embedded inside themselves it is possible, for example, to design a rule engaging three parties, requiring two witnesses,
but always including a specific party, and enforcing the submitting of the transaction not later than some point in time.
The similar or different regulation could pertain to staking. As there is a separation of the control over the movements of funds and the rights (and obligations)
in the PoS protocol powering the Cardano that are associated with those funds the native scripts regulating staking and spending could be different.</p>
<h3 id="overview-of-a-wallet-lifecycle"><a class="header" href="#overview-of-a-wallet-lifecycle">Overview of a wallet lifecycle</a></h3>
<p>The multisig wallet needs intermediation during the construction and making a transaction. Intermediation vehicle, eg. coordination server,
is needed to firstly agree on spending/staking ruling and to facilitate sharing cosigners identifiers.
In case of making a transaction the intermediation vehicle is needed to smooth the exchange of a partially signed transaction
to be handed over to another party to sign until a fully-signed transaction is achieved.</p>
<p>Figs. 1a-c introduce and visualize the construction phase.</p>
<p><img src="./multisig-figures/fig1a.svg" alt="image" /></p>
<p>Fig 1a. Wallet initialization: Spending/staking ruling and cosigner structure is decided.</p>
<p><img src="./multisig-figures/fig1b.svg" alt="image" /></p>
<p>Fig 1b. Wallet initialization: Cosigners share their extended account public keys.</p>
<p><img src="./multisig-figures/fig1c.svg" alt="image" /></p>
<p>Fig 1c. Wallet initiation. Each cosigner takes their other cosigner’s accXPub from the coordination server. Having spending/staking rules and all cosigners accXPubs one can create a multisig wallet. Each cosigner can search a balance and restore the wallet independently.</p>
<p>Parties upon multisig wallet creation agree on the script template regulating spending and optionally separate staking script template.
So they need to communicate this between parties which can be intermediated via a coordination server or by other off-chain means (Fig. 1a).
Template describes how scripts are going to be constructed. The script is formed in such a way that each cosigner tag is replaced with
the public verification keys belonging to cosigners. The script is then hashed and is a part of the address that is engaged in transactions.
Each party has its secret key (which is typically in the form of a mnemonic) that allows derivation of private and public keys
as specified by a derivation path. Private keys allow signing transactions in which the corresponding public keys are engaged as
a part of a script that give rise to spending credentials that build addresses. The secret key also allows derivation of an extended account public key
(and of course its private dual) that each party shares with other parties. Without full account public key exchange multisig wallet is in incomplete state
and cannot participate in transactions and recognize its resources. The collection of missing account public keys is performed off-chain (Fig. 1b).
When a given party collects all account public keys from each party the wallet is complete and ready to operate.
It means each party can recreate each party’s public keys and thus construct the script and its hash which acts as a credential.
Only the full collection of the keys allows each party to derive scripts that build the addresses that are commonly recognized amidst parties
and which participate in transactions. This means each cosigner needs to retrieve all missing account public keys (Fig 1c).
Script hashes act as credentials in addresses and can regulate separately spending and delegation.
When a spending transaction is to be submitted and accepted by blockchain the participants must collect all the required witnesses
as specified by the spending script template. In the situation presented in  Figs. 1 it means witnesses from both cosigner1 and cosigner2 are mandatory
to be provided to have a fully signed spending transaction.
For example, if we want to send some funds to another wallet, and the spending template requires two out of three witnesses,
plus transaction submission not later than slot 100, then it means any two parties must sign a given transaction and
submit the fully-signed transaction to the node at most at slot 100.
It entails one party to construct a transaction and sign it, then hand it over off-chain (for example via a coordination server)
to any other party for its signing. After the first sign we have a partially-signed transaction and only after adding
another witness on top we have a fully-signed transaction that, if submitted before slot 100, is expected to be accepted by cardano-node.
After sending the transaction each party separately is expected to detect the change of the balance of the shared wallet if the transaction is successful.</p>
<h3 id="staking-and-spending-are-ortogonal"><a class="header" href="#staking-and-spending-are-ortogonal">Staking and spending are ortogonal</a></h3>
<p>Spending and staking is orthogonal to each other and could be regulated by different rules.
The example presented in Fig 2 and Figs 3 show the case.</p>
<p><img src="./multisig-figures/fig2.svg" alt="image" /></p>
<p>Fig 2. Spending transaction. Due to spending ruling cosigner1 does not need a consent from cosigner2 to spend funds from a multisig wallet.
Hence, cosigner1 constructs, signs and submits the transaction that spends without coordination server intermediation.
Cosigner2 does not regulate spending and is irrelevant in this regard, but can follow cosigner1 action by inspecting a balance of the shared wallet.</p>
<p><img src="./multisig-figures/fig3a.svg" alt="image" /></p>
<p>Fig 3a. Staking transaction. Cosigner2 wants to stake funds to a specified pool.
Cosigner2 hands over the partially signed transaction to the coordination server.
Cosigner2 cannot realize this action without a consent from cosigner1 as determined by staking ruling.
Signing from both cosigner1 and cosigner2 is mandatory to move forward with staking.</p>
<p><img src="./multisig-figures/fig3b.svg" alt="image" /></p>
<p>Fig 3b. Staking transaction. The consent from cosigner1 is required to move forward with a staking transaction.
Cosigner1 uses the coordination server to download a partially signed transaction, inspects it, and if everything is valid he inscribes its witness
and submits it to the node. Due to time constraints present in the staking ruling he needs to realize the submission
in a time period defined by (s1, s2). After staking action is realized, both cosigners see rewards and
can initiate a withdrawal transaction that is regulated by staking ruling.
Spending of the rewards is regulated by spending ruling meaning cosigner1 can do it without consent from cosigners2.</p>
<p>The detailed draft specification of the multi-signature HD wallet can be found <a href="https://github.com/cardano-foundation/CIPs/tree/master/CIP-1854">here</a></p>
<p><strong>What comes next is the technical description of what it entails for a multisig wallet to be created,
what resources it has under its disposal and how spending of the funds looks like and what are mechanisms under the hood that make it happen.</strong></p>
<h3 id="creating-of-a-shared-wallet"><a class="header" href="#creating-of-a-shared-wallet">Creating of a shared wallet</a></h3>
<p>Let’s assume we have two parties interested in having a shared wallet and eager to jointly spend the funds.
Each side at the end of this process will have its own shared wallet instance that is able to track the wallet’s resources.
In order for those two parties to collaborate they need to decide on the following things before:</p>
<ol>
<li>Extended account public keys of other parties</li>
<li>Spending script template</li>
<li>ptional spending script template</li>
</ol>
<p>This information needs to be intermediated via coordination server or shared off-chain.
Agreeing on account index among the parties is not important as the shared wallet derives its resources on top of parties’ extended account keys.
In order to understand this statement one needs to start with the fact that a shared wallet is a hierarchical deterministic wallet
that imposes the exact tree derivation path. It is evident if we look at derivation path that any wallet uses for key derivation:</p>
<pre><code class="language-code">m / purpose' / coin_type' / account_ix' / role / index
</code></pre>
<p>In case of shared wallet we use</p>
<pre><code class="language-code">m / 1854’ / 1815’ / account_ix' / role / index
</code></pre>
<p>path to derive any key of index assuming a role and <code>account_ix’</code> for the party’s mnemonic <code>m</code>.
Parties exchange their extended public keys (<code>accXPub</code>) between themselves assuming the following path to derive <code>accXPub</code>.</p>
<pre><code class="language-code">m / 1854’ / 1815’ / account_ix'
</code></pre>
<p>This has the immediate consequence that parties can exchange account public keys that were derived for different account indices.
For each party it is enough to have accXPubs from all participants to derive other public keys that build credentials, both spending or staking.
And thanks to that construct addresses that participate in transactions.</p>
<p>It is worth noting that all purpose, coin type and account index all use hardened type of derivation.
To be even more concrete we could write down the path</p>
<pre><code class="language-code">m / 1854’ / 1815’ / 10' / 0 / 11
</code></pre>
<p>which denotes derivation path for the key assuming external role and index=11 for account index 10’.</p>
<p>Upon creation parties do not have to decide on <code>account_ix'</code> in order to be consistent when deriving key families for different roles.
Sharing <code>accXPub</code> is enough to make sure each party is able to fill in the script template with proper keys derived on top of them and
restore the address pool and hence is able to follow the shared wallet’s resources.</p>
<p>A script template regulates a witness set and time conditions to be met in order to spend or stake.
The exact form is presented in <a href="https://github.com/cardano-foundation/CIPs/tree/master/CIP-1854">CIP 1854</a>. Below we paste several examples that are simple, rather self-explanatory but still interesting:</p>
<pre><code class="language-code">all [cosigner#1, self, cosigner#2]
any [cosigner#1, self, cosigner#2]
at_least 2 [cosigner#1, self, cosigner#2]
all [at_least 2 [cosigner#1, self, cosigner#2], from 100, until 120]
</code></pre>
<p>As seen in the last example, templates can be nested. The last example encodes the following conditions for each spending
(or staking if this is a staking script template) transaction within the multisig wallet that has exactly this in the spending template:
two witnesses are required and the transaction must be submitted within any slot belonging to  &lt;100, 200) range.
When time conditions are met, it is enough to have witnesses from other parties (cosigner#1 and cosigner2)
or our witness along with any other party to have a fully-signed transaction.</p>
<p>When the spending script template is chosen it cannot change until the end of the wallet’s life.
The transaction conditions to be obeyed are determined statically upon wallet’s creation.</p>
<p>To sum up this part and be very concrete, each party after deciding off-chain script template and setting who is who (eg. me cosigner#1, you cosigner#2) creates the wallet via
<a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postSharedWallet">POST WALLET</a> api call.</p>
<p>In order to get account public key to be shared with other the parties one calls <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getAccountKeyShared">GET ACCOUNT</a> endpoint.
https://cardano-foundation.io/cardano-wallet/api/edge/#operation/getAccountKeyShared</p>
<p>Updating other parties <code>accXPub</code>s is realized via <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/patchSharedWalletInPayment">PATCH WALLET PAYMENT PART</a> endpoint for payment and
<a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/patchSharedWalletInDelegation">PATCH WALLET DELEGATION PART</a> endpoint for delegation.</p>
<h3 id="resources-of-a-shared-wallet"><a class="header" href="#resources-of-a-shared-wallet">Resources of a shared wallet</a></h3>
<p>When all parties' extended public keys are collected the wallet is ready to identify and discover its resources.
Each party can separately do this and will obtain the same results. Without <code>accXPub</code>s for all cosigners it is not possible.
In order to make this statement apparent one needs to appreciate that credential (either spending or staking) that
is part of each address can be constructed from either key hash or script hash (staking credential could be also constructor from pointer</p>
<ul>
<li>see delegation spec for details if interested).
In shared wallets we want script template to be the source of scripts that when serialized and hashed constitute a valid spending/staking credential.
The major question is how to go from a script template to a script.</li>
</ul>
<p>To explain that let’s assume we have spending script template as below:</p>
<pre><code class="language-code">all [cosigner#1, cosigner#2]
</code></pre>
<p>We decided to have a shared wallet with another party we named cosigner#1. We are cosigner#2 which from our perspective this is equivalent to</p>
<pre><code class="language-code">all [cosigner#1, self]
</code></pre>
<p>We collected <code>accXPub1</code> of cosigner#1 and the wallet is ready for operation.
We have two extended account public keys: <code>accXPub1</code> and <code>accXPub2</code>. <code>accXPub2</code> is our key that we shared with cosigner#1.
If we created the wallet from the account public key then this is the key used upon the creation
(which has a limitation as an account-based wallet cannot sign transactions, and is able only to track resources of the wallet).
If we create the wallet from the mnemonic m then the account public key is derived using below derivation path</p>
<pre><code class="language-code">m / 1854’ / 1815’ / account_ix'
</code></pre>
<p>Having an extended account public key (extended key gives us this capability) allows for derivation of public keys
originating from this node of the key tree. In detail we are able to derive a whole branch of keys following the derivation path:</p>
<pre><code class="language-code"> accXPub / role / index
</code></pre>
<p>where role can take 0, 1, 2 which stands for external (for payments), internal (for change), and staking, respectively.
Index can take 0, 1, … 2147483647. In case of staking 0 is assumed.</p>
<p>In order to have a significant number of keys under disposal the keys participating in filling in script templates are derived as specified above.
Having an extended account key of another party allows derivation of any of its public key in the key branch where the <code>accXPub</code> is a node.
Also in order to have synchrony between all parties, indices used in derivation are chosen in a particular fashion and
the address pool constructed from those keys is also obeying the restrictions.</p>
<p>Let’s look at how the template is filled in with keys to produce scripts in our example for payment credential.</p>
<pre><code class="language-code">payment keys for role = 0 and ix =0
key1-ix0 = accXPub1 / 0 / 0
key2-ix0 = accXPub2 / 0 / 0

payment keys for role = 0 and ix =12
key1-ix12 = accXPub1 / 0 / 12
key2-ix12 = accXPub2 / 0 / 12
</code></pre>
<p>When filling the script template to produce a spending credential,
for each cosigner <strong>the same index</strong> is used to derive a key.
Hence, the below credentials are valid:</p>
<pre><code class="language-code">all [key1-ix0, key2-ix0]
all [key1-ix12, key2-ix12]
</code></pre>
<p>The the below are invalid:</p>
<pre><code class="language-code">all [key1-ix12, key2-ix0]
all [key1-ix0, key2-ix12]
</code></pre>
<p>The reason for this is the size of the search space of script candidates to be tried by each cosigner to restore its resources.
We underscored that the only information shared off-chain between parties is script template, cosigner number mapping and <code>accXPub</code>s.
Key indexes to be used are unknown by the parties and to limit their scope (hence not to bloat index search space too much)
a number of measures are taken. The first one is the usage of pool gap that circumvent the whole number of indices that form search space by introducing
the exact number of consecutive and unused indices to be used.
Lets see the example to comprehend the concept (which is the same one used for shelley wallets and compliant with BIP-44 standard) for pool gap = 5 (the default value is 20).</p>
<ol>
<li>We have a freshly constructed wallet. None of the indices were used. Still we have 5 indices that form the search space.</li>
</ol>
<pre><code class="language-code">.....................
| 0 | 1 | 2 | 3 | 4 |
.....................

######
| ix |   index used
######

......
| ix |   index unused
......
</code></pre>
<ol start="2">
<li>We have used ix=0 to derive a script which was used as credential. The index pool forming the search space of all script candidates would look like:</li>
</ol>
<pre><code class="language-code">#####....................
| 0 | 1 | 2 | 3 | 4 | 5 |
#####....................
</code></pre>
<p>The wallet can use indices 0, 1, 2, 3, 4 and 5 to form a search space for spending credentials.
If all wallets stick to the same search space rules, all cosigners will be able to discover that ix=0 was used
and adjust the index search space accordingly.</p>
<ol start="3">
<li>Next our cosigner used ix=2 to derive a script. This time since ix=2 is within previous index search space
we are able to detect that it was used and adjust the search space.</li>
</ol>
<pre><code class="language-code">#####...#####....................
| 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
#####...#####....................
</code></pre>
<p>The search state expanded but still obey pool gap invariance (ie. at the end of it there are 5 unused indices).</p>
<p>Now comes the rule of using the same index when constructing a script using a script template.
In step 3 the rule ensures each party needs to construct 8 scripts that are a part of the address.
Meaning the wallet upon discovering resources in blockchain needs to check against 8 address candidates
at this moment (provided this is enterprise address or base address with only one possible staking credential).
If we would not have this restriction then the number of candidate addresses would be 8*8=64 for this particular two cosigner script.
The number of possibilities grows like ix<sup>cosignerNumber</sup>which for a long history wallets could be prohibitive.</p>
<p>At any given time available pool of addresses (which is derivative of indexes that were used to construct script credentials) can be inspected via
<a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listSharedAddresses">LIST ADDRESSES</a> endpoint.</p>
<p>Let’s sum up and draw index, script, credential, address relation.
The same index is used for each cosigner to derive its key:  <code>accXPub / role / index</code>
The cosigner’s key replace script template to form script for a given index
The script is serialized and hashed to form a credential
Spending credential forms either enterprise address (non-staking) or base address (if there is also staking credential)
See Fig 4 to inspect the relation.</p>
<p><img src="./multisig-figures/fig4.svg" alt="image" /></p>
<p>Fig. 4. From spending script template to address.</p>
<h3 id="making-a-transaction-in-a-shared-wallet"><a class="header" href="#making-a-transaction-in-a-shared-wallet">Making a transaction in a shared wallet</a></h3>
<p>Let’s continue the example of spending template script</p>
<pre><code class="language-code">all [cosigner#1, cosigner#2]
</code></pre>
<p>The wallet is funded, ie. some wallet sent X ada to our shared wallet on an enterprise address that is derived from index 0.
When it comes to a resource situation we have exactly a situation like in step 2 of the previous section.
Now cosigner#1 decides to make a transaction sending funds to another wallet (it needs to be less than X - fee ada).
As the money is “located” on an enterprise address having the credential coming from a script obtained using ix=0 we can point to
the derivation path needed for each cosigner to derive the private key that will form a witness.</p>
<pre><code class="language-code">Spending credential was constructed from

payment keys for role = 0 and ix =0
key1-ix0 = accXPub1 / 0 / 0
key2-ix0 = accXPub2 / 0 / 0

Signing key to be used are
prvkey1-ix0 = accXPrv1 / 0 / 0
prvkey2-ix0 = accXPrv2 / 0 / 0
</code></pre>
<p>For each party <code>accXPrv</code> and derived private keys are secrets, the derivations only they can perform.</p>
<p>Cosigner#1 constructs a transaction and as there are funds on the address with <code>ix=0</code> he signs the transaction with <code>prvkey1-ix0</code> and
enriches the transaction with the resultant witness. The transaction is partially-signed as the spending script template indicates.
The partially-signed transaction with witness from cosigner#1 needs to be handed over off-chain to cosigner#2 for his signing.
The cosigner#2 uses <code>prvkey2-ix0</code> to sign on his side and as he delivers the witness the transaction becomes fully-signed and
can be submitted to blockchain. After a short period of time both sides will detect the change of balance.</p>
<p>The construction of transaction can be realized via <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/constructSharedTransaction">CONSTRUCT TX</a> endpoint.
Signing is performed using <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/signSharedTransaction">SIGN TX</a> endpoint.
When transaction is fully-signed it can be submitted via <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitSharedTransaction">SUBMIT TX</a> endpoint call.
In order to inspect rhe transaction at each of the above steps any cosigner can use <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/decodeSharedTransaction">DECODE TX</a> endpoint.
What is the history of the transactions for a given wallet can be revealed using <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listSharedTransactions">LIST TXS</a>endpoint.
A single transaction pending/in a ledger can be investigated using <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getSharedTransaction">GET TX</a> call.</p>
<p>Staking actions are ruled by a staking script template. The script template translation to staking credential is exactly the same as for the spending credential.
The only difference is that role=2 and only one index=0 are used. This means the key derivation is as follows</p>
<pre><code class="language-code">delegation keys for role = 2 and ix =0
stakingkey1-ix0 = accXPub1 / 2 / 0
stakingkey2-ix0 = accXPub2 / 2 / 0
</code></pre>
<p>Each cosigner has one staking key and whatever staking script template is only they form the staking credential.
Moreover, private keys corresponding to them act as signing keys. The search space here is a singleton - it is just one staking credential possible.</p>
<p>There is one consequence that should be underlined. A spending script template should be <strong>less restrictive</strong> than a staking script template.
It follows from the fact that each transaction, also the one dealing with staking, needs to cover a fee.
Hence, it engages spending meaning spending script requirements is always present on top of optional staking script requirements.</p>
<h3 id="summary"><a class="header" href="#summary">Summary</a></h3>
<p>Overall multisig wallets offer multi-party shared spending and staking functionality that could be a source of many useful applications.
Any application begs down to providing an adequate coordination server.
One can think about custodial service or proxy management service (especially if external staking or spending credential is enabled).
Moreover, multi-party document signing applications can be envisaged marrying metadata functionality with multisig primitives.
Finally, support of zero-knowledge proof apps to multisig wallets could open a shared identity functionality or cross-blockchain applications.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../design/concepts/utxo.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../design/specs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../design/concepts/utxo.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../design/specs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>



    </div>
    </body>
</html>

<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Address Derivation - Cardano Wallet</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../.././mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cardano Wallet</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="address-derivation"><a class="header" href="#address-derivation">Address Derivation</a></h1>
<h2 id="hd-random-wallets-byron--legacy"><a class="header" href="#hd-random-wallets-byron--legacy"><em>HD Random</em> wallets (Byron / Legacy)</a></h2>
<h4 id="note"><a class="header" href="#note">Note</a></h4>
<p>This scheme is an underspecified / ad-hoc scheme designed in the early eras of
Cardano. It is intrinsically entangled to the address format and relies on
the ability to embed extra pieces of information into addresses themselves in
order to perform key derivation.</p>
<p>An initial key is created using a Ed25519 cryptographic elliptic curve from a
seed (encoded in the form of mnemonic words). From this wallet Key, other keys
can be derived. We therefore define a hierarchy of depth 2, where a single root
key and derivation indexes defines a <strong>derivation path</strong>.</p>
<p>We typically represent that derivation path as follows:</p>
<pre><code>m/account_ix'/address_ix'
</code></pre>
<p>where</p>
<ul>
<li><code>m</code> refers to the root master key</li>
<li><code>/</code> symbolizes a new derivation step using a particular derivation index.</li>
<li><code>'</code> indicates that keys at this step are considered hardened keys
(private key is required to derive new keys). Indexes of hardened keys
follows a particular convention and belongs to the interval <code>[2³¹, 2³²-1]</code>.</li>
</ul>
<pre><code>+--------------------------------------------------------------------------------+
|         BIP-39 Encoded 128 bits Seed with CRC a.k.a 12 Mnemonic Words          |
|                                                                                |
|    squirrel material silly twice direct ... razor become junk kingdom flee     |
|                                                                                |
+--------------------------------------------------------------------------------+
              |
              |
              v
+--------------------------+    +-----------------------+
|    Wallet Private Key    |---&gt;|   Wallet Public Key   |    m
+--------------------------+    +-----------------------+
              |
              | account ix
              v
+--------------------------+    +-----------------------+
|   Account Private Key    |---&gt;|   Account Public Key  |    m/account_ix'
+--------------------------+    +-----------------------+
              |
              | address ix
              v
+--------------------------+    +-----------------------+
|   Address Private Key    |---&gt;|   Address Public Key  |    m/account_ix'/address_ix'
+--------------------------+    +-----------------------+
</code></pre>
<p align="center"><small>Fig 1. Byron HD Wallets Key Hierarchy</small></p>
<p>Note that wallets typically store keys in memory in an encrypted form, using an
encryption passphrase. That passphrase prevents "free" key manipulation.</p>
<h2 id="hd-sequential-wallets-à-la-bip-44"><a class="header" href="#hd-sequential-wallets-à-la-bip-44"><em>HD Sequential</em> wallets (à la BIP-44)</a></h2>
<p>BIP-0044 Multi-Account Hierarchy for Deterministic Wallets is a Bitcoin
standard defining a structure and algorithm to build a hierarchy tree of keys
from a single root private key. Note that this is the derivation scheme
used by Icarus / Yoroi.</p>
<p>It is built upon <a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP-0032</a> and is a direct application of
<a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki">BIP-0043</a>.
It defines a common representation of addresses as a multi-level tree of derivations:</p>
<pre><code>m / purpose' / coin_type' / account_ix' / change_chain / address_ix
</code></pre>
<p>Cardano uses an extension / variation of BIP-44 described in <a href="https://github.com/cardano-foundation/CIPs/blob/master/CIP-1852/CIP-1852.md">CIP-1852</a>.</p>
<pre><code>+--------------------------------------------------------------------------------+
|                BIP-39 Encoded Seed with CRC a.k.a Mnemonic Words               |
|                                                                                |
|    squirrel material silly twice direct ... razor become junk kingdom flee     |
|                                                                                |
+--------------------------------------------------------------------------------+
       |
       |
       v
+--------------------------+    +-----------------------+
|    Wallet Private Key    |---&gt;|   Wallet Public Key   |
+--------------------------+    +-----------------------+
       |
       | purpose (e.g. 1852')
       |
       v
+--------------------------+
|   Purpose Private Key    |
+--------------------------+
       |
       | coin type (e.g. 1815' for ADA)
       v
+--------------------------+
|  Coin Type Private Key   |
+--------------------------+
       |
       | account ix (e.g. 0')
       v
+--------------------------+    +-----------------------+
|   Account Private Key    |---&gt;|   Account Public Key  |
+--------------------------+    +-----------------------+
       |                                          |
       | chain  (e.g. 1 for change)               |
       v                                          v
+--------------------------+    +-----------------------+
|   Change Private Key     |---&gt;|   Change Public Key   |
+--------------------------+    +-----------------------+
       |                                          |
       | address ix (e.g. 0)                      |
       v                                          v
+--------------------------+    +-----------------------+
|   Address Private Key    |---&gt;|   Address Public Key  |
+--------------------------+    +-----------------------+
</code></pre>
<p align="center"><small>Fig 2. BIP-44 Wallets Key Hierarchy</small></p>
<p>Paths with a tilde <code>'</code> refer to BIP-0032 hardened derivation path (meaning that
the private key is required to derive children). This leads to a couple of
interesting properties:</p>
<ol>
<li>New addresses (change or not) can be generated from an account's public key alone.</li>
<li>The derivation of addresses can be done sequentially / deterministically.</li>
<li>If an account private key is compromised, it doesn't compromise other accounts.</li>
</ol>
<p>This allows for external key-stores and off-loading of key derivation to some
external source such that a wallet could be tracking a set of accounts without
the need for knowing private keys. This approach is discussed more in details
below.</p>
<blockquote>
<p>NOTE:
One other important aspect is more of a security-concern. The introduction of
such new address scheme makes it possible to change the underlying derivation
function to a new better one with stronger cryptographic properties. This is
rather ad-hoc to the structural considerations above, but is still a major
motivation.</p>
</blockquote>
<h3 id="differences-between-cardano-hd-sequential-and-bip-44"><a class="header" href="#differences-between-cardano-hd-sequential-and-bip-44">Differences between <em>Cardano HD Sequential</em> and <em>BIP-44</em></a></h3>
<p>In BIP-44, new derivation paths are obtained by computing points on an elliptic
curve where curve parameters are defined by secp256k1. Cardano's implementation
relies on ed25519 for it provides better properties in terms of security and
performances.</p>
<p>Also, we use <code>purpose = 1852'</code> to clearly distinguish these formats from the original BIP-44 specification. Note however that Yoroi/Icarus in the Byron era are using <code>purpose = 44'</code>.</p>
<h2 id="differences-between-hd-random-and-hd-sequential-wallets"><a class="header" href="#differences-between-hd-random-and-hd-sequential-wallets">Differences between <em>HD Random</em> and <em>HD Sequential</em> Wallets</a></h2>
<p>Because BIP-44 public keys (HD Sequential) are generated in sequence, there's
no need to maintain a derivation path in the address attributes (incidentally,
this also makes addresses more private). Instead, we can generate pools of
addresses up to a certain limit (called address gap) for known accounts and
look for those addresses during block application.</p>
<p>We end up with two kind of Cardano addresses:</p>
<div class="table-wrapper"><table><thead><tr><th>Address V1 (Hd Random)</th><th>Address V2 (Icarus, HD Sequential)</th></tr></thead><tbody>
<tr><td>Uses ed25519@V1 (buggy) curve impl for derivation</td><td>Uses ed25519@V2 curve impl for derivation</td></tr>
<tr><td>Has a derivation path attribute</td><td>Has no derivation path attribute</td></tr>
<tr><td>New address indexes are random</td><td>New address indexes are sequential</td></tr>
<tr><td>Need root private key and passphrase to create addresses</td><td>Need only parent account public key to create addresses</td></tr>
<tr><td>Root keys are obtained from 12-word mnemonic phrases</td><td>Root keys are obtained from mnemonic phrases of various length</td></tr>
</tbody></table>
</div>
<p>Although the idea behind the BIP-44 protocol is to be able to have the wallet
working in a mode where the wallet doesn't know about the private keys, we still
do want to preserve compatibility with the existing address scheme (which can't
work without knowing private keys).</p>
<p>This leaves us with three operational modes for a wallet:</p>
<ul>
<li>
<p>Compatibility Mode with private key: In this mode, addresses are derived
using the wallet root private key and the classic derivation scheme. New address
indexes are generated randomly.</p>
</li>
<li>
<p>Deterministic Mode without private key: Here, we review the definition of a
wallet down to a list of account public keys with no relationship whatsoever
from the wallet's point of view. New addresses can be derived for each account
at will and discovered using the address pool discovery algorithm described in
BIP-44. Public keys are managed and provided from an external sources.</p>
</li>
<li>
<p>Deterministic Mode with private key: This is a special case of the above. In
this mode, the wallet maintain the key hierarchy itself, and leverage the
previous mode for block application and restoration.</p>
</li>
</ul>
<p>Those operational modes are detailed in more depth here below. Note that we'll
call <em>external wallets</em> wallets who don't own their private key.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../design/concepts/Notes-about-BIP-44.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../design/concepts/byron-address-format.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../design/concepts/Notes-about-BIP-44.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../design/concepts/byron-address-format.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>


    </div>
    </body>
</html>

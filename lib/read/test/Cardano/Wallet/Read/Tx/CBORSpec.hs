{-# LANGUAGE GADTs #-}
{-# LANGUAGE ScopedTypeVariables #-}

module Cardano.Wallet.Read.Tx.CBORSpec
    ( spec
    ) where

import Prelude

import Cardano.Wallet.Read.Eras
    ( Era (..)
    , EraValue (..)
    , IsEra
    , K (..)
    )
import Cardano.Wallet.Read.Tx.CBOR
    ( TxCBOR
    , parseTxFromCBOR
    , renderTxToCBOR
    )
import Data.ByteArray.Encoding
    ( Base (..)
    , convertFromBase
    )
import Data.ByteString
    ( ByteString
    )
import Data.ByteString.Lazy
    ( fromStrict
    )
import Test.Hspec
    ( Spec
    , describe
    , it
    , pendingWith
    )
import Test.QuickCheck
    ( Property
    , property
    , (===)
    )

import qualified Data.ByteString.Lazy as BL

spec :: Spec
spec = describe "Cardano.Wallet.Read.Tx.CBOR" $ do
    describe "TxCBOR encoding" $ do

        it "roundtrips byron tx properly" $ do
            pendingWith "CBOR for  byron missing"
            --  property $ prop_roundtrip byronTx
        it "roundtrips shelley tx properly" $ do
            property $ prop_roundtrip shelleyTx
        it "roundtrips allegra tx properly" $ do
            property $ prop_roundtrip allegraTx
        it "roundtrips mary tx properly" $ do
            property $ prop_roundtrip maryTx
        it "roundtrips alonzo tx properly" $ do
            property $ prop_roundtrip alonzoTx
        it "roundtrips babbage tx properly" $ do
            property $ prop_roundtrip babbageTx

prop_roundtrip :: TxCBOR -> Property
prop_roundtrip tx = (renderTxToCBOR <$> parseTxFromCBOR tx) === Right tx

alonzoTx :: TxCBOR
alonzoTx = mkTxCBOR Alonzo
    "84a400828258200000000000000000000000000000000000000000\
    \000000000000000000000000008258200000000000000000000000\
    \000000000000000000000000000000000000000000010183825839\
    \010202020202020202020202020202020202020202020202020202\
    \020202020202020202020202020202020202020202020202020202\
    \0202021a005b8d8082583901030303030303030303030303030303\
    \030303030303030303030303030303030303030303030303030303\
    \03030303030303030303030303031a005b8d808258390104040404\
    \040404040404040404040404040404040404040404040404040404\
    \040404040404040404040404040404040404040404040404041a00\
    \7801e0021a0002102003191e46a10282845820130ae82201d7072e\
    \6fbfc0a1884fb54636554d14945b799125cf7ce38d477f51584058\
    \35ff78c6fc5e4466a179ca659fa85c99b8a3fba083f3f3f42ba360\
    \d479c64ef169914b52ade49b19a7208fd63a6e67a19c406b482660\
    \8fdc5307025506c307582001010101010101010101010101010101\
    \0101010101010101010101010101010144a1024100845820010000\
    \000000000000000000000000000000000000000000000000000000\
    \00005840e8e769ecd0f3c538f0a5a574a1c881775f086d6f4c845b\
    \81be9b78955728bffa7efa54297c6a5d73337bd6280205b1759c13\
    \f79d4c93f29871fc51b78aeba80e58200000000000000000000000\
    \00000000000000000000000000000000000000000044a1024100f5\
    \f6"

babbageTx :: TxCBOR
babbageTx = mkTxCBOR Babbage
    "84a400818258200000000000000000000000000000000000000000\
    \000000000000000000000000000182a20058390101010101010101\
    \010101010101010101010101010101010101010101010101010101\
    \01010101010101010101010101010101010101010101011a001e84\
    \80a200583901020202020202020202020202020202020202020202\
    \020202020202020202020202020202020202020202020202020202\
    \0202020202020202011a0078175c021a0001faa403191e46a10281\
    \845820010000000000000000000000000000000000000000000000\
    \000000000000000058407154db81463825f150bb3b9b0824caf151\
    \3716f73498afe61d917a5621912a2b3df252bea14683a9ee56710d\
    \483a53a5aa35247e0d2b80e6300f7bdec763a20458200000000000\
    \000000000000000000000000000000000000000000000000000000\
    \44a1024100f5f6"

maryTx :: TxCBOR
maryTx = mkTxCBOR Mary
    "83a400828258200000000000000000000000000000000000000000\
    \000000000000000000000000008258200000000000000000000000\
    \000000000000000000000000000000000000000000010183825839\
    \010202020202020202020202020202020202020202020202020202\
    \020202020202020202020202020202020202020202020202020202\
    \0202021a005b8d8082583901030303030303030303030303030303\
    \030303030303030303030303030303030303030303030303030303\
    \03030303030303030303030303031a005b8d808258390104040404\
    \040404040404040404040404040404040404040404040404040404\
    \040404040404040404040404040404040404040404040404041a00\
    \7801e0021a0002102003191e46a10282845820130ae82201d7072e\
    \6fbfc0a1884fb54636554d14945b799125cf7ce38d477f51584058\
    \35ff78c6fc5e4466a179ca659fa85c99b8a3fba083f3f3f42ba360\
    \d479c64ef169914b52ade49b19a7208fd63a6e67a19c406b482660\
    \8fdc5307025506c307582001010101010101010101010101010101\
    \0101010101010101010101010101010144a1024100845820010000\
    \000000000000000000000000000000000000000000000000000000\
    \00005840e8e769ecd0f3c538f0a5a574a1c881775f086d6f4c845b\
    \81be9b78955728bffa7efa54297c6a5d73337bd6280205b1759c13\
    \f79d4c93f29871fc51b78aeba80e58200000000000000000000000\
    \00000000000000000000000000000000000000000044a1024100f6"

allegraTx :: TxCBOR
allegraTx = mkTxCBOR Allegra
    "83a400828258200000000000000000000000000000000000000000\
    \000000000000000000000000008258200000000000000000000000\
    \000000000000000000000000000000000000000000010183825839\
    \010202020202020202020202020202020202020202020202020202\
    \020202020202020202020202020202020202020202020202020202\
    \0202021a005b8d8082583901030303030303030303030303030303\
    \030303030303030303030303030303030303030303030303030303\
    \03030303030303030303030303031a005b8d808258390104040404\
    \040404040404040404040404040404040404040404040404040404\
    \040404040404040404040404040404040404040404040404041a00\
    \7801e0021a0002102003191e46a10282845820130ae82201d7072e\
    \6fbfc0a1884fb54636554d14945b799125cf7ce38d477f51584058\
    \35ff78c6fc5e4466a179ca659fa85c99b8a3fba083f3f3f42ba360\
    \d479c64ef169914b52ade49b19a7208fd63a6e67a19c406b482660\
    \8fdc5307025506c307582001010101010101010101010101010101\
    \0101010101010101010101010101010144a1024100845820010000\
    \000000000000000000000000000000000000000000000000000000\
    \00005840e8e769ecd0f3c538f0a5a574a1c881775f086d6f4c845b\
    \81be9b78955728bffa7efa54297c6a5d73337bd6280205b1759c13\
    \f79d4c93f29871fc51b78aeba80e58200000000000000000000000\
    \00000000000000000000000000000000000000000044a1024100f6"

shelleyTx :: TxCBOR
shelleyTx = mkTxCBOR Shelley
    "83a400828258200000000000000000000000000000000000000000\
    \000000000000000000000000008258200000000000000000000000\
    \000000000000000000000000000000000000000000010183825839\
    \010202020202020202020202020202020202020202020202020202\
    \020202020202020202020202020202020202020202020202020202\
    \0202021a005b8d8082583901030303030303030303030303030303\
    \030303030303030303030303030303030303030303030303030303\
    \03030303030303030303030303031a005b8d808258390104040404\
    \040404040404040404040404040404040404040404040404040404\
    \040404040404040404040404040404040404040404040404041a00\
    \7801e0021a0002102003191e46a10282845820130ae82201d7072e\
    \6fbfc0a1884fb54636554d14945b799125cf7ce38d477f51584058\
    \35ff78c6fc5e4466a179ca659fa85c99b8a3fba083f3f3f42ba360\
    \d479c64ef169914b52ade49b19a7208fd63a6e67a19c406b482660\
    \8fdc5307025506c307582001010101010101010101010101010101\
    \0101010101010101010101010101010144a1024100845820010000\
    \000000000000000000000000000000000000000000000000000000\
    \00005840e8e769ecd0f3c538f0a5a574a1c881775f086d6f4c845b\
    \81be9b78955728bffa7efa54297c6a5d73337bd6280205b1759c13\
    \f79d4c93f29871fc51b78aeba80e58200000000000000000000000\
    \00000000000000000000000000000000000000000044a1024100f6"

_byronTx :: TxCBOR
_byronTx = mkTxCBOR Byron ""

mkTxCBOR
    :: forall era
     . IsEra era
    => Era era
    -> ByteString
    -> EraValue (K BL.ByteString)
mkTxCBOR _era b = EraValue (K $ unsafeReadBase16 b :: K BL.ByteString era)

unsafeReadBase16 :: ByteString -> BL.ByteString
unsafeReadBase16 = either reportError fromStrict . convertFromBase Base16
  where
    reportError = error "unsafeReadBase16: input not in Base16"

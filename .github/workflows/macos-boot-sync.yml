name: macOS Boot Sync

on:
  push:
    branches: [master]
  pull_request:  # temporary â€“ remove after first successful run
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XDG_CACHE_HOME: /tmp/nix-eval-cache/${{ github.job }}

jobs:
  boot-syncs:
    name: "${{ matrix.name }}"
    runs-on: [self-hosted, macOS, ARM64, cardano-wallet]
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Preview Network Boot Sync"
            dir: run/preview/nix
            timeout: 600
            status: syncing
            network: testnet

          - name: "Mainnet Boot Sync"
            dir: run/mainnet/nix
            timeout: 600
            status: syncing
            network: mainnet

    env:
      SUCCESS_STATUS: ${{ matrix.status }}
      NODE_LOGS_FILE: ./logs/node.log
      WALLET_LOGS_FILE: ./logs/wallet.log
      CLEANUP_DB: "true"
      NETWORK: ${{ matrix.network }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run boot sync
        working-directory: ${{ matrix.dir }}
        run: |
          rm -rf logs databases
          mkdir -p logs
          ./run.sh sync ${{ matrix.timeout }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-boot-sync-logs-${{ strategy.job-index }}
          path: ${{ matrix.dir }}/logs/

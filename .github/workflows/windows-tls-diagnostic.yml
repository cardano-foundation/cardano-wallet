name: "Windows TLS Diagnostic"

on:
  pull_request:
  workflow_dispatch:

jobs:
  tls-diagnostic:
    name: "TLS Certificate Diagnostic"
    runs-on: [self-hosted, Windows, x64, cardano-wallet-win]
    steps:
      - name: "curl.exe → github.com (should work)"
        run: |
          curl.exe -sI https://github.com 2>&1 | Select-Object -First 5
          Write-Host "Exit code: $LASTEXITCODE"

      - name: "PowerShell → github.com (should work)"
        run: |
          try {
            $r = Invoke-WebRequest -Uri https://github.com -UseBasicParsing
            Write-Host "Status: $($r.StatusCode)"
          } catch {
            Write-Host "Failed: $_"
          }

      - name: "Show certificate chain for github.com"
        run: |
          $uri = [Uri]"https://github.com"
          $tcp = New-Object Net.Sockets.TcpClient($uri.Host, 443)
          $ssl = New-Object Net.Security.SslStream($tcp.GetStream(), $false)
          $ssl.AuthenticateAsClient($uri.Host)
          $cert = $ssl.RemoteCertificate
          Write-Host "Subject: $($cert.Subject)"
          Write-Host "Issuer: $($cert.Issuer)"
          Write-Host "Valid: $($cert.GetEffectiveDateString()) - $($cert.GetExpirationDateString())"
          $ssl.Dispose()
          $tcp.Dispose()

      - name: "List Local Machine ROOT store"
        run: |
          Get-ChildItem Cert:\LocalMachine\Root | Select-Object Subject, NotAfter | Format-Table -AutoSize

      - name: "List Current User ROOT store"
        run: |
          Get-ChildItem Cert:\CurrentUser\Root | Select-Object Subject, NotAfter | Format-Table -AutoSize

      - name: "Check USERTrust ECC in stores"
        run: |
          Write-Host "--- Local Machine ---"
          Get-ChildItem Cert:\LocalMachine\Root | Where-Object { $_.Subject -like "*USERTrust*" }
          Write-Host "--- Current User ---"
          Get-ChildItem Cert:\CurrentUser\Root | Where-Object { $_.Subject -like "*USERTrust*" }

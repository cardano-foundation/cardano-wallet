name: Linux Boot Syncs

on:
  workflow_dispatch:

jobs:
  build:
    name: "Build wallet and node"
    runs-on: [self-hosted, linux, x86_64, cardano-wallet]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Build derivations
        run: nix build -L .#cardano-wallet .#cardano-node .#cardano-cli

  boot-sync:
    name: "${{ matrix.name }}"
    needs: build
    runs-on: [self-hosted, linux, x86_64, cardano-wallet]
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Preview Network Boot Sync"
            dir: run/preview/nix
            timeout: 600
            status: syncing
            network: testnet

          - name: "Mainnet Boot Sync"
            dir: run/mainnet/nix
            timeout: 600
            status: syncing
            network: mainnet

    env:
      SUCCESS_STATUS: ${{ matrix.status }}
      NODE_LOGS_FILE: ./logs/node.log
      WALLET_LOGS_FILE: ./logs/wallet.log
      CLEANUP_DB: "true"
      NETWORK: ${{ matrix.network }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run boot sync
        working-directory: ${{ matrix.dir }}
        run: |
          rm -rf logs databases
          mkdir -p logs
          ./run.sh sync ${{ matrix.timeout }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: boot-sync-logs-${{ strategy.job-index }}
          path: ${{ matrix.dir }}/logs/

<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cardano Wallet</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="user.html"><strong aria-hidden="true">2.</strong> User Manual</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="user/when.html"><strong aria-hidden="true">2.1.</strong> When to use</a></li><li class="chapter-item expanded "><a href="user/common-use-cases.html"><strong aria-hidden="true">2.2.</strong> How to</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="user/common-use-cases/start-wallet-server.html"><strong aria-hidden="true">2.2.1.</strong> Start a server</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/create-a-wallet.html"><strong aria-hidden="true">2.2.2.</strong> Create a wallet</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/how-to-manage-wallets.html"><strong aria-hidden="true">2.2.3.</strong> Manage wallets</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/how-to-create-addresses.html"><strong aria-hidden="true">2.2.4.</strong> Create addresses</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/how-to-make-a-transaction.html"><strong aria-hidden="true">2.2.5.</strong> Create a transaction</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/assets.html"><strong aria-hidden="true">2.2.6.</strong> Handle assets</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/delegation.html"><strong aria-hidden="true">2.2.7.</strong> Handle delegation</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/handle-metadata.html"><strong aria-hidden="true">2.2.8.</strong> Handle metadata</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/shared-wallets.html"><strong aria-hidden="true">2.2.9.</strong> Create shared-wallets</a></li></ol></li><li class="chapter-item expanded "><a href="user/installation.html"><strong aria-hidden="true">2.3.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="user/installation/use-docker.html"><strong aria-hidden="true">2.3.1.</strong> Use docker</a></li><li class="chapter-item expanded "><a href="user/installation/use-nixos.html"><strong aria-hidden="true">2.3.2.</strong> Use NixOS</a></li></ol></li><li class="chapter-item expanded "><a href="user/cli.html"><strong aria-hidden="true">2.4.</strong> CLI</a></li><li class="chapter-item expanded "><a href="user/http-api.html"><strong aria-hidden="true">2.5.</strong> HTTP-API</a></li><li class="chapter-item expanded "><a href="user/hardware-recommendations.html"><strong aria-hidden="true">2.6.</strong> Hardware Recommendations</a></li><li class="chapter-item expanded "><a href="user/security.html"><strong aria-hidden="true">2.7.</strong> Security</a></li><li class="chapter-item expanded "><a href="user/integrations.html"><strong aria-hidden="true">2.8.</strong> Known integrations</a></li><li class="chapter-item expanded "><a href="user/ekg-and-prometheus.html"><strong aria-hidden="true">2.9.</strong> EKG and prometheus</a></li><li class="chapter-item expanded "><a href="user/common-use-cases/plutus-application-backend.html"><strong aria-hidden="true">2.10.</strong> Plutus application backend</a></li><li class="chapter-item expanded "><a href="user/faq.html"><strong aria-hidden="true">2.11.</strong> FAQ</a></li></ol></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">3.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="design/architecture.html"><strong aria-hidden="true">3.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="design/adrestia-architecture.html"><strong aria-hidden="true">3.2.</strong> Adrestia Architecture</a></li><li class="chapter-item expanded "><a href="design/links.html"><strong aria-hidden="true">3.3.</strong> Links</a></li><li class="chapter-item expanded "><a href="design/concepts.html"><strong aria-hidden="true">3.4.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="design/concepts/eras.html"><strong aria-hidden="true">3.4.1.</strong> Eras</a></li><li class="chapter-item expanded "><a href="design/concepts/recovery-phrases.html"><strong aria-hidden="true">3.4.2.</strong> Recovery Phrases</a></li><li class="chapter-item expanded "><a href="design/concepts/master-key-generation.html"><strong aria-hidden="true">3.4.3.</strong> Master Key Generation</a></li><li class="chapter-item expanded "><a href="design/concepts/Notes-about-BIP-44.html"><strong aria-hidden="true">3.4.4.</strong> Notes about BIP 44</a></li><li class="chapter-item expanded "><a href="design/concepts/address-derivation.html"><strong aria-hidden="true">3.4.5.</strong> Address Derivation</a></li><li class="chapter-item expanded "><a href="design/concepts/byron-address-format.html"><strong aria-hidden="true">3.4.6.</strong> Byron Address Format</a></li><li class="chapter-item expanded "><a href="design/concepts/coin-selection.html"><strong aria-hidden="true">3.4.7.</strong> Coin Selection</a></li><li class="chapter-item expanded "><a href="design/concepts/hierarchical-deterministic-wallets.html"><strong aria-hidden="true">3.4.8.</strong> Hierarchical Deterministic Wallets</a></li><li class="chapter-item expanded "><a href="design/concepts/transaction-lifecycle.html"><strong aria-hidden="true">3.4.9.</strong> Transaction Lifecycle</a></li><li class="chapter-item expanded "><a href="design/concepts/utxo.html"><strong aria-hidden="true">3.4.10.</strong> UTxO</a></li></ol></li><li class="chapter-item expanded "><a href="design/specs.html"><strong aria-hidden="true">3.5.</strong> Specifications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="design/specs/wallet-id.html"><strong aria-hidden="true">3.5.1.</strong> Wallet ID</a></li></ol></li><li class="chapter-item expanded "><a href="design/prototypes.html"><strong aria-hidden="true">3.6.</strong> Prototypes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="design/prototypes/light-mode.html"><strong aria-hidden="true">3.6.1.</strong> Light Mode</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="contributor.html"><strong aria-hidden="true">4.</strong> Contributor Manual</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributor/what.html"><strong aria-hidden="true">4.1.</strong> What – Code and Languages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributor/what/building.html"><strong aria-hidden="true">4.1.1.</strong> Building</a></li><li class="chapter-item expanded "><a href="contributor/what/coding-standards.html"><strong aria-hidden="true">4.1.2.</strong> Coding Standards</a></li><li class="chapter-item expanded "><a href="contributor/what/logging-guidelines.html"><strong aria-hidden="true">4.1.3.</strong> Logging Guidelines</a></li><li class="chapter-item expanded "><a href="contributor/what/swagger-development.html"><strong aria-hidden="true">4.1.4.</strong> Swagger Development</a></li><li class="chapter-item expanded "><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html"><strong aria-hidden="true">4.1.5.</strong> Specifying exceptions with Servant and Swagger</a></li><li class="chapter-item expanded "><a href="contributor/what/nix.html"><strong aria-hidden="true">4.1.6.</strong> Nix build language</a></li><li class="chapter-item expanded "><a href="contributor/what/nix-flake.html"><strong aria-hidden="true">4.1.7.</strong> Nix flake</a></li></ol></li><li class="chapter-item expanded "><a href="contributor/how.html"><strong aria-hidden="true">4.2.</strong> How – Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributor/how/testing.html"><strong aria-hidden="true">4.2.1.</strong> Testing</a></li><li class="chapter-item expanded "><a href="contributor/how/continuous-integration.html"><strong aria-hidden="true">4.2.2.</strong> Continuous Integration</a></li><li class="chapter-item expanded "><a href="contributor/how/release-process.html"><strong aria-hidden="true">4.2.3.</strong> Release Process</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributor/how/release-checklist.html"><strong aria-hidden="true">4.2.3.1.</strong> Release checklist</a></li></ol></li><li class="chapter-item expanded "><a href="contributor/how/code-review-guidelines.html"><strong aria-hidden="true">4.2.4.</strong> Code Review Guidelines</a></li></ol></li><li class="chapter-item expanded "><a href="contributor/notes.html"><strong aria-hidden="true">4.3.</strong> Notes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributor/notes/updating-dependencies.html"><strong aria-hidden="true">4.3.1.</strong> Updating Dependencies</a></li><li class="chapter-item expanded "><a href="contributor/notes/notes-from-upgrading-ghc-version.html"><strong aria-hidden="true">4.3.2.</strong> Notes from upgrading GHC version</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cardano Wallet</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="cardano-wallet"><a class="header" href="#cardano-wallet">Cardano Wallet</a></h1>
<p>Cardano Wallet helps you manage your Ada. You can use it to send and receive payments on the <a href="https://www.cardano.org/">Cardano</a> blockchain.</p>
<p>This project provides an HTTP Application Programming Interface (API) and command-line interface (CLI) for working with your wallet.</p>
<p>It can be used as a component of a frontend such as <a href="https://daedaluswallet.io/">Daedalus</a>, which provides a friendly user interface for wallets. Most users who would like to use Cardano should start with Daedalus.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-manual"><a class="header" href="#user-manual">User Manual</a></h1>
<p>Information about using the wallet.</p>
<p>This includes:</p>
<ul>
<li>Tutorials on how to perform specific tasks.</li>
<li>General recommendations.</li>
<li>Links to further documentation.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="when-to-use-cardano-wallet"><a class="header" href="#when-to-use-cardano-wallet">When to use <code>cardano-wallet</code></a></h1>
<p>Cardano-wallet was originally designed to provide the wallet logic for the graphical frontend <a href="https://daedaluswallet.io/">Daedalus</a>. Cardano-wallet does not offer a graphical interface, but it provides an HTTP API and a command line interface (CLI).</p>
<p>Cardano-wallet is a <strong>full-node wallet</strong>, which means that it depends on a <code>cardano-node</code> to provide blockchain data. In turn, this means that <code>cardano-wallet</code> enjoys the security properties of the Ouroboros consensus protocol. Other wallets such as <a href="https://eternl.io/">Eternl</a>, <a href="https://yoroi-wallet.com/">Yoroi</a> or <a href="https://www.lace.io/">Lace</a> are light wallets, which means that they have to trust a third party to provide blockchain data, but they use less computing resources in return.</p>
<p>Cardano-wallet supports</p>
<ul>
<li>
<p>All use cases</p>
<ul>
<li>Managing a balance of ADA and tokens</li>
<li>Submitting transactions to the Cardano network via a local `cardano-node``</li>
</ul>
</li>
<li>
<p>Personal use</p>
<ul>
<li>Staking</li>
<li>Compatibility with legacy wallets</li>
<li>Basic privacy with payment addresses creation</li>
</ul>
</li>
<li>
<p>Business use</p>
<ul>
<li>Minting and burning tokens</li>
<li>Multi-party signatures</li>
</ul>
</li>
</ul>
<p>We also accomodate</p>
<ul>
<li>
<p>Cryptocurrency Exchanges</p>
</li>
</ul>
<p>Please <a href="https://github.com/cardano-foundation/cardano-wallet/discussions">reach out to us</a> if you feel that we could do a better job of covering your use case. Preferably, tell us more about what you are trying to achieve and the problems you want to solve — then we can help you find out whether <code>cardano-wallet</code> is the right tool for you, and we can better accomodate your use case in our development roadmap.</p>
<h2 id="scalability"><a class="header" href="#scalability">Scalability</a></h2>
<h3 id="computing-resources"><a class="header" href="#computing-resources">Computing resources</a></h3>
<p>A single <code>cardano-wallet</code> process supports muliple wallets, each with separate (sets of) signing keys. These wallets run fairly independently, so that the computing resources used by <code>cardano-wallet</code> will be the sum of the resources used by each wallet.</p>
<p>Each wallet uses computing resources that grow with the number of addresses and UTxO in the wallet. For precise numbers, see our <a href="user/user/hardware-recommendations.html">Hardware Recommendations</a>.</p>
<p>If computing resources on a single machine are not sufficient, you can run multiple <code>cardano-wallet</code> process with different wallets on separate machines.</p>
<h3 id="transaction-throughput"><a class="header" href="#transaction-throughput">Transaction throughput</a></h3>
<p>If you want to submit frequent transactions to the Cardano blockchain, the wallet is typically not a bottleneck — rather, the transactions per seconds that can be accepted by the Cardano blockchain is the limiting factor. That said, transactions per second are not directly relevant to your end-users, see <a href="https://www.youtube.com/watch?v=gpSnyCn2s9U">Performance engineering: Lies, damned lies and (TPS) benchmarks</a> for a thorough discussion of performance on Cardano.</p>
<p>In general, note that the more your transactions depend on each other, the less they can be processed in parellel, reducing throughput and increasing latency.</p>
<p>On Cardano mainnet, on average 1 block per 20 slots is made, and one slot lasts 2 seconds (parameters as of July 2023). Each <a href="https://cardano.stackexchange.com/questions/216/is-there-a-maximum-number-of-transactions-a-block-can-hold">block may contain a maximum number of transactions</a>. Using these quantities, you can estimate an upper bound on the number of your transactions per second that the blockchain can accomodate.</p>
<p>If you need more frequent transactions that the estimate above, you need to consider a scaling solution such as <a href="https://hydra.family/">Hydra</a> or a sidechain.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to"><a class="header" href="#how-to">How to</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="start-wallet-server"><a class="header" href="#start-wallet-server">Start wallet server</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The easiest and most common way of managing your funds on the Cardano blockchain is through a wallet. This guide is to show how to start <code>cardano-wallet</code> together with <code>cardano-node</code> .</p>
<h2 id="full-node-mode"><a class="header" href="#full-node-mode">Full node mode</a></h2>
<p>Here we are going to start <code>cardano-wallet</code> in full node mode, meaning that we need to have also <code>cardano-node</code> running on the same machine. We can get binaries of <code>cardano-wallet</code> and compatible version of <code>cardano-node</code> from <a href="https://github.com/cardano-foundation/cardano-wallet/releases">cardano wallet release page</a>. <code>Cardano-wallet</code> archives published for each release, besides <code>cardano-wallet</code> itself, include all the relevant tools like <code>cardano-node</code> , <code>cardano-cli</code> , <code>cardano-addresses</code> or <code>bech32</code> .</p>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/start-wallet-server.html#admonition-note"></a></p>
</div>
<div>
<p>Alternatively one can use handy <a href="https://github.com/cardano-foundation/cardano-wallet#getting-started">docker-compose</a> to start wallet and the node on different networks:</p>
<p><code>&gt; NETWORK=mainnet docker-compose up</code></p>
<p><code>&gt; NETWORK=preprod docker-compose up</code></p>
<p><code>&gt; NETWORK=preview docker-compose up</code></p>
</div>
</div>
<h4 id="pre-requisites"><a class="header" href="#pre-requisites">Pre-requisites</a></h4>
<ul>
<li>Install cardano-wallet from <a href="https://github.com/cardano-foundation/cardano-wallet/releases">cardano wallet release page</a>.</li>
<li>Install cardano-node from <a href="https://github.com/cardano-foundation/cardano-wallet/releases">cardano wallet release page</a>.</li>
<li>Download up-to-date configuration files from <a href="https://book.world.dev.cardano.org/environments.html">Cardano Book</a>.</li>
</ul>
<h4 id="start-cardano-wallet-in-full-node-mode"><a class="header" href="#start-cardano-wallet-in-full-node-mode">Start <code>cardano-wallet</code> in full node mode</a></h4>
<div id="admonition-info" class="admonition info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/start-wallet-server.html#admonition-info"></a></p>
</div>
<div>
<p>Configuration files for all Cardano networks can be found in <a href="https://book.world.dev.cardano.org/environments.html">Cardano Book</a>.</p>
</div>
</div>
<ol>
<li>Start node:</li>
</ol>
<pre><code class="language-bash">&gt; cardano-node run \
  --config config.json \
  --topology topology.json \
  --database-path ./db \
  --socket-path /path/to/node.socket
</code></pre>
<ol start="2">
<li>Start wallet:</li>
</ol>
<p>When starting a wallet instance that targets a testing environment such as <code>preview</code> or <code>preprod</code> , we need to provide a <code>byron-genesis.json</code> file to the wallet:</p>
<pre><code class="language-bash">&gt; cardano-wallet serve --port 8090 \
  --node-socket /path/to/node.socket \
  --testnet byron-genesis.json \
  --database ./wallet-db \
  --token-metadata-server https://metadata.cardano-testnet.iohkdev.io
</code></pre>
<p>In case of <code>mainnet</code> we simply replace <code>--testnet byron-genesis.json</code> with option <code>--mainnet</code> .</p>
<pre><code class="language-bash">&gt; cardano-wallet serve --port 8090 \
  --node-socket /path/to/node.socket \
  --mainnet \
  --database ./wallet-db \
  --token-metadata-server https://tokens.cardano.org
</code></pre>
<div id="admonition-note-1" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/start-wallet-server.html#admonition-note-1"></a></p>
</div>
<div>
<p>We use different URLs for mainnet and test networks with the <code>--token-metadata-server</code> option. These URLs point to <a href="https://developers.cardano.org/docs/native-tokens/token-registry/cardano-token-registry">Cardano Token Registry</a> servers. See
<a href="user/common-use-cases/assets.html">assets</a>
for more information.</p>
</div>
</div>
<p>That's it! We can basically start managing our wallets from this point onwards. See
<a href="user/common-use-cases/../common-use-cases/create-a-wallet.html">how-to-create-a-wallet</a>
and <a href="user/common-use-cases/../common-use-cases/how-to-manage-wallets.html">how-to-manage-wallets</a></p>
<p>However, in order to be able to make transactions, we still need to wait until <code>cardano-node</code> is synced fully with the Cardano blockchain. In case of <code>mainnet</code> it may take several hours, in case of <code>testnet</code> a bit less.</p>
<p>We can monitor this process using <code>cardano-wallet's</code> <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getNetworkInformation"> <code>GET /network/information</code> </a> endpoint. Once the endpoint returns <code>sync_progress</code> status <code>ready</code> we'll know we are good to go:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/network/information | jq .sync_progress
{
  &quot;status&quot;: &quot;ready&quot;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-create-a-wallet"><a class="header" href="#how-to-create-a-wallet">How to create a wallet</a></h1>
<h2 id="pre-requisites-1"><a class="header" href="#pre-requisites-1">Pre-requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
</ul>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>The easiest and most common way of managing your funds on the Cardano blockchain is through a <a href="user/common-use-cases/../../concepts/hierarchical-deterministic-wallets.html">hierarchical deterministic wallet</a>
One can create a wallet using one of the following endpoints of <a href="user/common-use-cases/../http-api.html">http-api</a>:</p>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postWallet"> <code>POST /wallets</code> </a> - create <strong>Shelley</strong> wallet</p>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postByronWallet"> <code>POST /byron-wallets</code> </a> - create <strong>Byron</strong> wallet</p>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postSharedWallet"> <code>POST /shared-wallets</code> </a> - create <strong>Shared</strong> wallet</p>
<h2 id="shelley-wallets"><a class="header" href="#shelley-wallets">Shelley wallets</a></h2>
<p>Shelley wallets are <code>sequential</code> wallets recommended for any new applications. In particular they support delegation feature which is not supported by the Byron era wallets.</p>
<p>Exemplary request for creating new Shelley wallet may look as follows:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets \
    -d '{&quot;mnemonic_sentence&quot;:[&quot;slab&quot;,&quot;praise&quot;,&quot;suffer&quot;,&quot;rabbit&quot;,&quot;during&quot;,&quot;dream&quot;,&quot;arch&quot;,&quot;harvest&quot;,&quot;culture&quot;,&quot;book&quot;,&quot;owner&quot;,&quot;loud&quot;,&quot;wool&quot;,&quot;salon&quot;,&quot;table&quot;,&quot;animal&quot;,&quot;vivid&quot;,&quot;arrow&quot;,&quot;dirt&quot;,&quot;divide&quot;,&quot;humble&quot;,&quot;tornado&quot;,&quot;solution&quot;,&quot;jungle&quot;],
        &quot;passphrase&quot;:&quot;Secure Passphrase&quot;,
        &quot;name&quot;:&quot;My Test Wallet&quot;,
        &quot;address_pool_gap&quot;:20}' \
    -H &quot;Content-Type: application/json&quot;
</code></pre>
<p>Note also that you can have many wallets being operated by a single <code>cardano-wallet</code> server.</p>
<h2 id="byron-wallets"><a class="header" href="#byron-wallets">Byron wallets</a></h2>
<p>There are several Byron wallet types available:</p>
<ul>
<li>random</li>
<li>icarus</li>
<li>trezor</li>
<li>ledger</li>
</ul>
<p>The basic difference between them is that for a <code>random</code> wallet user needs to <a href="user/common-use-cases/how-to-create-addresses.html#random-wallets-legacy-byron">create addresses</a> manually, whereas for sequential wallets like <code>icarus</code> , <code>trezor</code> and <code>ledger</code> addresses are
<a href="user/common-use-cases/how-to-create-addresses.html#sequential-wallets-icarus-shelley--shared">created automatically</a> by the wallet.</p>
<blockquote>
<p>Please note that <code>random</code> wallets are considered <strong>deprecated</strong> and should not be used by new applications.</p>
</blockquote>
<p>See more on <a href="user/common-use-cases/../../concepts/hierarchical-deterministic-wallets.html">hierarchical deterministic wallet</a> and <a href="user/common-use-cases/../../concepts/byron-address-format.html">byron-address-format</a>.</p>
<h2 id="shared-wallets"><a class="header" href="#shared-wallets">Shared wallets</a></h2>
<p>Shared wallets are modern <code>sequential</code> &quot;Shelley-type wallets&quot;. The main idea is that funds within shared wallets can be managed by more than one owner. When creating such a wallet, it's necessary to provide a <code>payment_script_template</code> that lists all future co-signers and their extended account public keys (for spending operations), as well as a template script primitive that establishes the rules for sharing custody of the wallet's spending operations between the co-signers. Similarly, one can provide a <code>delegation_script_template</code> for sharing custody of delegation operations.</p>
<p>Exemplary request for creating new Shared wallet may look as follows:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/shared-wallets \
    -d '{&quot;mnemonic_sentence&quot;:[&quot;possible&quot;,&quot;lizard&quot;,&quot;zebra&quot;,&quot;hill&quot;,&quot;pluck&quot;,&quot;tourist&quot;,&quot;page&quot;,&quot;ticket&quot;,&quot;amount&quot;,&quot;fall&quot;,&quot;purpose&quot;,&quot;often&quot;,&quot;chest&quot;,&quot;fantasy&quot;,&quot;funny&quot;,&quot;sense&quot;,&quot;pig&quot;,&quot;goat&quot;,&quot;pet&quot;,&quot;minor&quot;,&quot;creek&quot;,&quot;vacant&quot;,&quot;swarm&quot;,&quot;fun&quot;],
    &quot;passphrase&quot;:&quot;Secure Passphrase&quot;,
    &quot;name&quot;:&quot;My Test Shared Wallet&quot;,
    &quot;account_index&quot;:&quot;0H&quot;,
    &quot;payment_script_template&quot;:{&quot;cosigners&quot;:{&quot;cosigner#0&quot;:&quot;self&quot;},&quot;template&quot;:{&quot;all&quot;:[&quot;cosigner#0&quot;,{&quot;active_from&quot;:120}]}},
    &quot;delegation_script_template&quot;:{&quot;cosigners&quot;:{&quot;cosigner#0&quot;:&quot;self&quot;,&quot;cosigner#1&quot;:&quot;1423856bc91c49e928f6f30f4e8d665d53eb4ab6028bd0ac971809d514c92db11423856bc91c49e928f6f30f4e8d665d53eb4ab6028bd0ac971809d514c92db2&quot;},&quot;template&quot;:{&quot;all&quot;:[&quot;cosigner#0&quot;,&quot;cosigner#1&quot;,{&quot;active_from&quot;:120},{&quot;active_until&quot;:300}]}}}' \
    -H &quot;Content-Type: application/json&quot;
</code></pre>
<p>See more elaborate example on <a href="user/common-use-cases/../common-use-cases/shared-wallets.html">shared wallets</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-manage-wallets"><a class="header" href="#how-to-manage-wallets">How to manage wallets</a></h1>
<h2 id="pre-requisites-2"><a class="header" href="#pre-requisites-2">Pre-requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
<li><a href="user/common-use-cases/create-a-wallet.html">how to create a wallet</a></li>
</ul>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>Once you created a wallet you can manage it with <code>cardano-wallet</code> endpoints. There are several operations available.</p>
<p>Refer to <a href="user/common-use-cases/../http-api.html">http-api</a>
for the extensive list of all operations. In particular for different wallet types supported by <code>cardano-wallet</code> :</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#tag/Wallets">Shelley wallets</a></li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#tag/Shared-Wallets">Shared wallets</a></li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#tag/Byron-Wallets">Byron wallets</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-create-addresses"><a class="header" href="#how-to-create-addresses">How to create addresses</a></h1>
<h2 id="pre-requisites-3"><a class="header" href="#pre-requisites-3">Pre-requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
<li><a href="user/common-use-cases/create-a-wallet.html">how to create a wallet</a></li>
</ul>
<h2 id="overview-3"><a class="header" href="#overview-3">Overview</a></h2>
<p>Once you have a wallet you can manage your funds. In order to receive a transaction you need to provide an address associated with your wallet to the sender.</p>
<h2 id="sequential-wallets-icarus-shelley--shared"><a class="header" href="#sequential-wallets-icarus-shelley--shared">Sequential wallets (Icarus, Shelley &amp; Shared)</a></h2>
<p>Since Icarus, wallets use sequential derivation which must satisfy very specific rules: a wallet is not allowed to use addresses beyond a certain limit before previously generated addresses have been used. This means that, at a given point in a time, a wallet has both a minimum and a maximum number of possible unused addresses. By default, the maximum number of consecutive unused addresses is set to <code>20</code> .</p>
<p>Therefore, address management is entirely done by the server and users aren't allowed to fiddle with them. The list of available addresses can be fetched from the server at any time via:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listByronAddresses"> <code>GET /byron-wallets/{walletId}/addresses</code> </a> - <strong>Icarus</strong> wallet addresses</li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listAddresses"> <code>GET /wallets/{walletId}/addresses</code> </a> - <strong>Shelley</strong> wallet addresses</li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listSharedAddresses"> <code>GET /shared-wallets/{walletId}/addresses</code> </a> - <strong>Shared</strong> wallet addresses</li>
</ul>
<p>This list automatically expands when new addresses become available so that there's always <code>address_pool_gap</code> consecutive unused addresses available (where <code>address_pool_gap</code> can be configured when a wallet is first restored / created).</p>
<h2 id="random-wallets-legacy-byron"><a class="header" href="#random-wallets-legacy-byron">Random wallets (Legacy Byron)</a></h2>
<p>Address creation is only allowed for wallets using random derivation. These are the legacy wallets from <em>cardano-sl</em>.</p>
<p>For <code>random</code> wallets user needs to invoke the following wallet endpoint to create new addresses:</p>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/createAddress"> <code>POST /byron-wallets/{walletId}/addresses</code> </a></p>
<p>In order to list existing addresses another endpoint can be used.</p>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listByronAddresses"> <code>GET /byron-wallets/{walletId}/addresses</code> </a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-make-a-transaction"><a class="header" href="#how-to-make-a-transaction">How to make a transaction</a></h1>
<h2 id="pre-requisites-4"><a class="header" href="#pre-requisites-4">Pre-requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
<li><a href="user/common-use-cases/create-a-wallet.html">how to create a wallet</a></li>
<li>In order to be able to send transactions, our wallet must have funds. In case of <code>preview</code> and <code>preprod</code> <a href="https://testnets.cardano.org/en/testnets/cardano/overview/">testnets</a> we can request tADA from the <a href="https://testnets.cardano.org/en/testnets/cardano/tools/faucet/">faucet</a>.</li>
</ul>
<h2 id="old-transaction-workflow"><a class="header" href="#old-transaction-workflow">Old transaction workflow</a></h2>
<p>Assuming you have already created a wallet, you can send a transaction by using the following endpoint:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postTransaction"><code>POST /wallets/{walletId}/transactions</code></a> - transaction from <strong>Shelley</strong> wallet</li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postByronTransaction"><code>POST /byron-wallets/{walletId}/transactions</code></a> - transaction from <strong>Byron</strong> wallet</li>
</ul>
<p>Behind the scene, the wallet engine will select necessary inputs from the wallet, generate a change address within the wallet, sign and submit the transaction. A transaction can have multiple outputs, possibly to the same address. Note that in Byron, addresses are necessarily base58-encoded (as an enforced convention).</p>
<h2 id="new-transaction-workflow"><a class="header" href="#new-transaction-workflow">New transaction workflow</a></h2>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#tag/Transactions-New">New transaction workflow</a> decouples creation of the transaction into separate steps:</p>
<ul>
<li>Construct: <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/constructTransaction"><code>POST /wallets/{walletId}/transactions-construct</code></a></li>
<li>Sign: <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/signTransaction"><code>POST /wallets/{walletId}/transactions-sign</code></a></li>
<li>Submit: <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitTransaction"><code>POST /wallets/{walletId}/transactions-submit</code></a></li>
</ul>
<p>Behind the scene, on the <strong>construct</strong> step, the wallet engine will select necessary inputs belonging to the wallet, generate a change address of the wallet and calculate the <code>fee</code> for this particular transaction.</p>
<p><strong>Sign</strong> and <strong>submit</strong> are now invoked as separate steps. This allows for presenting the actual transaction <code>fee</code> to the end user. In the old workflow, when all those steps where done in one go, showing precise fee was not possible and it had to be estimated using separate wallet endpoint. Because of the random nature of coin-selection algorithm such estimation might not have been always the same as the actual transaction fee.</p>
<p>Here is very basic example sending out 10₳ and 1 <code>asset</code> from the wallet:</p>
<ol>
<li>Construct.</li>
</ol>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-construct \
-d '{&quot;payments&quot;:
[{&quot;address&quot;:&quot;addr_test1qrv60y8vwu8cke6j83tgkfjttmtv0ytfvnhggp6f4gl5kf0l0dw5r75vk42mv3ykq8vyjeaanvpytg79xqzymqy5acmq5k85dg&quot;,
&quot;amount&quot;:{&quot;quantity&quot;:10000000,&quot;unit&quot;:&quot;lovelace&quot;},
&quot;assets&quot;:[{&quot;policy_id&quot;:&quot;b518eee977e1c8e3ce020e745be63b8b14498c565f5b59653e104ec7&quot;,
           &quot;asset_name&quot;:&quot;4163757374696330&quot;,
           &quot;quantity&quot;:1}]}]}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<ol start="2">
<li>Sign.</li>
</ol>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/how-to-make-a-transaction.html#admonition-note"></a></p>
</div>
<div>
<p>The response from <strong>construct</strong> will give us information like <code>fee</code> or <code>coin selection</code> details. It also returns a CBOR-encoded <code>transaction</code> represented in base64 encoding. This is what we need to feed into <strong>sign</strong>'s payload.</p>
</div>
</div>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-sign \
-d '{&quot;passphrase&quot;:&quot;Secure Passphrase&quot;,
     &quot;transaction&quot;:&quot;hKYAgYJYIJs6ATvbNwo5xpOkjHfUzr9Cv4zuFLFicFwWwpPC4ltBBQ2AAYKCWDkA0Tt2d1mVEvi5ZUp1k6RAHcWWqmNX0+gr0ea9nv97XUH6jLVVtkSWAdhJZ72bAkWjxTAETYCU7jaCGgCYloChWBy1GO7pd+HI484CDnRb5juLFEmMVl9bWWU+EE7HoUhBY3VzdGljMAGCWDkAILE1lnWHTaOk26BI/mHKGcjdgw9DcIsWT4W0YxcKHXESwr9eLTleQaAYVejg2GktTDXVp7ygo4CCGrYB1PChWBy1GO7pd+HI484CDnRb5juLFEmMVl9bWWU+EE7Hp0hBY3VzdGljMQFIQWN1c3RpYzIBSEFjdXN0aWM0AURCYXNzBUVEcnVtcwZJRHJ1bXNPbmx5AUhFbGVjdHJpYwYCGgAC2VUDGgMDcO8OgKD19g==&quot;}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<ol start="3">
<li>Submit.</li>
</ol>
<div id="admonition-note-1" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/how-to-make-a-transaction.html#admonition-note-1"></a></p>
</div>
<div>
<p>Again, we are feeding <strong>submit</strong>'s payload with CBOR-encoded <code>transaction</code> returned by <strong>sign</strong> request.</p>
</div>
</div>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-submit \
-d '{&quot;transaction&quot;:&quot;hKYAgYJYIJs6ATvbNwo5xpOkjHfUzr9Cv4zuFLFicFwWwpPC4ltBBQ2AAYKCWDkA0Tt2d1mVEvi5ZUp1k6RAHcWWqmNX0+gr0ea9nv97XUH6jLVVtkSWAdhJZ72bAkWjxTAETYCU7jaCGgCYloChWBy1GO7pd+HI484CDnRb5juLFEmMVl9bWWU+EE7HoUhBY3VzdGljMAGCWDkAILE1lnWHTaOk26BI/mHKGcjdgw9DcIsWT4W0YxcKHXESwr9eLTleQaAYVejg2GktTDXVp7ygo4CCGrYB1PChWBy1GO7pd+HI484CDnRb5juLFEmMVl9bWWU+EE7Hp0hBY3VzdGljMQFIQWN1c3RpYzIBSEFjdXN0aWM0AURCYXNzBUVEcnVtcwZJRHJ1bXNPbmx5AUhFbGVjdHJpYwYCGgAC2VUDGgMDcO8OgKEAgYJYIASQMgPsYJvlhj+L/ttWXivY8xL/Pzun5qalDwy+pVTpWECQQJAildc3KiO1u86KTH+qSg45K7/wckT4KPE21a819POFIf15NVDY9tsGAkT9uCBRyJ13m0h01ZsA9TWVso8J9fY=&quot;}' \
-H &quot;Content-Type: application/json&quot;

{
  &quot;id&quot;: &quot;35dd9db1f61822ac82f4690ea4fe12426bf6e534aff8e13563fce55a4d502772&quot;
}
</code></pre>
<p>We can monitor status of submitted transaction using <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getTransaction">GET /wallets/{walletId}/transactions/{transactionId}</a> endpoint.</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions/35dd9db1f61822ac82f4690ea4fe12426bf6e534aff8e13563fce55a4d502772 | jq

{
  &quot;inserted_at&quot;: {
    &quot;height&quot;: {
      &quot;quantity&quot;: 2975821,
      &quot;unit&quot;: &quot;block&quot;
    },
    &quot;time&quot;: &quot;2021-10-08T11:25:32Z&quot;,
    &quot;epoch_number&quot;: 161,
    &quot;absolute_slot_number&quot;: 39323116,
    &quot;slot_number&quot;: 140716
  },
  &quot;status&quot;: &quot;in_ledger&quot;,
....
</code></pre>
<h2 id="transaction-history"><a class="header" href="#transaction-history">Transaction history</a></h2>
<p>Note that all transactions made from and to any wallet are available in the transaction history.
We can always display details of a particular transaction as well as list all transactions that are known to a wallet.</p>
<p>For instance, transactions can be tracked via:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listTransactions"><code>GET /wallets/{walletId}/transactions</code></a> - transactions from <strong>Shelley</strong> wallet</li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listByronTransactions"><code>GET /byron-wallets/{walletId}/transactions</code></a> - transactions from <strong>Byron</strong> wallet</li>
</ul>
<p>Which returns a list of all transactions for this particular wallet. Optional range filters can be provided. A transaction will go through a succession of states, starting as “Pending”. If a transaction stays pending for too long (because rejected by a mempool, or because lost in translation due to multiple chain switches), users may decide to forget it using:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/deleteTransaction"><code>DELETE /wallets/{walletId}/transactions/{transactionId}</code></a>  - transactions from <strong>Shelley</strong> wallet</li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/deleteByronTransaction"><code>DELETE /byron-wallets/{walletId}/transactions/{transactionId}</code></a>  - transactions from <strong>Byron</strong> wallet</li>
</ul>
<p>For more information about transactions lifecycle, have a look at
<a href="user/common-use-cases/../../concepts/transaction-lifecycle.html">transaction lifecycle</a>.</p>
<h2 id="signed-and-serialized-transactions"><a class="header" href="#signed-and-serialized-transactions">Signed and serialized transactions</a></h2>
<p>Alternatively, <code>cardano-wallet</code> allows clients to submit already signed and serialized transactions as a raw bytes blob. This can be done by submitting such serialized data as an <code>application/octet-stream</code> :</p>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postExternalTransaction"><code>POST /proxy/transactions</code></a></p>
<p>In this scenario, the server engine will verify that the transaction is structurally well-formed and forward it to the node instance associated with it. If the transaction belongs to a known wallet, it will eventually show up in the wallet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="assets"><a class="header" href="#assets">Assets</a></h1>
<h2 id="pre-requisites-5"><a class="header" href="#pre-requisites-5">Pre-requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
<li><a href="user/common-use-cases/create-a-wallet.html">how to create a wallet</a></li>
<li>In order to be able to send transactions, our wallet must have funds. In case of <code>preview</code> and <code>preprod</code> <a href="https://testnets.cardano.org/en/testnets/cardano/overview/">testnets</a> we can request tADA from the <a href="https://testnets.cardano.org/en/testnets/cardano/tools/faucet/">faucet</a>.</li>
</ul>
<h2 id="overview-4"><a class="header" href="#overview-4">Overview</a></h2>
<p>The Cardano Blockchain features a unique ability to create (mint), interact (send and receive) and destroy (burn) custom tokens (or so-called 'assets') in a native way. Native, in this case, means besides sending and receiving the official currency ada, you can also interact with custom assets out of the box - without the need for smart contracts.</p>
<div id="admonition-info" class="admonition info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/assets.html#admonition-info"></a></p>
</div>
<div>
<p><a href="https://developers.cardano.org/docs/native-tokens/">Native tokens</a></p>
</div>
</div>
<div id="admonition-success" class="admonition success">
<div class="admonition-title">
<p>Success</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/assets.html#admonition-success"></a></p>
</div>
<div>
<p>Sending and receiving native assets is supported for all wallet types in <code>cardano-wallet</code></p>
</div>
</div>
<h2 id="assets-on-wallet-balance"><a class="header" href="#assets-on-wallet-balance">Assets on wallet balance</a></h2>
<p>You can easily check what assets you have on your wallet balance. Just look for <code>assets</code> in the response of <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getWallet">GET /wallets/{walletId}</a>.</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/wallets/73d38c71e4b8b5d71769622ab4f5bfdedbb7c39d | jq .assets

{
  &quot;total&quot;: [
    {
      &quot;asset_name&quot;: &quot;45524358&quot;,
      &quot;quantity&quot;: 1777134804,
      &quot;policy_id&quot;: &quot;36e93afe19e46227069520040012411e17839f219b549b7f5ac83b68&quot;
    },
    {
      &quot;asset_name&quot;: &quot;4d494c4b5348414b4530&quot;,
      &quot;quantity&quot;: 1,
      &quot;policy_id&quot;: &quot;dd043a63daf194065ca8c8f041337d8e75a08d8f6c469ddc1743d2f3&quot;
    }
  ],
  &quot;available&quot;: [
    {
      &quot;asset_name&quot;: &quot;45524358&quot;,
      &quot;quantity&quot;: 1777134804,
      &quot;policy_id&quot;: &quot;36e93afe19e46227069520040012411e17839f219b549b7f5ac83b68&quot;
    },
    {
      &quot;asset_name&quot;: &quot;4d494c4b5348414b4530&quot;,
      &quot;quantity&quot;: 1,
      &quot;policy_id&quot;: &quot;dd043a63daf194065ca8c8f041337d8e75a08d8f6c469ddc1743d2f3&quot;
    }
  ]
}

</code></pre>
<h2 id="listing-assets"><a class="header" href="#listing-assets">Listing assets</a></h2>
<p>You can also list assets that were ever associated with the wallet.</p>
<ul>
<li>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listAssets">GET /wallets/{walletId}/assets</a> - list all</p>
</li>
<li>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getAssetDefault">GET /wallets/{walletId}/assets/{policyId}</a> - get particular asset details by its <code>policy_id</code></p>
</li>
<li>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getAsset">GET /wallets/{walletId}/assets/{policyId}/{assetName}</a> - get particular asset details by <code>policy_id</code> and <code>asset_name</code></p>
</li>
</ul>
<h2 id="assets-off-chain-metadata"><a class="header" href="#assets-off-chain-metadata">Assets off-chain metadata</a></h2>
<p>Issuers of native assets may submit off-chain metadata relating to those assets to the <strong>Cardano Token Registry</strong>. There are separate instances of the token registry for <code>mainnet</code> and for each test network (e.g. <code>preview</code> or <code>preprod</code> ). Metadata submitted to the registry will be then served via the corresponding server.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>Mainnet</th><th>Testnets</th></tr></thead><tbody>
<tr><td><strong>Repository</strong></td><td>https://github.com/cardano-foundation/cardano-token-registry</td><td>https://github.com/input-output-hk/metadata-registry-testnet</td></tr>
<tr><td><strong>Server</strong></td><td>https://tokens.cardano.org</td><td>https://metadata.cardano-testnet.iohkdev.io</td></tr>
</tbody></table>
</div><div id="admonition-info-1" class="admonition info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/assets.html#admonition-info-1"></a></p>
</div>
<div>
<p><a href="https://developers.cardano.org/docs/native-tokens/token-registry/cardano-token-registry">Cardano Token Registry</a>, <a href="https://cips.cardano.org/cips/cip26">CIP26</a>.</p>
</div>
</div>
Cardano-wallet is capable of reading that metadata and serving it when listing assets. All you have to do is to start the wallet with the `--token-metadata-server` option, specifying an off-chain metadata server that corresponds to your network.
<p>For example on <code>preview</code> or <code>preprod</code> that would be:</p>
<pre><code class="language-bash">&gt; cardano-wallet serve --port 8090 \
  --node-socket /path/to/node.socket \
  --testnet byron-genesis.json \
  --database ./wallet-db \
  --token-metadata-server https://metadata.world.dev.cardano.org/
</code></pre>
<p>Then, if you list assets associated with your wallet you will get their available metadata.</p>
<p>For instance:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/wallets/1f82e83772b7579fc0854bd13db6a9cce21ccd95/assets/919e8a1922aaa764b1d66407c6f62244e77081215f385b60a6209149/4861707079436f696e

{
  &quot;fingerprint&quot;: &quot;asset1v96rhc76ke22mx8sulm4v3qhdcmtym7f4m66z2&quot;,
  &quot;asset_name&quot;: &quot;4861707079436f696e&quot;,
  &quot;policy_id&quot;: &quot;919e8a1922aaa764b1d66407c6f62244e77081215f385b60a6209149&quot;,
  &quot;metadata&quot;: {
    &quot;url&quot;: &quot;https://happy.io&quot;,
    &quot;name&quot;: &quot;HappyCoin&quot;,
    &quot;decimals&quot;: 6,
    &quot;ticker&quot;: &quot;HAPP&quot;,
    &quot;description&quot;: &quot;Coin with asset name - and everyone is happy!!!&quot;
  }
}
</code></pre>
<h2 id="minting-and-burning-assets"><a class="header" href="#minting-and-burning-assets">Minting and burning assets</a></h2>
<div id="admonition-info-2" class="admonition info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/assets.html#admonition-info-2"></a></p>
</div>
<div>
<p>Minting and burning assets is also available using <code>cardano-cli</code> . See more in https://developers.cardano.org/docs/native-tokens/minting.</p>
</div>
</div>
<p>Minting and burning of assets is available in the <code>cardano-wallet</code> in new transaction workflow. One can use wallet's key to mint any tokens that are guarded by native policy script. In practice it is just as simple as constructing a transaction that has a <code>mint_burn</code> field, then signing and submitting it to the network.</p>
<div id="admonition-info-3" class="admonition info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/assets.html#admonition-info-3"></a></p>
</div>
<div>
<p><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/constructTransaction">API to construct transactions</a></p>
</div>
</div>
<p>As an <strong>example</strong> on how to mint and burn assets we will try to mint (and then burn) an NFT with <a href="https://cips.cardano.org/cips/cip25/">CIP-25</a> metadata using <code>cardano-wallet</code> .</p>
<p>Please note that you would mint and burn other assets pretty much the same way. In our example we will be additionally adding on-chain metadata to our minting transaction as we want our NFT to be CIP-25 compliant. However this step is not required for minting. For instance, you could mint some assets and add off-chain metadata for them (<a href="https://cips.cardano.org/cips/cip26">CIP26</a>) in the <a href="https://developers.cardano.org/docs/native-tokens/token-registry/cardano-token-registry">Cardano Token Registry</a>.</p>
<h3 id="minting-an-nft"><a class="header" href="#minting-an-nft">Minting an NFT</a></h3>
<p>Let's see how can we mint an NFT with <a href="https://cips.cardano.org/cips/cip25/">CIP-25</a> metadata using <code>cardano-wallet</code> .</p>
<h4 id="policy-key"><a class="header" href="#policy-key">Policy key</a></h4>
<p>Before we attempt any minting/burning transaction we need to make sure our wallet is set up with a policy key. We can check it using <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getPolicyKey"> <code>GET /wallets/{walletId}/policy-key</code> </a>:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/wallets/73d38c71e4b8b5d71769622ab4f5bfdedbb7c39d/policy-key
&quot;policy_vk12d0gdel9u6px8wf3uv4z6m4h447n9qsad24gztaku8dzzdqfajzqfm3rr0&quot;
</code></pre>
<p>Looks good.
Otherwise we get <code>missing_policy_public_key</code> error:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/wallets/73d38c71e4b8b5d71769622ab4f5bfdedbb7c39d/policy-key
{
  &quot;code&quot;: &quot;missing_policy_public_key&quot;,
  &quot;message&quot;: &quot;It seems the wallet lacks a policy public key. Therefore it's not possible to create a minting/burning transaction or get a policy id. Please first POST to endpoint /wallets/{walletId}/policy-key to set a policy key.&quot;
}

</code></pre>
<p>In such a case we just need to make a <code>POST</code> request to <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postPolicyKey"> <code>POST /wallets/{walletId}/policy-key</code> </a> as suggested in the error message.</p>
<pre><code>&gt; curl -X POST http://localhost:8091/v2/wallets/73d38c71e4b8b5d71769622ab4f5bfdedbb7c39d/policy-key \
-d '{&quot;passphrase&quot;:&quot;Secure Passphrase&quot;}' \
-H &quot;Content-Type: application/json&quot;

&quot;policy_vk12d0gdel9u6px8wf3uv4z6m4h447n9qsad24gztaku8dzzdqfajzqfm3rr0&quot;
</code></pre>
<p>Once we have finished, we can proceed to minting NFTs from our wallet!</p>
<h4 id="cip-25-metadata"><a class="header" href="#cip-25-metadata">CIP-25 metadata</a></h4>
<p>We will be attaching CIP-25 metadata to our minting transaction, so there are few things that need to be sorted out. Most basic metadata can look as follows:</p>
<pre><code>{
      &quot;721&quot;: {
        &quot;&lt;POLICY_ID&gt;&quot;: {
          &quot;&lt;ASSET_NAME&gt;&quot;: {
            &quot;name&quot;: &quot;My amazing NFT&quot;,
            &quot;image&quot;: &quot;ipfs://&lt;IPFS_ID&gt;&quot;
          }
        }
      }
}
</code></pre>
<p>As we can see we need to figure out <code>&lt;POLICY_ID&gt;</code> , <code>&lt;ASSET_NAME&gt;</code> and <code>&lt;IPFS_ID&gt;</code> .</p>
<h5 id="policy-id"><a class="header" href="#policy-id">Policy ID</a></h5>
<p>Policy id is basically a hash of the native script that guards minting operation. In case of Shelley wallets we can only sign with one key, a wallet policy key, but because of the fact that we can embed it into a native script we can practically have unlimited amount of policy ids from one wallet.
These are examples of native scripts templates and each of them will produce different policy id.</p>
<pre><code>cosigner#0

{ &quot;all&quot;: [ &quot;cosigner#0&quot; ] }

{ &quot;any&quot;: [ &quot;cosigner#0&quot; ] }

{ &quot;some&quot;: {&quot;at_least&quot;: 1, &quot;from&quot;: [ &quot;cosigner#0&quot; ]} }

{ &quot;all&quot;:
     [ &quot;cosigner#0&quot;,
       { &quot;active_from&quot;: 120 }
     ]
}

{ &quot;all&quot;:
     [ &quot;cosigner#0&quot;,
       { &quot;active_until&quot;: 1200000 }
     ]
}
</code></pre>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/assets.html#admonition-note"></a></p>
</div>
<div>
<p><code>cosigner#0</code> stands for our wallet's policy key. In case of Shelley wallet we have only one. In the future, in the Shared wallets, we'll be able to construct a minting/burning script with many policy keys shared between different users and they will be identified as <code>cosigner#1</code> , <code>cosigner#2</code> ...</p>
</div>
</div>
<p>Let's create most basic policy id using <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postPolicyId"> <code>POST /wallets/{walletId}/policy-id</code> </a> endpoint:</p>
<pre><code>curl -X POST http://localhost:8090/v2/wallets/73d38c71e4b8b5d71769622ab4f5bfdedbb7c39d/policy-id \
-d '{&quot;policy_script_template&quot;:&quot;cosigner#0&quot;}' \
-H &quot;Content-Type: application/json&quot; | jq

{
  &quot;policy_id&quot;: &quot;6d5052088183db1ef06439a9f501b52721c2645532a50254a69d5390&quot;
}
</code></pre>
<h5 id="asset-name"><a class="header" href="#asset-name">Asset name</a></h5>
<p>The asset name acts as a sub-identifier within a given policy. Although we call it &quot;asset name&quot;, the value needn't be text, and it could even be empty. In case of CIP-25 however we can use a plain text. Let our asset name be... <code>AmazingNFT</code> .</p>
<h5 id="ipfs-id"><a class="header" href="#ipfs-id">IPFS id</a></h5>
<p>Let's assume that our NFT will point to a simple image, which we have already uploaded to IPFS. It is available at: https://ipfs.io/ipfs/QmRhTTbUrPYEw3mJGGhQqQST9k86v1DPBiTTWJGKDJsVFw. As we can see the IPFS id of the image is <code>QmRhTTbUrPYEw3mJGGhQqQST9k86v1DPBiTTWJGKDJsVFw</code> .</p>
<p>Now we can put together complete CIP-25 metadata JSON which we will use in the minting transaction:</p>
<pre><code>{
      &quot;721&quot;: {
        &quot;6d5052088183db1ef06439a9f501b52721c2645532a50254a69d5390&quot;: {
          &quot;AmazingNFT&quot;: {
            &quot;name&quot;: &quot;My amazing NFT&quot;,
            &quot;image&quot;: &quot;ipfs://QmRhTTbUrPYEw3mJGGhQqQST9k86v1DPBiTTWJGKDJsVFw&quot;
          }
        }
      }
}
</code></pre>
<h4 id="minting-transaction"><a class="header" href="#minting-transaction">Minting transaction</a></h4>
<p>We have already:</p>
<ul>
<li>verified that our wallet is equipped with policy key</li>
<li>created CIP-25 metadata JSON.</li>
</ul>
<p>We are now ready to mint!</p>
<p>We will <strong>construct</strong>  transaction that mints 1 <code>AmazingNFT</code> with policy id derived from simple native script template = <code>cosigner#0</code> and post the related CIP-25 metadata to blockchain.</p>
<p>Note that the wallet expects asset name to be hex-encoded string so let's hex encode our <code>AmazingNFT</code> first:</p>
<pre><code>&gt; echo -n &quot;AmazingNFT&quot; | xxd -p
416d617a696e674e4654
</code></pre>
<p>Let's now <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/constructTransaction"> <code>POST /wallets/{walletId}/transactions-construct</code> </a>:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/73d38c71e4b8b5d71769622ab4f5bfdedbb7c39d/transactions-construct \
-d '{
   &quot;metadata&quot;:{
      &quot;721&quot;:{
         &quot;6d5052088183db1ef06439a9f501b52721c2645532a50254a69d5390&quot;:{
            &quot;AmazingNFT&quot;:{
               &quot;name&quot;:&quot;My amazing NFT&quot;,
               &quot;image&quot;:&quot;ipfs://QmRhTTbUrPYEw3mJGGhQqQST9k86v1DPBiTTWJGKDJsVFw&quot;
            }
         }
      }
   },
   &quot;mint_burn&quot;:[
      {
         &quot;operation&quot;:{
            &quot;mint&quot;:{
               &quot;quantity&quot;:1
            }
         },
         &quot;policy_script_template&quot;:&quot;cosigner#0&quot;,
         &quot;asset_name&quot;:&quot;416d617a696e674e4654&quot;
      }
   ]
}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>That's it! I should now receive CBOR-encoded <code>transaction</code> , <code>fee</code> and <code>coin_selection</code> details in response.
I can now <strong>sign</strong> and <strong>submit</strong> such a transaction just like in
<a href="user/common-use-cases/how-to-make-a-transaction.html">how-to-make-a-transaction</a>.
After the transaction has been submitted, your freshly-minted NFT should appear in your wallet balance!</p>
<h3 id="burning-an-nft"><a class="header" href="#burning-an-nft">Burning an NFT</a></h3>
<p>Let's now burn our NFT. We have it already in our wallet balance and our wallet's policy key is &quot;guarding&quot; that asset so it shouldn't be any problem.</p>
<p>We can easily <strong>construct</strong> burning transaction with <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/constructTransaction"> <code>POST /wallets/{walletId}/transactions-construct</code> </a>:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/73d38c71e4b8b5d71769622ab4f5bfdedbb7c39d/transactions-construct \
-d '{
   &quot;mint_burn&quot;:[
      {
         &quot;operation&quot;:{
            &quot;burn&quot;:{
               &quot;quantity&quot;:1
            }
         },
         &quot;policy_script_template&quot;:&quot;cosigner#0&quot;,
         &quot;asset_name&quot;:&quot;416d617a696e674e4654&quot;
      }
   ]
}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>That's it. I can now <strong>sign</strong> and <strong>submit</strong> such transaction just like in
<a href="user/common-use-cases/how-to-make-a-transaction.html">how-to-make-a-transaction</a> and as a result my NFT will just disappear.</p>
<h2 id="sending-assets-in-a-transaction"><a class="header" href="#sending-assets-in-a-transaction">Sending assets in a transaction</a></h2>
<p>Once you have some assets on your wallet balance you can send it in a transaction.</p>
<p>For example, I'd like to send 1.5₳ and 15 <code>HappyCoins</code> to three different addresses in a single transaction.</p>
<p>First I need to <strong>construct</strong> it as follows:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/2269611a3c10b219b0d38d74b004c298b76d16a9/transactions-construct \
-d '{
   &quot;payments&quot;:[
      {
         &quot;address&quot;:&quot;addr_test1qqd2rhj0956q9xv8cevczvrvwg405agz7fzz0m2n87xhjvhxskq78v86w3zv9zc588rrp43sl2cusftxqkv3hzc0xs2sze9fu4&quot;,
         &quot;amount&quot;:{
            &quot;quantity&quot;:1500000,
            &quot;unit&quot;:&quot;lovelace&quot;
         },
         &quot;assets&quot;:[
            {
               &quot;policy_id&quot;:&quot;919e8a1922aaa764b1d66407c6f62244e77081215f385b60a6209149&quot;,
               &quot;asset_name&quot;:&quot;4861707079436f696e&quot;,
               &quot;quantity&quot;:15
            }
         ]
      },
      {
         &quot;address&quot;:&quot;addr_test1qqf90safefvsafmacrtu899vwg6nde3m8afeadtk8cp7qw8xskq78v86w3zv9zc588rrp43sl2cusftxqkv3hzc0xs2sekar6k&quot;,
         &quot;amount&quot;:{
            &quot;quantity&quot;:1500000,
            &quot;unit&quot;:&quot;lovelace&quot;
         },
         &quot;assets&quot;:[
            {
               &quot;policy_id&quot;:&quot;919e8a1922aaa764b1d66407c6f62244e77081215f385b60a6209149&quot;,
               &quot;asset_name&quot;:&quot;4861707079436f696e&quot;,
               &quot;quantity&quot;:15
            }
         ]
      },
      {
         &quot;address&quot;:&quot;addr_test1qpc038ku3u2js7hykte8xl7wctgl6avy20cp4k0z4ys2cy0xskq78v86w3zv9zc588rrp43sl2cusftxqkv3hzc0xs2sls284n&quot;,
         &quot;amount&quot;:{
            &quot;quantity&quot;:1500000,
            &quot;unit&quot;:&quot;lovelace&quot;
         },
         &quot;assets&quot;:[
            {
               &quot;policy_id&quot;:&quot;919e8a1922aaa764b1d66407c6f62244e77081215f385b60a6209149&quot;,
               &quot;asset_name&quot;:&quot;4861707079436f696e&quot;,
               &quot;quantity&quot;:15
            }
         ]
      }
   ]
}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>I should receive CBOR-encoded <code>transaction</code> , <code>fee</code> and <code>coin_selection</code> details in response.
I can now <strong>sign</strong> and <strong>submit</strong> such a transaction just like in <a href="user/common-use-cases/how-to-make-a-transaction.html">how-to-make-a-transaction</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-delegate"><a class="header" href="#how-to-delegate">How to delegate</a></h1>
<h2 id="pre-requisites-6"><a class="header" href="#pre-requisites-6">Pre-requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
<li><a href="user/common-use-cases/create-a-wallet.html">how to create a wallet</a></li>
<li>In order to be able to send transactions, our wallet must have funds. In case of <code>preview</code> and <code>preprod</code> <a href="https://testnets.cardano.org/en/testnets/cardano/overview/">testnets</a> we can request tADA from the <a href="https://testnets.cardano.org/en/testnets/cardano/tools/faucet/">faucet</a>.</li>
</ul>
<h2 id="overview-5"><a class="header" href="#overview-5">Overview</a></h2>
<p>Delegation is the process by which ada holders delegate the stake associated with their ada to a stake pool. Cardano wallet allows listing all stake pools that are operating on the blockchain and then &quot;join&quot; or &quot;quit&quot; them via special delegation transaction.</p>
<p>Delegation is supported only for <strong>Shelley</strong> wallets. <strong>Shared</strong> wallets will support it too in the near future.</p>
<h2 id="listing-stake-pools"><a class="header" href="#listing-stake-pools">Listing stake pools</a></h2>
<p>Before joining any stake pool we can first list all available stake pools that are operating on our blockchain. Stake pools are ordered by <code>non_myopic_member_rewards</code> which gives higher ranking and hence favors the pools potentially producing the best rewards in the future. The ordering could be influenced by the <code>?stake</code> query parameter which says how much stake we want to delegate.</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listStakePools"><code>GET /stake-pools</code></a></li>
</ul>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/stake-pools?stake=1000000000
</code></pre>
<h2 id="joining-stake-pool"><a class="header" href="#joining-stake-pool">Joining stake pool</a></h2>
<p>Once we select a stake pool we can &quot;join&quot; it. This operation will &quot;virtually&quot; add our wallet balance to the stake of this particular stake pool. Joining a pool for the first time will incur <code>fee</code> and <code>deposit</code> required for registering our stake key on the blockchain. This deposit will be returned to us if we quit stake pool all together.</p>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/delegation.html#admonition-note"></a></p>
</div>
<div>
<p>The amount of the deposit is controlled by Cardano network parameter. It is currently 2₳ on <code>mainnet</code> and <code>testnet</code>. Deposit is taken only once, when joining stake pool for the first time. Rejoining another stake pool does not incur another deposit.</p>
</div>
</div>
<p>We can join stake pool using old transaction workflow:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/joinStakePool"><code>PUT /stake-pools/{stakePoolId}/wallets/{walletId}</code></a></li>
</ul>
<p>Or new transaction workflow, where we can <strong>construct</strong> delegation transaction and then <strong>sign</strong> and <strong>submit</strong> it to the network:</p>
<ul>
<li>Construct: <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/constructTransaction"><code>POST /wallets/{walletId}/transactions-construct</code></a></li>
<li>Sign: <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/signTransaction"><code>POST /wallets/{walletId}/transactions-sign</code></a></li>
<li>Submit: <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitTransaction"><code>POST /wallets/{walletId}/transactions-submit</code></a></li>
</ul>
<p>Exemplary construct delegation request may look as follows:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-construct \
-d '{&quot;delegations&quot;:
     [{&quot;join&quot;:{&quot;pool&quot;:&quot;pool1mgjlw24rg8sp4vrzctqxtf2nn29rjhtkq2kdzvf4tcjd5pl547k&quot;,
               &quot;stake_key_index&quot;:&quot;0H&quot;}}]}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>Refer to <a href="user/common-use-cases/how-to-make-a-transaction.html">how-to-make-a-transaction</a>
for details on signing and submitting it to the network.</p>
<div id="admonition-note-1" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/delegation.html#admonition-note-1"></a></p>
</div>
<div>
<p>Information about <code>deposit_taken</code> and <code>deposit_returned</code> is available in the wallet transaction history. Refer to <a href="user/common-use-cases/how-to-make-a-transaction.html">how-to-make-a-transaction</a></p>
</div>
</div>
<h2 id="joining-another-stake-pool"><a class="header" href="#joining-another-stake-pool">Joining another stake pool</a></h2>
<p>Joining another stake pool doesn't differ from the previous process at all. The only difference is that, behind the scenes, <code>deposit</code> is not taken from the wallet, as it was already taken when joining for the first time.</p>
<h2 id="withdrawing-rewards"><a class="header" href="#withdrawing-rewards">Withdrawing rewards</a></h2>
<p>Our wallet accumulates rewards from delegating to a stake pool on special rewards account associated with it. We can see how many rewards we have on the wallet balance at any time.</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getWallet"><code>GET /wallets/{walletId}</code></a></li>
</ul>
<p>Just look up <code>balance</code> while getting your wallet details:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/wallets/1ceb45b37a94c7022837b5ca14045f11a5927c65 | jq .balance

{
  &quot;total&quot;: {
    &quot;quantity&quot;: 14883796944,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
  &quot;available&quot;: {
    &quot;quantity&quot;: 14876107482,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
  &quot;reward&quot;: {
    &quot;quantity&quot;: 7689462, &lt;----------- accumulated rewards
    &quot;unit&quot;: &quot;lovelace&quot;
  }
}
</code></pre>
<p>We can withdraw those rewards when making any transaction. In the both, old and new transaction workflow, it is as simple as adding <code>{ &quot;withdrawal&quot;: &quot;self&quot; }</code> to the transaction payload.</p>
<p>In particular in <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#tag/Transactions-New">new transaction workflow</a> we can just withdraw our rewards:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-construct \
-d '{&quot;withdrawal&quot;:&quot;self&quot;}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>or withdraw rewards while doing any other transaction:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-construct \
-d '{&quot;payments&quot;:[{&quot;address&quot;:&quot;addr_test1qrtez7vn0d8xp495ggypmu2kyt7tt6qyva2spm0f5a3ewn0v474mcs4q8e9g55yknx3729kyg5dl69x5596ee9tvnynq7ffety&quot;,&quot;amount&quot;:{&quot;quantity&quot;:1000000,&quot;unit&quot;:&quot;lovelace&quot;}}],
     &quot;withdrawal&quot;:&quot;self&quot;}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>As a result, after we sign and submit such transaction, the rewards will be added to our available balance (or just spend in case the amount of the transaction we're doing is bigger than our available balance and rewards are enough to compensate).</p>
<div id="admonition-note-2" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/delegation.html#admonition-note-2"></a></p>
</div>
<div>
<p>Information about <code>withdrawals</code> is also available in the wallet transaction history. Refer to <a href="user/common-use-cases/how-to-make-a-transaction.html">how-to-make-a-transaction</a></p>
</div>
</div>
<h2 id="quitting-stake-pool"><a class="header" href="#quitting-stake-pool">Quitting stake pool</a></h2>
<p>At any point we can decide to quit delegation all together. Quitting stake pool will cause de-registration of the stake key associated to our wallet and our deposit will be returned. After that we're not longer going to receive rewards.</p>
<p>Quitting can be done in old transaction workflow:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/quitStakePool"><code>DELETE /stake-pools/*/wallets/{walletId}</code></a></li>
</ul>
<div id="admonition-note-3" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/delegation.html#admonition-note-3"></a></p>
</div>
<div>
<p>All rewards will be withdrawn automatically upon quitting a stake pool.</p>
</div>
</div>
<p>or <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#tag/Transactions-New">new transaction workflow</a>, for instance:</p>
<p>Just quitting:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-construct \
-d '{&quot;delegations&quot;:[{&quot;quit&quot;:{&quot;stake_key_index&quot;:&quot;0H&quot;}}]}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>Quitting and withdrawing rewards in the same transaction. It should be noted that quitting can be realized only when all rewards are withdrawn:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-construct \
-d '{&quot;withdrawal&quot;:&quot;self&quot;,
     &quot;delegations&quot;:[{&quot;quit&quot;:{&quot;stake_key_index&quot;:&quot;0H&quot;}}]}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>After constructing a transaction that undelegates from a stake pool, I should receive a CBOR-encoded <code>transaction</code>, <code>fee</code>, and <code>coin_selection</code> in the response.
I can now <strong>sign</strong> and <strong>submit</strong> such a transaction just like in
<a href="user/common-use-cases/how-to-make-a-transaction.html">how-to-make-a-transaction</a>.</p>
<div id="admonition-note-4" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/delegation.html#admonition-note-4"></a></p>
</div>
<div>
<p>All rewards will be withdrawn only if you add {&quot;withdrawal&quot;:&quot;self&quot;} to the payload. You can achieve this with a single transaction, as shown above.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="handle-metadata"><a class="header" href="#handle-metadata">Handle Metadata</a></h1>
<h2 id="pre-requisites-7"><a class="header" href="#pre-requisites-7">Pre-requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
<li><a href="user/common-use-cases/create-a-wallet.html">how to create a wallet</a></li>
<li>In order to be able to send transactions, our wallet must have funds. In case of <code>preview</code> and <code>preprod</code> <a href="https://testnets.cardano.org/en/testnets/cardano/overview/">testnets</a> we can request tADA from the <a href="https://testnets.cardano.org/en/testnets/cardano/tools/faucet/">faucet</a>.</li>
</ul>
<h2 id="transaction-metadata"><a class="header" href="#transaction-metadata">Transaction Metadata</a></h2>
<p>Since the Shelley era, the Cardano blockchain allows user-defined data to be associated with transactions.</p>
<p>The metadata hash is part of the transaction body, so is covered by all transaction signatures.</p>
<p>The cardano-wallet API server uses a JSON representation of transaction metadata, isomorphic to the binary encoding on chain.</p>
<div id="admonition-warning" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/handle-metadata.html#admonition-warning"></a></p>
</div>
<div>
<p>Please note that metadata provided in a transaction will be stored on the blockchain forever. Make sure not to include any sensitive data, in particular personally identifiable information (PII).</p>
</div>
</div>
<h2 id="metadata-structure-on-chain"><a class="header" href="#metadata-structure-on-chain">Metadata structure on chain</a></h2>
<p>The <strong>top level</strong> is a map from metadata keys to metadata values.</p>
<p><strong>Metadata keys</strong> are integers in the range 0 to 2<sup>64</sup> - 1.</p>
<p><strong>Metadata values</strong> are one of three simple types or two compound types.</p>
<p>Simple types:</p>
<ul>
<li>
<p><em>Integers</em> in the range -(2<sup>64</sup> - 1) to 2<sup>64</sup> - 1</p>
</li>
<li>
<p><em>Strings</em> (UTF-8 encoded)</p>
</li>
<li>
<p><em>Bytestrings</em></p>
</li>
</ul>
<p>Compound types:</p>
<ul>
<li>
<p>Lists of <em>metadata values</em></p>
</li>
<li>
<p>Mappings from <em>metadata values</em> to <em>metadata values</em></p>
</li>
</ul>
<p>Note that lists and maps need not necessarily contain the same type of metadata value in each element.</p>
<h3 id="limits"><a class="header" href="#limits">Limits</a></h3>
<ul>
<li>Strings may be at most 64 bytes long when UTF-8 encoded.</li>
<li>Unencoded bytestrings may be at most 64 bytes long (i.e. at most 128 hex digits).</li>
<li>There are no limits to the number of metadata values, apart from the protocol limit on transaction size.</li>
</ul>
<p>The string length limitation is explained in the
<a href="https://hydra.iohk.io/job/Cardano/cardano-ledger-specs/delegationDesignSpec/latest/download-by-type/doc-pdf/delegation_design_spec">Delegation Design Spec, section E.3</a>:</p>
<blockquote>
<p>The size of strings in the structured value is limited to mitigate
the problem of unpleasant or illegal content being posted to the
blockchain. It does not prevent this problem entirely, but it means
that it is not as simple as posting large binary blobs.</p>
</blockquote>
<h2 id="json-representation-in-cardano-wallet"><a class="header" href="#json-representation-in-cardano-wallet">JSON representation in cardano-wallet</a></h2>
<p>The <strong>top level</strong> is a JSON object mapping <strong>metadata keys</strong> as
decimal number strings to JSON objects for metadata values.</p>
<p>Every <strong>metadata value</strong> is tagged with its type, using a JSON object,
like this:</p>
<ul>
<li>
<p><em>Integers</em></p>
<p><code>{ &quot;int&quot;: NUMBER }</code></p>
</li>
<li>
<p><em>Strings</em></p>
<p><code>{ &quot;string&quot;: STRING }</code></p>
</li>
<li>
<p><em>Bytestrings</em></p>
<p><code>{ &quot;bytes&quot;: HEX-STRING }</code></p>
<p>The value must be base16-encoded (a hex string).</p>
</li>
<li>
<p>Lists of <em>metadata values</em></p>
<p><code>{ &quot;list&quot;: [ METADATA-VALUE, ... ] }</code></p>
</li>
<li>
<p>Mappings from <em>metadata values</em> to <em>metadata values</em></p>
<p><code>{ &quot;map&quot;: [{ &quot;k&quot;: METADATA-VALUE, &quot;v&quot;: METADATA-VALUE }, ... ] }</code></p>
</li>
</ul>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>This is a transaction metadata which contains four values.</p>
<pre><code class="language-json">{
  &quot;64&quot;: {&quot;string&quot;: &quot;some text&quot;},
  &quot;32&quot;: {&quot;int&quot;: 42},
  &quot;16&quot;: {
    &quot;map&quot;: [
      {
        &quot;k&quot;: {&quot;string&quot;: &quot;numbers&quot;},
        &quot;v&quot;: {&quot;list&quot;: [{&quot;int&quot;: 1}, {&quot;int&quot;: 2}, {&quot;int&quot;: 4}, {&quot;int&quot;: 8}]}
      },
      {
        &quot;k&quot;: {&quot;string&quot;: &quot;alphabet&quot;},
        &quot;v&quot;: {
          &quot;map&quot;: [
            {&quot;k&quot;: {&quot;string&quot;: &quot;A&quot;}, &quot;v&quot;: {&quot;int&quot;: 65}},
            {&quot;k&quot;: {&quot;string&quot;: &quot;B&quot;}, &quot;v&quot;: {&quot;int&quot;: 66}},
            {&quot;k&quot;: {&quot;string&quot;: &quot;C&quot;}, &quot;v&quot;: {&quot;int&quot;: 67}}
          ]
        }
      }
    ]
  },
  &quot;8&quot;: { &quot;bytes&quot;: &quot;48656c6c6f2c2043617264616e6f21&quot; }
}
</code></pre>
<h2 id="sample-code-converting-from-javascript-objects"><a class="header" href="#sample-code-converting-from-javascript-objects">Sample code: Converting from JavaScript objects</a></h2>
<p>Use a function like this to translate arbitrary JavaScript values into metadata JSON format. If your application requires a more precise mapping, it can be modified to suit. Note that this code does not validate strings for length.</p>
<pre><code class="language-javascript">#!/usr/bin/env node

function txMetadataValueFromJS(jsVal) {
  if (Array.isArray(jsVal)) {
    // compound type - List
    // (note that sparse arrays are not representable in JSON)
    return { list: jsVal.map(txMetadataValueFromJS) };
  } else if (typeof(jsVal) === 'object') {
    if (jsVal !== null ) {
      // compound type - Map with String keys
      return { map: Object.keys(jsVal).map(key =&gt; {
        return { k: { string: key }, v: txMetadataValueFromJS(jsVal[key]) };
      }) };
    } else {
      // null: convert to simple type - String
      return { string: 'null' };
    }
  } else if (Number.isInteger(jsVal)) {
    // simple type - Int
    return { int: jsVal };
  } else if (typeof(jsVal) === 'string') {
    // simple type - String
    return { string: jsVal };
  } else {
    // anything else: convert to simple type - String.
    // e.g. undefined, true, false, NaN, Infinity.
    // Some of these can't be represented in JSON anyway.
    // Floating point numbers: note there can be loss of precision when
    // representing floats as decimal numbers
    return { string: '' + jsVal };
  }
}

// Get JSON objects from stdin, one per line.
const jsVals = require('fs')
  .readFileSync(0, { encoding: 'utf8' })
  .toString()
  .split(/\r?\n/)
  .filter(line =&gt; !!line)
  .map(JSON.parse);

// Convert to transaction metadata JSON form
const txMetadataValues = jsVals.map(txMetadataValueFromJS);
const txMetadata = txMetadataValues
  .reduce((ob, val, i) =&gt; { ob['' + i] = val; return ob; }, {});

// Print JSON to stdout
console.log(JSON.stringify(txMetadata));
</code></pre>
<h2 id="cli"><a class="header" href="#cli">CLI</a></h2>
<p>Metadata can be provided when creating transactions through the
<a href="user/common-use-cases/../cli.html">cli</a>.</p>
<p>The JSON is provided directly as a command-line argument.</p>
<ul>
<li>On Linux/MacOS JSON metadata can be put inside single quotes:</li>
</ul>
<pre><code>--metadata '{ &quot;0&quot;:{ &quot;string&quot;:&quot;cardano&quot; } }'
</code></pre>
<ul>
<li>On Windows it can be put in double quotes with double quotes inside JSON metadata escaped:</li>
</ul>
<pre><code>--metadata &quot;{ \&quot;0\&quot;:{ \&quot;string\&quot;:\&quot;cardano\&quot; } }&quot;
</code></pre>
<pre><code>Usage: cardano-wallet transaction create [--port INT] WALLET_ID
                                         --payment PAYMENT [--metadata JSON]
  Create and submit a new transaction.

Available options:
  -h,--help                Show this help text
  --port INT               port used for serving the wallet API. (default: 8090)
  --payment PAYMENT        address to send to and amount to send separated by @,
                           e.g. '&lt;amount&gt;@&lt;address&gt;'
  --metadata JSON          Application-specific transaction metadata as a JSON
                           object. The value must match the schema defined in
                           the cardano-wallet OpenAPI specification.
</code></pre>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<p>For a detailed explanation of the metadata design, and information about the transaction format, consult the following specifications.</p>
<ol>
<li><a href="https://hydra.iohk.io/job/Cardano/cardano-ledger-specs/delegationDesignSpec/latest/download-by-type/doc-pdf/delegation_design_spec">Delegation Design Spec</a>, Appendix E.</li>
<li><a href="https://hydra.iohk.io/job/Cardano/cardano-ledger-specs/specs.shelley-ledger/latest/download-by-type/doc-pdf/ledger-spec">Cardano Shelley Ledger Spec</a>, Figure 10.</li>
</ol>
<p>The full JSON schema is specified in the OpenAPI 3.0 <code>swagger.yaml</code>.</p>
<ol>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postTransaction">cardano-wallet OpenAPI Documentation</a>, Shelley / Transactions / Create.</li>
<li><a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/specifications/api/swagger.yaml">cardano-wallet OpenAPI Specification</a>, scroll to <code>TransactionMetadataValue</code>.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shared-wallets-1"><a class="header" href="#shared-wallets-1">Shared wallets</a></h1>
<h2 id="pre-requisites-8"><a class="header" href="#pre-requisites-8">Pre-requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
<li>In order to be able to send transactions, our wallet must have funds. In case of <code>preview</code> and <code>preprod</code> <a href="https://testnets.cardano.org/en/testnets/cardano/overview/">testnets</a> we can request tADA from the <a href="https://testnets.cardano.org/en/testnets/cardano/tools/faucet/">faucet</a>.</li>
</ul>
<h2 id="overview-6"><a class="header" href="#overview-6">Overview</a></h2>
<p>This guide shows you how to create a shared wallet and make a shared transaction, providing witnesses from all required co-signers referenced in the <code>payment_script_template</code> and <code>delegation_script_template</code> fields. In this example, we'll create two shared wallets using the same template for both payment and delegation operations. The template that we'll use will indicate that we require signatures from <strong>all</strong> co-owners in order to make a transaction. In our case, the wallet will have two co-owners <code>cosigner#0</code> and <code>cosigner#1</code>:</p>
<pre><code>&quot;template&quot;:
    { &quot;all&quot;:
       [ &quot;cosigner#0&quot;, &quot;cosigner#1&quot;]
    }
</code></pre>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/shared-wallets.html#admonition-note"></a></p>
</div>
<div>
<p>The script templates use Cardano <a href="https://github.com/IntersectMBO/cardano-node/blob/master/doc/reference/simple-scripts.md">simple scripts</a> therefore one can build more sophisticated templates to guard their shared wallet spending or delegation operations. Below are some examples of possible templates. You can also explore <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postSharedWallet"><code>POST /shared-wallets</code></a> swagger specification for more details.</p>
</div>
</div>
<h3 id="template-examples"><a class="header" href="#template-examples">Template examples</a></h3>
<ul>
<li>required signature from any cosigner from the list</li>
</ul>
<pre><code>&quot;template&quot;:
    { &quot;any&quot;:
       [ &quot;cosigner#0&quot;, &quot;cosigner#1&quot;, &quot;cosigner#2&quot;]
    }
</code></pre>
<ul>
<li>required signature from at least 2 cosigners from the list</li>
</ul>
<pre><code>&quot;template&quot;:
    { &quot;some&quot;:
       { &quot;at_least&quot;: 2,
         &quot;from&quot;: [ &quot;cosigner#0&quot;, &quot;cosigner#1&quot;, &quot;cosigner#2&quot;]
       }
    }
</code></pre>
<ul>
<li>required signature from at least 1 cosigners from the list but with additional nested constraints (at least <code>cosigner#0</code> or at least <code>cosigner#1</code> or at least both <code>cosigner#2</code> and <code>cosigner#3</code> and any of <code>cosigner#4</code> and <code>cosigner#5</code>)</li>
</ul>
<pre><code>&quot;template&quot;:{
  &quot;some&quot;:{
      &quot;at_least&quot;:1,
      &quot;from&quot;:[
        &quot;cosigner#0&quot;,
        &quot;cosigner#1&quot;,
        {
            &quot;all&quot;:[
              &quot;cosigner#2&quot;,
              &quot;cosigner#3&quot;,
              {
                  &quot;any&quot;:[
                    &quot;cosigner#4&quot;,
                    &quot;cosigner#5&quot;
                  ]
              }
            ]
        }
      ]
  }
}
</code></pre>
<ul>
<li>required signature from any cosigner but with additional time locking constraints (either <code>cosigner#0</code> or <code>cosigner#1</code> but only until slot 18447928 or <code>cosigner#2</code> but only from slot 18447928)</li>
</ul>
<pre><code>&quot;template&quot;:{
  &quot;any&quot;:[
      &quot;cosigner#0&quot;,
      {
        &quot;all&quot;:[
            &quot;cosigner#1&quot;,
            {
              &quot;active_until&quot;:18447928
            }
        ]
      },
      {
        &quot;all&quot;:[
            &quot;cosigner#2&quot;,
            {
              &quot;active_from&quot;:18447928
            }
        ]
      }
  ]
}
</code></pre>
<h2 id="creating-wallets"><a class="header" href="#creating-wallets">Creating wallets</a></h2>
<p>First let's create two <code>incomplete</code> shared wallets using the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/postSharedWallet"><code>POST /shared-wallets</code></a> endpoint. The wallets are marked as &quot;incomplete&quot; because they do not yet have public keys from all cosigners.</p>
<ol>
<li><code>Cosigner#0</code> wallet</li>
</ol>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/shared-wallets \
-d '{
   &quot;mnemonic_sentence&quot;:[
      &quot;beach&quot;,
      &quot;want&quot;,
      &quot;fly&quot;,
      &quot;guess&quot;,
      &quot;cabbage&quot;,
      &quot;hybrid&quot;,
      &quot;profit&quot;,
      &quot;leaf&quot;,
      &quot;term&quot;,
      &quot;air&quot;,
      &quot;join&quot;,
      &quot;feel&quot;,
      &quot;sting&quot;,
      &quot;nurse&quot;,
      &quot;anchor&quot;,
      &quot;come&quot;,
      &quot;entire&quot;,
      &quot;oil&quot;,
      &quot;kidney&quot;,
      &quot;situate&quot;,
      &quot;fun&quot;,
      &quot;deal&quot;,
      &quot;palm&quot;,
      &quot;chimney&quot;
   ],
   &quot;passphrase&quot;:&quot;Secure Passphrase&quot;,
   &quot;name&quot;:&quot;`Cosigner#0` wallet&quot;,
   &quot;account_index&quot;:&quot;0H&quot;,
   &quot;payment_script_template&quot;:{
      &quot;cosigners&quot;:{
         &quot;cosigner#0&quot;:&quot;self&quot;
      },
      &quot;template&quot;:{
         &quot;all&quot;:[
            &quot;cosigner#0&quot;,
            &quot;cosigner#1&quot;
         ]
      }
   },
   &quot;delegation_script_template&quot;:{
      &quot;cosigners&quot;:{
         &quot;cosigner#0&quot;:&quot;self&quot;
      },
      &quot;template&quot;:{
         &quot;all&quot;:[
            &quot;cosigner#0&quot;,
            &quot;cosigner#1&quot;
         ]
      }
   }
}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<ol start="2">
<li><code>Cosigner#1</code> wallet</li>
</ol>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/shared-wallets \
-d '{
   &quot;mnemonic_sentence&quot;:[
      &quot;slight&quot;,
      &quot;tool&quot;,
      &quot;pear&quot;,
      &quot;write&quot;,
      &quot;body&quot;,
      &quot;fruit&quot;,
      &quot;crucial&quot;,
      &quot;tomorrow&quot;,
      &quot;hunt&quot;,
      &quot;alley&quot;,
      &quot;object&quot;,
      &quot;tool&quot;,
      &quot;voyage&quot;,
      &quot;loud&quot;,
      &quot;loop&quot;,
      &quot;client&quot;,
      &quot;access&quot;,
      &quot;vocal&quot;,
      &quot;unable&quot;,
      &quot;brand&quot;,
      &quot;patch&quot;,
      &quot;remain&quot;,
      &quot;object&quot;,
      &quot;boat&quot;
   ],
   &quot;passphrase&quot;:&quot;Secure Passphrase&quot;,
   &quot;name&quot;:&quot;`Cosigner#1` wallet&quot;,
   &quot;account_index&quot;:&quot;0H&quot;,
   &quot;payment_script_template&quot;:{
      &quot;cosigners&quot;:{
         &quot;cosigner#1&quot;:&quot;self&quot;
      },
      &quot;template&quot;:{
         &quot;all&quot;:[
            &quot;cosigner#0&quot;,
            &quot;cosigner#1&quot;
         ]
      }
   },
   &quot;delegation_script_template&quot;:{
      &quot;cosigners&quot;:{
         &quot;cosigner#1&quot;:&quot;self&quot;
      },
      &quot;template&quot;:{
         &quot;all&quot;:[
            &quot;cosigner#0&quot;,
            &quot;cosigner#1&quot;
         ]
      }
   }
}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>Notice that the templates <code>payment_script_template</code> and <code>delegation_script_template</code> are partially the same for both wallets:</p>
<pre><code>  &quot;template&quot;:{
      &quot;all&quot;:[
        &quot;cosigner#0&quot;,
        &quot;cosigner#1&quot;
      ]
  }
</code></pre>
<p>However the <code>&quot;cosigners&quot;:</code> part differs slightly. &quot;<code>Cosigner#0</code> wallet&quot; has <code>&quot;cosigner#0&quot;:&quot;self&quot;</code> and &quot;<code>Cosigner#1</code> wallet&quot; - <code>&quot;cosigner#1&quot;:&quot;self&quot;</code>. Each wallet has partial information about cosigners. &quot;<code>Cosigner#0</code> wallet&quot; only knows about <code>cosigner#0</code> and &quot;<code>Cosigner#1</code> wallet&quot; only knows about <code>cosigner#1</code>.</p>
<p>Now we can look up the wallets we've just created using the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getSharedWallet"><code>GET /shared-wallets/{walletId}</code></a> endpoint. From the response, we can tell that the wallet's status is &quot;incomplete&quot;. For instance:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/shared-wallets/5e46668c320bb4568dd25551e0c33b0539668aa8 | jq

{
  &quot;account_index&quot;: &quot;0H&quot;,
  &quot;address_pool_gap&quot;: 20,
  &quot;delegation_script_template&quot;: {
    &quot;cosigners&quot;: {
      &quot;cosigner#1&quot;: &quot;acct_shared_xvk1mqrjad6aklkpwvhhktrzeef5yunla9pjs0jt9csp3gjcynxvumfjpk99hqxkyknn30ya6l5yjgeegs5ltmmsy70gm500sacvllvwt6qjztknp&quot;
    },
    &quot;template&quot;: {
      &quot;all&quot;: [
        &quot;cosigner#0&quot;,
        &quot;cosigner#1&quot;
      ]
    }
  },
  &quot;id&quot;: &quot;5e46668c320bb4568dd25551e0c33b0539668aa8&quot;,
  &quot;name&quot;: &quot;`Cosigner#1` wallet&quot;,
  &quot;payment_script_template&quot;: {
    &quot;cosigners&quot;: {
      &quot;cosigner#1&quot;: &quot;acct_shared_xvk1mqrjad6aklkpwvhhktrzeef5yunla9pjs0jt9csp3gjcynxvumfjpk99hqxkyknn30ya6l5yjgeegs5ltmmsy70gm500sacvllvwt6qjztknp&quot;
    },
    &quot;template&quot;: {
      &quot;all&quot;: [
        &quot;cosigner#0&quot;,
        &quot;cosigner#1&quot;
      ]
    }
  },
  &quot;state&quot;: {
    &quot;status&quot;: &quot;incomplete&quot;
  }
}

</code></pre>
<h3 id="patching-wallets"><a class="header" href="#patching-wallets">Patching wallets</a></h3>
<p>In order to be able to spend from the wallets we need to <em>patch</em> their payment and delegation templates with missing cosigners.
We already know that &quot;<code>Cosigner#0</code> wallet&quot; is missing the <code>cosigner#1</code> key and &quot;<code>Cosigner#1</code> wallet&quot; is missing the <code>cosigner#0</code> key.</p>
<p>First, let's get the <code>cosigner#1</code> key from the &quot;<code>Cosigner#1</code> wallet&quot;. We can use the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getAccountKeyShared"><code>GET /shared-wallets/{walletId}/keys</code></a> endpoint for this:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/shared-wallets/5e46668c320bb4568dd25551e0c33b0539668aa8/keys?format=extended

&quot;acct_shared_xvk1mqrjad6aklkpwvhhktrzeef5yunla9pjs0jt9csp3gjcynxvumfjpk99hqxkyknn30ya6l5yjgeegs5ltmmsy70gm500sacvllvwt6qjztknp&quot;

</code></pre>
<p>Now we can <em>patch</em> the payment and delegation templates of the &quot;<code>Cosigner#0</code> wallet&quot; with the <code>cosigner#1</code> key using the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/patchSharedWalletInPayment"><code>PATCH /shared-wallets/{walletId}/payment-script-template</code></a> and <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/patchSharedWalletInDelegation"><code>PATCH /shared-wallets/{walletId}/delegation-script-template</code></a> endpoints, respectively.</p>
<pre><code>&gt; curl -X PATCH http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f/payment-script-template \
-d '{&quot;cosigner#1&quot;:&quot;acct_shared_xvk1mqrjad6aklkpwvhhktrzeef5yunla9pjs0jt9csp3gjcynxvumfjpk99hqxkyknn30ya6l5yjgeegs5ltmmsy70gm500sacvllvwt6qjztknp&quot;}' \
-H &quot;Content-Type: application/json&quot;

&gt; curl -X PATCH http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f/delegation-script-template \
-d '{&quot;cosigner#1&quot;:&quot;acct_shared_xvk1mqrjad6aklkpwvhhktrzeef5yunla9pjs0jt9csp3gjcynxvumfjpk99hqxkyknn30ya6l5yjgeegs5ltmmsy70gm500sacvllvwt6qjztknp&quot;}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>We'll repeat the same action or &quot;<code>Cosigner#1</code> wallet&quot;, i.e. first get <code>cosigner#0</code> key from &quot;<code>Cosigner#0</code> wallet&quot; and then patch the payment and delegation templates of &quot;<code>Cosigner#1</code> wallet&quot; with it.</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f/keys?format=extended

&quot;acct_shared_xvk1lk5eg5unj4fg48vamr9pc40euump5qs084a7cdgvs9u6yn82nh9lr3s62asfv45r4s0fqa239j3dc5e4f7z24heug43zpg6qdy5kawq63hhzl&quot;

&gt; curl -X PATCH http://localhost:8090/v2/shared-wallets/5e46668c320bb4568dd25551e0c33b0539668aa8/payment-script-template \
-d '{&quot;cosigner#0&quot;:&quot;acct_shared_xvk1lk5eg5unj4fg48vamr9pc40euump5qs084a7cdgvs9u6yn82nh9lr3s62asfv45r4s0fqa239j3dc5e4f7z24heug43zpg6qdy5kawq63hhzl&quot;}' \
-H &quot;Content-Type: application/json&quot;

&gt; curl -X PATCH http://localhost:8090/v2/shared-wallets/5e46668c320bb4568dd25551e0c33b0539668aa8/delegation-script-template \
-d '{&quot;cosigner#0&quot;:&quot;acct_shared_xvk1lk5eg5unj4fg48vamr9pc40euump5qs084a7cdgvs9u6yn82nh9lr3s62asfv45r4s0fqa239j3dc5e4f7z24heug43zpg6qdy5kawq63hhzl&quot;}' \
-H &quot;Content-Type: application/json&quot;
</code></pre>
<p>Now, if we look up the wallet again with <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getSharedWallet"><code>GET /shared-wallets/{walletId}</code></a>, we should notice that the wallet has started restoring, and after a while it is ready to use:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f | jq .state

{
  &quot;status&quot;: &quot;ready&quot;
}
</code></pre>
<p>Furthermore, the wallets now have complete information about cosigners for delegation and payment templates:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f | jq .payment_script_template

{
  &quot;cosigners&quot;: {
    &quot;cosigner#0&quot;: &quot;acct_shared_xvk1lk5eg5unj4fg48vamr9pc40euump5qs084a7cdgvs9u6yn82nh9lr3s62asfv45r4s0fqa239j3dc5e4f7z24heug43zpg6qdy5kawq63hhzl&quot;,
    &quot;cosigner#1&quot;: &quot;acct_shared_xvk1mqrjad6aklkpwvhhktrzeef5yunla9pjs0jt9csp3gjcynxvumfjpk99hqxkyknn30ya6l5yjgeegs5ltmmsy70gm500sacvllvwt6qjztknp&quot;
  },
  &quot;template&quot;: {
    &quot;all&quot;: [
      &quot;cosigner#0&quot;,
      &quot;cosigner#1&quot;
    ]
  }
}

&gt; curl -X GET http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f | jq .delegation_script_template

{
  &quot;cosigners&quot;: {
    &quot;cosigner#0&quot;: &quot;acct_shared_xvk1lk5eg5unj4fg48vamr9pc40euump5qs084a7cdgvs9u6yn82nh9lr3s62asfv45r4s0fqa239j3dc5e4f7z24heug43zpg6qdy5kawq63hhzl&quot;,
    &quot;cosigner#1&quot;: &quot;acct_shared_xvk1mqrjad6aklkpwvhhktrzeef5yunla9pjs0jt9csp3gjcynxvumfjpk99hqxkyknn30ya6l5yjgeegs5ltmmsy70gm500sacvllvwt6qjztknp&quot;
  },
  &quot;template&quot;: {
    &quot;all&quot;: [
      &quot;cosigner#0&quot;,
      &quot;cosigner#1&quot;
    ]
  }
}
</code></pre>
<h3 id="spending-transactions"><a class="header" href="#spending-transactions">Spending transactions</a></h3>
<p>Our shared wallets are now fully-operational. In particular, we can access the addresses of the wallets via the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listSharedAddresses"><code>GET /shared-wallets/{walletId}/addresses</code></a> endpoint. We can get the address and fund it from the <a href="https://testnets.cardano.org/en/testnets/cardano/tools/faucet/">faucet</a> so that we can spend from our wallet later on.</p>
<p>After we have funded the &quot;<code>Cosigner#0</code> wallet&quot;, we can see that the balance has changed on the &quot;<code>Cosigner#1</code> wallet&quot; as well. Both wallets have the same balance:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f | jq .balance

{
  &quot;available&quot;: {
    &quot;quantity&quot;: 10000000000,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
  &quot;reward&quot;: {
    &quot;quantity&quot;: 0,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
  &quot;total&quot;: {
    &quot;quantity&quot;: 10000000000,
    &quot;unit&quot;: &quot;lovelace&quot;
  }
}

&gt; curl -X GET http://localhost:8090/v2/shared-wallets/5e46668c320bb4568dd25551e0c33b0539668aa8 | jq .balance

{
  &quot;available&quot;: {
    &quot;quantity&quot;: 10000000000,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
  &quot;reward&quot;: {
    &quot;quantity&quot;: 0,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
  &quot;total&quot;: {
    &quot;quantity&quot;: 10000000000,
    &quot;unit&quot;: &quot;lovelace&quot;
  }
}
</code></pre>
<p>Of course, this is expected. Both co-owners have full knowledge of the balance, however they cannot spend from the balance on their own. As required by the payment template, the wallet needs signatures from both co-owners before funds can be spent.</p>
<p>Let's make a simple transaction. The owner of &quot;<code>Cosigner#0</code> wallet&quot; will construct and sign a transaction on their end, and then provide a CBOR blob of this transaction to the owner of &quot;<code>Cosigner#1</code> wallet&quot;. Then <code>Cosigner#1</code> can sign it on their own, and submit it to the network.</p>
<p>We will be using the following shared wallet transaction endpoints:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/constructSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-construct</code></a></li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/signSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-sign</code></a></li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-submit</code></a></li>
</ul>
<div id="admonition-note-1" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/common-use-cases/shared-wallets.html#admonition-note-1"></a></p>
</div>
<div>
<p>At any point during the process of constructing and signing a transaction, both &quot;<code>Cosigner#0</code>&quot; and &quot;<code>Cosigner#1</code>&quot; may decode the transaction from its CBOR representation using the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/decodeSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-decode</code></a> endpoint. Decoding the transaction makes it possible to see all details associated with the transaction, such as its <code>inputs</code>, <code>outputs</code>, <code>fees</code>, <code>deposits</code>, <code>metadata</code>, or <code>witness_count</code>.</p>
</div>
</div>
<h4 id="cosigner0"><a class="header" href="#cosigner0"><code>Cosigner#0</code></a></h4>
<h5 id="constructing"><a class="header" href="#constructing">Constructing</a></h5>
<p>&quot;<code>Cosigner#0</code>&quot; constructs a transaction sending 10₳ to an external address using the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/constructSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-construct</code></a> endpoint. In response, they receive a CBOR representation of the unsigned transaction.</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f/transactions-construct \
-d '{
   &quot;payments&quot;:[
      {
         &quot;address&quot;:&quot;addr_test1qq86pgrf7yyzp3gysxgqwt4ahegzslygvzh77eq2qwg66pedkztnw78s6gkt3eux35sllasu0x6grejewlrzaus8kekq7cp9ck&quot;,
         &quot;amount&quot;:{
            &quot;quantity&quot;:10000000,
            &quot;unit&quot;:&quot;lovelace&quot;
         }
      }
   ]
}' \
-H &quot;Content-Type: application/json&quot; | jq .transaction

&quot;hKUAgYJYIP8Fwso5i5ovF8bJJuqZ4xOdvXC3mXJCN2O2vDIxQQOYAAGCogBYOQAPoKBp8QggxQSBkAcuvb5QKHyIYK/vZAoDka0HLbCXN3jw0iy454aNIf/2HHm0geZZd8Yu8ge2bAEaAJiWgKIAWDkwZ/CRYzhreLBgWdOZFReuuejo5RIhvNwLOk51lWQGg+0Ii6yF8VB/6jOUJdwEhwqE3Od9sHl14eQBGwAAAAJTcJsvAhoAArJRAxoBDHtNCAChAYGCAYKCAFgciTss5ZpPDifzTTlpVVbNSaZGERzre1z05XYVWYIAWBzHmpkAwWCRnUTfcTy0aZK2LLLM36Y/4gZMlJhm9fY=&quot;
</code></pre>
<h5 id="signing"><a class="header" href="#signing">Signing</a></h5>
<p>&quot;<code>Cosigner#0</code>&quot; signs the transaction with the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/signSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-sign</code></a> endpoint:</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f/transactions-sign \
-d '{
   &quot;passphrase&quot;:&quot;Secure Passphrase&quot;,
   &quot;transaction&quot;:&quot;hKUAgYJYIP8Fwso5i5ovF8bJJuqZ4xOdvXC3mXJCN2O2vDIxQQOYAAGCogBYOQAPoKBp8QggxQSBkAcuvb5QKHyIYK/vZAoDka0HLbCXN3jw0iy454aNIf/2HHm0geZZd8Yu8ge2bAEaAJiWgKIAWDkwZ/CRYzhreLBgWdOZFReuuejo5RIhvNwLOk51lWQGg+0Ii6yF8VB/6jOUJdwEhwqE3Od9sHl14eQBGwAAAAJTcJsvAhoAArJRAxoBDHzCCAChAYGCAYKCAFgciTss5ZpPDifzTTlpVVbNSaZGERzre1z05XYVWYIAWBzHmpkAwWCRnUTfcTy0aZK2LLLM36Y/4gZMlJhm9fY=&quot;
}' \
-H &quot;Content-Type: application/json&quot; | jq .transaction

&quot;hKUAgYJYIP8Fwso5i5ovF8bJJuqZ4xOdvXC3mXJCN2O2vDIxQQOYAAGCogBYOQAPoKBp8QggxQSBkAcuvb5QKHyIYK/vZAoDka0HLbCXN3jw0iy454aNIf/2HHm0geZZd8Yu8ge2bAEaAJiWgKIAWDkwZ/CRYzhreLBgWdOZFReuuejo5RIhvNwLOk51lWQGg+0Ii6yF8VB/6jOUJdwEhwqE3Od9sHl14eQBGwAAAAJTcJsvAhoAArJRAxoBDHzCCACiAIGCWCBOK9nJ9IxJt2gddyZ2fUHC4nre84+EbPQdL60OP0m4ZlhA11gVIBWSlDZl8NQyzV4v9U8AuX8n2UqJK9+Wt1sqnM7jAeYtbuyAN5weTaVV+NDVlpKVg3piowyC1eqZBeWWAQGBggGCggBYHIk7LOWaTw4n8005aVVWzUmmRhEc63tc9OV2FVmCAFgcx5qZAMFgkZ1E33E8tGmStiyyzN+mP+IGTJSYZvX2&quot;
</code></pre>
<p>and in response, receives a CBOR representation of the partially-signed transaction.</p>
<h4 id="cosigner1"><a class="header" href="#cosigner1"><code>Cosigner#1</code></a></h4>
<p>Now &quot;<code>Cosigner#0</code>&quot; can hand over the CBOR of the partially-signed transaction to &quot;<code>Cosigner#1</code>&quot;, who can then sign it on their own.</p>
<h5 id="signing-1"><a class="header" href="#signing-1">Signing</a></h5>
<p>&quot;<code>Cosigner#1</code>&quot; signs the transaction with <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/signSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-sign</code></a> and gets a CBOR representation of the fully-signed transaction in response.</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/shared-wallets/5e46668c320bb4568dd25551e0c33b0539668aa8/transactions-sign \
-d '{
   &quot;passphrase&quot;:&quot;Secure Passphrase&quot;,
   &quot;transaction&quot;:&quot;hKUAgYJYIP8Fwso5i5ovF8bJJuqZ4xOdvXC3mXJCN2O2vDIxQQOYAAGCogBYOQAPoKBp8QggxQSBkAcuvb5QKHyIYK/vZAoDka0HLbCXN3jw0iy454aNIf/2HHm0geZZd8Yu8ge2bAEaAJiWgKIAWDkwZ/CRYzhreLBgWdOZFReuuejo5RIhvNwLOk51lWQGg+0Ii6yF8VB/6jOUJdwEhwqE3Od9sHl14eQBGwAAAAJTcJsvAhoAArJRAxoBDHzCCACiAIGCWCBOK9nJ9IxJt2gddyZ2fUHC4nre84+EbPQdL60OP0m4ZlhA11gVIBWSlDZl8NQyzV4v9U8AuX8n2UqJK9+Wt1sqnM7jAeYtbuyAN5weTaVV+NDVlpKVg3piowyC1eqZBeWWAQGBggGCggBYHIk7LOWaTw4n8005aVVWzUmmRhEc63tc9OV2FVmCAFgcx5qZAMFgkZ1E33E8tGmStiyyzN+mP+IGTJSYZvX2&quot;
}' \
-H &quot;Content-Type: application/json&quot; | jq .transaction

&quot;hKUAgYJYIP8Fwso5i5ovF8bJJuqZ4xOdvXC3mXJCN2O2vDIxQQOYAAGCogBYOQAPoKBp8QggxQSBkAcuvb5QKHyIYK/vZAoDka0HLbCXN3jw0iy454aNIf/2HHm0geZZd8Yu8ge2bAEaAJiWgKIAWDkwZ/CRYzhreLBgWdOZFReuuejo5RIhvNwLOk51lWQGg+0Ii6yF8VB/6jOUJdwEhwqE3Od9sHl14eQBGwAAAAJTcJsvAhoAArJRAxoBDHzCCACiAIKCWCBOK9nJ9IxJt2gddyZ2fUHC4nre84+EbPQdL60OP0m4ZlhA11gVIBWSlDZl8NQyzV4v9U8AuX8n2UqJK9+Wt1sqnM7jAeYtbuyAN5weTaVV+NDVlpKVg3piowyC1eqZBeWWAYJYIKRn9pUgwcx7GBoIBVJd+9Gh8I/YOwFFK7KyXUXSfrWnWEAqOkD9ljkgYwqwPpuxV+4iJw0hf4PPXA7o9XVxZ4wqT6vSnu1hvsyM4ezuCP/ahTMQ7RzZHTLa1BDx6YawGHQHAYGCAYKCAFgciTss5ZpPDifzTTlpVVbNSaZGERzre1z05XYVWYIAWBzHmpkAwWCRnUTfcTy0aZK2LLLM36Y/4gZMlJhm9fY=&quot;
</code></pre>
<h5 id="submission"><a class="header" href="#submission">Submission</a></h5>
<p>The transaction is now fully-signed by both co-owners: &quot;<code>Cosigner#0</code>&quot; and &quot;<code>Cosigner#1</code>&quot;. At this point, either of them can submit it to the network using their respective wallets via the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-submit</code></a> endpoint.</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/shared-wallets/5e46668c320bb4568dd25551e0c33b0539668aa8/transactions-submit \
-d '{
   &quot;transaction&quot;:&quot;hKUAgYJYIP8Fwso5i5ovF8bJJuqZ4xOdvXC3mXJCN2O2vDIxQQOYAAGCogBYOQAPoKBp8QggxQSBkAcuvb5QKHyIYK/vZAoDka0HLbCXN3jw0iy454aNIf/2HHm0geZZd8Yu8ge2bAEaAJiWgKIAWDkwZ/CRYzhreLBgWdOZFReuuejo5RIhvNwLOk51lWQGg+0Ii6yF8VB/6jOUJdwEhwqE3Od9sHl14eQBGwAAAAJTcJsvAhoAArJRAxoBDHzCCACiAIKCWCBOK9nJ9IxJt2gddyZ2fUHC4nre84+EbPQdL60OP0m4ZlhA11gVIBWSlDZl8NQyzV4v9U8AuX8n2UqJK9+Wt1sqnM7jAeYtbuyAN5weTaVV+NDVlpKVg3piowyC1eqZBeWWAYJYIKRn9pUgwcx7GBoIBVJd+9Gh8I/YOwFFK7KyXUXSfrWnWEAqOkD9ljkgYwqwPpuxV+4iJw0hf4PPXA7o9XVxZ4wqT6vSnu1hvsyM4ezuCP/ahTMQ7RzZHTLa1BDx6YawGHQHAYGCAYKCAFgciTss5ZpPDifzTTlpVVbNSaZGERzre1z05XYVWYIAWBzHmpkAwWCRnUTfcTy0aZK2LLLM36Y/4gZMlJhm9fY=&quot;
}' \
-H &quot;Content-Type: application/json&quot; | jq

{
  &quot;id&quot;: &quot;d443719bbd3e4301aa34791823b2b7821757e843509d29918006e5ca26ca368c&quot;
}
</code></pre>
<p>The transaction has been submitted successfully. The <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitSharedTransaction"><code>POST /shared-wallets/{walletId}/transactions-submit</code></a> endpoint provides a transaction identifier in its response.</p>
<p>We can use this transaction identifier to look up the transaction from either shared wallet using the <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/listSharedTransactions"><code>GET /shared-wallets/{walletId}/transactions</code></a> or <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getSharedTransaction"><code>GET /shared-wallets/{walletId}/transactions/{transactionId}</code></a> endpoints.</p>
<p>&quot;<code>Cosigner#0</code> wallet&quot;:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/shared-wallets/2a0ebd0cceab2161765badf2e389b26e0961de2f/transactions/d443719bbd3e4301aa34791823b2b7821757e843509d29918006e5ca26ca368c | jq

{
  &quot;amount&quot;: {
    &quot;quantity&quot;: 10176721,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
  ...
  &quot;direction&quot;: &quot;outgoing&quot;,
  ...
  &quot;fee&quot;: {
    &quot;quantity&quot;: 176721,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
...
</code></pre>
<p>&quot;<code>Cosigner#1</code> wallet&quot;:</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/shared-wallets/5e46668c320bb4568dd25551e0c33b0539668aa8/transactions/d443719bbd3e4301aa34791823b2b7821757e843509d29918006e5ca26ca368c | jq

{
  &quot;amount&quot;: {
    &quot;quantity&quot;: 10176721,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
  ...
  &quot;direction&quot;: &quot;outgoing&quot;,
  ...
  &quot;fee&quot;: {
    &quot;quantity&quot;: 176721,
    &quot;unit&quot;: &quot;lovelace&quot;
  },
...
</code></pre>
<h3 id="delegation"><a class="header" href="#delegation">Delegation</a></h3>
<p>Delegation of shared wallets will be supported <em>soon</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>There are a number of ways to obtain cardano-wallet.</p>
<h2 id="daedalus-installer"><a class="header" href="#daedalus-installer">Daedalus installer</a></h2>
<p>The <code>cardano-wallet</code> backend is included in the <a href="https://daedaluswallet.io">Daedalus</a> installation. This is convenient if you already have Daedalus installed, but the version of <code>cardano-wallet</code> may not be the latest.</p>
<h2 id="pre-built-binaries-from-github-release-page"><a class="header" href="#pre-built-binaries-from-github-release-page">Pre-built binaries from GitHub release page</a></h2>
<p>Release builds of <code>cardano-wallet</code> for Linux, macOS, and Windows are available at:
https://github.com/cardano-foundation/cardano-wallet/releases</p>
<p>These release bundles include the recommended version of <code>cardano-node</code>, according to the <a href="https://github.com/cardano-foundation/cardano-wallet#latest-releases">release matrix</a>.</p>
<h3 id="direct-download-urls"><a class="header" href="#direct-download-urls">Direct download URLS</a></h3>
<p>The release packages can be downloaded directly from the github servers using a command-line tool like <code>wget</code> or <code>cURL</code>. For example, one can download and unpack a pre-packaged linux binary for <code>cardano-wallet@v2020-04-07</code> with:</p>
<pre><code>&gt; curl -L https://github.com/cardano-foundation/cardano-wallet/releases/download/v2020-04-07/cardano-wallet-v2020-04-07-linux64.tar.gz | tar xvz
</code></pre>
<h2 id="docker"><a class="header" href="#docker">Docker</a></h2>
<p>See <a href="user/installation/use-docker.html">Docker</a>.</p>
<h2 id="nixnixos"><a class="header" href="#nixnixos">Nix/NixOS</a></h2>
<p>See <a href="user/installation/use-nixos.html">NixOS</a>.</p>
<h2 id="compile-from-source"><a class="header" href="#compile-from-source">Compile from source</a></h2>
<p>See <a href="user/../developer-guide/building.html">Building</a>.</p>
<p>If you feel brave enough and want to compile everything from sources, please refer to
<a href="user/../developer-guide/building.html">Building</a>
, or the equivalent documentation in each source repository (instructions often appear in <code>README.md</code>).</p>
<p>As a pre-requisite, you may want to install and configure <a href="https://nixos.org/">Nix</a> or <a href="https://www.haskell.org/cabal/">cabal</a>, depending on your weapon of choice.</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Repository</th><th>Releases</th><th>Linux</th><th>MacOS</th><th>Windows</th></tr></thead><tbody>
<tr><td><a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a></td><td><a href="https://github.com/IntersectMBO/cardano-node/releases">releases</a></td><td>✔️</td><td>✔️</td><td>✔️</td></tr>
<tr><td><a href="https://github.com/IntersectMBO/cardano-db-sync">cardano-db-sync</a></td><td><a href="https://github.com/IntersectMBO/cardano-db-sync/releases">releases</a></td><td>✔️</td><td>✔️</td><td>❌</td></tr>
<tr><td><a href="https://github.com/IntersectMBO/cardano-node/tree/master/cardano-submit-api">cardano-submit-api</a></td><td><a href="https://github.com/IntersectMBO/cardano-node/releases">releases</a></td><td>✔️</td><td>✔️</td><td>❌</td></tr>
<tr><td><a href="https://github.com/cardano-foundation/cardano-graphql">cardano-graphql</a></td><td><a href="https://github.com/cardano-foundation/cardano-graphql/releases">releases</a></td><td>✔️</td><td>✔️</td><td>❌</td></tr>
<tr><td><a href="https://github.com/input-output-hk/cardano-rosetta">cardano-rosetta</a></td><td><a href="https://github.com/input-output-hk/cardano-rosetta/releases">releases</a></td><td>✔️</td><td>✔️</td><td>❌</td></tr>
<tr><td><a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a></td><td><a href="https://github.com/cardano-foundation/cardano-wallet/releases">releases</a></td><td>✔️</td><td>✔️</td><td>✔️</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="running-with-docker"><a class="header" href="#running-with-docker">Running with Docker</a></h1>
<p>Docker images are continuously built and deployed on <a href="https://hub.docker.com/u/cardanofoundation">dockerhub</a> under specific tags. Using docker provides <strong>the fastest</strong> and <strong>easiest</strong> user experience for setting up the Cardano stack. You should prefer this solution over building from sources unless you have really good reasons not to. The following images are available for each component of the Adrestia architecture:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Repository</th><th style="text-align: center">Tags</th><th style="text-align: center">Documentation</th></tr></thead><tbody>
<tr><td style="text-align: left"><a href="https://hub.docker.com/r/inputoutput/cardano-node">inputoutput/cardano-node</a></td><td style="text-align: center"><code>master</code>, <code>MAJ.MIN.PATCH</code>, <code>latest</code></td><td style="text-align: center"><a href="https://github.com/IntersectMBO/cardano-node/blob/master/nix/docker.nix#L1-L25">link</a></td></tr>
<tr><td style="text-align: left">[cardanofoundation/cardano-wallet][cardanofoundation-cardano-wallet]</td><td style="text-align: center"><code>byron</code>, <code>YYYY.MM.DD-byron</code>, <code>latest</code></td><td style="text-align: center"><a href="user/installation/use-docker.html">Docker</a></td></tr>
</tbody></table>
</div>
<h2 id="tag-naming-scheme"><a class="header" href="#tag-naming-scheme">Tag Naming Scheme</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Tag</th><th>Contents</th></tr></thead><tbody>
<tr><td><code>latest</code></td><td>Points to the latest <strong>stable</strong> image for the corresponding component. This is also the tag to which <code>docker</code> defaults when pulling without an explicit tag. These typically points to latest known release which happens at the end of an iteration cycle. Depending on which project / component, the iteration cycle may vary from 1 to 2 weeks.</td></tr>
<tr><td><code>MAJ.MIN.PATCH</code> or <code>YYYY.MM.DD</code></td><td>Must match actual releases of the corresponding component. Refer to each component release notes to know which release tags are available.</td></tr>
<tr><td><code>master</code></td><td>Points to the very tip of the development branch. This is therefore <strong>not recommended</strong> for production but can be useful to try out features before they are officially released.</td></tr>
</tbody></table>
</div>
<h3 id="examples-1"><a class="header" href="#examples-1">Examples</a></h3>
<p>For example, in order to use <code>cardano-node@1.10.0</code>, one can simply run:</p>
<pre><code>&gt; docker pull inputoutput/cardano-node:1.10.0
</code></pre>
<p>Similarly, one can pull <code>cardano-wallet@v2021-08-11</code> with:</p>
<pre><code>&gt; docker pull cardanofoundation/cardano-wallet:2021.8.11
</code></pre>
<h3 id="about-version-compatibility"><a class="header" href="#about-version-compatibility">About version compatibility</a></h3>
<p>For version compatibility between components, please refer to compatibility matrix on each component main page
(e.g. <a href="https://github.com/cardano-foundation/cardano-wallet#latest-releases">cardano-wallet</a>).</p>
<h2 id="downloading-the-docker-image"><a class="header" href="#downloading-the-docker-image">Downloading the Docker image</a></h2>
<p>To get the latest release of <code>cardano-wallet</code>, run:</p>
<pre><code>docker pull cardanofoundation/cardano-wallet:latest
</code></pre>
<h2 id="running-the-docker-container-for-cardano-wallet"><a class="header" href="#running-the-docker-container-for-cardano-wallet">Running the Docker container for cardano-wallet</a></h2>
<p>To run basic CLI commands, use:</p>
<pre><code>&gt; docker run --rm cardanofoundation/cardano-wallet:latest --help
</code></pre>
<p>See <a href="user/installation/../cli.html">cli</a>
for full documentation of the CLI.</p>
<h2 id="building-the-docker-image-locally"><a class="header" href="#building-the-docker-image-locally">Building the Docker image locally</a></h2>
<p>Ensure that you have Nix installed and the IOHK binary cache enabled
(<a href="https://github.com/input-output-hk/iohk-nix/blob/master/docs/nix.md">instructions</a>).</p>
<p>Then run this command from the <code>cardano-wallet</code> git repo:</p>
<pre><code>&gt; docker load -i $(nix build --json .#dockerImage | jq -r '.[0].outputs.out')
</code></pre>
<p>If you have no local changes, the build should be downloaded from
the <a href="https://hydra.iohk.io/job/Cardano/cardano-wallet/native.dockerImage.shelley.x86_64-linux">IOHK binary cache</a>
then loaded into your local Docker image storage.</p>
<h2 id="inspecting-the-contents-of-the-docker-image"><a class="header" href="#inspecting-the-contents-of-the-docker-image">Inspecting the contents of the Docker image</a></h2>
<p>The default entrypoint of the image is
<code>/bin/start-cardano-wallet-shelley</code>. If you need to run a shell
inside the Docker image, use the bash shell as the entrypoint:</p>
<pre><code>&gt; docker run --rm -it --entrypoint bash cardanofoundation/cardano-wallet:latest
</code></pre>
<h2 id="docker-compose"><a class="header" href="#docker-compose">Docker compose</a></h2>
<p>One can also use <a href="https://docs.docker.com/compose/">docker-compose</a> to quickly spin up <code>cardano-wallet</code> together with supported block producer. Those are useful for a quick start or as a baseline for development.</p>
<p><a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/docker-compose.yml">cardano-wallet/docker-compose.yml</a> is an example <code>docker-compose.yaml</code> combining the latest versions of <code>cardano-wallet</code> and <code>cardano-node</code>.</p>
<p>To give it a spin, simply launch:</p>
<pre><code>wget https://raw.githubusercontent.com/cardano-foundation/cardano-wallet/master/docker-compose.yml
NETWORK=mainnet docker-compose up
</code></pre>
<p>There is also an example configuration for <a href="https://github.com/cardano-foundation/cardano-graphql/blob/master/docker-compose.yml">cardano-graphql</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-cardano-wallet-with-nixos"><a class="header" href="#running-cardano-wallet-with-nixos">Running cardano-wallet with NixOS</a></h1>
<h2 id="running-without-installation"><a class="header" href="#running-without-installation">Running without installation</a></h2>
<p>The following command will download and run a given release of <code>cardano-wallet</code> using Nix:</p>
<pre><code class="language-console">&gt; nix run github:cardano-foundation/cardano-wallet/v2022-01-18 -- version
v2022-01-18 (git revision: ce772ff33623e2a522dcdc15b1d360815ac1336a)
</code></pre>
<p>It's also possible to run the very latest version from the master branch on GitHub:</p>
<pre><code class="language-console">&gt; nix run github:cardano-foundation/cardano-wallet -- --help
...
</code></pre>
<h3 id="wrapper-script-with-pre-configured-network-settings"><a class="header" href="#wrapper-script-with-pre-configured-network-settings">Wrapper script with pre-configured network settings</a></h3>
<p>To run a wallet on <em>mainnet</em>:</p>
<pre><code class="language-console">&gt; CARDANO_NODE_SOCKET_PATH=../cardano-node/node.socket

&gt; nix run github:cardano-foundation/cardano-wallet#mainnet/wallet
</code></pre>
<h2 id="installing-into-user-profile"><a class="header" href="#installing-into-user-profile">Installing into user profile</a></h2>
<pre><code>&gt; nix profile install github:cardano-foundation/cardano-wallet/v2022-01-18
&gt; cardano-wallet version
v2022-01-18 (git revision: ce772ff33623e2a522dcdc15b1d360815ac1336a)
</code></pre>
<h2 id="nixos-module"><a class="header" href="#nixos-module">NixOS Module</a></h2>
<p>A nixos service definition for cardano-wallet server is available by importing the flake <code>nixosModule</code> attribute into your nixos configuration. Or by importing <a href="https://github.com/cardano-foundation/cardano-wallet/tree/master/nix/nixos"><code>nix/nixos</code></a>.</p>
<p>Then <code>cardano-wallet</code> server can then be activated and configured:</p>
<pre><code class="language-nix">{
  description = &quot;Flake example with cardano-wallet NixOS module&quot;;
  inputs.cardano-wallet.url = github:cardano-foundation/cardano-wallet;
  outputs = { self, cardano-wallet }@inputs: {
    nixosModules.example = { config, ...}: {
      imports = [
        inputs.cardano-wallet.nixosModule
      ];
      services.config.cardano-wallet = {
        enable = true;
        walletMode = &quot;mainnet&quot;;
        nodeSocket = config.services.cardano-node.socketPath;
        poolMetadataFetching = {
          enable = true;
          smashUrl = &quot;https://smash.cardano-mainnet.iohk.io&quot;;
        };
        tokenMetadataServer = &quot;https://tokens.cardano.org&quot;;
      };
    };
  };
}
</code></pre>
<p>See <a href="https://github.com/cardano-foundation/cardano-wallet/tree/master/nix/nixos/cardano-wallet-service.nix"><code>nix/nixos/cardano-wallet-service.nix</code></a> for the other configuration options (such as the <code>genesisFile</code> option to run cardano-wallet on a testnet) and complete documentation.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="command-line-interface"><a class="header" href="#command-line-interface">Command-Line Interface</a></h1>
<p>The CLI is a proxy to the wallet server, which is required for most commands. Commands are turned into corresponding API calls, and submitted to an up-and-running server. Some commands do not require an active server and can be run &quot;offline&quot;. (e.g. <code>recovery-phrase generate</code>)</p>
<p>The wallet command-line interface (abbrev. CLI) is a tool that provides a convenient way of using the cardano-wallet HTTP Application Programming Interface (abbrev. API). The wallet API is an HTTP service used to manage wallets, make payments, and update wallet data such as addresses and keys, for instance. The wallet CLI can start the wallet server, or run a number of commands on a running server, and supports most functions of the API itself.</p>
<p>The intended audience of the CLI are users who run a wallet API server outside of Daedalus and work with the cardano-wallet API directly - these include application developers, stake pool operators, and exchanges.</p>
<p>CLI commands allow you to make and track changes while maintaining the wallet API. The wallet CLI converts commands into corresponding API calls, submits them to a running server and display the server's responses in a readable way into the terminal.</p>
<h2 id="pre-requisites-9"><a class="header" href="#pre-requisites-9">Pre-Requisites</a></h2>
<ul>
<li><a href="user/common-use-cases/start-wallet-server.html">how to start a server</a></li>
</ul>
<h2 id="how-to-run"><a class="header" href="#how-to-run">How to Run</a></h2>
<p>You can explore the wallet CLI with:</p>
<pre><code class="language-console">&gt; cardano-wallet --help
</code></pre>
<p>Then, you can use a list of commands for various purposes, such as:</p>
<ul>
<li>list, create, update, or delete wallets</li>
<li>create, submit, forget, or track fees in regards to transactions</li>
<li>list, create, and import wallet addresses</li>
<li>view network information and parameters</li>
<li>manage private and public keys</li>
</ul>
<p>Each sub-command will also provide some additional help when passed <code>--help</code>. For example:</p>
<pre><code class="language-console">&gt; cardano-wallet transaction --help
</code></pre>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<pre><code class="language-console">&gt; cardano-wallet --help
</code></pre>
<div id="admonition-warning" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="user/cli.html#admonition-warning"></a></p>
</div>
<div>
<p>The CLI commands for <code>wallet</code>, <code>transaction</code> and <code>address</code> only output valid JSON on <code>stdout</code>. So you may redirect the output to a file with <code>&gt;</code> or pipe it into utility software like <code>jq</code>!</p>
</div>
</div>
<h3 id="serve"><a class="header" href="#serve">serve</a></h3>
<p>Serve API that listens for commands/actions. Before launching user should start <a href="https://github.com/IntersectMBO/cardano-node"><code>cardano-node</code></a>.</p>
<pre><code class="language-console">Usage: cardano-wallet serve [--listen-address HOST]
                            (--node-socket FILE [--sync-tolerance DURATION])
                            [--random-port | --port INT]
                            [--tls-ca-cert FILE --tls-sv-cert FILE
                              --tls-sv-key FILE]
                            (--mainnet | --testnet FILE )
                            [--database DIR] [--shutdown-handler]
                            [--pool-metadata-fetching ( none | direct | SMASH-URL )]
                            [--token-metadata-server URL]
                            [--trace-NAME SEVERITY]

  Serve API that listens for commands/actions.

Available options:
  -h,--help                Show this help text
  --help-tracing           Show help for tracing options
  --listen-address HOST    Specification of which host to bind the API server
                           to. Can be an IPv[46] address, hostname, or '*'.
                           (default: 127.0.0.1)
  --node-socket FILE       Path to the node's domain socket file (POSIX) or pipe
                           name (Windows). Note: Maximum length for POSIX socket
                           files is approx. 100 bytes. Note: Windows named pipes
                           are of the form \\.\pipe\cardano-node
  --sync-tolerance DURATION
                           time duration within which we consider being synced
                           with the network. Expressed in seconds with a
                           trailing 's'. (default: 300s)
  --random-port            serve wallet API on any available port (conflicts
                           with --port)
  --port INT               port used for serving the wallet API. (default: 8090)
  --tls-ca-cert FILE       A x.509 Certificate Authority (CA) certificate.
  --tls-sv-cert FILE       A x.509 Server (SV) certificate.
  --tls-sv-key FILE        The RSA Server key which signed the x.509 server
                           certificate.
  --mainnet                Use Cardano mainnet protocol
  --testnet FILE           Path to the byron genesis data in JSON format.
  --database DIR           use this directory for storing wallets. Run in-memory
                           otherwise.
  --shutdown-handler       Enable the clean shutdown handler (exits when stdin
                           is closed)
  --pool-metadata-fetching ( none | direct | SMASH-URL )
                           Sets the stake pool metadata fetching strategy.
                           Provide a URL to specify a SMASH metadata proxy
                           server, use &quot;direct&quot; to fetch directly from the
                           registered pool URLs, or &quot;none&quot; to completely disable
                           stake pool metadata. The initial setting is &quot;none&quot;
                           and changes by either this option or the API will
                           persist across restarts.
  --token-metadata-server URL
                           Sets the URL of the token metadata server. If unset,
                           metadata will not be fetched. By using this option,
                           you are fully trusting the operator of the metadata
                           server to provide authentic token metadata.
  --log-level SEVERITY     Global minimum severity for a message to be logged.
                           Individual tracers severities still need to be
                           configured independently. Defaults to &quot;DEBUG&quot;.
  --trace-NAME SEVERITY    Individual component severity for 'NAME'. See
                           --help-tracing for details and available tracers.
</code></pre>
<h4 id="minimal-arguments"><a class="header" href="#minimal-arguments">Minimal Arguments</a></h4>
<div id="admonition-info" class="admonition info">
<div class="admonition-title">
<p>Info</p>
<p><a class="admonition-anchor-link" href="user/cli.html#admonition-info"></a></p>
</div>
<div>
<p>More information on starting the wallet server can be found in <a href="user/common-use-cases/start-wallet-server.html">Start a server</a>.</p>
</div>
</div>
In order to start the wallet server, you'll need to provide _at least_ the path to cardano-node's socket/pipe and a target network. That socket is automatically created when starting a cardano-node and it exists so long as the node remains running.
<p>We also recommend to pass a <code>--database</code> option pointing to a directory on the file-system; without this option, the wallet will maintain a state in-memory which will vanish once stopped.</p>
<h4 id="runtime-flags"><a class="header" href="#runtime-flags">Runtime flags</a></h4>
<p>By default, the wallet runs <strong>on a single core</strong> which is sufficient for most 'normal users'. Application running larger wallets like exchanges should configure the server to use multiple cores for some database blocking operations may have a visible negative effect on the overall server behavior. This can be achieved by providing specific runtime flags to the serve command delimited by <code>+RTS &lt;flags&gt; -RTS</code>. To configure the how much cores are available to the server, use the <code>-N</code> flag. For example, to configure 2 cores do:</p>
<pre><code class="language-console">&gt; cardano-wallet serve ... +RTS -N2 -RTS
</code></pre>
<p>Using <code>+RTS -N4 -RTS</code> will tell the server to use 4 cores. Note that there's little performance benefits between 2 and 4 cores for server running a single wallet, but there are visible performance improvements from 1 to 2.</p>
<h4 id="domain-socketnamed-pipe"><a class="header" href="#domain-socketnamed-pipe">Domain socket/named pipe</a></h4>
<p>On POSIX systems (i.e. Linux and macOS), a <a href="https://en.wikipedia.org/wiki/Unix_domain_socket">UNIX domain socket</a> is used for communication between the cardano-wallet and cardano-node processes.</p>
<p>On these systems, the <code>--node-socket</code> argument must be a path to a socket file. Note that there is a limitation on socket path lengths of about 100 characters or so.</p>
<p>On Windows systems, a <a href="https://en.wikipedia.org/wiki/Named_pipe#In_Windows">Named Pipe</a> is used instead.</p>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/ipc/named-pipes">Windows Named Pipes</a> do not have filenames. So on Windows systems, the <code>--node-socket</code> argument must be a pipe name. Pipe names are a string of the form <code>\\.\pipe\name</code>. For example, <code>\\.\pipe\cardano-wallet</code>.</p>
<h4 id="examples-2"><a class="header" href="#examples-2">Examples</a></h4>
<h5 id="mainnet"><a class="header" href="#mainnet">Mainnet</a></h5>
<pre><code class="language-console">&gt; cardano-wallet serve \
  --mainnet \
  --node-socket CARDANO_NODE_SOCKET_PATH_OR_PIPE \
  --database ./wallets-mainnet
</code></pre>
<h5 id="testnet"><a class="header" href="#testnet">Testnet</a></h5>
<p>Note that for testnets, a <em>byron</em> genesis file is required (see <a href="user/cli.html#pre-requisites">pre-requisites</a>), even though the network is in the shelley era. This is because the chain is
synced from the beginning of the first era.</p>
<pre><code class="language-console">&gt; cardano-wallet serve \
  --testnet testnet-byron-genesis.json \
  --node-socket CARDANO_NODE_SOCKET_PATH_OR_PIPE \
  --database ./wallets-testnet
</code></pre>
<h4 id="metadata"><a class="header" href="#metadata">Metadata</a></h4>
<p>For the wallet to show stake pool metadata, you need to set <code>--pool-metadata-fetching ( none | direct | SMASH-URL )</code>. And for the wallet to show token metadata, you need to set <code>--token-metadata-server URL</code>.</p>
<h4 id="logging-options-for-serve"><a class="header" href="#logging-options-for-serve">Logging options for serve</a></h4>
<p><code>serve</code> accepts extra command-line arguments for logging (also called &quot;tracing&quot;). Use <code>--help-tracing</code> to show the
options, the tracer names, and the possible log levels.</p>
<pre><code class="language-console">&gt; cardano-wallet serve --help-tracing

Additional tracing options:

  --log-level SEVERITY     Global minimum severity for a message to be logged.
                           Defaults to &quot;DEBUG&quot; unless otherwise configured.
  --trace-NAME=off         Disable logging on the given tracer.
  --trace-NAME=SEVERITY    Set the minimum logging severity for the given
                           tracer. Defaults to &quot;INFO&quot;.

The possible log levels (lowest to highest) are:
  debug info notice warning error critical alert emergency

The possible tracers are:
  application    About start-up logic and the server's surroundings.
  api-server     About the HTTP API requests and responses.
  wallet-engine  About background wallet workers events and core wallet engine.
  wallet-db      About database operations of each wallet.
  pools-engine   About the background worker monitoring stake pools and stake pools engine.
  pools-db       About database operations on stake pools.
  ntp-client     About ntp-client.
  network        About network communication with the node.

</code></pre>
<h5 id="example"><a class="header" href="#example">example</a></h5>
<p>Use these options to enable debug-level tracing for certain components
of the wallet. For example, to log all database queries for the wallet
databases, use:</p>
<pre><code class="language-console">&gt; cardano-wallet serve --trace-wallet-db=debug ...
</code></pre>
<h3 id="recovery-phrase-generate"><a class="header" href="#recovery-phrase-generate">recovery-phrase generate</a></h3>
<pre><code class="language-console">&gt; cardano-wallet recovery-phrase generate [--size=INT]
</code></pre>
<p>Generates an English recovery phrase.</p>
<pre><code class="language-console">&gt; cardano-wallet recovery-phrase generate
</code></pre>
<p>These words will be used to create a wallet later. You may also ask for a specific number of words using the <code>--size</code> option:</p>
<pre><code class="language-console">&gt; cardano-wallet recovery-phrase generate --size 21
</code></pre>
<h3 id="wallet-list"><a class="header" href="#wallet-list">wallet list</a></h3>
<pre><code class="language-console">&gt; cardano-wallet wallet list [--port=INT]
</code></pre>
<p>Lists all your wallets:</p>
<pre><code class="language-console">&gt; cardano-wallet wallet list
</code></pre>
<h3 id="wallet-create-from-recovery-phrase"><a class="header" href="#wallet-create-from-recovery-phrase">wallet create from recovery-phrase</a></h3>
<pre><code class="language-console">&gt; cardano-wallet wallet create from-recovery-phrase [--port=INT] &lt;name&gt; [--address-pool-gap=INT]
</code></pre>
<p>Create a new wallet using a sequential address scheme. This is an interactive command that will prompt you for recovery-phrase words and password.</p>
<pre><code class="language-console">&gt; cardano-wallet wallet create &quot;My Wallet&quot;
Please enter a 15–24 word recovery-phrase sentence: &lt;enter generated recovery-phrase here&gt;
(Enter a blank line if you do not wish to use a second factor.)
Please enter a 9–12 word recovery-phrase second factor: &lt;skip or enter new recovery-phrase here&gt;
Please enter a passphrase: ****************
Enter the passphrase a second time: ****************
</code></pre>
<p>after this your new wallet will be created</p>
<h3 id="wallet-get"><a class="header" href="#wallet-get">wallet get</a></h3>
<pre><code class="language-console">&gt; cardano-wallet wallet get [--port=INT] WALLET_ID
</code></pre>
<p>Fetches the wallet with specified wallet id:</p>
<pre><code class="language-console">&gt; cardano-wallet wallet get 2512a00e9653fe49a44a5886202e24d77eeb998f
</code></pre>
<h3 id="wallet-utxo"><a class="header" href="#wallet-utxo">wallet utxo</a></h3>
<pre><code class="language-console">&gt; cardano-wallet wallet utxo [--port=INT] WALLET_ID
</code></pre>
<p>Visualize a wallet's UTxO distribution in the form of an histrogram with a logarithmic scale.
The distribution's data is returned by the API in a JSON format, e.g.:</p>
<pre><code class="language-json">{
  &quot;distribution&quot;: {
      &quot;10&quot;: 1,
      &quot;100&quot;: 0,
      &quot;1000&quot;: 8,
      &quot;10000&quot;: 14,
      &quot;100000&quot;: 32,
      &quot;1000000&quot;: 3,
      &quot;10000000&quot;: 0,
      &quot;100000000&quot;: 12,
      &quot;1000000000&quot;: 0,
      &quot;10000000000&quot;: 0,
      &quot;100000000000&quot;: 0,
      &quot;1000000000000&quot;: 0,
      &quot;10000000000000&quot;: 0,
      &quot;100000000000000&quot;: 0,
      &quot;1000000000000000&quot;: 0,
      &quot;10000000000000000&quot;: 0,
      &quot;45000000000000000&quot;: 0
  }
}
</code></pre>
<p>which could be plotted as:</p>
<pre><code>    │
100 ─
    │
    │                                 ┌───┐
 10 ─                         ┌───┐   │   │                   ┌───┐
    │                 ┌───┐   │   │   │   │                   │   │
    │                 │   │   │   │   │   │   ┌───┐           │   │
  1 ─ ┌───┐           │   │   │   │   │   │   │   │           │   │
    │ │   │           │   │   │   │   │   │   │   │           │   │
    │ │   │ │       │ │   │ │ │   │ ╷ │   │ ╷ │   │ ╷       ╷ │   │      ╷
    └─┘   └─│───────│─┘   └─│─┘   └─│─┘   └─│─┘   └─│───────│─┘   └──────│────────────
          10μ₳    100μ₳   1000μ₳   0.1₳    1₳      10₳     100₳        1000₳
</code></pre>
<h3 id="wallet-utxo-snapshot"><a class="header" href="#wallet-utxo-snapshot">wallet utxo-snapshot</a></h3>
<pre><code class="language-console">&gt; cardano-wallet wallet utxo-snapshot [--port INT] WALLET_ID
</code></pre>
<p>Gets a snapshot of the wallet's entire UTxO set, in JSON format.</p>
<p>Each entry in the list contains the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ada</code></td><td>the actual ada quantity of this UTxO entry</td></tr>
<tr><td><code>ada_minimum</code></td><td>the minimum ada quantity permitted by the protocol</td></tr>
<tr><td><code>assets</code></td><td>quantities of all other assets included in this UTxO entry</td></tr>
</tbody></table>
</div>
<pre><code class="language-json">{
    &quot;entries&quot;: [
        {
            &quot;ada_minimum&quot;: {
                &quot;quantity&quot;: 1666665,
                &quot;unit&quot;: &quot;lovelace&quot;
            },
            &quot;ada&quot;: {
                &quot;quantity&quot;: 15582575,
                &quot;unit&quot;: &quot;lovelace&quot;
            },
            &quot;assets&quot;: [
                {
                    &quot;asset_name&quot;: &quot;&quot;,
                    &quot;quantity&quot;: 1503,
                    &quot;policy_id&quot;: &quot;789ef8ae89617f34c07f7f6a12e4d65146f958c0bc15a97b4ff169f1&quot;
                },
                {
                    &quot;asset_name&quot;: &quot;4861707079436f696e&quot;,
                    &quot;quantity&quot;: 4958,
                    &quot;policy_id&quot;: &quot;919e8a1922aaa764b1d66407c6f62244e77081215f385b60a6209149&quot;
                }
            ]
        },
        ...
    ]
}
</code></pre>
<blockquote>
<p>⚠ This endpoint was intended to be used for debugging purposes. The output format is subject to change at any time.</p>
</blockquote>
<h3 id="wallet-update-name"><a class="header" href="#wallet-update-name">wallet update name</a></h3>
<pre><code class="language-console">&gt; cardano-wallet wallet update name [--port=INT] WALLET_ID STRING
</code></pre>
<p>Updates name of a wallet given wallet id:</p>
<pre><code>&gt; cardano-wallet wallet update name 2512a00e9653fe49a44a5886202e24d77eeb998f NewName
</code></pre>
<h3 id="wallet-update-passphrase"><a class="header" href="#wallet-update-passphrase">wallet update passphrase</a></h3>
<pre><code>&gt; cardano-wallet wallet update passphrase [--port=INT] WALLET_ID
</code></pre>
<p>Interactive prompt to update the wallet master's passphrase (old passphrase required).</p>
<pre><code class="language-console">&gt; cardano-wallet wallet update passphrase 2512a00e9653fe49a44a5886202e24d77eeb998f
Please enter your current passphrase: **********
Please enter a new passphrase: **********
Enter the passphrase a second time: **********
</code></pre>
<h3 id="wallet-delete"><a class="header" href="#wallet-delete">wallet delete</a></h3>
<pre><code>&gt; cardano-wallet wallet delete [--port=INT] WALLET_ID
</code></pre>
<p>Deletes wallet with specified wallet id:</p>
<pre><code class="language-console">&gt; cardano-wallet wallet delete 2512a00e9653fe49a44a5886202e24d77eeb998f
</code></pre>
<h3 id="transaction-create"><a class="header" href="#transaction-create">transaction create</a></h3>
<pre><code>&gt; cardano-wallet transaction create [--port=INT] WALLET_ID [--metadata=JSON] [--ttl=SECONDS] --payment=PAYMENT...
</code></pre>
<p>Creates and submits a new transaction:</p>
<pre><code class="language-console">&gt; cardano-wallet transaction create 2512a00e9653fe49a44a5886202e24d77eeb998f \
    --payment 22@Ae2tdPwUPEZ...nRtbfw6EHRv1D \
    --payment 5@Ae2tdPwUPEZ7...pVwEPhKwseVvf \
    --metadata '{ &quot;0&quot;:{ &quot;string&quot;:&quot;cardano&quot; } }'
</code></pre>
<p>This creates a transaction that sends 22 lovelace to <code>Ae2tdPwUPEZ...nRtbfw6EHRv1D</code> and 5 lovelace to <code>Ae2tdPwUPEZ7...pVwEPhKwseVvf</code> from wallet with id 2512a00e9653fe49a44a5886202e24d77eeb998f.</p>
<p>For more information about the <code>--metadata</code> option, see <a href="user/common-use-cases/handle-metadata.html">TxMetadata</a>.</p>
<h3 id="transaction-fees"><a class="header" href="#transaction-fees">transaction fees</a></h3>
<pre><code>&gt; cardano-wallet transaction fees [--port=INT] WALLET_ID [--metadata=JSON] [--ttl=SECONDS] --payment=PAYMENT...
</code></pre>
<p>Estimates fee for a given transaction:</p>
<pre><code class="language-console">&gt; cardano-wallet transaction fees 2512a00e9653fe49a44a5886202e24d77eeb998f \
    --payment 22@Ae2tdPwUPEZ...nRtbfw6EHRv1D \
    --payment 5@Ae2tdPwUPEZ7...pVwEPhKwseVvf \
    --metadata '{ &quot;0&quot;:{ &quot;string&quot;:&quot;cardano&quot; } }'
</code></pre>
<p>This estimates fees for a transaction that sends 22 lovelace to <code>Ae2tdPwUPEZ...nRtbfw6EHRv1D</code> and 5 lovelace to <code>Ae2tdPwUPEZ7...pVwEPhKwseVvf</code> from wallet with id 2512a00e9653fe49a44a5886202e24d77eeb998f.</p>
<h3 id="transaction-list"><a class="header" href="#transaction-list">transaction list</a></h3>
<pre><code>&gt; cardano-wallet transaction list [--port INT] WALLET_ID [--start TIME] [--end TIME] [--order ORDER] [--simple-metadata] [--max_count MAX_COUNT]
</code></pre>
<p>List the transactions associated with a wallet.</p>
<pre><code>&gt; cardano-wallet transaction list 2512a00e9653fe49a44a5886202e24d77eeb998f \
    --start 2018-09-25T10:15:00Z \
    --end 2019-11-21T10:15:00Z \
    --order ascending \
    --max_count 10
</code></pre>
<p>This lists max 10 transactions between <code>2018-09-25T10:15:00Z</code> and <code>2019-11-21T10:15:00Z</code> in <code>ascending</code> order.</p>
<h3 id="transaction-submit"><a class="header" href="#transaction-submit">transaction submit</a></h3>
<pre><code>&gt; cardano-wallet transaction submit [--port INT] BINARY_BLOB
</code></pre>
<p>Submit transaction prepared and signed outside of the wallet:</p>
<pre><code>&gt; cardano-wallet transaction submit 00bf02010200000...d21942304
</code></pre>
<p>Sends transaction identified by a hex-encoded BINARY_BLOB of externally-signed transaction.</p>
<h3 id="transaction-forget"><a class="header" href="#transaction-forget">transaction forget</a></h3>
<pre><code>&gt; cardano-wallet transaction forget [--port INT] WALLET_ID TRANSACTION_ID
</code></pre>
<p>Forget pending transaction for a given wallet:</p>
<pre><code>&gt; cardano-wallet transaction forget 2512a00e9653fe49a44a5886202e24d77eeb998f 3e6ec12da4414aa0781ff8afa9717ae53ee8cb4aa55d622f65bc62619a4f7b12
</code></pre>
<h3 id="transaction-get"><a class="header" href="#transaction-get">transaction get</a></h3>
<pre><code>&gt; cardano-wallet transaction get [--port INT] WALLET_ID TRANSACTION_ID
</code></pre>
<p>Get a transaction with the specified id:</p>
<pre><code>&gt; cardano-wallet transaction get 2512a00e9653fe49a44a5886202e24d77eeb998f 3e6ec12da4414aa0781ff8afa9717ae53ee8cb4aa55d622f65bc62619a4f7b12
</code></pre>
<h3 id="address-list"><a class="header" href="#address-list">address list</a></h3>
<pre><code>&gt; cardano-wallet address list [--port=INT] WALLET_ID [--state=STRING]
</code></pre>
<p>List all known (used or not) addresses and their corresponding status.</p>
<pre><code>&gt; cardano-wallet list addresses 2512a00e9653fe49a44a5886202e24d77eeb998f
</code></pre>
<h3 id="address-create"><a class="header" href="#address-create">address create</a></h3>
<pre><code>&gt; cardano-wallet address create [--port INT] [--address-index INDEX] WALLET_ID
</code></pre>
<p>Create new address for random wallet.</p>
<pre><code>&gt; cardano-wallet address create 03f4c150aa4626e28d02be95f31d3c79df344877
Please enter your passphrase: *****************
Ok.
{
    &quot;state&quot;: &quot;unused&quot;,
    &quot;id&quot;: &quot;2w1sdSJu3GVgr1ic6aP3CEwZo9GAhLzigdBvCGY4JzEDRbWV4HUNpZdHf2n5fV41dGjPpisDX77BztujAJ1Xs38zS8aXvN7Qxoe&quot;
}
</code></pre>
<h3 id="address-import"><a class="header" href="#address-import">address import</a></h3>
<pre><code>&gt; cardano-wallet address import [--port INT] WALLET_ID ADDRESS
</code></pre>
<p>Import address belonging to random wallet.</p>
<h3 id="network-information"><a class="header" href="#network-information">network information</a></h3>
<pre><code>&gt; cardano-wallet network information [--port=INT]
</code></pre>
<p>View network information and syncing progress between the node and the blockchain.</p>
<pre><code>&gt; cardano-wallet network information
</code></pre>
<h3 id="network-parameters"><a class="header" href="#network-parameters">network parameters</a></h3>
<pre><code>&gt; cardano-wallet network parameters [--port=INT] EPOCH_NUMBER
</code></pre>
<p>View network parameters. EPOCH_NUMBER can be <code>latest</code> or valid epoch number (not later than the current one), ie., <code>0</code>, <code>1</code>, .. .</p>
<pre><code class="language-console">&gt; cardano-wallet network parameters latest
</code></pre>
<h3 id="network-clock"><a class="header" href="#network-clock">network clock</a></h3>
<pre><code>&gt; cardano-wallet network clock
</code></pre>
<p>View <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol">NTP</a> offset for cardano-wallet server in microseconds.</p>
<pre><code>&gt; cardano-wallet network clock
Ok.
{
    &quot;status&quot;: &quot;available&quot;,
    &quot;offset&quot;: {
        &quot;quantity&quot;: -30882,
        &quot;unit&quot;: &quot;microsecond&quot;
    }
}
</code></pre>
<div id="admonition-warning-1" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="user/cli.html#admonition-warning-1"></a></p>
</div>
<div>
<p>At this stage the command is not supported on Windows platform. Invoked on Windows will return <code>status: unavailable</code> in the response message.</p>
</div>
</div>
<h3 id="key-from-recovery-phrase"><a class="header" href="#key-from-recovery-phrase">key from-recovery-phrase</a></h3>
<p>Extract the root extended private key from a recovery phrase. New recovery phrases can be generated using <a href="user/cli.html#recovery-phrase-generate"><code>recovery-phrase generate</code></a>.</p>
<pre><code>Usage: cardano-wallet key from-recovery-phrase ([--base16] | [--base58] | [--bech32]) STYLE
  Convert a recovery phrase to an extended private key

Available options:
  -h,--help                Show this help text
  STYLE                    Byron | Icarus | Jormungandr | Shelley

The recovery phrase is read from stdin.
</code></pre>
<p>Example:</p>
<pre><code class="language-console">&gt; cardano-wallet recovery-phrase generate | cardano-wallet key from-recovery-phrase Icarus
xprv12qaxje8hr7fc0t99q94jfnnfexvma22m0urhxgenafqmvw4qda0c8v9rtmk3fpxy9f2g004xj76v4jpd69a40un7sszdnw58qv527zlegvapwaee47uu724q4us4eurh52m027kk0602judjjw58gffvcqzkv2hs
</code></pre>
<h3 id="key-child"><a class="header" href="#key-child">key child</a></h3>
<p>Derive child key from root private key. The parent key is read from standard input.</p>
<pre><code>Usage: cardano-wallet key child ([--base16] | [--base58] | [--bech32]) [--legacy] DERIVATION-PATH
  Derive child keys from a parent public/private key

Available options:
  -h,--help                Show this help text
  DERIVATION-PATH          Slash-separated derivation path.
                           Hardened indexes are marked with a 'H' (e.g. 1852H/1815H/0H/0).

The parent key is read from stdin.
</code></pre>
<p>Example:</p>
<pre><code class="language-console">&gt; cardano-wallet recovery-phrase generate | cardano-wallet key from-recovery-phrase Icarus &gt; root.xprv
cat root.xprv | cardano-wallet key child 44H/1815H/0H/0
xprv13parrg5g83utetrwsp563w7hps2chu8mwcwqcrzehql67w9k73fq8utx6m8kgjlhle8claexrtcu068jgwl9zj5jyce6wn2k340ahpmglnq6x8zkt7plaqjgads0nvmj5ahav35m0ss8q95djl0dcee59vvwkaya
</code></pre>
<h3 id="key-public"><a class="header" href="#key-public">key public</a></h3>
<p>Extract the public key of an extended private key. Keys can be obtained using <a href="user/cli.html#key-from-recovery-phrase"><code>key from-recovery-phrase</code></a> and <a href="user/cli.html#key-child"><code>key child</code></a>.</p>
<pre><code>Usage: cardano-wallet-jormungandr key public ([--base16] | [--base58] | [--bech32])
  Get the public counterpart of a private key

Available options:
  -h,--help                Show this help text

The private key is read from stdin.
</code></pre>
<p>Example:</p>
<pre><code class="language-console">&gt; cardano-wallet recovery-phrase generate | cardano-wallet key from-recovery-phrase Icarus &gt; root.xprv
cat root.xprv | cardano-wallet key public
xpub1le8gm0m5cesjzzjqlza4476yncp0yk2jve7cce8ejk9cxjjdama24hudzqkrxy4daxwmlfq6ynczj338r7f5kzs43xs2fkmktekd4fgnc8q98
</code></pre>
<h3 id="key-inspect"><a class="header" href="#key-inspect">key inspect</a></h3>
<pre><code>Usage: cardano-wallet-jormungandr key inspect
  Show information about a key

Available options:
  -h,--help                Show this help text

The parent key is read from stdin.
</code></pre>
<h3 id="stake-pool-list"><a class="header" href="#stake-pool-list">stake-pool list</a></h3>
<pre><code>Usage: cardano-wallet stake-pool list [--port INT] [--stake STAKE]
  List all known stake pools.

Available options:
  -h,--help                Show this help text
  --port INT               port used for serving the wallet API. (default: 8090)
  --stake STAKE            The stake you intend to delegate, which affects the
                           rewards and the ranking of pools.
</code></pre>
<h3 id="version"><a class="header" href="#version">version</a></h3>
<pre><code>&gt; cardano-wallet version
</code></pre>
<p>Show the software version.</p>
<h2 id="bash-shell-command-completion"><a class="header" href="#bash-shell-command-completion">Bash Shell Command Completion</a></h2>
<p>:gift_heart: For bash/zsh auto-completion, put the following script in your <code>/etc/bash_completion.d</code>:</p>
<pre><code class="language-bash"># /etc/bash_completion.d/cardano-wallet.sh

_cardano-wallet()
{
   local CMDLINE
   local IFS=$'\n'
   CMDLINE=(--bash-completion-index $COMP_CWORD)

   for arg in ${COMP_WORDS[@]}; do
       CMDLINE=(${CMDLINE[@]} --bash-completion-word $arg)
   done

   COMPREPLY=( $(cardano-wallet &quot;${CMDLINE[@]}&quot;) )
}

complete -o filenames -F _cardano-wallet cardano-wallet
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="http-api-documentation"><a class="header" href="#http-api-documentation">HTTP API Documentation</a></h1>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/">Latest API docs from <code>master</code> branch</a></li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/swagger.yaml">OpenAPI specs</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="hardware-recommendations"><a class="header" href="#hardware-recommendations">Hardware recommendations</a></h2>
<p>As cardano-wallet runs side by side with cardano-node, the hardware requirements for cardano-wallet would largely depend on the hardware requirements for cardano-node. Current hardware requirements for cardano-node are published on cardano-node's <a href="https://github.com/IntersectMBO/cardano-node/releases">release page</a>. For most cases cardano-node's hardware requirements are good enough to cover requirements of running cardano-wallet as well.</p>
<p>Here are some general hardware recommendations for running cardano-wallet:</p>
<ul>
<li><strong>Processor:</strong> A multicore processor with a clock speed of at least 1.6 GHz or faster is recommended, but a faster processor is better for optimal performance.</li>
<li><strong>Memory:</strong> A minimum of 4 GB of RAM is recommended, although more is better.</li>
<li><strong>Storage:</strong> A minimum of 5 GB of free storage for wallet data is recommended.</li>
<li><strong>Network:</strong> A stable internet connection with at least 5 Mbps upload and download speeds is recommended for syncing the blockchain data and performing transactions.</li>
</ul>
<p>Again, these are general recommendations and the actual hardware requirements may vary depending on factors such as the number and size of wallets being managed and the specific usage patterns of the software. In particular the above requirements are good enough to handle fairly large wallet having <strong>15k addresses</strong> and <strong>15k transactions</strong> in history. Smaller wallets would not require as much resources but larger would require more.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="wallet-security-considerations"><a class="header" href="#wallet-security-considerations">Wallet security considerations</a></h2>
<p>The cardano-wallet HTTP service is designed to be used by trusted users only. <em>Any other use is not supported or planned</em> .</p>
<p>In order to ensure that only trusted users may access the HTTP service, cardano-wallet uses TLS client certificate authentication. For example, this is how the Daedalus wallet frontend ensures that only this frontend can access the cardano-wallet API. In other words, trust is established through a TLS client certificate. Such certificates need to be placed in the disk storage used by the cardano-wallet process before the HTTP service is started.</p>
<p>It’s worth mentioning that a trusted user can attack the wallet through the HTTP service in many ways, they can also view sensitive information, delete a wallet’s store, etc. Thus, as soon as an attacker is able to become a trusted user.</p>
<p>It’s also worth mentioning that a trusted user that can access the HTTP API is not able to spend funds of the wallet without gaining access to additional information such as the passphrase or the wallet secret key. TLS prevents eavesdropping on the passphrase, and the wallet secret key is encrypted by the passphrase.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integrations"><a class="header" href="#integrations">Integrations</a></h1>
<p>A non-exhaustive list of applications and libraries which use the <code>cardano-wallet</code> backend.</p>
<h2 id="elixir"><a class="header" href="#elixir">Elixir</a></h2>
<ul>
<li><a href="https://github.com/ricn/cardanoex"><code>ricn/cardanoex</code></a> - an Elixir library for accessing the <code>cardano-wallet</code> REST <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/">API</a>.</li>
</ul>
<h2 id="go"><a class="header" href="#go">Go</a></h2>
<ul>
<li><a href="https://github.com/echovl/cardano-go"><code>echovl/cardano-go</code></a> - a Go library for creating go applicactions that interact with the Cardano Blockchain as well as a CLI to manage Cardano Wallets.</li>
<li><a href="https://github.com/godano/cardano-wallet-client"><code>godano/cardano-wallet-client</code></a> - a Go library for accessing the <code>cardano-wallet</code> REST <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/">API</a>.</li>
</ul>
<h2 id="ruby"><a class="header" href="#ruby">Ruby</a></h2>
<ul>
<li><a href="https://github.com/piotr-iohk/cardano-wallet-rb"><code>piotr-iohk/cardano-wallet-rb</code></a> - a Ruby Gem for accessing the <code>cardano-wallet</code> REST <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/">API</a>.</li>
<li><a href="https://github.com/piotr-iohk/ikar"><code>piotr-iohk/ikar</code></a> - a helper web app to interact with <code>cardano-wallet</code>.</li>
</ul>
<h2 id="scalajava"><a class="header" href="#scalajava">Scala/Java</a></h2>
<ul>
<li><a href="https://github.com/input-output-hk/psg-cardano-wallet-api"><code>input-output-hk/psg-cardano-wallet-api</code></a> - a Scala and Java client for the Cardano Wallet <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/">API</a>.</li>
<li><a href="https://github.com/uniVocity/envlp-cardano-wallet"><code>uniVocity/envlp-cardano-wallet</code></a> - a Java client for accessing the <code>cardano-wallet</code> REST <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/">API</a>.</li>
<li>( <a href="https://github.com/bloxbean/cardano-client-lib"><code>bloxbean/cardano-client-lib</code></a> - a client library for Cardano in Java, currently integrated through Blockfrost, but planning on to integrate with cardano-wallet )</li>
</ul>
<h2 id="typescriptjavascript"><a class="header" href="#typescriptjavascript">TypeScript/JavaScript</a></h2>
<ul>
<li><a href="https://github.com/input-output-hk/daedalus"><code>input-output-hk/daedalus</code></a> - a graphical Cardano Wallet user interface using Electron and the <a href="https://github.com/input-output-hk/react-polymorph">React Polymorph</a> framework.</li>
<li><a href="https://github.com/IntersectMBO/cardano-launcher"><code>IntersectMBO/cardano-launcher</code></a> - a library for configuring, starting and stopping <code>cardano-wallet</code> and <code>cardano-node</code>.</li>
<li><a href="https://github.com/tango-crypto/cardano-wallet-js"><code>tango-crypto/cardano-wallet-js</code></a> - a Typescript/Javascript module for accessing the <code>cardano-wallet</code> REST <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/">API</a>.</li>
</ul>
<h2 id="unknown"><a class="header" href="#unknown">Unknown</a></h2>
<ul>
<li><a href="https://adawallet.io/"><code>Medusa AdaWallet</code></a> - a web-based Cardano Wallet</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ekg-and-prometheus-metrics"><a class="header" href="#ekg-and-prometheus-metrics">EKG and Prometheus Metrics</a></h1>
<p>It is possible to enable EKG and Prometheus monitoring on cardano-wallet server, by setting environment variables that configure ports and host names for those services:</p>
<pre><code>CARDANO_WALLET_EKG_PORT
CARDANO_WALLET_PROMETHEUS_PORT

CARDANO_WALLET_EKG_HOST
CARDANO_WALLET_PROMETHEUS_HOST
</code></pre>
<div id="admonition-warning" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="user/ekg-and-prometheus.html#admonition-warning"></a></p>
</div>
<div>
<p>Monitoring is disabled by default. It is enabled by setting <code>CARDANO_WALLET_EKG_PORT</code> and/or <code>CARDANO_WALLET_PROMETHEUS_PORT</code> respectively.</p>
</div>
</div>
<h3 id="enabling-monitoring"><a class="header" href="#enabling-monitoring">Enabling monitoring</a></h3>
<p>To enable monitoring one can simply set environment variables with <code>cardano-wallet serve</code> command as follows:</p>
<pre><code>&gt; CARDANO_WALLET_EKG_PORT=8070 \
    CARDANO_WALLET_PROMETHEUS_PORT=8080 \
    cardano-wallet serve --port 8090 \
    --node-socket /path_to/cardano-node.socket \
    --mainnet \
    --database ./wallet-db
</code></pre>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="user/ekg-and-prometheus.html#admonition-note"></a></p>
</div>
<div>
<p>In order to see EKG <code>GC and memory statistics</code> start wallet with
<code>cardano-wallet +RTS -T -RTS &lt;other-args&gt;</code></p>
</div>
</div>
<p>Following the example above metrics would be available in <code>localhost</code> under corresponding ports:</p>
<ul>
<li>EKG: http://localhost:8070</li>
</ul>
<p><img src="user/ekg.png" alt="" /></p>
<pre><code>&gt; curl -H &quot;Accept: application/json&quot; http://localhost:8070/ | jq

{
  &quot;iohk-monitoring version&quot;: {
    &quot;type&quot;: &quot;l&quot;,
    &quot;val&quot;: &quot;0.1.10.1&quot;
  },
  &quot;ekg&quot;: {
    &quot;server_timestamp_ms&quot;: {
      &quot;type&quot;: &quot;c&quot;,
      &quot;val&quot;: 1606997751752
    }
  },
  &quot;rts&quot;: {
    &quot;gc&quot;: {
      &quot;gc_cpu_ms&quot;: {
        &quot;type&quot;: &quot;c&quot;,
        &quot;val&quot;: 0
      },
</code></pre>
<h3 id="prometheus-metrics"><a class="header" href="#prometheus-metrics">Prometheus metrics</a></h3>
<pre><code>&gt; curl http://localhost:8080/metrics

cardano_wallet_metrics_Stat_rtpriority_int 0
cardano_wallet_metrics_Stat_itrealvalue_int 0
rts_gc_par_max_bytes_copied 0
cardano_wallet_metrics_IO_syscr_int 3722
cardano_wallet_metrics_Stat_minflt_int 6731
cardano_wallet_metrics_Stat_cminflt_int 0
</code></pre>
<h3 id="binding-monitoring"><a class="header" href="#binding-monitoring">Binding monitoring</a></h3>
<p>By default both EKG and Prometheus monitoring is bound to <code>localhost</code> . One can bind it to different hostname or external ip using:</p>
<pre><code>CARDANO_WALLET_EKG_HOST
CARDANO_WALLET_PROMETHEUS_HOST
</code></pre>
<p>For instance:</p>
<pre><code>&gt; CARDANO_WALLET_EKG_PORT=8070 \
    CARDANO_WALLET_PROMETHEUS_PORT=8080 \
    CARDANO_WALLET_EKG_HOST=0.0.0.0 \
    CARDANO_WALLET_PROMETHEUS_HOST=0.0.0.0 \
    cardano-wallet serve --port 8090 \
    --node-socket /path_to/cardano-node.socket \
    --mainnet \
    --database ./wallet-db
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="plutus-application-backend"><a class="header" href="#plutus-application-backend">Plutus Application Backend</a></h1>
<h2 id="pre-requisites-10"><a class="header" href="#pre-requisites-10">Pre-requisites</a></h2>
<ul>
<li>Install <a href="https://github.com/input-output-hk/plutus/tree/master/plutus-pab">Plutus Application Backend</a>.</li>
<li>In order to be able to balance Plutus transaction we need funds on the wallet. In case of <a href="https://testnets.cardano.org/en/testnets/cardano/overview/">Testnet</a> we can request tADA from the <a href="https://testnets.cardano.org/en/testnets/cardano/tools/faucet/">faucet</a>.</li>
</ul>
<h2 id="overview-7"><a class="header" href="#overview-7">Overview</a></h2>
<p>This guide is to show how to invoke Plutus contracts with cardano-wallet.</p>
<h2 id="workflow"><a class="header" href="#workflow">Workflow</a></h2>
<p>Once you have created a smart contract with <a href="https://github.com/input-output-hk/plutus/tree/master/plutus-pab">PAB</a> you can execute it via cardano-wallet.</p>
<p>There are three endpoints that need to be invoked to follow the workflow:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/balanceTransaction">POST /wallets/{walletId}/transactions-balance</a> - for balancing transaction from PAB.</li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/signTransaction">POST /wallets/{walletId}/transactions-sign</a> - for signing transaction.</li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitTransaction">POST
/wallets/{walletId}/transactions-submit</a> - for submitting transaction to the network.</li>
</ul>
<h3 id="balance-transaction"><a class="header" href="#balance-transaction">Balance transaction</a></h3>
<p>Plutus Application Backend provides a payload of an unbalanced transaction. This transaction needs to be balanced with wallet's inputs such that it can be submitted to the network. The response from this endpoint returns <code>fee</code> and <code>coin_selection</code> of the balanced transaction as well as CBOR-encoded <code>transaction</code> represented in base64 encoding. We will need the returned <code>transaction</code> value to pass on to <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/signTransaction">POST /wallets/{walletId}/transactions-sign</a> endpoint.</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-balance \
-d '{&quot;transaction&quot;:&quot;84a500800d80018183581d704d72cf569a339a18a7d9302313983f56e0d96cd45bdcb1d6512dca6a1a001e84805820923918e403bf43c34b4ef6b48eb2ee04babed17320d8d1b9ff9ad086e86f44ec02000e80a10481d87980f5f6&quot;,&quot;redeemers&quot;:[],&quot;inputs&quot;:[]}' \
-H &quot;Content-Type: application/json&quot; | jq .transaction

hKYAgYJYIJs6ATvbNwo5xpOkjHfUzr9Cv4zuFLFicFwWwpPC4ltBAw2AAYKDWB1wTXLPVpozmhin2TAjE5g/VuDZbNRb3LHWUS3KahoAHoSAWCCSORjkA79Dw0tO9rSOsu4Eur7RcyDY0bn/mtCG6G9E7IJYOQDsKgV69YfvMZdbfIT11OqtWL9bv7n++Jx0f+TDFwodcRLCv14tOV5BoBhV6ODYaS1MNdWnvKCjgBq2bfNOAhoAApgxDoALWCAvUOolRvjOAgykW/zyq+sC/xivIoNGb4iK5IkYSz0tOaEEgdh5gPX2
</code></pre>
<h3 id="sign-transaction"><a class="header" href="#sign-transaction">Sign transaction</a></h3>
<p>Once the transaction is balanced we need to sign it using our wallet's secure passphrase and pass the previously returned CBOR-encoded <code>transaction</code> . The sign endpoint will again return CBOR-encoded <code>transaction</code> which is needed to be passed further to <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitTransaction">POST
/wallets/{walletId}/transactions-submit</a> endpoint.</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-sign \
-d '{&quot;passphrase&quot;:&quot;Secure Passphrase&quot;,
&quot;transaction&quot;:&quot;hKYAgYJYIJs6ATvbNwo5xpOkjHfUzr9Cv4zuFLFicFwWwpPC4ltBAw2AAYKDWB1wTXLPVpozmhin2TAjE5g/VuDZbNRb3LHWUS3KahoAHoSAWCCSORjkA79Dw0tO9rSOsu4Eur7RcyDY0bn/mtCG6G9E7IJYOQDsKgV69YfvMZdbfIT11OqtWL9bv7n++Jx0f+TDFwodcRLCv14tOV5BoBhV6ODYaS1MNdWnvKCjgBq2bfNOAhoAApgxDoALWCAvUOolRvjOAgykW/zyq+sC/xivIoNGb4iK5IkYSz0tOaEEgdh5gPX2&quot;}' \
-H &quot;Content-Type: application/json&quot; | jq .transaction

hKYAgYJYIJs6ATvbNwo5xpOkjHfUzr9Cv4zuFLFicFwWwpPC4ltBAw2AAYKDWB1wTXLPVpozmhin2TAjE5g/VuDZbNRb3LHWUS3KahoAHoSAWCCSORjkA79Dw0tO9rSOsu4Eur7RcyDY0bn/mtCG6G9E7IJYOQDsKgV69YfvMZdbfIT11OqtWL9bv7n++Jx0f+TDFwodcRLCv14tOV5BoBhV6ODYaS1MNdWnvKCjgBq2bfNOAhoAApgxDoALWCAvUOolRvjOAgykW/zyq+sC/xivIoNGb4iK5IkYSz0tOaIAgYJYIAVUtVUzi4FodRYiBmO9mD5hQGo2YjjYDoCgw5gn+/w9WEAyVhMWNiK88QKW6HBXIVxQyu0E+9epkIQbCQwNjKur5ORLojHxIZtZDDfkT6caz0yxp92t4Y7rDwsDw4geMOkJBIHYeYD19g==
</code></pre>
<h3 id="submit-transaction"><a class="header" href="#submit-transaction">Submit transaction</a></h3>
<p>We have our balanced and signed CBOR-encoded <code>transaction</code> represented in base64 encoding. Now we can submit it to the network with <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/submitTransaction">POST
/wallets/{walletId}/transactions-submit</a> endpoint.</p>
<pre><code>&gt; curl -X POST http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions-submit \
-d '{&quot;transaction&quot;:&quot;hKYAgYJYIJs6ATvbNwo5xpOkjHfUzr9Cv4zuFLFicFwWwpPC4ltBAw2AAYKDWB1wTXLPVpozmhin2TAjE5g/VuDZbNRb3LHWUS3KahoAHoSAWCCSORjkA79Dw0tO9rSOsu4Eur7RcyDY0bn/mtCG6G9E7IJYOQDsKgV69YfvMZdbfIT11OqtWL9bv7n++Jx0f+TDFwodcRLCv14tOV5BoBhV6ODYaS1MNdWnvKCjgBq2bfNOAhoAApgxDoALWCAvUOolRvjOAgykW/zyq+sC/xivIoNGb4iK5IkYSz0tOaIAgYJYIAVUtVUzi4FodRYiBmO9mD5hQGo2YjjYDoCgw5gn+/w9WEAyVhMWNiK88QKW6HBXIVxQyu0E+9epkIQbCQwNjKur5ORLojHxIZtZDDfkT6caz0yxp92t4Y7rDwsDw4geMOkJBIHYeYD19g==&quot;}' \
-H &quot;Content-Type: application/json&quot;

{&quot;id&quot;:&quot;c287cd5a752ff632e07747109193ed8f8b8e446211563951e7f8e470ed859782&quot;}
</code></pre>
<p>We can monitor status of the submitted transaction using <a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getTransaction">GET /wallets/{walletId}/transactions/{transactionId}</a> endpoint.</p>
<pre><code>&gt; curl -X GET http://localhost:8090/v2/wallets/1b0aa24994b4181e79116c131510f2abf6cdaa4f/transactions/c287cd5a752ff632e07747109193ed8f8b8e446211563951e7f8e470ed859782 | jq

{
  &quot;status&quot;: &quot;in_ledger&quot;,
...
&quot;amount&quot;: {
  &quot;quantity&quot;: 2170033,
  &quot;unit&quot;: &quot;lovelace&quot;
},
&quot;inserted_at&quot;: {
  &quot;height&quot;: {
    &quot;quantity&quot;: 3324947,
    &quot;unit&quot;: &quot;block&quot;
  },
  &quot;epoch_number&quot;: 187,
  &quot;time&quot;: &quot;2022-02-16T11:22:12Z&quot;,
  &quot;absolute_slot_number&quot;: 50641316,
  &quot;slot_number&quot;: 226916
},
...
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="faq"><a class="header" href="#faq">FAQ</a></h1>
<h2 id="why-arent-my-unused-addresses-imported-when-i-restore-a-wallet"><a class="header" href="#why-arent-my-unused-addresses-imported-when-i-restore-a-wallet">Why aren't my unused addresses imported when I restore a wallet?</a></h2>
<p>This is by virtue of the blockchain. An unused address is by definition unused. Meaning that is doesn't exist on the chain and only exists locally, in the context of the software that has generated it. Different software may use different rules to generate addresses. For example in the past, <em>cardano-sl</em> wallets used a method called random derivation where addresses were created from a root seed and a random index stored within the address itself. Because these indexes were random, it was not possible to restore randomly generated addresses which hadn't been used on chain yet!</p>
<p>More recently, <code>cardano-wallet</code> has been using sequential derivation which follows a very similar principle with the major difference that indexes are derived in sequence, starting from 0. Following this method, wallets aren't allowed to pre-generate too many addresses in advance. As a consequence, it is now possible to restore a wallet across many machines while keeping a very consistent state.</p>
<h2 id="ive-noticed-that-other-blockchains-create-accounts-for-wallets"><a class="header" href="#ive-noticed-that-other-blockchains-create-accounts-for-wallets">I’ve noticed that other blockchains create accounts for wallets?</a></h2>
<p>There are two sides to this question. Either, you are referring to accounts as in Ethereum accounts, or you may refer to accounts of hierarchical deterministic wallets.</p>
<p>In the first scenario, assets in the form of accounts are only supported in the Shelley era of Cardano and only for a specific use-case: rewards. Rewards are indeed implicitly published on the blockchain to mitigate the risk of flooding the network at the end of every epoch with rewards payouts! Hence, each core node keeps track of the current value of each reward account in a Ledger. Money can be withdrawn from this account and is then turned as a UTxO. Please note that funds can never be manually sent to a reward account. The creation of a reward account is done when registering a staking key, via a specific type of transaction.</p>
<p>In the second case, please refer to the <a href="user/../concepts/hierarchical-deterministic-wallets.html">hierarchical deterministic wallets</a> section in the <em>Key concepts</em>. Cardano wallets typically follow an HD tree of derivation as described in this section.</p>
<h2 id="it-seems-like-i-have-to-install-and-configure-many-apis-and-libraries-what-is-the-fastest-and-most-simple-way-to-do-this-at-once"><a class="header" href="#it-seems-like-i-have-to-install-and-configure-many-apis-and-libraries-what-is-the-fastest-and-most-simple-way-to-do-this-at-once">It seems like I have to install and configure many APIs and libraries, what is the fastest and most simple way to do this at once?</a></h2>
<p>🐳 <a href="https://docs.docker.com/">docker</a> is your friend here! Every component is packaged as docker images. Releases are tagged and the very edge is always accessible. See the various docker guides on the components' repository, and also how to compose services using <a href="https://docs.docker.com/compose/">docker-compose</a>.</p>
<h2 id="is-there-a-reason-why-i-would-have-to-build-from-src"><a class="header" href="#is-there-a-reason-why-i-would-have-to-build-from-src">Is there a reason why I would have to build from src?</a></h2>
<p>If you intend to contribute to Cardano by making code changes to one of the core components, then yes. We recommend using <a href="https://www.haskell.org/cabal/">cabal</a> for a better developer experience.</p>
<p>If you only intend to use the services as-is then, using either the pre-compiled release artifacts for your appropriate platform or a pre-packaged docker image is preferable.</p>
<h2 id="where-is-the-faucet-and-do-i-get-test-ada"><a class="header" href="#where-is-the-faucet-and-do-i-get-test-ada">Where is the faucet and do I get test ADA?</a></h2>
<ul>
<li>https://testnets.cardano.org/en/testnets/cardano/tools/faucet/</li>
</ul>
<h2 id="wallet-backend-specifications"><a class="header" href="#wallet-backend-specifications">Wallet Backend Specifications</a></h2>
<details>
  <summary>Where do the various notations come from?</summary>
<p>Like often in Maths, notations are described within the context of the paper with some a priori hypotheses. For the
Wallet Backend specifications, the notation is inspired from the <a href="https://en.wikipedia.org/wiki/Z_notation">Z notation</a> in a slightly more lightweight form.</p>
</details>
<details>
  <summary>What is <code>dom</code> from <strong>Lemma 2.1</strong></summary>
<p>There are multiple occurrences in the spec of expressions like: <code>(dom u ∩ ins) ◃ u</code>. The meaning of <code>dom u</code> isn't quite clearly defined anywhere but refers to the set of keys from the mapping defined by <code>u: txin ↦ txout</code>. Hence, <code>dom u</code> refers to all <code>txin</code> available in <code>u</code>.</p>
<p>In Haskell, this translates to:</p>
<pre><code class="language-hs">newtype UTxO = UTxO (Map TxIn TxOut)

dom :: UTxO -&gt; Set TxIn
dom (UTxO utxo) = Set.fromList $ Map.keys utxo
</code></pre>
</details>
<details>
    <summary>How do I interpret <code>(Ix -> TxOut)</code> in the definition of <code>Tx</code> in fig. 1?</summary>
<p>In the current wallet implementation it corresponds to <code>NonEmpty TxOut</code>.</p>
</details>
<details>
  <summary>Are we going to update the formal specification?</summary>
<p>Some elements of the specification are written according to the current wallet implementation. Some parts could be simplified or removed, in particular the bits concerning a few metadata that we won't be implementing until a need for them is made clear. A few bits are also missing from the specifications (like the fact that answering <code>isOurs</code> is a stateful operation when dealing with BIP-44, or also, foreign transactions coming from ADA certificates redemption). In the long run, we do want to have the specification updated and proved.</p>
</details>
<h2 id="address-derivation-à-la-bip-44"><a class="header" href="#address-derivation-à-la-bip-44">Address Derivation à la BIP-44</a></h2>
<details>
  <summary>Are we going to support the old Random derivation scheme forever?</summary>
<p>Short answer: yes. Though, we don't necessarily have to support a full set of features for wallets using an old derivation scheme in order to encourage users to migrate to the sequential scheme (a.k.a BIP-44). Most probably, we will forever have to support the old derivation scheme and a few features like tracking of the wallet UTxO and balance, and, allowing funds to be migrated to a wallet using the sequential scheme.</p>
</details>
<h2 id="coin-selection"><a class="header" href="#coin-selection">Coin selection</a></h2>
<details>
  <summary>How many outputs can a single transaction have?</summary>
<p>It depends. To make a transaction, our implementation currently select UTxO from the available UTxO in the wallet in order to cover for the output requested in a transaction. For every output, the wallet actually creates two outputs:</p>
<ul>
<li>The actual output to a target address</li>
<li>A change output to a change address of the source wallet</li>
</ul>
<p>Also, in practice, we strive to make these two outputs relatively equivalent in size, such that one cannot easily guess the change output from the actual one by looking at the transaction; enforcing therefore some privacy for users.</p>
<p>Incidentally, we do consider every requested output in a transaction as an independent problem. This means that a single UTxO can only cover for one of the output (and will in practice, tend to be twice as big, such that we can generate an equivalent corresponding change output). As a consequence, in order to make a transaction to three target outputs, one needs to have at least three UTxOs that are big enough to cover all three outputs independently.</p>
<p>Finally, it's important to notice that the fee calculation runs <strong>after</strong> the coin selection and is divvied across all change outputs. So in practice, the UTxOs only need to independently cover for outputs, but are considered together when adjusting for fees.</p>
<p>A few examples to make this more concrete (in the scenario below, fees are ~<code>180000</code>):</p>
<pre><code>// Both UTxOs can separately cover fee and outputs
Available UTxO:  [200000, 200000]
Payment Distribution: [14, 42]
Result: Ok

// 2 UTxOs, each cannot separately cover fee and outputs, but jointly can
Available UTxO: [100000, 100000]
Payment Distribution: [14, 42]
Result: Ok

// Single UTxOs, big enough to cover for total requested amount &amp; fee, but multiple outputs
Available UTxO: [400000]
Payment Distribution: [14, 42]
Result: Error - UTxO not enough fragmented
</code></pre>
</details>
<details>
  <summary>What is the security issue with re-using addresses?</summary>
<p>In practice, there's none.</p>
</details>
<h2 id="miscellaneous"><a class="header" href="#miscellaneous">Miscellaneous</a></h2>
<details>
  <summary>How do I write a question in this FAQ?</summary>
<p>Use the <code>&lt;details&gt;</code> and <code>&lt;summary&gt;</code> html tags. The <code>&lt;summary&gt;</code> are nested inside the <code>&lt;details&gt;</code> tag
and the question goes within the <code>&lt;summary&gt;</code> tag as a body. The answer goes below, and can contain any
arbitrary markdown or HTML supported / allowed by GitHub. This produces a nice, readable output.</p>
<p>e.g.</p>
<pre><code class="language-html">  &lt;details&gt;
    &lt;summary&gt;What is love?&lt;/summary&gt;

    Baby don't hurt me.
  &lt;/details&gt;
</code></pre>
</details>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-documents"><a class="header" href="#design-documents">Design Documents</a></h1>
<p>Information about the design of the wallet.</p>
<p>This includes:</p>
<ul>
<li>Documentation of internal design decisions.</li>
<li>Concepts and terminology.</li>
<li>Specifications of user-facing APIs.</li>
<li>Prototypes.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture-diagram"><a class="header" href="#architecture-diagram">Architecture Diagram</a></h1>
<pre class="mermaid">flowchart TB;
  subgraph local system
    Daedalus -- calls --&gt; cardano-launcher;
    cardano-launcher -. spawns .-&gt; cardano-wallet;
    cardano-launcher -. spawns .-&gt; cardano-node;

    %% by HTTP REST API
    Daedalus -- queries --&gt; cardano-wallet;

    %% Local socket/named pipe
    cardano-wallet -- queries --&gt; cardano-node;
  end


  subgraph Internet
    %% HTTP API
    cardano-wallet -- queries --&gt; SMASH;

    %% Network protocol
    cardano-node -- syncs --&gt; blockchain;
  end

  class cardano-wallet adrestia;
  class Daedalus,cardano-launcher daedalus;
  class cardano-node,SMASH cardano;
  class blockchain other;

  click cardano-wallet call mermaidClick(&quot;wallet-backend&quot;);
  click cardano-launcher mermaidClick;
  click cardano-node call mermaidClick(&quot;node&quot;);
  click SMASH call mermaidClick(&quot;smash&quot;);
  click Daedalus call mermaidClick(&quot;daedalus&quot;);
</pre>
<p>This is how the software components fit together in the <a href="design/architecture.html#daedalus">Daedalus</a> scenario.</p>
<p>See also: <a href="design/adrestia-architecture.html">Adrestia Architecture</a>.</p>
<h2 id="node"><a class="header" href="#node">Node</a></h2>
<p>The core <a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a>, which participates in the Cardano network, and maintains the state of the Cardano blockchain ledger.</p>
<h2 id="wallet-backend"><a class="header" href="#wallet-backend">Wallet Backend</a></h2>
<p><a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a> is an HTTP REST API is recommended for 3rd party wallets and small exchanges who do not want to manage UTxOs for transactions themselves. Use it to send and receive payments from hierarchical deterministic wallets on the Cardano blockchain via HTTP REST or a command-line interface.</p>
<h2 id="cardano-launcher"><a class="header" href="#cardano-launcher">Cardano Launcher</a></h2>
<p><a href="https://github.com/IntersectMBO/cardano-launcher">cardano-launcher</a> is a TypeScript package which handles the details of starting and stopping the Node and Wallet Backend.</p>
<h2 id="daedalus"><a class="header" href="#daedalus">Daedalus</a></h2>
<p><a href="https://github.com/input-output-hk/daedalus">Daedalus</a> is a user-friendly desktop application to manage Cardano wallets.</p>
<h2 id="smash"><a class="header" href="#smash">SMASH</a></h2>
<p><a href="https://github.com/input-output-hk/smash">SMASH</a> is a proxy for stake pool metadata.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="adrestia-architecture"><a class="header" href="#adrestia-architecture">Adrestia Architecture</a></h1>
<p>Adrestia is a collection of products which makes it easier to integrate with Cardano.</p>
<p>It comes in different flavours: SDK or high-level APIs. Depending on the use-cases you have and the control that you seek, you may use any of the components below.</p>
<h2 id="services"><a class="header" href="#services">Services</a></h2>
<p>Service applications for integrating with Cardano.</p>
<ul>
<li><a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a>: HTTP REST API for managing UTxOs, and much more.</li>
<li><a href="https://github.com/cardano-foundation/cardano-graphql">cardano-graphql</a>: HTTP GraphQL API for exploring the blockchain.</li>
<li><a href="https://github.com/input-output-hk/cardano-rosetta">cardano-rosetta</a>: <a href="https://www.rosetta-api.org/docs/1.4.4/welcome.html">Rosetta</a> implementation for Cardano.</li>
<li><a href="https://github.com/IntersectMBO/cardano-node/tree/master/cardano-submit-api">cardano-submit-api</a>: HTTP API for submitting signed transactions.</li>
</ul>
<h2 id="software-libraries"><a class="header" href="#software-libraries">Software Libraries</a></h2>
<ul>
<li><a href="https://github.com/IntersectMBO/cardano-addresses">cardano‑addresses</a>: Address generation, derivation &amp;  mnemonic manipulation.</li>
<li><a href="https://github.com/IntersectMBO/cardano-coin-selection">cardano-coin-selection</a>: Algorithms for coin selection and fee balancing.</li>
<li><a href="https://github.com/IntersectMBO/cardano-transactions">cardano-transactions</a>: Utilities for constructing and signing transactions.</li>
<li><a href="https://github.com/IntersectMBO/bech32">bech32</a>: Haskell implementation of the Bech32 address format (BIP 0173).</li>
</ul>
<h2 id="high-level-dependency-diagram"><a class="header" href="#high-level-dependency-diagram">High-Level Dependency Diagram</a></h2>
<pre class="mermaid">flowchart TB
  cardano-submit-api --&gt; cardano-node;
  cardano-wallet     --&gt; cardano-node;
  cardano-db-sync    --&gt; cardano-node;

  cardano-db-sync-- writes --&gt; PostgreSQL[(PostgreSQL)];
  SMASH-- reads --&gt; PostgreSQL;
  cardano-graphql-- reads --&gt; PostgreSQL;
  cardano-rosetta-- reads --&gt; PostgreSQL;

  cardano-explorer[cardano-explorer fab:fa-react] --&gt; cardano-graphql;

  cardano-wallet --&gt; SMASH;
  daedalus[Daedalus fab:fa-react] --&gt; cardano-wallet;

  click cardano-submit-api mermaidClick;
  click cardano-wallet mermaidClick;
  click cardano-db-sync mermaidClick;
  click SMASH mermaidClick;
  click cardano-graphql mermaidClick;
  click cardano-rosetta mermaidClick;
  click cardano-explorer mermaidClick;
  click PostgreSQL href &quot;https://postgresql.org&quot;;
  click daedalus href &quot;https://github.com/input-output-hk/daedalus&quot;;

  %% Styles for these classes are in static/adrestia.css.
  class cardano-wallet,cardano-explorer,cardano-graphql,cardano-rosetta adrestia;
  class cardano-node,cardano-submit-api,cardano-db-sync,SMASH cardano;
  class daedalus daedalus;
  class PostgreSQL other;
</pre>
<h2 id="component-synopsis"><a class="header" href="#component-synopsis">Component Synopsis</a></h2>
<h3 id="cardano-node"><a class="header" href="#cardano-node"><a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a></a></h3>
<p>The core <a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a>, which participates in the Cardano network, and maintains the state of the Cardano blockchain ledger.</p>
<h4 id="cardano-network-protocol"><a class="header" href="#cardano-network-protocol">Cardano Network Protocol</a></h4>
<p>An implementation of the protocol is <a href="https://github.com/IntersectMBO/ouroboros-network">here</a>, deployed as stake pool nodes and relay nodes to form the Cardano network.</p>
<h3 id="cardano-wallet-1"><a class="header" href="#cardano-wallet-1"><a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a></a></h3>
<p><a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a> An HTTP REST API is recommended for 3rd party wallets and small exchanges who do not want to manage UTxOs for transactions themselves. Use it to send and receive payments from hierarchical deterministic wallets on the Cardano blockchain via HTTP REST or a command-line interface.</p>
<h3 id="cardanolauncher"><a class="header" href="#cardanolauncher"><a href="https://github.com/IntersectMBO/cardano-launcher">cardano‑launcher</a></a></h3>
<p>This is a small Typescript package for NodeJS applications which manages the configuration and lifetime of <a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a> and <a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a> processes.</p>
<h3 id="cardano-db-sync"><a class="header" href="#cardano-db-sync"><a href="https://github.com/IntersectMBO/cardano-db-sync">cardano-db-sync</a></a></h3>
<p>This application stores blockchain data fetched from <a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a> in a PostgreSQL database to enable higher-level interfaces for blockchain exploration. It powers <a href="https://github.com/cardano-foundation/cardano-graphql">cardano-graphql</a>.</p>
<h3 id="cardano-graphql"><a class="header" href="#cardano-graphql"><a href="https://github.com/cardano-foundation/cardano-graphql">cardano-graphql</a></a></h3>
<p>A GraphQL API for Cardano, which also serves as the backend of
<a href="https://explorer.cardano.org/">Cardano Explorer</a>.</p>
<h3 id="cardano-submit-api"><a class="header" href="#cardano-submit-api"><a href="https://github.com/IntersectMBO/cardano-node/tree/master/cardano-submit-api">cardano-submit-api</a></a></h3>
<p>A small HTTP API for submitting transactions to a local <a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a>.</p>
<p>The transaction must be fully signed and CBOR-encoded. This could be done by <a href="https://docs.cardano.org/projects/cardano-node/en/latest/reference/cardano-node-cli-reference.html">cardano-cli</a>, for example.</p>
<h3 id="cardano-rosetta"><a class="header" href="#cardano-rosetta"><a href="https://github.com/input-output-hk/cardano-rosetta">cardano-rosetta</a></a></h3>
<p><a href="https://github.com/input-output-hk/cardano-rosetta">Cardano-rosetta</a> is an implementation of the <a href="https://www.rosetta-api.org/docs/1.4.4/welcome.html">Rosetta</a> specification for Cardano. Rosetta is an open-source specification and set of tools that makes integrating with blockchains simpler, faster, and more reliable.</p>
<h3 id="smash-1"><a class="header" href="#smash-1"><a href="https://github.com/input-output-hk/smash">SMASH</a></a></h3>
<p>The Stakepool Metadata Aggregation Server [for Hashes] is basically a proxy of the metadata published by stake pool owners. It improves performance of the network by taking load off the various web servers which host the actual metadata.</p>
<p>Clients such as <code>cardano-wallet</code> must verify the integrity of metadata served by a SMASH server by comparing the metadata's content hash with that in the stake pool registration certificate.</p>
<h2 id="component-relationships-explorer-scenario"><a class="header" href="#component-relationships-explorer-scenario">Component Relationships: Explorer Scenario</a></h2>
<pre class="mermaid">erDiagram
  CARDANO-NODE ||--|{ CARDANO-SUBMIT-API : connects-to
  CARDANO-NODE ||--|{ CARDANO-DB-SYNC : depends-on

  CARDANO-DB-SYNC ||--|| POSTGRESQL : dumps-into
  POSTGRESQL ||--|| SMASH : is-queried
  POSTGRESQL ||--|| CARDANO-GRAPHQL : is-queried
  POSTGRESQL ||--|| CARDANO-ROSETTA : is-queried

  CARDANO-GRAPHQL ||--|{ EXPLORER : depends-on
</pre>
<h2 id="component-relationships-wallet-scenario"><a class="header" href="#component-relationships-wallet-scenario">Component Relationships: Wallet Scenario</a></h2>
<pre class="mermaid">flowchart TB
  subgraph local system
    Daedalus -- calls --&gt; cardano-launcher;
    cardano-launcher -. spawns .-&gt; cardano-wallet;
    cardano-launcher -. spawns .-&gt; cardano-node;

    %% by HTTP REST API
    Daedalus -- queries --&gt; cardano-wallet;

    %% Local socket/named pipe
    cardano-wallet -- queries --&gt; cardano-node;
  end


  subgraph Internet
    %% HTTP API
    cardano-wallet -- queries --&gt; SMASH;

    %% Network protocol
    cardano-node -- syncs --&gt; blockchain;
  end

  class cardano-wallet adrestia;
  class Daedalus,cardano-launcher daedalus;
  class cardano-node,SMASH cardano;
  class blockchain other;

  click cardano-wallet mermaidClick;
  click cardano-launcher mermaidClick;
  click cardano-node mermaidClick;
  click SMASH mermaidClick;
  click Daedalus href &quot;https://github.com/input-output-hk/daedalus&quot;;
  click blockchain call mermaidClick(&quot;cardano-network-protocol&quot;);
</pre>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<h3 id="apis"><a class="header" href="#apis">APIs</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name / Link</th><th>Description</th><th>Byron</th><th>Jörm</th><th>Shelley</th><th>Mary</th><th>Alonzo</th></tr></thead><tbody>
<tr><td><a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a></td><td>JSON/REST API for managing UTxOs in HD wallets</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><a href="https://github.com/cardano-foundation/cardano-graphql">cardano-graphql</a></td><td>GraphQL/HTTP API for browsing on-chain data</td><td>✔</td><td>❌</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><a href="https://github.com/input-output-hk/cardano-rosetta">cardano-rosetta</a></td><td>Implementation of <a href="https://www.rosetta-api.org/">Rosetta</a> spec for Cardano</td><td></td><td></td><td>✔</td><td>✔</td><td>🚧</td></tr>
<tr><td><del><a href="https://github.com/input-output-hk/cardano-rest">cardano-rest</a></del></td><td><em>Deprecated</em></td><td>✔</td><td>❌</td><td>✔</td><td>❌</td><td>❌</td></tr>
</tbody></table>
</div>
<h3 id="clis"><a class="header" href="#clis">CLIs</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name / Link</th><th>Description</th><th>Byron</th><th>Jörm</th><th>Shelley</th><th>Mary</th><th>Alonzo</th></tr></thead><tbody>
<tr><td><a href="https://github.com/IntersectMBO/bech32">bech32</a></td><td>Human-friendly Bech32 address encoding</td><td>N/A</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a></td><td>Command-line for interacting with cardano-wallet API</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><a href="https://github.com/IntersectMBO/cardano-addresses">cardano‑addresses</a></td><td>Addresses and mnemonic manipulation &amp; derivations</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><del><a href="https://github.com/IntersectMBO/cardano-transactions">cardano-transactions</a></del></td><td><em>Deprecated</em></td><td>✔</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td></tr>
</tbody></table>
</div>
<h3 id="haskell-sdks"><a class="header" href="#haskell-sdks">Haskell SDKs</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name / Link</th><th>Description</th><th>Byron</th><th>Jörm</th><th>Shelley</th><th>Mary</th><th>Alonzo</th></tr></thead><tbody>
<tr><td><a href="https://github.com/IntersectMBO/bech32">bech32</a></td><td>Human-friendly Bech32 address encoding</td><td></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><a href="https://github.com/IntersectMBO/cardano-addresses">cardano‑addresses</a></td><td>Addresses and mnemonic manipulation &amp; derivations</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><del><a href="https://github.com/IntersectMBO/cardano-coin-selection">cardano-coin-selection</a></del></td><td><em>Deprecated</em></td><td>✔</td><td>✔</td><td>✔</td><td>❌</td><td>❌</td></tr>
<tr><td><del><a href="https://github.com/IntersectMBO/cardano-transactions">cardano-transactions</a></del></td><td><em>Deprecated</em></td><td>✔</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td></tr>
</tbody></table>
</div>
<h3 id="rust-sdks-webassembly-support"><a class="header" href="#rust-sdks-webassembly-support">Rust SDKs (+WebAssembly support)</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name / Link</th><th>Description</th><th>Byron</th><th>Jörmungandr</th><th>Shelley</th></tr></thead><tbody>
<tr><td><a href="https://github.com/Emurgo/cardano-serialization-lib">cardano-serialization-lib</a></td><td>Binary serialization of on-chain data types</td><td>N/A</td><td>N/A</td><td>✔</td></tr>
<tr><td><a href="https://github.com/Emurgo/react-native-haskell-shelley">react-native-haskell-shelley</a></td><td>React Native bindings for <a href="https://github.com/Emurgo/cardano-serialization-lib">cardano-serialization-lib</a></td><td>N/A</td><td>N/A</td><td>🚧</td></tr>
</tbody></table>
</div>
<h3 id="javascript-sdks"><a class="header" href="#javascript-sdks">JavaScript SDKs</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name / Link</th><th>Description</th><th>Byron</th><th>Jörm</th><th>Shelley</th><th>Mary</th><th>Alonzo</th></tr></thead><tbody>
<tr><td><a href="https://github.com/IntersectMBO/cardano-launcher">cardano‑launcher</a></td><td>Typescript library for starting and stopping <a href="https://github.com/cardano-foundation/cardano-wallet">cardano-wallet</a> and <a href="https://github.com/IntersectMBO/cardano-node">cardano-node</a></td><td></td><td>❌</td><td>✔</td><td>✔</td><td>✔</td></tr>
<tr><td><a href="https://github.com/IntersectMBO/cardano-addresses">cardano‑addresses</a></td><td>Address validation and inspection</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr>
</tbody></table>
</div>
<h3 id="formal-specifications"><a class="header" href="#formal-specifications">Formal Specifications</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name / Link</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/input-output-hk/utxo-wallet-specification">utxo-wallet-specification</a></td><td>Formal specification for a UTxO wallet</td></tr>
</tbody></table>
</div>
<h3 id="internal"><a class="header" href="#internal">Internal</a></h3>
<div id="admonition-warning" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="design/adrestia-architecture.html#admonition-warning"></a></p>
</div>
<div>
<p>These tools are used internally by other tools and
does not benefit from the same care in documentation than other tools above.</p>
</div>
</div>
<div class="table-wrapper"><table><thead><tr><th>Name / Link</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/input-output-hk/persistent">persistent</a></td><td>Fork of the persistent Haskell library maintained for cardano-wallet</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="other-resources"><a class="header" href="#other-resources">Other Resources</a></h1>
<h2 id="cardano-node-1"><a class="header" href="#cardano-node-1">Cardano Node</a></h2>
<ul>
<li><a href="https://docs.cardano.org/en/latest/">User Guide</a></li>
<li><a href="https://hydra.iohk.io/build/902246/download/1/delegation_design_spec.pdf">Engineering Design Specification for Delegation and Incentives</a></li>
<li><a href="https://hydra.iohk.io/build/1224753/download/1/ledger-spec.pdf">A Formal Specification of the Cardano Ledger</a></li>
<li>Networking Protocol(s)
<ul>
<li>Repository: <a href="https://github.com/IntersectMBO/ouroboros-network">IntersectMBO/ouroboros-network</a>, includes specifications</li>
<li>Specification: <a href="https://hydra.iohk.io/build/6955704/download/2/network-spec.pdf">The Shelley Networking Protocol</a> (Version 1.3.0, 16th July 2021)</li>
</ul>
</li>
<li>Low-Level Specifications
<ul>
<li><a href="https://github.com/input-output-hk/cardano-sl/blob/master/docs/on-the-wire/current-spec.cddl"> [Byron] On-Chain Binary Formats</a></li>
<li><a href="https://github.com/IntersectMBO/ouroboros-network/blob/master/ouroboros-network/test/messages.cddl">  [Shelley] Network Binary Formats - Draft</a></li>
<li><a href="https://github.com/IntersectMBO/cardano-ledger/blob/master/shelley/chain-and-ledger/cddl-spec/shelley.cddl#L32"> [Shelley] On chain Binary formats - Draft</a></li>
</ul>
</li>
</ul>
<h2 id="plutus"><a class="header" href="#plutus">Plutus</a></h2>
<ul>
<li><a href="https://plutus-book.surge.sh">Plutus Book</a></li>
<li><a href="https://hydra.iohk.io/job/Cardano/cardano-ledger-specs/specs.shelley-mc/latest/download/1/multi-asset.pdf">Multi-assets Ledger Specs extension</a></li>
</ul>
<h2 id="emurgo"><a class="header" href="#emurgo">Emurgo</a></h2>
<ul>
<li><a href="https://www.seiza.com/">Seiza: explorer</a></li>
<li><a href="https://github.com/Emurgo/tangata-manu">Tangata Manu: Yoroi data importer</a></li>
<li><a href="https://github.com/Emurgo/yoroi-frontend">Yoroi</a></li>
<li><a href="https://github.com/Emurgo/EmIPs/tree/master/specs">Emurgo Improvements Proposals</a>
<ul>
<li><a href="https://github.com/Emurgo/EmIPs/blob/master/specs/emip-001.md">Account Number Plates (Checksum IDs)</a></li>
<li><a href="https://github.com/Emurgo/EmIPs/blob/master/specs/emip-002.md">URI Scheme for ADA transfer</a></li>
<li><a href="https://github.com/Emurgo/EmIPs/blob/master/specs/emip-003.md">Encrypting Data With a Passphrase</a></li>
</ul>
</li>
</ul>
<h2 id="bitcoin"><a class="header" href="#bitcoin">Bitcoin</a></h2>
<ul>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP 0032 - Hierarchical Deterministic Wallets</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP 0039 - Mnemonic Code for Generating Deterministic Keys</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP 0044 - Multi-Account Hierarchy for Deterministic Wallets</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP 0173 - Base32 Address Format</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="concepts"><a class="header" href="#concepts">Concepts</a></h1>
<p>This section describes the concepts and terminology used in the Cardano Wallet API.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cardano-eras"><a class="header" href="#cardano-eras">Cardano Eras</a></h1>
<p>A blockchain &quot;hard fork&quot; is a change to the block producing software such that any new blocks produced would be invalid according to the old unchanged software. Therefore, the unchanged software would not accept these blocks into its chain. If nodes running the new and modified software continue to produce blocks on top of their chain, a &quot;fork&quot; will result, starting at the parent block of the first incompatible block.</p>
<p>Cardano manages hard forks by gating the new block generation code behind a feature flag. The network agrees upon a slot at which all nodes will enable the new block generation code. After that slot, the network is said to be operating in a new &quot;era.&quot;</p>
<p>Agreement on the slot number (epoch really) to switch to the new era happens by an on-chain voting protocol. If the voting proposal is carried, operators of nodes must ensure that their software version will be compatible with the new era, before the hard fork occurs.</p>
<h4 id="terminology"><a class="header" href="#terminology">Terminology</a></h4>
<p>One might ask why the eras listed in <a href="https://input-output-hk.github.io/cardano-node/cardano-api/lib/Cardano-Api.html">Cardano.Api</a> don't all appear in the <a href="https://roadmap.cardano.org/en/">Cardano Roadmap</a>.</p>
<p>The roadmap is actually divided into <em>phases</em>, under which one or more eras (hard forks) may occur.</p>
<h2 id="the-hard-fork-combinator"><a class="header" href="#the-hard-fork-combinator">The Hard Fork Combinator</a></h2>
<p>The mechanism whereby the Cardano Node operates in different modes - depending on which slot it is up to - is called the &quot;Hard Fork Combinator&quot;.</p>
<p>The following <a href="https://input-output.atlassian.net/wiki/spaces/EN/pages/718962750/IOHK+Research+Engineering+Seminar">seminars</a> (company internal use only) are a good introduction:</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2020/05/15</td><td><a href="https://drive.google.com/file/d/1m_jKQM_gxBm0ctLqIq9NGj5_nXPI66Su/view">Hardfork Combinator I: Reconciling The Eras</a></td><td>This session will explain the technology behind the fabled hardfork combinator for Cardano. As this is quite a bit of machinery, and central to Shelley, we will take the time to talk about it in two sessions, to give enough background that everyone can follow along. This first session will focus on the combinator itself, and how advanced Haskell features allow us to travel from one typed world to another. In a future session, which yet needs to be scheduled, he will present on the subtleties of treating time in the presence of a hardfork.</td></tr>
<tr><td>2020/06/05</td><td><a href="https://drive.google.com/file/d/1QIJ-VBlj-txB6K6E7DIEnY5TzaD89qQm/view">Hard Fork Combinator II: Time for a Hard Fork</a></td><td>As any computer scientist, physicist, or cross-timezone remote worker can testify, time is a tricky and unforgiving beast. Cardano, as a slot-based Proof of Stake system, is inherently time-driven, so it is vital to get time right. Across the hardfork from Byron to Shelley, the way in which time is divided into slots will change, which turned out to be a massive complicating factor. In this presentation, Edsko will show us how the hard fork combinator handles time across the fork point.</td></tr>
</tbody></table>
</div>
<p>In a nutshell, pretty much all types in <code>Cardano.Api</code> are indexed by the <code>Era</code>. The node will provide a <code>TimeInterpreter</code> object by the <code>LocalStateQuery</code> protocol, which allows <code>cardano-wallet</code> to calculate what time a certain slot occurs at. Calculating the time of a given slot number is more complicated than it sounds.</p>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Both <code>cardano-node</code> and <code>cardano-wallet</code> have command-line parameters and/or configuration options for the hard-fork combinator.</p>
<h3 id="genesis"><a class="header" href="#genesis">Genesis</a></h3>
<p>Nodes must be initialised with a genesis config. The genesis config defines the initial state of the chain. There is the Byron era genesis obviously, and some subsequent eras (Shelley and Alonzo, at the time of writing) also have their own genesis.</p>
<p>Only the hash of a genesis config is stored on-chain. For mainnet, the genesis hash is used as the previous block header hash for the <em>Epoch Boundary Block</em> of epoch 0.</p>
<p>When <code>cardano-wallet</code> connects to its local <code>cardano-node</code>, it must provide the Byron genesis config hash. Hashes for subsequent genesis configs are contained on-chain within the voting system update proposals.</p>
<p>For <em>mainnet</em>, we have hardcoded the genesis hash. It will never change. For <em>testnet</em>, users must supply a genesis config to the <a href="design/concepts/../user-guide/cli.html">cli</a> , so that its hash may be used when connecting to the local node.</p>
<h4 id="epoch-boundary-blocks"><a class="header" href="#epoch-boundary-blocks">Epoch Boundary Blocks</a></h4>
<p>Epoch Boundary Blocks (EBBs) only existed in the Byron era, prior to their abolition with the Shelley hard fork. Confusingly, they were also referred to as &quot;genesis&quot; blocks. The EBB is the previous block of the first block in a Byron epoch. EBBs were calculated locally on each full node of mainnet, and were never transmitted across the network between nodes.</p>
<h3 id="_instafork_-technology"><a class="header" href="#_instafork_-technology">_Instafork_™ Technology</a></h3>
<p>Hard forking to Alonzo (the latest era, at the time of writing) by natural methods requires several epochs' worth of network operation time to take effect. For disposable local testnets, this would delay startup and make our integration tests slower.</p>
<p>Therefore, <code>cardano-node</code> can be configured to hard fork itself at the start of any given epoch number, without an update proposal. It's also possible to hard fork directly into all the eras at epoch 0. This is what we use for the integration tests <code>local-cluster</code>. The <code>cardano-node</code> configuration for this is:</p>
<pre><code class="language-yaml">TestShelleyHardForkAtEpoch: 0
TestAllegraHardForkAtEpoch: 0
TestMaryHardForkAtEpoch: 0
TestAlonzoHardForkAtEpoch: 0
</code></pre>
<h3 id="historical-note-cardano-mode"><a class="header" href="#historical-note-cardano-mode">Historical note: &quot;Cardano Mode&quot;</a></h3>
<p>In theory, it is possible to run <code>cardano-node</code> in a single-era mode, where the Hard Fork Combinator is completely disabled. This is called running in Byron-only or Shelley-only mode. Then there is full &quot;Cardano Mode&quot;, which enables the Hard Fork Combinator, thereby allowing the software to pass through eras.</p>
<p>For <code>cardano-cli</code>, there are <code>--byron-mode</code>, <code>--shelley-mode</code>, and <code>--cardano-mode</code> switches, to tell the network client which mode the local node is using.</p>
<p>Cardano Mode is the default. I'm not aware of too many people using single-era modes for anything much.</p>
<h2 id="specifications"><a class="header" href="#specifications">Specifications</a></h2>
<p>Formal specifications (and the actual implementations!) for each Cardano era exist in the <a href="https://github.com/IntersectMBO/cardano-ledger">IntersectMBO/cardano-ledger</a> repo. These documents are surprisingly readable, and are our go-to source for answers about how the node operates. See the <a href="https://github.com/IntersectMBO/cardano-ledger/blob/master/README.md"><code>README.md</code></a> for links to PDFs and/or build instructions.</p>
<h3 id="decentralized-update-proposals"><a class="header" href="#decentralized-update-proposals">Decentralized Update Proposals</a></h3>
<p>The <a href="https://github.com/input-output-hk/decentralized-software-updates">input-output-hk/decentralized-software-updates</a> repo contains research materials for a <em>future</em> implementation of decentralized software updates.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="recovery-phrases"><a class="header" href="#recovery-phrases">Recovery Phrases</a></h1>
<p>Recovery phrases (also known as <em>mnemonics</em>) provide a way for humans to easily read and write down arbitrary large numbers which would otherwise be very difficult to remember.</p>
<p>They use a predefined dictionary of simple words (available in many different languages) which map uniquely back and forth to a binary code.</p>
<h2 id="seeds--entropy"><a class="header" href="#seeds--entropy">Seeds / Entropy</a></h2>
<p>The recovery phrase is normally used to encode a wallet's &quot;seed&quot; - a secret random number which is 28 decimal digits long, or more!</p>
<p>A seed is also called just <em>entropy<sup class="footnote-reference"><a href="#entropy">1</a></sup></em>, implying that it is a sequence of bytes which has been generated using high-quality randomness methods.</p>
<p>All keys belonging to a wallet
<a href="design/concepts/address-derivation.html#address-derivation">address-derivation</a>
from the wallet seed.</p>
<div class="footnote-definition" id="entropy"><sup class="footnote-definition-label">1</sup>
<p>See also the definition of &quot;entropy&quot; from
<a href="https://en.wikipedia.org/wiki/Information_theory">information theory</a>.</p>
</div>
<h2 id="encoding"><a class="header" href="#encoding">Encoding</a></h2>
<p>The process for encoding recovery phrases is described in
<a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki#Generating_the_mnemonic">BIP-0039 § <em>Generating the mnemonic</em></a>.
Below is a reformulation of this specification.</p>
<p>The allowed size of <em>entropy</em> is 96-256 bits and must be multiple of 32 bits (4 bytes).</p>
<p>A checksum is appended to the initial entropy by taking the first $|ent| / 32$ bits of the SHA-256 hash of it, where $|ent|$ designates the <em>entropy</em> size in bits.</p>
<p>Then, the concatenated result is split into groups of 11 bits, each encoding a number from 0 to 2047 serving as an index into a known dictionary (see below).</p>
<div class="table-wrapper"><table><thead><tr><th>Sentence Length</th><th>Entropy Size</th><th>Checksum Size</th></tr></thead><tbody>
<tr><td>9 words</td><td>96  bits (12 bytes)</td><td>3 bits</td></tr>
<tr><td>12 words</td><td>128 bits (16 bytes)</td><td>4 bits</td></tr>
<tr><td>15 words</td><td>160 bits (20 bytes)</td><td>5 bits</td></tr>
<tr><td>18 words</td><td>192 bits (24 bytes)</td><td>6 bits</td></tr>
<tr><td>21 words</td><td>224 bits (28 bytes)</td><td>7 bits</td></tr>
<tr><td>24 words</td><td>256 bits (32 bytes)</td><td>8 bits</td></tr>
</tbody></table>
</div>
<h2 id="dictionaries"><a class="header" href="#dictionaries">Dictionaries</a></h2>
<p>Cardano uses the same dictionaries as defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0039/bip-0039-wordlists.md">BIP-0039</a>.</p>
<h2 id="example-1"><a class="header" href="#example-1">Example</a></h2>
<p>This is an English recovery phrase, ordered left-to-right, then top-to-bottom.</p>
<pre><code>write       maid        rib
female      drama       awake
release     inhale      weapon
crush       mule        jump
sound       erupt       stereo
</code></pre>
<p>It is 15 words long, so $15\times11 = 165$ bits of information, which is split into a 160 bit seed and 5 bit checksum.</p>
<p>Using the dictionary, these words resolve to:</p>
<pre><code>2036        1072        1479
 679         529         129
1449         925        1986
 424        1162         967
1662         615        1708
</code></pre>
<p>Which is:</p>
<pre><code>Seed:
01111100111 11100100110 01111101011
01010100111 01000010001 00010000001
10110101001 01110011101 11111000010
00110101000 10010001010 01111000111
11001111110 01001100111 110101
Checksum:                     01100

Seed (base16):     fe90c2e3aa7422206d4b9df846a2453c7cfc99f5
Checksum (base16): 0c
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="master-key-generation"><a class="header" href="#master-key-generation">Master Key Generation</a></h1>
<p><em>Master key generation</em> is the process by which the wallet turns a
<a href="design/concepts/recovery-phrases.html#seeds--entropy">recovery-phrases</a>
(<em>entropy</em>) into
a secure cryptographic key. Child keys can be derived from a master key to produce
a derivation tree structure as outlined in
<a href="design/concepts/hierarchical-deterministic-wallets.html">hierarchical-deterministic-wallets</a>.</p>
<p>In Cardano, the master key generation algorithm is different depending on which style of wallet
one is considering. In each case however, the generation is a function from an initial
seed to an extended private key (<em>XPrv</em>) composed of:</p>
<ul>
<li>64 bytes: an extended Ed25519 secret key composed of:
<ul>
<li>32 bytes: Ed25519 curve scalar from which few bits have been tweaked (see below)</li>
<li>32 bytes: Ed25519 binary blob used as IV for signing</li>
</ul>
</li>
<li>32 bytes: chain code for allowing secure child key derivation</li>
</ul>
<h3 id="additional-resources"><a class="header" href="#additional-resources">Additional resources</a></h3>
<ul>
<li><a href="https://github.com/satoshilabs/slips/blob/master/slip-0010.md">SLIP 0010</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP 0032</a></li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP 0039</a></li>
<li><a href="https://tools.ietf.org/html/rfc8032#section-5.1.5">RFC 8032</a></li>
<li><a href="https://cips.cardano.org/cips/cip3/">CIP 3 — &quot;Wallet key generation&quot;</a></li>
<li><a href="https://cips.cardano.org/cips/cip1852/">CIP 1852 — &quot;HD (Hierarchy for Deterministic) Wallets for Cardano&quot;</a></li>
</ul>
<h2 id="history"><a class="header" href="#history">History</a></h2>
<p>Throughout the years, Cardano has been using different styles of HD wallets.
We categorize these wallets in the following terms:</p>
<div class="table-wrapper"><table><thead><tr><th>Wallet Style</th><th>Compatible Products</th></tr></thead><tbody>
<tr><td>Byron</td><td>Daedalus, Yoroi</td></tr>
<tr><td>Icarus</td><td>Yoroi, Trezor</td></tr>
<tr><td>Ledger</td><td>Ledger</td></tr>
</tbody></table>
</div>
<p>Each wallet is based on Ed25519 elliptic curves though differs in subtle ways
highlighted in the next sections.</p>
<h2 id="pseudo-code"><a class="header" href="#pseudo-code">Pseudo-code</a></h2>
<h3 id="byron"><a class="header" href="#byron">Byron</a></h3>
<pre><code class="language-js">function generateMasterKey(seed) {
    return hashRepeatedly(seed, 1);
}

function hashRepeatedly(key, i) {
    (iL, iR) = HMAC
        ( hash=SHA512
        , key=key
        , message=&quot;Root Seed Chain &quot; + UTF8NFKD(i)
        );

    let prv = tweakBits(SHA512(iL));

    if (prv[31] &amp; 0b0010_0000) {
        return hashRepeatedly(key, i+1);
    }

    return (prv + iR);
}

function tweakBits(data) {
    // * clear the lowest 3 bits
    // * clear the highest bit
    // * set the highest 2nd bit
    data[0]  &amp;= 0b1111_1000;
    data[31] &amp;= 0b0111_1111;
    data[31] |= 0b0100_0000;

    return data;
}
</code></pre>
<h3 id="icarus"><a class="header" href="#icarus">Icarus</a></h3>
<p><em>Icarus</em> master key generation style supports setting an extra password as an arbitrary
byte array of any size. This password acts as a second factor applied to cryptographic key
retrieval. When the seed comes from an encoded recovery phrase, the password can therefore
be used to add extra protection in case where the recovery phrase were to be exposed.</p>
<pre><code class="language-js">function generateMasterKey(seed, password) {
    let data = PBKDF2
        ( kdf=HMAC-SHA512
        , iter=4096
        , salt=seed
        , password=password
        , outputLen=96
        );

    return tweakBits(data);
}

function tweakBits(data) {
    // on the ed25519 scalar leftmost 32 bytes:
    // * clear the lowest 3 bits
    // * clear the highest bit
    // * clear the 3rd highest bit
    // * set the highest 2nd bit
    data[0]  &amp;= 0b1111_1000;
    data[31] &amp;= 0b0001_1111;
    data[31] |= 0b0100_0000;

    return data;
}
</code></pre>
<h4 id="more-info"><a class="header" href="#more-info">More info</a></h4>
<p>For a detailed analysis of the cryptographic choices and the above requirements,
have a look at: <a href="https://github.com/input-output-hk/chain-wallet-libs/blob/master/doc/CRYPTO.md#master-key-generation-to-cryptographic-key">Wallet Cryptography and Encoding</a></p>
<pre><code class="language-js">function generateMasterKey(seed, password) {
    let data = PBKDF2
        ( kdf=HMAC-SHA512
        , iter=2048
        , salt=&quot;mnemonic&quot; + UTF8NFKD(password)
        , password=UTF8NFKD(spaceSeparated(toMnemonic(seed)))
        , outputLen=64
        );

    let cc = HMAC
        ( hash=SHA256
        , key=&quot;ed25519 seed&quot;
        , message=UTF8NFKD(1) + seed
        );

    let (iL, iR) = hashRepeatedly(data);

    return (tweakBits(iL) + iR + cc);
}

function hashRepeatedly(message) {
    let (iL, iR) = HMAC
        ( hash=SHA512
        , key=&quot;ed25519 seed&quot;
        , message=message
        );

    if (iL[31] &amp; 0b0010_0000) {
        return hashRepeatedly(iL + iR);
    }

    return (iL, iR);
}

function tweakBits(data) {
    // * clear the lowest 3 bits
    // * clear the highest bit
    // * set the highest 2nd bit
    data[0]  &amp;= 0b1111_1000;
    data[31] &amp;= 0b0111_1111;
    data[31] |= 0b0100_0000;

    return data;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notes-about-bip-44"><a class="header" href="#notes-about-bip-44">Notes about BIP-44</a></h1>
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>This document gives a semi-technical overview of multi-account hierarchy for deterministic wallets, their trade-offs and limitations.</p>
<h2 id="overview-8"><a class="header" href="#overview-8">Overview</a></h2>
<p><a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP-44</a> is a standard to defines a logical hierarchy for deterministic wallets. It is constructed on top of another standard called <a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP-32</a> which describes how to create hierarchical deterministic (abbrev. HD) wallets.
In a nutshell, a HD wallet is a set of public/private key pairs that all descend from a common root key pair. The process of generating a new key pair from a parent key pair is known as <em>key derivation</em>. BIP-32 offers an approach for defining such structure by showing how to derive child keys from a parent key, an index and an elliptic curve. Cardano differs
from BIP-32 in its choice of elliptic curve (namely Curve25519) but the base principle remains the same.</p>
<p>On top of this derivation mechanism, BIP-44 defines a set of <em>5 standard levels</em> (i.e. subsequent derivation indexes) with a precise semantic. In particular:</p>
<ol>
<li>
<p>The first derivation index is called the <em>purpose</em> and is always set to <code>44'</code> to indicate that the derivation indexes must be interpreted according to BIP-44.</p>
</li>
<li>
<p>The second derivation index is called the <em>coin_type</em> and is set depending on the underlying coin. There's a <a href="https://github.com/satoshilabs/slips/blob/master/slip-0044.md">public list of registered coin types</a>. Ada is registered as <code>1815'</code>. The idea of having this second level
is to allow a wallet to use a single root key to manage assets of different kinds.</p>
</li>
<li>
<p>The third derivation index is called the <em>account</em> and is used to separate the space in multiple user entities for enhanced organization.</p>
</li>
<li>
<p>The fourth derivation index is called the <em>change</em> which is meant for distinguish addresses that need to be treated as change from those treated as deposit addresses.</p>
</li>
<li>
<p>The fifth and last index is called the <em>address</em>, which is meant to increase sequentially to generate new addresses.</p>
</li>
</ol>
<p>Each derivation level can contain up to <code>2^31 (2 147 483 648)</code> different values, which in total makes for <em>a lot</em> of possible combinations. In practice, the first two levels are always set to the same constants and the third and fourth index has a very limited range.</p>
<h2 id="address--account-discovery"><a class="header" href="#address--account-discovery">Address &amp; Account discovery</a></h2>
<p>Because it is not possible for a software to know after the facts what indexes were used to obtain a particular key pair, one needs a strategy for discovering addresses and knowing whether a given address belongs to a wallet.
A naive approach would be to generate upfront all possible addresses for a given sub-path and to perform lookups in this table. Not only would this be extremely inefficient (it would take ~4 months to generate the entire space for a <em>single</em> sub-path on a decent hardware), it would also be very much ineffective (for each address on a blockchain, one would have to lookup in an index containing more than two billion entries).</p>
<p>Instead, BIP-44 specifies a few key points that each software implementing it should follow. In particular, BIP-44 introduces the concept of a <em>gap limit</em>, which is the maximum number of <strong>consecutive</strong> unused addresses the software must keep track of at any time.</p>
<h3 id="example-2"><a class="header" href="#example-2">Example</a></h3>
<p>Let see how it works with an example in which we consider only a single derivation level (the last one) and for which the gap limit is set to <code>3</code>.</p>
<ol>
<li>
<p>A new empty wallet would be allowed to generate up to 3 addresses with index <code>0</code>, <code>1</code> and <code>2</code></p>
<pre><code>┌───┬───┬───┐
│ 0 │ 1 │ 2 │
└───┴───┴───┘
</code></pre>
</li>
<li>
<p>The wallet scans the blockchain looking for addresses which would have been generated from these indexes. An addresses is found using the index <code>i=2</code>.</p>
<pre><code>          ↓
┌───┬───┬───┐       ┌───┬───┬───┬───┬───┬───┐
│ 0 │ 1 │ 2 │   ⇒   │ 0 │ 1 │ ✓ │ 3 │ 4 │ 5 │
└───┴───┴───┘       └───┴───┴───┴───┴───┴───┘
</code></pre>
<p>By discovering an address using <code>i=2</code>, the wallet needs to generate 3 new addresses at indexes <code>i=3</code>, <code>i=4</code> and <code>i=5</code> so that it is always keeping track of 3 consecutive unused addresses.</p>
</li>
<li>
<p>The wallet continues scanning the blockchain and finds an address at index <code>i=0</code>.</p>
<pre><code>  ↓
┌───┬───┬───┬───┬───┬───┐      ┌───┬───┬───┬───┬───┬───┐
│ 0 │ 1 │ ✓ │ 3 │ 4 │ 5 │  ⇒   │ ✓ │ 1 │ ✓ │ 3 │ 4 │ 5 │
└───┴───┴───┴───┴───┴───┘      └───┴───┴───┴───┴───┴───┘
</code></pre>
<p>Because discovering the address at index <code>i=0</code> does not reduce the number of consecutive unused addresses, there's no need to generate new addresses, there are still 3 consecutive unused addresses available.</p>
</li>
<li>
<p>The wallet continues scanning the blockchain and finds an address at index <code>i=3</code></p>
<pre><code>              ↓
┌───┬───┬───┬───┬───┬───┐      ┌───┬───┬───┬───┬───┬───┬───┐
│ ✓ │ 1 │ ✓ │ 3 │ 4 │ 5 │  ⇒   │ ✓ │ 1 │ ✓ │ ✓ │ 4 │ 5 │ 6 │
└───┴───┴───┴───┴───┴───┘      └───┴───┴───┴───┴───┴───┴───┘
</code></pre>
<p>Here, we need to generate only one new address in order to maintain a number of 3 consecutive unused addresses.</p>
</li>
<li>
<p>This goes on and on until there are no more addresses discovered on-chain with indexes we know of.</p>
</li>
</ol>
<p><strong>What if there's an address with index <code>i=7</code> ?</strong></p>
<h2 id="limitations-of-bip-44"><a class="header" href="#limitations-of-bip-44">Limitations of BIP-44</a></h2>
<p>The discovery algorithm above works only because wallet software enforces and satisfies two invariants which are stated in BIP-44 as such:</p>
<ol>
<li>
<p>Software should prevent a creation of an account if a previous account does not have a transaction history (meaning none of its addresses have been used before).</p>
</li>
<li>
<p>Address gap limit is currently set to 20. If the software hits 20 unused addresses in a row, it expects there are no used addresses beyond this point and stops searching the address chain.</p>
</li>
</ol>
<p>For sequential discovery to work, one needs to fix some upper boundaries. Without such boundaries, it'd be impossible for a wallet software to know <em>when</em> to stop generating addresses. Because each software that follows BIP-44 also abides by these two rules, it generally works fine. Yet, there are some annoying consequences stemming from it:</p>
<h3 id="limit-1---unsuitable-for-exchanges"><a class="header" href="#limit-1---unsuitable-for-exchanges">Limit 1 - Unsuitable for exchanges</a></h3>
<p>Users like exchanges do typically need to generate <em>a lot</em> of unused addresses upfront that their users can use for deposit. BIP-44 is a standard that is well tailored for personal wallets, where the address space grows with the user needs. It is however a quite poor choice for exchanges who typically use a single set of root credentials for managing assets of thousands of users.</p>
<p>Possible mitigations:</p>
<ol>
<li>Exchanges could make use of a larger gap limit, violating the classic BIP-44 default but, still following the same principle otherwise. Despite being inefficient, it could work for exchanges with a limited number of users.</li>
<li>Another wallet scheme that would be better suited for exchanges should probably be considered.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="address-derivation"><a class="header" href="#address-derivation">Address Derivation</a></h1>
<h2 id="hd-random-wallets-byron--legacy"><a class="header" href="#hd-random-wallets-byron--legacy"><em>HD Random</em> wallets (Byron / Legacy)</a></h2>
<h4 id="note"><a class="header" href="#note">Note</a></h4>
<p>This scheme is an underspecified / ad-hoc scheme designed in the early eras of
Cardano. It is intrinsically entangled to the address format and relies on
the ability to embed extra pieces of information into addresses themselves in
order to perform key derivation.</p>
<p>An initial key is created using a Ed25519 cryptographic elliptic curve from a
seed (encoded in the form of mnemonic words). From this wallet Key, other keys
can be derived. We therefore define a hierarchy of depth 2, where a single root
key and derivation indexes defines a <strong>derivation path</strong>.</p>
<p>We typically represent that derivation path as follows:</p>
<pre><code>m/account_ix'/address_ix'
</code></pre>
<p>where</p>
<ul>
<li><code>m</code> refers to the root master key</li>
<li><code>/</code> symbolizes a new derivation step using a particular derivation index.</li>
<li><code>'</code> indicates that keys at this step are considered hardened keys
(private key is required to derive new keys). Indexes of hardened keys
follows a particular convention and belongs to the interval <code>[2³¹, 2³²-1]</code>.</li>
</ul>
<pre><code>+--------------------------------------------------------------------------------+
|         BIP-39 Encoded 128 bits Seed with CRC a.k.a 12 Mnemonic Words          |
|                                                                                |
|    squirrel material silly twice direct ... razor become junk kingdom flee     |
|                                                                                |
+--------------------------------------------------------------------------------+
              |
              |
              v
+--------------------------+    +-----------------------+
|    Wallet Private Key    |---&gt;|   Wallet Public Key   |    m
+--------------------------+    +-----------------------+
              |
              | account ix
              v
+--------------------------+    +-----------------------+
|   Account Private Key    |---&gt;|   Account Public Key  |    m/account_ix'
+--------------------------+    +-----------------------+
              |
              | address ix
              v
+--------------------------+    +-----------------------+
|   Address Private Key    |---&gt;|   Address Public Key  |    m/account_ix'/address_ix'
+--------------------------+    +-----------------------+
</code></pre>
<p align="center"><small>Fig 1. Byron HD Wallets Key Hierarchy</small></p>
<p>Note that wallets typically store keys in memory in an encrypted form, using an
encryption passphrase. That passphrase prevents &quot;free&quot; key manipulation.</p>
<h2 id="hd-sequential-wallets-à-la-bip-44"><a class="header" href="#hd-sequential-wallets-à-la-bip-44"><em>HD Sequential</em> wallets (à la BIP-44)</a></h2>
<p>BIP-0044 Multi-Account Hierarchy for Deterministic Wallets is a Bitcoin
standard defining a structure and algorithm to build a hierarchy tree of keys
from a single root private key. Note that this is the derivation scheme
used by Icarus / Yoroi.</p>
<p>It is built upon <a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP-0032</a> and is a direct application of
<a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki">BIP-0043</a>.
It defines a common representation of addresses as a multi-level tree of derivations:</p>
<pre><code>m / purpose' / coin_type' / account_ix' / change_chain / address_ix
</code></pre>
<p>Cardano uses an extension / variation of BIP-44 described in <a href="https://github.com/cardano-foundation/CIPs/blob/master/CIP-1852/CIP-1852.md">CIP-1852</a>.</p>
<pre><code>+--------------------------------------------------------------------------------+
|                BIP-39 Encoded Seed with CRC a.k.a Mnemonic Words               |
|                                                                                |
|    squirrel material silly twice direct ... razor become junk kingdom flee     |
|                                                                                |
+--------------------------------------------------------------------------------+
       |
       |
       v
+--------------------------+    +-----------------------+
|    Wallet Private Key    |---&gt;|   Wallet Public Key   |
+--------------------------+    +-----------------------+
       |
       | purpose (e.g. 1852')
       |
       v
+--------------------------+
|   Purpose Private Key    |
+--------------------------+
       |
       | coin type (e.g. 1815' for ADA)
       v
+--------------------------+
|  Coin Type Private Key   |
+--------------------------+
       |
       | account ix (e.g. 0')
       v
+--------------------------+    +-----------------------+
|   Account Private Key    |---&gt;|   Account Public Key  |
+--------------------------+    +-----------------------+
       |                                          |
       | chain  (e.g. 1 for change)               |
       v                                          v
+--------------------------+    +-----------------------+
|   Change Private Key     |---&gt;|   Change Public Key   |
+--------------------------+    +-----------------------+
       |                                          |
       | address ix (e.g. 0)                      |
       v                                          v
+--------------------------+    +-----------------------+
|   Address Private Key    |---&gt;|   Address Public Key  |
+--------------------------+    +-----------------------+
</code></pre>
<p align="center"><small>Fig 2. BIP-44 Wallets Key Hierarchy</small></p>
<p>Paths with a tilde <code>'</code> refer to BIP-0032 hardened derivation path (meaning that
the private key is required to derive children). This leads to a couple of
interesting properties:</p>
<ol>
<li>New addresses (change or not) can be generated from an account's public key alone.</li>
<li>The derivation of addresses can be done sequentially / deterministically.</li>
<li>If an account private key is compromised, it doesn't compromise other accounts.</li>
</ol>
<p>This allows for external key-stores and off-loading of key derivation to some
external source such that a wallet could be tracking a set of accounts without
the need for knowing private keys. This approach is discussed more in details
below.</p>
<blockquote>
<p>NOTE:
One other important aspect is more of a security-concern. The introduction of
such new address scheme makes it possible to change the underlying derivation
function to a new better one with stronger cryptographic properties. This is
rather ad-hoc to the structural considerations above, but is still a major
motivation.</p>
</blockquote>
<h3 id="differences-between-cardano-hd-sequential-and-bip-44"><a class="header" href="#differences-between-cardano-hd-sequential-and-bip-44">Differences between <em>Cardano HD Sequential</em> and <em>BIP-44</em></a></h3>
<p>In BIP-44, new derivation paths are obtained by computing points on an elliptic
curve where curve parameters are defined by secp256k1. Cardano's implementation
relies on ed25519 for it provides better properties in terms of security and
performances.</p>
<p>Also, we use <code>purpose = 1852'</code> to clearly distinguish these formats from the original BIP-44 specification. Note however that Yoroi/Icarus in the Byron era are using <code>purpose = 44'</code>.</p>
<h2 id="differences-between-hd-random-and-hd-sequential-wallets"><a class="header" href="#differences-between-hd-random-and-hd-sequential-wallets">Differences between <em>HD Random</em> and <em>HD Sequential</em> Wallets</a></h2>
<p>Because BIP-44 public keys (HD Sequential) are generated in sequence, there's
no need to maintain a derivation path in the address attributes (incidentally,
this also makes addresses more private). Instead, we can generate pools of
addresses up to a certain limit (called address gap) for known accounts and
look for those addresses during block application.</p>
<p>We end up with two kind of Cardano addresses:</p>
<div class="table-wrapper"><table><thead><tr><th>Address V1 (Hd Random)</th><th>Address V2 (Icarus, HD Sequential)</th></tr></thead><tbody>
<tr><td>Uses ed25519@V1 (buggy) curve impl for derivation</td><td>Uses ed25519@V2 curve impl for derivation</td></tr>
<tr><td>Has a derivation path attribute</td><td>Has no derivation path attribute</td></tr>
<tr><td>New address indexes are random</td><td>New address indexes are sequential</td></tr>
<tr><td>Need root private key and passphrase to create addresses</td><td>Need only parent account public key to create addresses</td></tr>
<tr><td>Root keys are obtained from 12-word mnemonic phrases</td><td>Root keys are obtained from mnemonic phrases of various length</td></tr>
</tbody></table>
</div>
<p>Although the idea behind the BIP-44 protocol is to be able to have the wallet
working in a mode where the wallet doesn't know about the private keys, we still
do want to preserve compatibility with the existing address scheme (which can't
work without knowing private keys).</p>
<p>This leaves us with three operational modes for a wallet:</p>
<ul>
<li>
<p>Compatibility Mode with private key: In this mode, addresses are derived
using the wallet root private key and the classic derivation scheme. New address
indexes are generated randomly.</p>
</li>
<li>
<p>Deterministic Mode without private key: Here, we review the definition of a
wallet down to a list of account public keys with no relationship whatsoever
from the wallet's point of view. New addresses can be derived for each account
at will and discovered using the address pool discovery algorithm described in
BIP-44. Public keys are managed and provided from an external sources.</p>
</li>
<li>
<p>Deterministic Mode with private key: This is a special case of the above. In
this mode, the wallet maintain the key hierarchy itself, and leverage the
previous mode for block application and restoration.</p>
</li>
</ul>
<p>Those operational modes are detailed in more depth here below. Note that we'll
call <em>external wallets</em> wallets who don't own their private key.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="byron-address-format"><a class="header" href="#byron-address-format">Byron Address Format</a></h1>
<h2 id="internal-structure"><a class="header" href="#internal-structure">Internal Structure</a></h2>
<pre><code>+-------------------------------------------------------------------------------+
|                                                                               |
|                        CBOR-Serialized Object with CRC¹                       |
|                                                                               |
+-------------------------------------------------------------------------------+
                                        |
                                        |
                                        v
+-------------------------------------------------------------------------------+
|     Address Root    |     Address Attributes    |           AddrType          |
|                     |                           |                             |
|   Hash (224 bits)   |  Der. Path² + Stake + NM  |  PubKey | (Script) | Redeem |
|                     |    (open for extension)   |     (open for extension)    |
+-------------------------------------------------------------------------------+
             |                 |
             |                 |     +----------------------------------+
             v                 |     |        Derivation Path           |
+---------------------------+  |----&gt;|                                  |
| SHA3-256                  |  |     | ChaChaPoly⁴ AccountIx/AddressIx  |
|   |&gt; Blake2b 224          |  |     +----------------------------------+
|   |&gt; CBOR                 |  |
|                           |  |
|  -AddrType                |  |     +----------------------------------+
|  -ASD³ (~AddrType+PubKey) |  |     |       Stake Distribution         |
|  -Address Attributes      |  |     |                                  |
+---------------------------+  |----&gt;|  BootstrapEra | (Single | Multi) |
                               |     +----------------------------------+
                               |
                               |
                               |     +----------------------------------+
                               |     |          Network Magic           |
                               |----&gt;|                                  |
                                     | Addr Discr: MainNet vs TestNet   |
                                     +----------------------------------+

</code></pre>
<ol>
<li><strong>CRC</strong>: <a href="https://computer.howstuffworks.com/encryption7.htm">Cyclic Redundancy Check</a>;
sort of checksum, a bit (pun intended) more reliable.</li>
<li><strong>ASD</strong>: Address Spending Data; Some data that are bound to an address. It's
an extensible object with payload which identifies one of the three elements:
<ul>
<li>A Public Key (Payload is thereby a PublicKey)</li>
<li>A Script (Payload is thereby a script and its version)</li>
<li>A Redeem Key (Payload is thereby a RedeemPublicKey)</li>
</ul>
</li>
<li><strong>Derivation Path</strong>: Note that there's no derivation path for Redeem nor
Scripts addresses!</li>
<li><strong>ChaChaPoly</strong>: Authenticated Encryption with Associated Data
(see <a href="https://datatracker.ietf.org/doc/rfc7539">RFC 7539</a>.
We use it as a way to cipher the derivation path using a passphrase (the root public key).</li>
</ol>
<h2 id="example-1-yoroi-address---byron-mainnet"><a class="header" href="#example-1-yoroi-address---byron-mainnet">Example 1: Yoroi Address - Byron Mainnet</a></h2>
<p>Let's take an arbitrary Yoroi base58-encoded address of the Byron mainNet:</p>
<pre><code>Ae2tdPwUPEZFRbyhz3cpfC2CumGzNkFBN2L42rcUc2yjQpEkxDbkPodpMAi
</code></pre>
<p>Now, this address could be represented as a raw bytestring by decoding from
base58:</p>
<pre><code>0X82 0XD8 0X18 0X58 0X21 0X83 0X58 0X1C 0XBA 0X97 0X0A 0XD3 0X66 0X54
0XD8 0XDD 0X8F 0X74 0X27 0X4B 0X73 0X34 0X52 0XDD 0XEA 0XB9 0XA6 0X2A
0X39 0X77 0X46 0XBE 0X3C 0X42 0XCC 0XDD 0XA0 0X00 0X1A 0X90 0X26 0XDA
0X5B
</code></pre>
<p>In this representation, bytes are in a structured format called <a href="https://tools.ietf.org/html/rfc7049">CBOR</a>.
Some bytes are actually tags which carry a particular semantic, and some are values.
We can re-shuffle the bytes as follows to make things a bit clearer:</p>
<pre><code>82                        # array (2)
   D8 18                  # tag (24)             [CBOR Metadata]
      58 21 (8358...A000) # bytes (33)           [Address Payload]
   1A 9026DA5B            # unsigned(2418465371) [CRC]
</code></pre>
<p>So, a Byron address is basically formed of two top-level elements:</p>
<ul>
<li>A tagged bytestring; <code>24</code> means that the bytes represent another CBOR-encoded structure.</li>
<li>A CRC of the inner tagged bytestring</li>
</ul>
<p>Now, if we also interpret the inner bytestring as a CBOR structure, we obtain:</p>
<pre><code>83                        # array(3)
   58 1C (BA97...CCDD)    # bytes(28)      [Address Root]
   A0                     # map(0)         [Address Attributes]
   00                     # unsigned(0)    [Address Type]
</code></pre>
<p>An address type of <code>0</code> refers to a spending address for which the address root
contains a hash of a public spending key. This address payload has no attribute
for the initial address was a Yoroi's address on MainNet which follows a BIP-44
derivation scheme and therefore, does not require any attributes.</p>
<h2 id="example-2-daedalus-address---byron-testnet"><a class="header" href="#example-2-daedalus-address---byron-testnet">Example 2: Daedalus Address - Byron TestNet</a></h2>
<p>Let's take an arbitrary Daedalus base58-encoded address of a Byron testNet:</p>
<pre><code>37btjrVyb4KEB2STADSsj3MYSAdj52X5FrFWpw2r7Wmj2GDzXjFRsHWuZqrw7zSkwopv8Ci3VWeg6bisU9dgJxW5hb2MZYeduNKbQJrqz3zVBsu9nT
</code></pre>
<p>Now, this address could be represented as a raw bytestring by decoding from
base58:</p>
<pre><code>0X82 0XD8 0X18 0X58 0X49 0X83 0X58 0X1C 0X9C 0X70 0X85 0X38 0XA7 0X63 0XFF 0X27
0X16 0X99 0X87 0XA4 0X89 0XE3 0X50 0X57 0XEF 0X3C 0XD3 0X77 0X8C 0X05 0XE9 0X6F
0X7B 0XA9 0X45 0X0E 0XA2 0X01 0X58 0X1E 0X58 0X1C 0X9C 0X17 0X22 0XF7 0XE4 0X46
0X68 0X92 0X56 0XE1 0XA3 0X02 0X60 0XF3 0X51 0X0D 0X55 0X8D 0X99 0XD0 0XC3 0X91
0XF2 0XBA 0X89 0XCB 0X69 0X77 0X02 0X45 0X1A 0X41 0X70 0XCB 0X17 0X00 0X1A 0X69
0X79 0X12 0X6C
</code></pre>
<p>In this representation, bytes are in a structured format called <a href="https://tools.ietf.org/html/rfc7049">CBOR</a>.
Some bytes are actually tags which carry a particular semantic, and some are values.
We can re-shuffle the bytes as follows to make things a bit clearer:</p>
<pre><code>82                         # array(2)
   D8 18                   # tag(24)               [CBOR Metadata]
      58 49 (8358...1700)  # bytes(73)             [Address Payload]
   1A 6979126C             # unsigned(1769542252)  [CRC]
</code></pre>
<p>So, a Byron address is basically formed of two top-level elements:</p>
<ul>
<li>A tagged bytestring; <code>24</code> means that the bytes represent another CBOR-encoded structure.</li>
<li>A CRC of the inner tagged bytestring</li>
</ul>
<p>Now, if we also interpret the inner bytestring as a CBOR structure, we obtain:</p>
<pre><code>83                                      # array(3)
   58 1C (9C70...450E)                  # bytes(28)    [Address Root]
   A2                                   # map(2)       [Address Attributes]
      01                                # unsigned(1)  [Derivation Path Attribute]
      58 1E (581C...6977)               # bytes(30)    [Derivation Path Value]
      02                                # unsigned(2)  [Network Magic Attribute]
      45 (1A4170CB17)                   # bytes(5)     [Network Magic Value]
   00                                   # unsigned(0)  [Address Type]
</code></pre>
<p>An address type of <code>0</code> refers to a spending address for which the address root
contains a hash of a public spending key. In addition, we can see that this
address has 2 attributes identified by two tags <code>01</code> for the derivation path,
and <code>02</code> for the network magic. The derivation path is an encrypted bytestring
which holds two derivation indexes for the account and address paths.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="coin-selection-1"><a class="header" href="#coin-selection-1">Coin Selection</a></h1>
<h2 id="reminder-on-utxo"><a class="header" href="#reminder-on-utxo">Reminder on UTxO</a></h2>
<p>Cardano is a crypto-currency that is UTxO-based. UTxO stands here for <em>&quot;Unspent
Transaction Output&quot;</em>. In essence, UTxOs are very similar to bank notes and we
treat them as such. Hence, it is not possible to spend a single UTxO in more
than one transaction, and, in our current implementation, it's not possible to
split a single UTxO into multiple recipients of a transaction. Note that, we
also use the term <em>coin</em> when referring to UTxO.</p>
<p>Contrary to a classic accounting model, there's no such thing as spending part
of a UTXO, and one has to wait for a transaction to be included in a block
before spending the remaining change. Similarly, one can't spend a $20 bill at
two different shops at the same time, even if it is enough to cover both
purchases — one has to wait for change from the first transaction before making
the second one. Having many available coins allow for greater concurrency
capacity. The more coins are available, the more transactions can be made at
the same time.</p>
<h3 id="what-is-coin-selection"><a class="header" href="#what-is-coin-selection">What is Coin Selection</a></h3>
<p>For every transaction, the wallet backend performs a coin selection. There are
many approaches to the problem and, many solutions. Moreover, there are a few
problematics we have to deal with when performing coin selection:</p>
<ul>
<li>
<p>A transaction has a limited size defined by the protocol. Adding inputs or
outputs to a transaction increases its size. Therefore, there's a practical
maximum number of coins that can be selected.</p>
</li>
<li>
<p>As soon as coins from a given address are spent, that address is exposed to
the public. From this follows privacy and security issues known about address
re-use.</p>
</li>
<li>
<p>In order to maintain good privacy, change outputs shouldn't be much discernible
from the actual outputs.</p>
</li>
<li>
<p>Because of the first point, a wallet needs to make sure it doesn't needlessly
fragment available UTxOs by creating many small change outputs. Otherwise, in
the long run, the wallet becomes unusable.</p>
</li>
<li>
<p>Coin selection needs to remain fairly efficient to minimize fees as much as
possible.</p>
</li>
</ul>
<p>In Cardano, the coin selection works mainly in two steps:</p>
<ol>
<li>Coins are selected randomly to cover a given amount, generating a change output that is nearly as big as the original output</li>
<li>The inputs and outputs are slightly adjusted to cover for fees</li>
</ol>
<p>Note that in case the random coin selection fails (because we couldn't reach
the target amount without exceeding the transaction max size), we fallback to
selecting UTxO from the largest first. If this fails again, it means that the
UTxOs of the wallet is too fragmented and smaller transactions have to be sent.
In practice, this shouldn't happen much as the wallet tries to get rid of the
dust (by selecting randomly, if one has many small UTxOs, a random selection
has bigger chances to contain many small UTxOs as well).</p>
<h3 id="multi-output-transactions"><a class="header" href="#multi-output-transactions">Multi-Output Transactions</a></h3>
<p>Cardano only allows a given UTXO to cover at most one single transaction
output. As a result, when the number of transaction outputs is greater than the
number of available UTXOs, the API returns a 'UTXONotEnoughFragmented' error.</p>
<p>To make sure the source account has a sufficient level of UTXO fragmentation
(i.e. number of UTXOs), the state of the UTXOs can be monitored via following wallet endpoints:</p>
<ul>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getUTxOsStatistics">UTxO Statistics</a></li>
<li><a href="https://cardano-foundation.github.io/cardano-wallet/api/edge/#operation/getWalletUtxoSnapshot">UTxO Snapshot</a></li>
</ul>
<p>The number of wallet UTXOs should be no less than the transaction outputs, and
the sum of all UTXOs should be enough to cover the total transaction amount,
including fees.</p>
<h3 id="annexes"><a class="header" href="#annexes">Annexes</a></h3>
<ul>
<li><a href="https://medium.com/@lopp/the-challenges-of-optimizing-unspent-output-selection-a3e5d05d13ef">The Challenge of Optimizing Unspent Output Selection</a></li>
<li><a href="https://iohk.io/blog/self-organisation-in-coin-selection/">Self Organisation In Coin Selection</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hierarchical-deterministic-hd-wallets"><a class="header" href="#hierarchical-deterministic-hd-wallets">Hierarchical Deterministic (HD) Wallets</a></h1>
<p>In Cardano, <em>hierarchical deterministic</em> (HD) wallets are similar to those described in
<a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki#motivation">BIP-0032</a>.</p>
<p>Deterministic wallets and elliptic curve mathematics permit schemes
where one can calculate a wallet public keys without revealing its
private keys. This permits for example a webshop business to let its
webserver generate fresh addresses (public key hashes) for each order
or for each customer, without giving the webserver access to the
corresponding private keys (which are required for spending the
received funds).  However, deterministic wallets typically consist of
a single &quot;chain&quot; of keypairs. The fact that there is only one chain
means that sharing a wallet happens on an all-or-nothing basis.</p>
<p>However, in some cases one only wants some (public) keys to be shared
and recoverable. In the example of a webshop, the webserver does not
need access to all public keys of the merchant's wallet; only to those
addresses which are used to receive customer's payments, and not for
example the change addresses that are generated when the merchant
spends money. Hierarchical deterministic wallets allow such selective
sharing by supporting multiple keypair chains, derived from a single
root.</p>
<h2 id="notation"><a class="header" href="#notation">Notation</a></h2>
<p>Conceptually, HD derivation can be seen as a tree with many branches,
where keys live at each node and leaf such that an entire sub-tree can
be recovered from only a parent key (and seemingly, the whole tree can
be recovered from the root master key).</p>
<p><a href="design/concepts/Ed25519_BIP.pdf">BIP32-Ed25519: Hierarchical Deterministic Keys over a Non-linear Keyspace</a>.
For deriving new keys from parent keys, we use the same approach as defined in</p>
<p>We note \(CKD_{priv}\) the derivation of a private child key from a parent private key such that:</p>
<p>$$
CKD_{prv}((k^P, c^P), i) → (k_i, c_i)
$$</p>
<p>We note \(CKD_{pub}\) the derivation of a public child key from a parent public key such that:</p>
<p>$$
i &lt;  2^{31}: CKD_{pub}((A^P, c^P), i) → (A_i, c_i)
$$</p>
<h3 id="note-1"><a class="header" href="#note-1">Note</a></h3>
<p>This is only possible for so-called &quot;soft&quot; derivation indexes, smaller than \(2^{31}\).</p>
<p>We note \(N\) the public key corresponding to a private key such that:</p>
<p>$$ N(k, c) → (A, c) $$</p>
<p>To shorten notation, we will borrow the same notation as described in BIP-0032
and write</p>
<p>\(CKD_{priv}(CKD_{priv}(CKD_{priv}(m,3H),2),5)\) as <code>m/3H/2/5</code>.</p>
<p>Equivalently for public keys, we write</p>
<p>\(CKD_{pub}(CKD_{pub}(CKD_{pub}(M,3),2),5)\) as <code>M/3/2/5</code>.</p>
<h3 id="path-levels"><a class="header" href="#path-levels">Path Levels</a></h3>
<p>Cardano wallet defines the following path levels:</p>
<p>$$
m / purpose_H / coin_type_H / account_H / account\_type / address\_index
$$</p>
<ul>
<li>\(purpose_H = 1852_H\)</li>
<li>\(coin\_type_H = 1815_H\)</li>
<li>\(account_H = 0_H\)</li>
<li>\(account\_type \) is either:
<ul>
<li><code>0</code> to indicate an address on the external chain, that is, an address
that is meant to be public and communicated to other users.</li>
<li><code>1</code> to indicate an address on the internal chain, that is, an address
that is meant for change, generated by a wallet software.</li>
<li><code>2</code> to indicate a reward account address, used for delegation.</li>
</ul>
</li>
<li>\(address\_index\) is either:
<ul>
<li><code>0</code> if the \(account\_type\) is <code>2</code></li>
<li>Anything between \(0\) and \(2^{31}\) otherwise</li>
</ul>
</li>
</ul>
<p>In the <em>Byron</em> era, sequential wallets used in Yoroi (a.k.a Icarus wallets) have been using $$purpose = 44_H$$ according to standard BIP-44 wallets.
The <em>Shelley</em> era introduces however an extension to BIP-44, and therefore, uses a different $purpose$ number.</p>
<h3 id="account-discovery"><a class="header" href="#account-discovery">Account Discovery</a></h3>
<p>What follows is taken from the &quot;Account Discovery&quot; section from <a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki#account-discovery">BIP-0044</a></p>
<p>When the master seed is imported from an external source the software should start to discover the accounts in the following manner:</p>
<ul>
<li>derive the first account's node (index = 0)</li>
<li>derive the external chain node of this account</li>
<li>scan addresses of the external chain; respect the gap limit described below</li>
<li>if no transactions are found on the external chain, stop discovery</li>
<li>if there are some transactions, increase the account index and go to step 1</li>
</ul>
<p>For the algorithm to be successful, software should disallow creation of new accounts if previous one has no transaction history.</p>
<p>Please note that the algorithm works with the transaction history, not account balances, so you can have an account with 0 total coins and the algorithm will still continue with discovery.</p>
<h3 id="address-gap-limit"><a class="header" href="#address-gap-limit">Address gap limit</a></h3>
<p>Address gap limit is currently set to 20. If the software hits 20 unused addresses in a row, it expects there are no used addresses beyond this point and stops searching the address chain. We scan just the external chains, because internal chains receive only coins that come from the associated external chains.</p>
<p>Wallet software should warn when the user is trying to exceed the gap limit on an external chain by generating a new address.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="transaction-lifecycle"><a class="header" href="#transaction-lifecycle">Transaction Lifecycle</a></h1>
<blockquote>
<p>This needs to be updated to include transaction resubmission by the wallet.</p>
</blockquote>
<h2 id="states"><a class="header" href="#states">States</a></h2>
<pre class="mermaid">stateDiagram
  [*] --&gt; pending: request
  [*] --&gt; in_ledger: discover
  pending --&gt; in_ledger: discover
  pending --&gt; [*]: forget
  in_ledger --&gt; pending: rollback
</pre>
<h3 id="state-transition-forget"><a class="header" href="#state-transition-forget">State transition: <code>forget</code></a></h3>
<p>Importantly, a transaction, when sent, cannot be cancelled. One can only
request forgetting about it in order to try spending (concurrently) the same
UTxO in another transaction. But, the transaction may still show up later in a
block and therefore, appear in the wallet.</p>
<h3 id="state-transition-discover"><a class="header" href="#state-transition-discover">State transition: <code>discover</code></a></h3>
<p>Discovering a transaction happens regardless of a transaction being present
or not as <code>pending</code> . Actually, only outgoing transactions are going through
the <code>pending</code> state. Incoming ones or, outgoing ones that have been forgotten
may be discovered directly in blocks.</p>
<h2 id="submission-1"><a class="header" href="#submission-1">Submission</a></h2>
<pre class="mermaid">sequenceDiagram
  participant Wallet Client
  participant Wallet Server
  participant Network

  Wallet Client -&gt;&gt;+ Wallet Server: POST payment request
  Wallet Server -&gt;&gt; Wallet Server: Select available coins
  Wallet Server -&gt;&gt; Wallet Server: Construct transaction
  Wallet Server -&gt;&gt; Wallet Server: Sign transaction
  Wallet Server --&gt;&gt; Wallet Client: 403 Forbidden
  Wallet Server -&gt;&gt;+ Network: Submit transaction

  Network -&gt;&gt; Network: Validate transaction structure
  Network --&gt;&gt; Wallet Server: (ERR) Malformed transaction
  Wallet Server --&gt;&gt; Wallet Client: 500 Internal Server Error

  Network -&gt;&gt;- Wallet Server: Accepted
  Wallet Server -&gt;&gt;- Wallet Client: 202 Accepted

  Network -&gt;&gt; Network: Broadcast transaction to peers
  loop Every block
      Network -&gt;&gt; Network: Insert or discard transaction(s)
      Network -&gt;&gt; Wallet Server: Yield new block
      Wallet Server -&gt;&gt; Wallet Server: Discover transaction(s)
  end
</pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unspent-transaction-outputs-utxo"><a class="header" href="#unspent-transaction-outputs-utxo">Unspent Transaction Outputs (UTxO)</a></h1>
<p>In a UTxO-based blockchain, a <strong>transaction</strong> is a binding between <strong>inputs</strong> and <strong>outputs</strong>.</p>
<pre><code>                  input #1  &gt;---*         *---&gt; output #1
                                \        /
                  input #2  &gt;---*--------*
                                /        \
                  input #3  &gt;---*         *---&gt; output #2
</code></pre>
<p>In a standard payment, outputs are a combination of:</p>
<ul>
<li>A value</li>
<li>A reference (a.k.a address, a &quot;proof&quot; of ownership telling <em>who</em> owns the output).</li>
</ul>
<pre><code>                input #1  &gt;---*         *---&gt; (123, DdzFFzCqr...)
                              \        /
                input #2  &gt;---*--------*
                              /        \
                input #3  &gt;---*         *---&gt; (456, hswdEoQCp...)
</code></pre>
<h3 id="about-address-encoding"><a class="header" href="#about-address-encoding">About address encoding</a></h3>
<p>We usually represent addresses as encoded text strings. An address has a structure
and a binary representation that is defined by the underlying blockchain. Yet, since
they are often used in user-facing interfaces, addresses are usually encoded in a
human-friendly format to be easily shared between users.</p>
<p>An <em>address</em> <strong>does not</strong> uniquely identify an output. As a matter of fact, multiple
transactions could send funds to a same output address! We can however uniquely identify
an output by:</p>
<ul>
<li>Its host transaction id</li>
<li>Its index within that transaction</li>
</ul>
<p>This combination is also called an <strong>input</strong>. Said differently, inputs are
outputs of previous transactions.</p>
<pre><code>                 *---------------- tx#42 ----------------------*
                 |                                             |
 (tx#14, ix#2) &gt;-----------------*       *--&gt; (123, DdzFFqr...)--- (tx#42, ix#0)
                 |               \      /                      |
 (tx#41, ix#0) &gt;-----------------*-----*                       |
                 |               /      \                      |
 (tx#04, ix#0) &gt;----------------*        *--&gt; (456, hswdQCp...)--- (tx#42, ix#1)
                 |                                             |
                 *---------------------------------------------*

</code></pre>
<p>Therefore, new transactions spend outputs of previous transactions, and produce
new outputs that can be consumed by future transactions. An unspent transaction
output (i.e. not used as an input of any transaction) is called a <strong>UTxO</strong> (as
in <strong>U</strong>nspent <strong>Tx</strong> <strong>O</strong>utput) and represents an amount of money owned by a
participant.</p>
<h2 id="faq-1"><a class="header" href="#faq-1">FAQ</a></h2>
<h3 id="where-does-the-money-come-from-how-do-i-make-the-first-transaction"><a class="header" href="#where-does-the-money-come-from-how-do-i-make-the-first-transaction">Where does the money come from? How do I make the first transaction?</a></h3>
<p>When bootstrapping a blockchain, some initial funds can be distributed among
an initial set of stakeholders. This is usually the result of an <strong>I</strong>nitial
<strong>C</strong>oin <strong>O</strong>ffering or, an agreement between multiple parties. In practice
it means that, the genesis block of a blockchain may already contain some
UTxOs belonging to various stakeholders.</p>
<p>Beside, core nodes running the protocol and producing blocks are allowed to
insert in every block minted (resp. mined) called a <strong>coinbase</strong> transaction.
This transaction has no inputs but follows specific rules fixed by the
protocol and is used as an incentive to encourage participants to engage in
the protocol.</p>
<h3 id="what-is-the-difference-between-an-address-and-a-public-key"><a class="header" href="#what-is-the-difference-between-an-address-and-a-public-key">What is the difference between an address and a public key?</a></h3>
<p>In a very simple system that would only support payment transactions, public key
could be substituted for addresses. In practice, addresses are meant to hold some
extra pieces of information that are useful for other aspects of the protocol.
For instance, in Cardano in the Shelley era, addresses may also contain:</p>
<ul>
<li>
<p>A network discriminant tag, to distinguish addresses between a testNet and the
MainNet and avoid unfortunate mistakes.</p>
</li>
<li>
<p>A stake reference to take part in delegation.</p>
</li>
</ul>
<p>Addresses may also be used to trigger smart contracts, in which case, they'll
refer to a particular script rather than a public key.</p>
<p>In a nutshell, a public key is a piece of information that enables a stakeholder to
prove one owns a particular UTxO. Whereas an address is a data-structure which contain various
pieces of information, for example, a (reference to a) public key.</p>
<h3 id="what-are-cardano-addresses-made-of"><a class="header" href="#what-are-cardano-addresses-made-of">What are Cardano addresses made of?</a></h3>
<p>See:</p>
<ul>
<li><a href="design/concepts/byron-address-format.html">Byron Address Formatt</a></li>
<li><a href="https://github.com/input-output-hk/implementation-decisions/blob/master/text/0001-address.md">Shelley Address Format</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="specifications-1"><a class="header" href="#specifications-1">Specifications</a></h1>
<p>Precise specifications for</p>
<ul>
<li>Parts of the wallet API</li>
<li>Data structures used in the wallet</li>
</ul>
<p>Additional information:</p>
<ul>
<li><a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/specifications/wallet/formal-specification-for-a-cardano-wallet.pdf">Formal Specification for a Cardano Wallet</a></li>
<li><a href="https://cips.cardano.org/">Cardano Improvement Proposals (CIPs)</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wallet-identifiers-walletid"><a class="header" href="#wallet-identifiers-walletid">Wallet Identifiers (WalletId)</a></h1>
<p>The <code>WalletId</code> is a hexadecimal string derived from the wallet's mnemonic.</p>
<p>It is used by the <code>cardano-wallet</code> server to refer to specific wallets.</p>
<p>For all wallet types, the <code>WalletId</code> is a <em>blake2b-160</em> hash of
something. This hash function produces a 20-byte digest, which becomes
40 hexadecimal digits.</p>
<h2 id="shelley-wallets-1"><a class="header" href="#shelley-wallets-1">Shelley Wallets</a></h2>
<p>The <code>WalletId</code> is calculated the same way for shared (multi-sig) and non-shared Shelley wallets.</p>
<p>Therefore, each signer in a shared wallet will have a unique <code>WalletId</code>, because they have a different mnemonic.</p>
<h3 id="full-wallets-the-default"><a class="header" href="#full-wallets-the-default">Full Wallets (the default)</a></h3>
<p>The extended private key is derived from the mnemonic, and then its public key is hashed to produce the <code>WalletId</code>.</p>
<p>$$WalletId = \mathrm{base16}(\mathrm{blake2b_{160}}(\mathrm{xpub}(rootXPrv)))$$</p>
<h3 id="single-account-wallets"><a class="header" href="#single-account-wallets">Single Account Wallets</a></h3>
<p>These are wallets for which only an account-level XPrv or XPub is known.</p>
<p>$$WalletId = \mathrm{base16}(\mathrm{blake2b_{160}}(accountXPub))$$</p>
<h2 id="byron-wallets-1"><a class="header" href="#byron-wallets-1">Byron Wallets</a></h2>
<p>The <code>WalletId</code> comes from the extended public key of the wallet root key.</p>
<p>$$WalletId = \mathrm{base16}(\mathrm{blake2b_{160}}(\mathrm{xpub}(rootXPrv)))$$</p>
<h2 id="example-code"><a class="header" href="#example-code">Example code</a></h2>
<p>This shell script will produce a Shelley <code>WalletId</code> from the mnemonic words provided on stdin.</p>
<pre><code class="language-bash">#!/usr/bin/env bash

xargs \
  | cardano-address key from-recovery-phrase Shelley \
  | cardano-address key public --with-chain-code \
  | bech32 \
  | xxd -r -p \
  | b2sum -b -l 160 \
  | cut -d' ' -f1
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prototypes"><a class="header" href="#prototypes">Prototypes</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="specification-light-mode-for-cardano-wallet"><a class="header" href="#specification-light-mode-for-cardano-wallet">Specification: Light mode for cardano-wallet</a></h1>
<p>11th Feb 2022</p>
<p>Status: DRAFT</p>
<h1 id="synopsis"><a class="header" href="#synopsis">Synopsis</a></h1>
<p>This document specifies a light-mode for <code>cardano-wallet</code>.
This mode aims to make synchronisation to the blockchain faster by trusting an off-chain source of aggregated blockchain data.</p>
<p>Light wallets often employ this strategy of using a less trusted data source; for example the <a href="https://namiwallet.io">Nami</a> wallet uses <a href="http://blockfrost.io">Blockfrost</a> as data source. The purpose of the light-mode of <code>cardano-wallet</code> is to make this &quot;trust vs speed&quot; trade-off readily available to downstream software such as <a href="https://daedaluswallet.io">Daedalus</a> with <em>minimal</em> changes to its downstream API.</p>
<p>In addition, the &quot;trust versus speed&quot; trade-off will be partially obsoleted by <a href="https://iohk.io/en/research/library/papers/mithrilstake-based-threshold-multisignatures/">Mithril</a> technology, which aims to give us &quot;trust <em>and</em> speed&quot; by providing verified ledger state data as opposed to block data. The act of implementing light-mode in <code>cardano-wallet</code> does not only offer immediate benefits, but will, in fact, partially prepare the codebase for Mithril technology.</p>
<h1 id="motivation"><a class="header" href="#motivation">Motivation</a></h1>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>As the Cardano blockchain grows in size, retrieving and verifying blocks from the consensus network becomes increasingly time consuming. By making a &quot;trust versus speed&quot; trade-off, we can significantly decrease synchronization times.</p>
<h2 id="user-visible-benefits"><a class="header" href="#user-visible-benefits">User-visible benefits</a></h2>
<ul>
<li>Allow users to operate their wallet without needing to wait for the node to download and validate the entire blockchain.</li>
<li>Allow users to run cardano-wallet and Daedalus on systems with significantly less than 8GB of memory and less than 10GB of disk space.</li>
<li>Allow users to control where they sit on the trust vs convenience spectrum, depending upon their current circumstances.</li>
</ul>
<h2 id="technical-benefits"><a class="header" href="#technical-benefits">Technical benefits</a></h2>
<ul>
<li><em>Speed</em>. With light-mode, we expect synchronisation times of &lt; 1 minute for a wallet with 1'000 transactions. In contrast, synchronisation of an empty wallet currently takes ~ 50 minutes by connecting to a node — assuming that the node has already synced to the chain tip and built its ledger state, which itself takes hours.</li>
<li><em>Compatibility</em>. Light-mode is intended to preserve the API presented to downstream software such as <a href="https://daedaluswallet.io">Daedalus</a>, only <em>minimal</em> changes are expected.</li>
<li><em>Optionality</em>. A wallet that was started in light-mode can be restarted in full mode without resynchronization, and vice versa. (MVP: no support yet for changing the mode dynamically while the wallet is running.)</li>
</ul>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<ul>
<li><em>Trust</em>. The external data source does <em>not</em> provide the same level of protection against <em>omission</em> of transactions as the Proof-of-Stake consensus protocol.</li>
<li><em>Privacy</em>. In addition to the reduction of trust in the blockchain data, we now also reveal private information about addresses belonging to a single wallet.</li>
<li><em>Address schemes</em>. Only <em>Shelley</em> wallets with <em>sequential address discovery</em> can be supported.</li>
</ul>
<p>However, these limitations are shared by all existing light wallets. In fact, some light wallets only provide <em>single-address</em> wallets, which is an additional reduction of privacy.</p>
<h1 id="specification"><a class="header" href="#specification">Specification</a></h1>
<h2 id="overview-9"><a class="header" href="#overview-9">Overview</a></h2>
<p>The implementation of light-mode is based on an efficient query <code>Address -&gt; Transactions</code> which the blockchain data source provides. This query is useful to wallets that use <em>sequential address discovery</em> (Shelley wallets). These wallets work with a sequence of potential addresses <code>addr_0</code>, <code>addr_1</code>, <code>addr_2</code>, …. For each integer <code>n</code>, there is a deterministic procedure for generating the corresponding address <code>addr_n</code>. The wallet generates the first few addresses in this sequence and uses the above query to retrieve the corresponding transactions. When no transactions are found for <code>g</code> (&quot;address gap&quot;) many consecutive addresses, the procedure stops — as the wallet never puts addresses with higher indices on the chain. In other words, this iterative loop yields all transactions that belong to the wallet.</p>
<p>This procedure can be visualized in a flow chart:</p>
<pre class="mermaid">flowchart TB
  start([begin]) --&gt; init[j := 0\ng := 0\ngap := 20]
  init --&gt; query[query addr_j]
  query --&gt; tx{transactions?}
  tx -- no --&gt; gapAdd[g := g+1]
  gapAdd --&gt; g{g &gt; gap?}
  tx -- yes --&gt; gapReset[g := 0]
  gapReset --&gt; add[j := j+1]
  g -- yes ----&gt; e([end])
  g -- no --&gt; add
  add --&gt; query
</pre>
<p>This procedure is implemented and demonstrated in the <code>light-mode-test</code> prototype.</p>
<h2 id="functionality"><a class="header" href="#functionality">Functionality</a></h2>
<h3 id="network-topology"><a class="header" href="#network-topology">Network topology</a></h3>
<p>In full-node mode, <code>cardano-wallet</code> connects to a local <code>cardano-node</code>:</p>
<pre class="mermaid">flowchart TB
  subgraph local system
    cardano-launcher -. spawns .-&gt; cardano-wallet
    cardano-launcher -. spawns .-&gt; cardano-node
    cardano-wallet -- ChainSync --&gt; cardano-node
    cardano-wallet -- LocalTxSubmission --&gt; cardano-node
    cardano-wallet -- LocalStateQuery --&gt; cardano-node
  end
  cardano-node -- syncs --&gt; blockchain
  subgraph internet
    blockchain
  end
</pre>
<p>In light-mode, <code>cardano-wallet</code> instead connects to the data source (e.g. <code>cardano-graphql</code> or <a href="http://blockfrost.io">Blockfrost</a>) and a transaction submission service through the internet</p>
<pre class="mermaid">flowchart TB
  cardano-launcher -. spawns .-&gt; cardano-wallet
  cardano-wallet -- query\nAddressTransactions --&gt; cardano-graphql
  cardano-wallet -- TxSubmission --&gt; cardano-submit-api

  subgraph local system
    cardano-launcher
    cardano-wallet
  end

  subgraph internet
    cardano-graphql --&gt; n1[cardano-node]
    cardano-submit-api --&gt; n2[cardano-node]
    n1 -- syncs --&gt; blockchain
    n2 -- syncs --&gt; blockchain
  end
</pre>
<h3 id="command-line"><a class="header" href="#command-line">Command line</a></h3>
<p>The <code>cardano-wallet</code> executable will feature a new flag <code>--light</code> which indicates that the executable is to be started in light-mode:</p>
<pre><code>$ cardano-wallet serve --light CRED
</code></pre>
<ul>
<li><code>CRED</code> specifies how to connect to the less trusted blockchain data source. (MVP: Use <a href="http://blockfrost.io">Blockfrost</a>; <code>CRED</code> is a filepath to the secret token.)</li>
<li>The <code>--light</code> argument and the <code>--node-socket</code> arguments are mutually exclusive with each other.</li>
</ul>
<h3 id="rest-api"><a class="header" href="#rest-api">REST API</a></h3>
<p>When the executable was started in light-mode:</p>
<ul>
<li>The endpoints in the hierarchy <code>/v2/byron-wallets/*</code> MUST return an error. Because byron wallets use random derivation indices to generate addresses, they are significantly more challenging to make a light wallet for.</li>
<li>(MVP: The endpoints in the hierarchy <code>/v2/shared-wallets/*</code> MAY return an error.)</li>
<li>The <code>GET /v2/network/information</code> endpoint MAY not return <code>sync_progress</code> as a percentage quantity from [0..100].</li>
</ul>
<h2 id="internal-1"><a class="header" href="#internal-1">Internal</a></h2>
<p>See also the <code>light-mode-test</code> prototype!</p>
<ul>
<li>
<p>Collect required queries on data source in a data type <code>LightLayer</code>. In this way, we can replace the data source with a mock data source and run property tests on the chain following logic. (MVP: Use <a href="http://blockfrost.io">Blockfrost</a> for demonstration purposes.)</p>
</li>
<li>
<p>Provide second implementation of <code>NetworkLayer</code> using a <code>LightLayer</code>.</p>
<ul>
<li>See prototype for details! Important changes:</li>
<li><code>watchTip</code> requires polling (2 seconds interval)</li>
<li><code>currentNodeEra</code> may require hard-coding known eras.</li>
<li><code>performanceEstimate</code> requires copying from ledger code.</li>
<li><code>syncProgress</code> should be ignored for MVP.</li>
<li>The node-mode <code>NetworkLayer</code> does a lot of caching, we should avoid that for now and instead add a more uniform caching system later  through a function <code>addCaches :: NetworkLayer -&gt; IO NetworkLayer</code>.</li>
<li><code>postTx</code> submits a transaction to a web service instead of using the <code>LocalTxSubmission</code> protocol with cardano-node. This web service can be different from the blockchain data source. An example of such a service is <code>cardano-submit-api</code>.</li>
</ul>
</li>
<li>
<p>New data type</p>
<pre><code class="language-haskell">data BlockSummary m = BlockSummary
    { from  :: ChainPoint
    , to    :: ChainPoint
    , query :: Address -&gt; m [Transaction]
    }
</code></pre>
<ul>
<li>
<p>consumed by <code>applyBlocks</code>. Adapt <code>discoverTransactions</code> from the prototype.</p>
</li>
<li>
<p>produced by <code>NetworkLayer</code>. Adapt <code>lightSync</code> from the prototype.</p>
</li>
<li>
<p>Idea: Use an additional GADT wrapper to specialize <code>applyBlocks</code> to sequential address states:</p>
<pre><code class="language-haskell">    data BlockData m s where
        List
            :: NonEmpty Block
            -&gt; BlockData m s
        Summary
            :: BlockSummary m
            -&gt; BlockData m (SeqState n k)
</code></pre>
<p>By using this type as argument to <code>applyBlocks</code>, we are guaranteed that <code>BlockSummary</code> is only used in conjunction with sequential state. Caveat: It would be better if we could avoid parametrizing the <code>NetworkLayer</code> type with the address discovery state <code>s</code>.</p>
</li>
</ul>
</li>
</ul>
<h2 id="quality-assurance"><a class="header" href="#quality-assurance">Quality assurance</a></h2>
<h3 id="benchmarks"><a class="header" href="#benchmarks">Benchmarks</a></h3>
<ul>
<li>Compare restoration times for an empty wallet in node-mode and in light-mode. The existing nightly wallet restoration benchmark can be updated for this purpose.</li>
<li>Number of requests that we make to the data source needs to be monitored / kept in check. The number of requests should scale linearly with the number of transactions and the number of addresses belonging to the wallet. If the data source supports aggregated queries, we can make a single request with a larger body.</li>
</ul>
<h3 id="testing"><a class="header" href="#testing">Testing</a></h3>
<ul>
<li>Mock implementation of <code>LightLayer</code>.
<ul>
<li>We probably won't get good value / work out of implementing a <code>LightLayer</code> that interacts with the local cluster. One could look into implementing the light-mode <code>NetworkLayer</code> in terms of the node-mode <code>NetworkLayer</code>, though.</li>
</ul>
</li>
<li>Property tests for <code>applyBlocks</code> using <code>BlockSummary</code>
<ul>
<li>Implement a conversion function <code>summarize :: NonEmpty Block -&gt; BlockSummary Identity</code></li>
<li>Create a list of blocks, apply <code>applyBlocks</code> to both the list directly, and to the result of <code>summarize</code> — the results should be equal.</li>
</ul>
</li>
</ul>
<h2 id="external"><a class="header" href="#external">External</a></h2>
<ul>
<li>
<p><a href="https://github.com/IntersectMBO/cardano-launcher">Cardano-launcher</a> will have to be modified to not launch the <code>cardano-node</code> process when the cardano-wallet is launched in light-mode.</p>
</li>
<li>
<p>Provision of the data source and of the transaction submission service is outside the scope of light-mode; we assume these services will be operated and paid for by someone. (Any light wallet assumes this.) In the MVP, we use <a href="http://blockfrost.io">Blockfrost</a> for demonstration purposes.</p>
</li>
</ul>
<h1 id="design-alternatives"><a class="header" href="#design-alternatives">Design alternatives</a></h1>
<h2 id="byron-wallets-2"><a class="header" href="#byron-wallets-2">Byron wallets</a></h2>
<p>Byron wallets cannot be supported by the light-mode as described above, as it is based on an efficient query <code>Address -&gt; Transactions</code> which Byron wallets cannot take advantage of. For these wallets, alternative designs would have to be explored. Possibilities include:</p>
<ul>
<li>A third-party byron <em>address discovery service</em> which takes a byron root XPub and sends back a list of addresses belonging to that wallet. However, that involve an additional reduction in trust.</li>
<li>Existing Byron wallets can be <em>partially supported</em> in light-mode as long as the database of addresses generated/discovered so far is intact, as we can still retrieve the balance and all transactions. However, in light-mode, these wallets cannot be restored and cannot receive funds from newly generated addresses. Conversion to Shelly wallets is recommended.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributor-manual"><a class="header" href="#contributor-manual">Contributor Manual</a></h1>
<p>Information about how to contribute code to the wallet.</p>
<p>This includes:</p>
<ul>
<li>
<p>Information about our <strong>code</strong> (&quot;what&quot;). This includes information about</p>
<ul>
<li>coding style,</li>
<li>libraries, and</li>
<li>tools</li>
</ul>
<p>that we use, and which are not specific to our problem domain.</p>
</li>
<li>
<p>Information about our <strong>processes</strong> (&quot;how&quot;), such as how we</p>
<ul>
<li>do continuous integration, or</li>
<li>make releases.</li>
</ul>
</li>
<li>
<p>Notes about various topics that might be useful.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what--code-and-languages"><a class="header" href="#what--code-and-languages">What – Code and Languages</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building"><a class="header" href="#building">Building</a></h1>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p><code>cardano-wallet</code> uses the following Haskell build tool versions.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th><strong>Supported version</strong></th><th><strong>Dependency?</strong></th></tr></thead><tbody>
<tr><td><a href="https://www.haskell.org/downloads/">ghc</a></td><td>== 9.2.8</td><td>Required</td></tr>
<tr><td><a href="https://www.haskell.org/cabal/download.html">cabal</a></td><td>&gt;= 3.4.0.0</td><td>Required</td></tr>
<tr><td><a href="https://cardano-foundation.github.io/cardano-wallet/contributor/what/nix.html">Nix</a></td><td>&gt;= 2.5.1</td><td>Optional</td></tr>
</tbody></table>
</div>
<h2 id="cabal"><a class="header" href="#cabal">Cabal</a></h2>
<p><strong>Note:</strong> the Cabal build is checked by <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/.buildkite/nightly.yml">Buildkite</a>.</p>
<ol>
<li>
<p>Update your Hackage index (this may take a while):</p>
<pre><code class="language-console">&gt; cabal update
</code></pre>
</li>
</ol>
<div id="admonition-warning" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="contributor/what/building.html#admonition-warning"></a></p>
</div>
<div>
<p>Don't skip this, otherwise there may be
warnings from Cabal about index states, or some packages will
fail to build.</p>
</div>
</div>
<ol start="2">
<li>
<p>Build the project packages:</p>
<pre><code class="language-console">&gt; cabal build all
</code></pre>
</li>
<li>
<p>Run the freshly-built <code>cardano-wallet</code> executable.</p>
<p>As an example, this will show the help page:</p>
<pre><code class="language-console">&gt; cabal run cardano-wallet-api:exe:cardano-wallet -- --help
</code></pre>
</li>
<li>
<p>Make a build with <code>-O2</code> level compiler optimizations:</p>
<pre><code class="language-console">&gt; cabal build cardano-wallet-api:exe:cardano-wallet -frelease
</code></pre>
</li>
<li>
<p>Build and run the test suites or benchmarks.</p>
<p>First, enable tests and benchmarks:</p>
<pre><code class="language-console">&gt; cabal configure --enable-tests --enable-benchmarks
</code></pre>
<p>To run one of the unit test suites:</p>
<pre><code class="language-console">&gt; cabal run cardano-wallet-unit:test:unit
</code></pre>
<p>To run the DB benchmark:</p>
<pre><code class="language-console">&gt; cabal run cardano-wallet-benchmarks:bench:db
</code></pre>
<p>To run the integration test suite:</p>
<pre><code class="language-console">&gt; cabal run cardano-wallet-integration:test:integration
</code></pre>
</li>
<li>
<p>Install binaries from <code>./dist-newstyle/</code> into a system location:</p>
<pre><code class="language-console">&gt; cabal install --install-method=copy --installdir=/usr/local/bin
</code></pre>
</li>
</ol>
<h2 id="nix"><a class="header" href="#nix">Nix</a></h2>
<p>Use the <a href="https://cardano-foundation.github.io/cardano-wallet/contributor/what/nix.html">Nix</a> build if:</p>
<ol>
<li>You don't have Haskell development tools installed, but you do have
Nix installed.</li>
<li>You would like to cross-compile a build for Windows, or run the
tests under Wine.</li>
<li>You would like to quickly grab a build of another branch from the
Hydra cache, without needing to build it yourself.</li>
</ol>
<p>Follow the instructions on the <a href="https://cardano-foundation.github.io/cardano-wallet/contributor/what/nix.html">Nix</a> page to install and configure Nix.</p>
<div id="admonition-warning-1" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="contributor/what/building.html#admonition-warning-1"></a></p>
</div>
<div>
<p>Make sure that you have set up the <strong>binary cache for Haskell.nix</strong>,
<a href="https://input-output-hk.github.io/haskell.nix/tutorials/getting-started#setting-up-the-binary-cache">according to the instructions</a>,
or you <strong>will</strong> wait a long time building multiple copies of GHC.
If Nix builds GHC, this is an indication that the cache
has not been set up correctly.</p>
</div>
</div>
<p>To build the wallet for your current platform:</p>
<pre><code>&gt; nix build
</code></pre>
<p>The resulting executable will appear at <code>./result/bin/cardano-wallet</code>.</p>
<p>Unless you have local changes in your git repo, Nix will download the
build from a nix cache rather than building locally.</p>
<p>You may also run the executable directly with:</p>
<pre><code class="language-console">&gt; nix run . -- &lt;cardano wallet arguments&gt;
</code></pre>
<p>or more comfortably, for pre-configured networks (<code>mainnet</code>, <code>testnet</code>, ...):</p>
<pre><code class="language-console">&gt; CARDANO_NODE_SOCKET_PATH=../cardano-node/node.socket

&gt; nix run .#mainnet/wallet -- &lt;optional additional cardano wallet arguments&gt;
</code></pre>
<p>You can run the integration tests with:</p>
<pre><code class="language-console">&gt; nix build -L .#ci.x86_64-linux.tests.run.integration
</code></pre>
<h4 id="cross-compiling-with-nix"><a class="header" href="#cross-compiling-with-nix">Cross-compiling with Nix</a></h4>
<p>To build the wallet for Windows, from <strong>Linux</strong>:</p>
<pre><code>&gt; nix build .#ci.artifacts.win64.release
</code></pre>
<h4 id="building-straight-from-github"><a class="header" href="#building-straight-from-github">Building straight from GitHub</a></h4>
<p>The following command will build the <code>master</code> branch, with the resulting executable appearing at <code>./result/bin/cardano-wallet</code>. To build another branch, add <code>/&lt;branch name, tag, or commit hash&gt;</code> (see <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake.html#flake-references">Nix Manual: Flake References</a> for syntax). As before, if the target ref has already been built by Hydra, then it will be fetched from cache rather than built locally.</p>
<pre><code class="language-console">&gt; nix build github:cardano-foundation/cardano-wallet
&gt; ./result/bin/cardano-wallet version
v2022-01-18 (git revision: ce772ff33623e2a522dcdc15b1d360815ac1336a)
</code></pre>
<h4 id="cabalnix-build"><a class="header" href="#cabalnix-build">Cabal+Nix build</a></h4>
<p>Use the Cabal+Nix build if you want to develop with incremental
builds, but also have it automatically download cached builds of
all dependencies.</p>
<p>If you run <code>nix develop</code>, it will start a
<a href="https://input-output-hk.github.io/haskell.nix/user-guide/development/">development environment</a>
for <code>cardano-wallet</code>. This will contain:</p>
<ul>
<li><code>cabal-install</code> and a GHC configured with a package database containing all Haskell package dependencies;</li>
<li>system library dependencies;</li>
<li>a Hoogle index and <code>hoogle</code> command for searching documentation;</li>
<li>development tools such as <code>haskell-language-server</code>, <code>hlint</code>, <code>stylish-haskell</code>, and <code>weeder</code>;</li>
<li>the <code>sqlite3</code> command;</li>
<li>the Shelley node backend <code>cardano-node</code> and <code>cardano-cli</code>; and</li>
<li>other Adrestia utility programs such as <code>cardano-address</code> and <code>bech32</code></li>
</ul>
<p>Inside this shell you can use <code>cabal build</code> and <code>ghci</code> for development.</p>
<p>For example, you might start an incremental build of the integration test suite with:</p>
<pre><code class="language-console">ghcid -c &quot;cabal repl test:integration&quot;
</code></pre>
<p>and run the test suite with:</p>
<pre><code class="language-console">cabal run test:integration
</code></pre>
<h5 id="profiling-build-with-cached-dependencies"><a class="header" href="#profiling-build-with-cached-dependencies">Profiling build with cached dependencies</a></h5>
<p>Use <code>nix develop .#profiled</code> to get a shell where Haskell
dependencies are built with profiling enabled. You won't need to
rebuild all of the dependencies because they can be downloaded from
the Hydra cache.</p>
<pre><code class="language-console">&gt; nix develop .#profiled

[nix-shell:~/iohk/cardano-wallet]$ cabal build \
    --enable-tests --enable-benchmarks \
    --enable-profiling \
    all
</code></pre>
<h2 id="haskell-language-server"><a class="header" href="#haskell-language-server">Haskell-Language-Server</a></h2>
<p>The <a href="https://haskell-language-server.readthedocs.io/en/latest/">haskell-language-server</a> provides an IDE for developers with some typical features:</p>
<ul>
<li>Jump to definition.</li>
<li>Find references.</li>
<li>Documentation on hover.</li>
<li>etc.</li>
</ul>
<h3 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h3>
<p>The following must be installed:</p>
<ul>
<li><a href="https://direnv.net/">direnv</a></li>
<li><a href="https://github.com/nix-community/nix-direnv">nix-direnv</a></li>
</ul>
<p>We do not require a special version per-project so these executables can be installed system-wide.</p>
<p>Additionally, the following tools are provided by the cardano-wallet nix development shell:</p>
<ul>
<li><a href="https://github.com/haskell/hie-bios">hie-bios</a></li>
<li><a href="https://haskell-language-server.readthedocs.io/en/latest/">haskell-language-server</a></li>
</ul>
<p>We require a particular version of each per-project, so it's recommended to use the nix development environment to ensure you have the correct version.</p>
<p>In these instructions we enter a nix development environment using <code>direnv allow</code> rather than <code>nix develop</code> or <code>nix-shell</code> (see <a href="contributor/what/building.html#editor-setup">Editor Setup</a>).</p>
<h3 id="setup"><a class="header" href="#setup">Setup</a></h3>
<p><strong>haskell-language-server</strong> requires some priming to work with <em>cardano-wallet</em>:</p>
<pre><code># Symlink hie.yaml to hie-direnv.yaml, which is the project configuration for haskell-language-server
ln -sf hie-direnv.yaml hie.yaml

# Build and cache the nix development environment
direnv allow

# Generate a build plan
cabal configure --enable-tests --enable-benchmarks -O0

# Build entire project
cabal build all
</code></pre>
<p>This will prime <strong>haskell-language-server</strong> to work with all modules of the project (tests, benchmarks, etc.) and be fully featured. Without these steps, <strong>haskell-language-server</strong> may fail to:</p>
<ul>
<li>Find auto-generated modules (such as Paths_* modules).</li>
<li>Navigate across projects (jump-to-definition).</li>
<li>Provide documentation on hover.</li>
</ul>
<h3 id="testing-1"><a class="header" href="#testing-1">Testing</a></h3>
<p>To test the <strong>haskell-language-server</strong>, use the following commands (these should be in your $PATH because you executed <code>direnv allow</code> previously, or have entered a nix development environment):</p>
<pre><code>hie-bios check lib/wallet/src/Cardano/Wallet.hs
haskell-language-server lib/wallet/exe/cardano-wallet.hs
</code></pre>
<p>Occasionally <code>hie-bios</code> will fail with a <code>Segmentation Fault</code>. In these cases just run <code>hie-bios</code> again.</p>
<p>Note that these commands will only test a couple of files. To test the whole project, see <a href="contributor/what/building.html#troubleshooting">Troubleshooting</a>.</p>
<h3 id="editor-setup"><a class="header" href="#editor-setup">Editor Setup</a></h3>
<p>With a working installation of <strong>haskell-language-server</strong>, we can integrate with our IDE of choice. See <a href="https://haskell-language-server.readthedocs.io/en/latest/configuration.html#configuring-your-editor">Configuring Your Editor</a>.</p>
<p>IMPORTANT: you need to ensure that your editor invokes the same version of <strong>haskell-language-server</strong> that we have configured above. A simple way to do that is to launch your editor from within a nix development environment (e.g. <code>nix develop --command 'vim'</code>), or, more practically, to configure your editor with <code>direnv</code> support. Here are some examples:</p>
<ul>
<li><a href="https://github.com/direnv/direnv.vim">direnv.vim</a></li>
<li><a href="https://github.com/wbolster/emacs-direnv">emacs-direnv</a></li>
</ul>
<h3 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h3>
<p>Helpful resources:</p>
<ul>
<li><a href="https://haskell-language-server.readthedocs.io/en/latest/configuration.html#configuring-haskell-language-server">Configuring haskell-language-server</a></li>
<li><a href="https://github.com/haskell/hie-bios#bios">hie-bios BIOS Configuration</a></li>
<li><a href="https://haskell-language-server.readthedocs.io/en/latest/troubleshooting.html">Troubleshooting haskell-language-server</a></li>
</ul>
<p>The <a href="contributor/what/building.html#testing">Testing</a> commands only tested a subset of the files in the project. To troubleshoot configuration issues, it's important to determine the source of the error.</p>
<p>If you know the source of the error, you can reproduce it on the command line with <code>haskell-language-server &lt;the file&gt;</code>. There are debug flags which might be useful (see <code>--help</code>).</p>
<p>If you do not know the source of the error, you can test every file in the project with:</p>
<pre><code># Provide list_sources function.
source &quot;$(dirname &quot;$0&quot;)/../cabal-lib.sh&quot;

# Get every file in the project.
mapfile -t srcs &lt; &lt;(list_sources)

# Execute haskell-language-server on every file in the project.
# Note that this command can take upwards of an hour.
haskell-language-server &quot;${srcs[@]}&quot;
</code></pre>
<p>Once you can reproduce the error, look through the <a href="contributor/what/building.html#worked-examples">Worked Examples</a> below and see if you can resolve the issue. If you cannot, raise a <a href="https://github.com/cardano-foundation/cardano-wallet/issues/new?assignees=&amp;labels=BUG&amp;template=bug_report.yml">GitHub issue</a> (external) or a JIRA issue (internal) with reproduction steps and tag @sevanspowell or @rvl.</p>
<h4 id="worked-examples"><a class="header" href="#worked-examples">Worked Examples</a></h4>
<p>NOTE: <a href="https://github.com/haskell/hie-bios#bios">hie-bios BIOS Configuration</a> is helpful background reading.</p>
<h5 id="source-filtering"><a class="header" href="#source-filtering">Source Filtering</a></h5>
<p>In the past <strong>haskell-language-server</strong> failed when processing the <code>lib/wallet/extra/Plutus/FlatInteger.hs</code> file, as it was technically a Haskell file in the repository, but wasn't intended to be compiled with the project.</p>
<p>To fix this issue, we excluded the <code>lib/wallet/extra</code> folder from the project sources.</p>
<p>The bash function <code>list_sources</code> in <code>scripts/cabal-lib.sh</code> is responsible for determining the source files <strong>haskell-language-server</strong> sees. Modify this function to further remove any other files you wish to exclude:</p>
<pre><code>list_sources() {
  # Exclude lib/wallet/extra. Those files are Plutus scripts intended
  # to be serialised for use in the tests. They are not intended to be built
  # with the project.
  # Exclude prototypes dir because it's a different project.
  git ls-files 'lib/**/*.hs' | grep -v Main.hs | grep -v prototypes/ | grep -v lib/wallet/extra
}
</code></pre>
<h5 id="ghci-flags"><a class="header" href="#ghci-flags">GHCI Flags</a></h5>
<p>There were previously issues debugging overlapping/ambiguous instances as the error message printed by <strong>haskell-language-server</strong> did not contain enough information. We rectified this by adding <code>-fprint-potential-instances</code> to the GHCI flags of the <strong>haskell-language-server</strong> BIOS.</p>
<p>The bash function <code>ghci_flags</code> in <code>scripts/cabal-lib.sh</code> is responsible for providing the GHCI flags <strong>haskell-language-server</strong> uses. Modify this file with any other GHC flags you may require:</p>
<pre><code>ghci_flags() {
  cat &lt;&lt;EOF
-XOverloadedStrings
-XNoImplicitPrelude
-XTypeApplications
-XDataKinds
-fwarn-unused-binds
-fwarn-unused-imports
-fwarn-orphans
-fprint-potential-instances
-Wno-missing-home-modules
EOF

...
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="coding-standards"><a class="header" href="#coding-standards">Coding Standards</a></h1>
<h2 id="foreword"><a class="header" href="#foreword">Foreword</a></h2>
<p>This file contains agreed-upon coding standards and best practices, as well as proposals for changes or new standards. Proposals are prefixed with <code>[PROPOSAL]</code> and are voted on by the Adrestia team through polls on Slack. To be accepted, a practice should be voted with majority + 1, with neutral votes counting as positive votes.</p>
<p>Each proposal should start with a section justifying the standard with rational arguments. When it makes sense, we should also provide examples of good and bad practices to make the point clearer.</p>
<h2 id="summary-1"><a class="header" href="#summary-1">Summary</a></h2>
<ul>
<li><a href="contributor/what/coding-standards.html#coding-standards">Coding Standards</a>
<ul>
<li><a href="contributor/what/coding-standards.html#foreword">Foreword</a></li>
<li><a href="contributor/what/coding-standards.html#summary">Summary</a></li>
<li><a href="contributor/what/coding-standards.html#code-formatting">Code Formatting</a>
<ul>
<li><a href="contributor/what/coding-standards.html#editor-configuration-via-editorconfig">Editor Configuration via <code>.editorconfig</code></a></li>
<li><a href="contributor/what/coding-standards.html#limit-line-length-to-80-characters">Limit line length to 80 characters</a>
<ul>
<li><a href="contributor/what/coding-standards.html#examples">Examples</a>
<ul>
<li><a href="contributor/what/coding-standards.html#strategy-1-wrap-code">Strategy 1: Wrap code</a></li>
<li><a href="contributor/what/coding-standards.html#strategy-2-place-comments-on-their-own-line-instead-of-attempting-to-align-them-vertically">Strategy 2: Place comments on their own line instead of attempting to align them vertically</a></li>
<li><a href="contributor/what/coding-standards.html#strategy-3-break-up-long-string-literals">Strategy 3: Break up long string literals</a></li>
<li><a href="contributor/what/coding-standards.html#strategy-4-reduce-nesting">Strategy 4: Reduce nesting</a></li>
</ul>
</li>
<li><a href="contributor/what/coding-standards.html#exceptions">Exceptions</a>
<ul>
<li><a href="contributor/what/coding-standards.html#exception-1-urls-in-comments">Exception 1: URLs in comments</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="contributor/what/coding-standards.html#use-only-a-single-blank-line-between-top-level-definitions">Use only a single blank line between top-level definitions</a></li>
<li><a href="contributor/what/coding-standards.html#avoid-variable-length-indentation">Avoid Variable-Length Indentation</a></li>
<li><a href="contributor/what/coding-standards.html#stylish-haskell-is-used-to-format-grouped-imports--language-pragmas">Stylish-Haskell is used to format grouped imports &amp; language pragmas</a></li>
</ul>
</li>
<li><a href="contributor/what/coding-standards.html#haskell-practices">Haskell Practices</a>
<ul>
<li><a href="contributor/what/coding-standards.html#favor-newtype-and-tagged-type-over-type-aliases">Favor <code>newtype</code> and tagged type over type-aliases</a></li>
<li><a href="contributor/what/coding-standards.html#language-extensions-are-specified-on-top-of-each-module">Language extensions are specified on top of each module</a></li>
<li><a href="contributor/what/coding-standards.html#hlint-is-used-for-hints-and-general-code-style">HLint is used for hints and general code style</a></li>
<li><a href="contributor/what/coding-standards.html#we-use-explicit-imports-by-default-and-favor-qualified-imports-for-ambiguous-functions">We use explicit imports by default, and favor qualified imports for ambiguous functions</a></li>
<li><a href="contributor/what/coding-standards.html#all-modules-begin-with-a-helpful-documentation-comment">All modules begin with a helpful documentation comment</a></li>
<li><a href="contributor/what/coding-standards.html#prefer-named-constants-over-magic-numbers">Prefer named constants over magic numbers</a>
<ul>
<li><a href="contributor/what/coding-standards.html#bad">BAD</a></li>
<li><a href="contributor/what/coding-standards.html#good">GOOD</a></li>
</ul>
</li>
<li><a href="contributor/what/coding-standards.html#avoid-wildcards-when-pattern-matching-on-sum-types">Avoid wildcards when pattern-matching on sum types</a></li>
<li><a href="contributor/what/coding-standards.html#prefer-pattern-matching-to-equality-testing-on-sum-types">Prefer pattern-matching to equality testing on sum types.</a></li>
<li><a href="contributor/what/coding-standards.html#proposed-dont-spit-back-malformed-values-in-errors-from-user-inputs">[PROPOSED] Don't spit back malformed values in errors from user inputs.</a></li>
</ul>
</li>
<li><a href="contributor/what/coding-standards.html#quickcheck">QuickCheck</a>
<ul>
<li><a href="contributor/what/coding-standards.html#see-your-property-fail">See your property fail</a></li>
<li><a href="contributor/what/coding-standards.html#define-properties-as-separate-functions">Define properties as separate functions</a></li>
<li><a href="contributor/what/coding-standards.html#provide-readable-counter-examples-on-failures">Provide readable counter-examples on failures</a></li>
<li><a href="contributor/what/coding-standards.html#tag-interesting-cases-in-complex-properties">Tag interesting cases in complex properties</a></li>
<li><a href="contributor/what/coding-standards.html#write-properties-to-assert-the-validity-of-complex-generators-and-shrinkers">Write properties to assert the validity of complex generators (and shrinkers)</a></li>
<li><a href="contributor/what/coding-standards.html#use-checkcoverage-to-measure-coverage-requirements">Use <code>checkCoverage</code> to measure coverage requirements</a></li>
<li><a href="contributor/what/coding-standards.html#avoid-liftio-in-monadic-properties">Avoid <code>liftIO</code> in monadic properties</a></li>
</ul>
</li>
<li><a href="contributor/what/coding-standards.html#testing">Testing</a>
<ul>
<li><a href="contributor/what/coding-standards.html#test-files-are-separated-and-self-contained">Test files are separated and self-contained</a></li>
<li><a href="contributor/what/coding-standards.html#unit-test-files-names-match-their-corresponding-module">Unit test files names match their corresponding module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="code-formatting"><a class="header" href="#code-formatting">Code Formatting</a></h2>
<h3 id="editor-configuration-via-editorconfig"><a class="header" href="#editor-configuration-via-editorconfig">Editor Configuration via <code>.editorconfig</code></a></h3>
<p>A <code>.editorconfig</code> (see https://editorconfig.org/) at the root of the project specifies for various filetype:</p>
<ul>
<li>Line length</li>
<li>Indentation style (spaces vs tabs)</li>
<li>Encoding</li>
</ul>
<p>This file should be parsed and enforced by any contributor's editor.</p>
<blockquote>
<p><em>Why</em></p>
<p>This is the kind of details we don't want to be fighting over constantly. The <code>.editorconfig</code> are widely used,
easily written and supported by any decent editor out there. Agreeing on such rules prevent our version control
system to go crazy because people use different encoding or indentation style. It makes the overall code more consistent.</p>
</blockquote>
<h3 id="limit-line-length-to-80-characters"><a class="header" href="#limit-line-length-to-80-characters">Limit line length to 80 characters</a></h3>
<p>Source code, including comments, should <strong>not</strong> exceed 80 characters in length, unless in exceptional situations.</p>
<blockquote>
<p><em>Why</em></p>
<ul>
<li><strong>To maximize readability</strong>. Human eyes find it much harder to scan long lines. For people with imperfect vision, it can be even harder. Narrower code can be read quickly without having to scan from side to side. Although monitors have grown in width and resolution in recent years, human eyes haven't changed.</li>
<li><strong>To easily view multiple sources side-by-side</strong>. This is particularly important when working on a laptop. With a readable font size of around 11 pt, 80 characters is about half the horizontal distance across a laptop monitor. Trying to fit 90 or 100 characters into the same width requires a smaller font, raising the level of discomfort for people with poorer vision.</li>
<li><strong>To avoid horizontal scrolling when viewing source code</strong>. When reading most source code, we already have to scroll vertically. Horizontal scrolling means that readers have to move their viewpoint in two dimensions rather than one. This requires more effort and can cause strain for people reading your code.</li>
</ul>
</blockquote>
<details><summary>See Examples and Exceptions</summary>
<h4 id="examples-3"><a class="header" href="#examples-3">Examples</a></h4>
<p>If you find yourself exceeding 80 characters, there are several strategies you can use.</p>
<h5 id="strategy-1-wrap-code"><a class="header" href="#strategy-1-wrap-code">Strategy 1: Wrap code</a></h5>
<p>By inserting carriage returns in the right place, we can often reveal the underlying structure of an expression. Haskell allows you to break up long expressions so that they occur over multiple lines. For example:</p>
<pre><code class="language-Haskell">-- BAD
instance Bi Block where
    encode block = encodeListLen 3 &lt;&gt; encode (blockHeader block) &lt;&gt; encode (blockBody block) &lt;&gt; encode (blockExtraData block)
</code></pre>
<pre><code class="language-Haskell">-- GOOD
instance Bi Block where
    encode block = encodeListLen 3
        &lt;&gt; encode (blockHeader block)
        &lt;&gt; encode (blockBody block)
        &lt;&gt; encode (blockExtraData block)
</code></pre>
<p>Another example of wrapping:</p>
<pre><code class="language-hs">-- BAD:
describe &quot;Lemma 2.6 - Properties of balance&quot; $ do
    it &quot;2.6.1) dom u ⋂ dom v ==&gt; balance (u ⋃ v) = balance u + balance v&quot; (checkCoverage prop_2_6_1)
    it &quot;2.6.2) balance (ins⋪ u) = balance u - balance (ins⊲ u)&quot; (checkCoverage prop_2_6_2)
</code></pre>
<pre><code class="language-hs">-- GOOD:
describe &quot;Lemma 2.6 - Properties of balance&quot; $ do
    it &quot;2.6.1) dom u ⋂ dom v ==&gt; balance (u ⋃ v) = balance u + balance v&quot;
        (checkCoverage prop_2_6_1)
    it &quot;2.6.2) balance (ins⋪ u) = balance u - balance (ins⊲ u)&quot;
        (checkCoverage prop_2_6_2)
</code></pre>
<h5 id="strategy-2-place-comments-on-their-own-line-instead-of-attempting-to-align-them-vertically"><a class="header" href="#strategy-2-place-comments-on-their-own-line-instead-of-attempting-to-align-them-vertically">Strategy 2: Place comments on their own line instead of attempting to align them vertically</a></h5>
<pre><code class="language-Haskell">-- BAD
mkMagicalBlock
    :: MagicProtocolId                     -- A unique key specifying a magic protocol.
    -&gt; MagicType                           -- The type of magic used in this block signing.
    -&gt; MagicalKey                          -- The magical key used in this block signing.
    -&gt; Maybe Delegation.MagicalCertificate -- A magical certificate of delegation, in case the specified 'MagicalKey' does not have the right to sign this block.
    -&gt; Block
</code></pre>
<pre><code class="language-Haskell">-- GOOD
mkMagicalBlock
    :: MagicProtocolId
    -- ^ A unique key specifying a magic protocol.
    -&gt; MagicType
    -- ^ The type of magic used in this block signing.
    -&gt; MagicalKey
    -- ^ The magical key used in this block signing.
    -&gt; Maybe Delegation.MagicalCertificate
    -- ^ A magical certificate of delegation, in case the specified
    -- 'MagicalKey' does not have the right to sign this block.
    -&gt; Block
</code></pre>
<h5 id="strategy-3-break-up-long-string-literals"><a class="header" href="#strategy-3-break-up-long-string-literals">Strategy 3: Break up long string literals</a></h5>
<p>Haskell provides convenient support for multi-line string literals:</p>
<pre><code class="language-Haskell">-- BAD
errorAccountFundsCompletelyExhausted = &quot;The funds in this account have been completely spent, and its balance is now zero. Either add more funds to this account or use a different account for this transaction.&quot;
</code></pre>
<pre><code class="language-Haskell">-- GOOD
errorAccountFundsCompletelyExhausted =
    &quot;The funds in this account have been completely spent, and its balance \
    \is now zero. Either add more funds to this account or use a different \
    \account for this transaction.&quot;
</code></pre>
<pre><code class="language-Haskell">-- BAD:
spec = do
    scenario &quot;Only this account's balance can be retrieved while standing on one leg on the side of an extremely tall mountain, and breathing thin air with only very limited amounts of oxygen.&quot; $ do
</code></pre>
<pre><code class="language-Haskell">-- GOOD:
spec = do
    scenario
        &quot;Only this account's balance can be retrieved while standing on one \
        \leg on the side of an extremely tall mountain, and breathing thin \
        \air with only very limited amounts of oxygen.&quot; $ do
</code></pre>
<h5 id="strategy-4-reduce-nesting"><a class="header" href="#strategy-4-reduce-nesting">Strategy 4: Reduce nesting</a></h5>
<p>If your function contains so many levels of nesting that it's hard to keep things within 80 characters (even with careful use of wrapping), consider breaking your function up into smaller parts.</p>
<h4 id="exceptions"><a class="header" href="#exceptions">Exceptions</a></h4>
<p>Sometimes, it's <strong>impossible</strong> to adhere to this rule.</p>
<p>Here is a list of allowed exceptions:</p>
<h5 id="exception-1-urls-in-comments"><a class="header" href="#exception-1-urls-in-comments">Exception 1: URLs in comments</a></h5>
<p>According to the standard, URLs can be extremely long. In some situations, we need to place URLs in source code comments. If a URL is longer than 80 characters, then place it on its own line:</p>
<pre><code class="language-hs">--| For more information about this implementation, see:
--  https://an.exceptionally.long.url/7919ce329e804fc0bc1fa2df8a141fd3d996c484cf7a49e79f14d7bd974acadd
</code></pre>
</details>
<h3 id="use-only-a-single-blank-line-between-top-level-definitions"><a class="header" href="#use-only-a-single-blank-line-between-top-level-definitions">Use only a single blank line between top-level definitions</a></h3>
<p>A source code file <strong>should not</strong> contain multiple consecutive blank lines.</p>
<p>Use only a <strong>single</strong> blank line between the following top-level definitions:</p>
<ul>
<li>function definitions</li>
<li>data type definitions</li>
<li>class definitions</li>
<li>instance definitions</li>
</ul>
<blockquote>
<p><em>Why</em></p>
<ul>
<li>Consistency with other Haskell code.</li>
<li>Excessive vertical space increases the amount of unnecessary scrolling required to read a module.</li>
</ul>
</blockquote>
<details>
  <summary>See Examples</summary>
<pre><code class="language-hs">-- BAD
newtype Foo = Foo Integer
    deriving (Eq, Show)



newtype Bar = Bar Integer
    deriving (Eq, Show)
</code></pre>
<pre><code class="language-hs">-- GOOD
newtype Foo = Foo Integer
    deriving (Eq, Show)

newtype Bar = Bar Integer
    deriving (Eq, Show)
</code></pre>
<pre><code class="language-hs">-- BAD
instance FromCBOR Block where
    fromCBOR = Block &lt;$&gt; decodeBlock



newtype BlockHeader = BlockHeader
    { getBlockHeader :: Primitive.BlockHeader
    }
    deriving Eq
</code></pre>
<pre><code class="language-hs">-- GOOD
instance FromCBOR Block where
    fromCBOR = Block &lt;$&gt; decodeBlock

newtype BlockHeader = BlockHeader
    { getBlockHeader :: Primitive.BlockHeader
    }
    deriving Eq
</code></pre>
</details>
<h3 id="avoid-variable-length-indentation"><a class="header" href="#avoid-variable-length-indentation">Avoid Variable-Length Indentation</a></h3>
<p>Variables, arguments, fields and tokens in general shouldn't be aligned based
on the length of a previous token. Rather, tokens should go over a new line and
be indented one-level extra when it makes sense, or not be aligned at all.</p>
<blockquote>
<p><em>Why</em></p>
<p>Haskellers have a tendency to over-align everything vertically for the sake
of readability. In practice, this is much more of an habit than a real gain
in readability. Aligning content based on a function name, variable name or
record field tends to create unnecessarily long diffs and needless conflicts
in version control systems when making a change to add an argument, variable
or parameters. Favoring new-line and fixed-length alignment plays nicer with
version control.</p>
</blockquote>
<details>
  <summary>See Examples</summary>
<pre><code class="language-hs">-- GOOD
data AddressPool address = AddressPool
    { _addresses :: !(Map address Word32)
    , _gap :: !AddressPoolGap
    }

-- GOOD
data AddressPool address = AddressPool
    { _addresses
        :: !(Map address Word32)
    , _gap
        :: !AddressPoolGap
    }

-- GOOD
deriveAccountPrivateKey
    :: PassPhrase
    -&gt; EncryptedSecretKey
    -&gt; Word32
    -&gt; Maybe EncryptedSecretKey
deriveAccountPrivateKey passPhrase masterEncPrvKey accountIx =

-- BAD
myFunction :: Word64 -&gt; Maybe String
myFunction w = let res = Wrap w in
               case someOp res of
                 Left _err -&gt; Nothing
                 Right ()  -&gt; Just coin

-- BAD
myFunction :: Int
           -&gt; Maybe ByteString
           -&gt; Set Word32
           -&gt; Update DB (Either [Word32]
                        (Map Word32 ([String], Set ByteString)))

-- BAD
data MyRecord = MyRecord
    { _myRecordLongNameField :: !String
    , _myRecordShort         :: ![Int]
    }
</code></pre>
</details>
<h3 id="stylish-haskell-is-used-to-format-grouped-imports--language-pragmas"><a class="header" href="#stylish-haskell-is-used-to-format-grouped-imports--language-pragmas">Stylish-Haskell is used to format grouped imports &amp; language pragmas</a></h3>
<p>Contributors' editors should pick up and enforce the rules defined by the <code>.stylish-haskell.yaml</code>
configuration file at the root of the project. Also, in order to maximize readability, imports
should be grouped into three groups, separated by a blank newline.</p>
<ul>
<li>Prelude import</li>
<li>Explicit imports</li>
<li>Qualified imports</li>
</ul>
<blockquote>
<p><strong>Why</strong></p>
<p>It is rather annoying and time-consuming to align import lines or statement
as we code and it's much simpler to leave that to our editor. Yet, we do want
to enforce some common formatting such that everyone gets to be aligned (pun
intended).</p>
<p>We can use Stylish-Haskell with various set of rules, yet, the same arguments
from 'Avoid Variable-Length Indentation' applies when it comes to automatic
formatting. Imports are a real pain with git and Haskell when they are vertically
aligned based on the imported module's name.</p>
</blockquote>
<details>
    <summary>See examples</summary>
<pre><code class="language-hs">-- GOOD
import Prelude

import Cardano.Wallet.Binary
    ( txId )
import Data.Set
    ( Set )
import Data.Traversable
    ( for )

import qualified Data.Map as Map
import qualified Data.Set as Set

-- BAD
import Cardano.Wallet.Binary
    ( txId )
import Data.Set
    ( Set )
import Prelude
import Data.Traversable
    ( for )

import qualified Data.Map as Map
import qualified Data.Set as Set

-- BAD
import Prelude

import Cardano.Wallet.Binary
    ( txId )
import qualified Data.Set as Set
import Data.Set
    ( Set )
import qualified Data.Map as Map
import Data.Traversable
    ( for )
</code></pre>
</details>
<p>Here below is a proposal for the initial set of rules:</p>
<pre><code class="language-yaml">columns: 80 # Should match .editorconfig
steps:
  - imports:
      align: none
      empty_list_align: inherit
      list_align: new_line
      list_padding: 4
      long_list_align: new_line_multiline
      pad_module_names: false
      separate_lists: true
      space_surround: true

  - language_pragmas:
      align: false
      remove_redundant: true
      style: vertical
</code></pre>
<details>
  <summary>See example</summary>
<pre><code class="language-hs">{-# LANGUAGE BangPatterns #-}
{-# LANGUAGE DataKinds #-}
{-# LANGUAGE DeriveGeneric #-}
{-# LANGUAGE DerivingStrategies #-}
{-# LANGUAGE FlexibleContexts #-}
{-# LANGUAGE TupleSections #-}
{-# LANGUAGE TypeApplications #-}
{-# LANGUAGE TypeFamilies #-}

module Main where

import Control.Applicative
    ( (&lt;|&gt;) )
import Control.Arrow
    ( first )
import Control.Concurrent.MVar
    ( modifyMVar_, newMVar, putMVar, readMVar, takeMVar )
import Crypto.Hash.Algorithms
    ( Blake2b_224, Blake2b_256, SHA3_256, SHA512 (..) )
import Lens.Micro
    ( at, (%~), (&amp;), (.~), (^.) )
import Network.HTTP.Client
    ( Manager
    , defaultRequest
    , httpLbs
    , path
    , port
    , responseBody
    , responseStatus
    )

import qualified Codec.CBOR.Decoding as CBOR
import qualified Codec.CBOR.Encoding as CBOR
import qualified Codec.CBOR.Read as CBOR
import qualified Codec.CBOR.Write as CBOR
import qualified Crypto.Cipher.ChaChaPoly1305 as Poly
</code></pre>
</details>
<h2 id="haskell-practices"><a class="header" href="#haskell-practices">Haskell Practices</a></h2>
<h3 id="favor-newtype-and-tagged-type-over-type-aliases"><a class="header" href="#favor-newtype-and-tagged-type-over-type-aliases">Favor <code>newtype</code> and tagged type over type-aliases</a></h3>
<p>Instead of writing type aliases, one should favor wrapping up values in newtype
when it makes sense, or, have them wrapped into a tagged type with a phantom
type to convey some extra meaning while still preserving type safeness. By
using newtypes, we actually extend our program vocabulary and increase its
robustness.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Type-aliases convey a false sense of type-safety. While they usually make
things a bit better for the reader, they have a tendency to spread through
the code-base transforming those sweet help spot into traps. We can't define
proper instances on type aliases, and we treat them as different type whereas
they are behind the scene, just another one.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">-- GOOD
newtype HardenedIndex = HardenedIndex { getHardenedIndex :: Word32 }
deriveAccount :: HardenedIndex -&gt; XPrv -&gt; XPrv

-- GOOD
data Scheme = Seq | Rnd
newtype Key (* :: Scheme) = Key { getKey :: XPrv }
deriveAccount :: Word32 -&gt; Key 'Seq -&gt; Key 'Seq

-- GOOD
newtype Tagged (* :: Symbol) = Tagged { getTagged :: String }
startNode :: Tagged &quot;nodeId&quot; -&gt; IO ()

-- BAD
type HardenedIndex = Word32
deriveAccount :: HardenedIndex -&gt; XPrv -&gt; XPrv
</code></pre>
</details>
<h3 id="language-extensions-are-specified-on-top-of-each-module"><a class="header" href="#language-extensions-are-specified-on-top-of-each-module">Language extensions are specified on top of each module</a></h3>
<p>Haskell's language extension are specified on top of each module.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Having a lot of default extensions enabled across the whole project can sometimes lead to cryptic
errors where GHC would interpret things differently because of the enabled extensions. Yet, it's
sometimes hard to distinguish by simply looking at the module themselves.</p>
<p>Also, being more explicit on extensions used by a module can help speeding up compile-time of such simple modules
that don't need to be pull in a lot of extra complexity.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">-- GOOD
{-# LANGUAGE DataKinds #-}
{-# LANGUAGE GeneralizedNewtypeDeriving #-}
{-# LANGUAGE DerivingStrategies #-}

module Cardano.Wallet where

-- BAD
default-extensions:
  - DataKinds
  - GeneralizedNewtypeDeriving
  - DerivingStrategies
</code></pre>
</details>
<h3 id="hlint-is-used-for-hints-and-general-code-style"><a class="header" href="#hlint-is-used-for-hints-and-general-code-style">HLint is used for hints and general code style</a></h3>
<p>Contributors' editors should pick up and enforce the rules defined by the
.hlint.yaml configuration file at the root of the project. File should be
committed without warnings or errors. When it make senses, developer may ignore
lints at a function site using a proper annotation:</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Linters are common practices in software development and help maintaining consistency across a large codebase with
many developers. Hlint is de de-facto linter in Haskell and comes with a lot of different rules and features that
are <em>most of the time</em> rather relevant and convey good practices, agreed upon and shared across the team.</p>
</blockquote>
<p>e.g.</p>
<pre><code class="language-hs">{-# ANN decodeBlock (&quot;HLint: ignore Use &lt;$&gt;&quot; :: String) #-}
</code></pre>
<p>As a start, we'll use the following built-in rules from <code>hlint</code> with the following configuration, and refine this as we move forward:</p>
<pre><code class="language-yaml">- modules:
  # Enforce some common qualified imports aliases across the codebase
  - {name: [Data.Aeson, Data.Aeson.Types], as: Aeson}
  - {name: [Data.ByteArray], as: BA}
  - {name: [Data.ByteString.Base16], as: B16}
  - {name: [Data.ByteString.Char8], as: B8}
  - {name: [Data.ByteString.Lazy], as: BL}
  - {name: [Data.ByteString], as: BS}
  - {name: [Data.Foldable], as: F}
  - {name: [Data.List.NonEmpty], as: NE}
  - {name: [Data.List], as: L}
  - {name: [Data.Map.Strict], as: Map}
  - {name: [Data.Sequence], as: Seq}
  - {name: [Data.Set, Data.HashSet], as: Set}
  - {name: [Data.Text, Data.Text.Encoding], as: T}
  - {name: [Data.Vector], as: V}

# Ignore some build-in rules
- ignore: {name: &quot;Reduce duplication&quot;} # This is a decision left to developers and reviewers
- ignore: {name: &quot;Redundant bracket&quot;} # Not everyone knows precedences of every operators in Haskell. Brackets help readability.
- ignore: {name: &quot;Redundant do&quot;} # Just an annoying hlint built-in, GHC may remove redundant do if he wants
</code></pre>
<h3 id="we-use-explicit-imports-by-default-and-favor-qualified-imports-for-ambiguous-functions"><a class="header" href="#we-use-explicit-imports-by-default-and-favor-qualified-imports-for-ambiguous-functions">We use explicit imports by default, and favor qualified imports for ambiguous functions</a></h3>
<p>Apart from the chosen prelude, there should be no implicit imports. Instead,
every function or class used from a given module should be listed explicitly.
In case where a function name is ambiguous or requires context, a qualified
import should be used instead (this is mainly the case for modules coming from
<code>containers</code>, <code>bytestring</code> and <code>aeson</code>).</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Imports can be a great source of pain in Haskell. When dealing with some
foreign code (and every code becomes quite hostile after a while, even if we
originally wrote it), it can be hard to understand where functions and
abstractions are pulled from. On the other hand, fully qualified imports can
become verbose and a real impediment to readability.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">-- GOOD
import Prelude
import Control.DeepSeq
    ( NFData (..) )
import Data.ByteString
    ( ByteString )
import Data.Map.Strict
    ( Map )
import Data.Aeson
    ( FromJSON (..), ToJSON (..) )


-- GOOD
import qualified Data.Map.Strict as Map
import qualified Data.ByteString as BS

isSubsetOf :: UTxO -&gt; UTxO -&gt; Bool
isSubsetOf (UTxO a) (UTxO b) =
    a `Map.isSubmapOf` b

(magic, filetype, version) =
    ( BS.take 8 bytes
    , BS.take 4 $ BS.drop 8 bytes
    , BS.take 4 $ BS.drop 12 bytes
    )


-- BAD
import Options.Applicative


-- BAD
import qualified Data.Aeson as Aeson

instance Aeson.FromJSON MyType where
    -- ...


-- BAD
import Data.Map.Strict
    ( filter )
import Data.Set
    ( member )

restrictedTo :: UTxO -&gt; Set TxOut -&gt;  UTxO
restrictedTo (UTxO utxo) outs =
    UTxO $ filter (`member` outs) utxo
</code></pre>
</details>
<h3 id="all-modules-begin-with-a-helpful-documentation-comment"><a class="header" href="#all-modules-begin-with-a-helpful-documentation-comment">All modules begin with a helpful documentation comment</a></h3>
<p>The comments might answer the question <em>why?</em> They <em>might</em>:</p>
<ol>
<li>Explain the relation to other modules</li>
<li>Explain the relation to business functionality</li>
<li>Provide some other good-to-know information</li>
</ol>
<p>We should keep an eye out out-of-date comments. For instance when creating and reviewing PRs.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Even if individual functions are well-documented, it can be difficult to grasp how it all fits together.</p>
<p>In the legacy code-base, it was common to have multiple functions with the same or similar names, in different modules.
Try seaching for <code>applyBlocks</code> or <code>switchToFork</code>. What is the difference between <code>DB.Spec.Update.switchToFork</code> and <code>DB.AcidState.switchToFork</code>?</p>
<p>Having a comment at the top of each module would be an easy-to-follow rule to better document this. It is also very appropriate for
generated <a href="https://cardano-foundation.github.io/cardano-wallet/haddock/">haddock docs</a>.</p>
<p>If we re-design a module and forget to update the comment, the comment is no longer useful.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">-- |
-- Copyright: © 2018-2019 IOHK
-- License: MIT
--
-- This module contains the core primitive of a Wallet. This is roughly a
-- Haskell translation of the [Formal Specification for a Cardano Wallet](https://github.com/cardano-foundation/cardano-wallet/blob/master/specifications/wallet/formal-specification-for-a-cardano-wallet.pdf)
--
-- It doesn't contain any particular business-logic code, but define a few
-- primitive operations on Wallet core types as well.
</code></pre>
<p>(https://github.com/cardano-foundation/cardano-wallet/blob/d3cca01f66f0abe93012343dab093a2551b6cbea/src/Cardano/Wallet/Primitive.hs#L12-L20)</p>
<pre><code class="language-hs">-- |
-- Copyright: © 2018-2019 IOHK
-- License: MIT
--
-- Provides the wallet layer functions that are used by API layer and uses both
-- &quot;Cardano.DBLayer&quot; and &quot;Cardano.NetworkLayer&quot; to realize its role as being
-- intermediary between the three.
</code></pre>
<p>(https://cardano-foundation.github.io/cardano-wallet/haddock/cardano-wallet-2.0.0/Cardano-WalletLayer.html)</p>
</details>
<h3 id="prefer-named-constants-over-magic-numbers"><a class="header" href="#prefer-named-constants-over-magic-numbers">Prefer named constants over magic numbers</a></h3>
<blockquote>
<p><strong>Why</strong></p>
<p>A <strong>magic number</strong> (or magic value) is a value that appears in source code without an accompanying explanation, which could (preferably) be replaced with a named constant.</p>
<p>The use of an unnamed magic number often obscures the developer's intent in choosing that number, increases opportunities for subtle errors and makes it more difficult for the program to be adapted and extended in the future.</p>
<p>Replacing all significant magic numbers with named constants makes programs easier to read, understand and maintain. Named constants can also be reused in multiple places, making it obvious that the value is supposed to be the same across all places that its used.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<h4 id="bad"><a class="header" href="#bad">BAD</a></h4>
<pre><code class="language-hs">humanReadableCharIsValid :: Char -&gt; Bool
humanReadableCharIsValid c = c &gt;= chr 33 &amp;&amp; c &lt;= chr 126

bech32CharSet :: Set Char
bech32CharSet =
    Set.filter (not . isUpper) $
        Set.fromList [chr 33 .. chr 126]
            `Set.union` (Set.singleton '1')
            `Set.union` (Set.fromList &quot;qpzry9x8gf2tvdw0s3jn54khce6mua7l&quot;)

instance Arbitrary HumanReadableChar where
    arbitrary = HumanReadableChar &lt;$&gt;
        choose (chr 33, chr 126)
</code></pre>
<h4 id="good"><a class="header" href="#good">GOOD</a></h4>
<pre><code class="language-hs">-- | The lower bound of the set of characters permitted to appear within the
--   human-readable part of a Bech32 string.
humanReadableCharMinBound :: Char
humanReadableCharMinBound = chr 33

-- | The upper bound of the set of characters permitted to appear within the
--   human-readable part of a Bech32 string.
humanReadableCharMaxBound :: Char
humanReadableCharMaxBound = chr 126

-- | The separator character. This character appears immediately after the
-- human-readable part and before the data part.
separatorChar :: Char
separatorChar = '1'

-- | A list of all characters that are permitted to appear within the data part
--   of a Bech32 string.
dataCharList :: String
dataCharList = &quot;qpzry9x8gf2tvdw0s3jn54khce6mua7l&quot;

humanReadableCharIsValid :: Char -&gt; Bool
humanReadableCharIsValid c =
    c &gt;= humanReadableCharMinBound &amp;&amp;
    c &lt;= humanReadableCharMaxBound

bech32CharSet :: Set Char
bech32CharSet =
    Set.filter (not . isUpper) $
        Set.fromList [humanReadableCharMinBound .. humanReadableCharMaxBound]
            `Set.union` (Set.singleton separatorChar)
            `Set.union` (Set.fromList dataCharList)

instance Arbitrary HumanReadableChar where
    arbitrary = HumanReadableChar &lt;$&gt;
        choose (humanReadableCharMinBound, humanReadableCharMaxBound)
</code></pre>
</details>
<h3 id="avoid-wildcards-when-pattern-matching-on-sum-types"><a class="header" href="#avoid-wildcards-when-pattern-matching-on-sum-types">Avoid wildcards when pattern-matching on sum types</a></h3>
<p>When pattern-matching on sum types or finite structures, we should avoid
the use of the wildcard <code>_</code> as much as possible, and instead favor explicit
handling of all branches. This way, we get compiler errors when extending
the underlying ADT and avoid silently handling (probably incorretly) some
of the new branches.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>When pattern-matching on sum types it is tempting to handle a few similar cases
using a wildcard <code>_</code>. However, this often leads to undesirable behavior when
adding new branches to an ADT. Compilers won't trigger any warnings and, as
developers, we might miss some necessary logic updates in existing pattern
matches.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">-- GOOD
isPositive = \case
    InLedger -&gt; True
    Pending -&gt; False
    Invalidated -&gt; False

-- BAD
isPositive = \case
    InLedger -&gt; True
    _ -&gt; False

-- BAD
handleErr = \case
    ErrWalletNotFound -&gt; {- ... -}
    _ -&gt; ErrUnknown
</code></pre>
</details>
<h3 id="prefer-pattern-matching-to-equality-testing-on-sum-types"><a class="header" href="#prefer-pattern-matching-to-equality-testing-on-sum-types">Prefer pattern-matching to equality testing on sum types.</a></h3>
<p>For expressions that evaluate differently depending on a value of a sum type,
prefer pattern matching over equality testing for values of that type.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>When conditional evaluation depends on the value of a sum type, it's tempting
to use a test for equality or inequality to branch on a particular
value.</p>
<p>However, if someone adds a new constructor to the sum type later on,
we'd ideally like the compiler to remind us to check all locations that inspect
values of this type, especially where conditional evaluation is involved.</p>
<p>Using an equality test is non-ideal because the compiler won't necessarily
fail if a new constructor is added to the underlying sum type, whereas it
will <strong>always</strong> fail if a pattern match becomes incomplete.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">data SortOrder = Ascending | Descending
    deriving Eq

-- BAD
sortWithOrder' :: Ord a =&gt; SortOrder -&gt; [a] -&gt; [a]
sortWithOrder' order = f . sort
  where
    f = if order == Ascending then id else reverse

-- GOOD
sortWithOrder :: Ord a =&gt; SortOrder -&gt; [a] -&gt; [a]
sortWithOrder order = f . sort
  where
    f = case order of
        Ascending -&gt; id
        Descending -&gt; reverse
</code></pre>
</details>
<h3 id="proposed-dont-spit-back-malformed-values-in-errors-from-user-inputs"><a class="header" href="#proposed-dont-spit-back-malformed-values-in-errors-from-user-inputs">[PROPOSED] Don't spit back malformed values in errors from user inputs.</a></h3>
<p>When failing to parse user inputs, error message should not contain the malformed input. Instead, the error message should contain hints or examples of well-formed values expected by the parser. It is acceptable to show a raw input value if it is known to be within acceptable boundaries (e.g. parsing a <code>Word32</code> into a more refined type, there is little chance that the <code>Word32</code> will be inadequate to display).</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Spitting back what the user has just entered is generally not very helpful. Users can generally easily replay what they've entered and see for themselves. More importantly, an input that didn't parse successfully may be arbitrary long or improper for display; since it failed to parse, we have actually not much control or knowledge about it.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">-- BAD
err =
    &quot;Invalid value: &quot; &lt;&gt; show v &lt;&gt; &quot;. Please provide a valid value.&quot;

-- GOOD
err =
    &quot;EpochNo value is out of bounds (&quot; &lt;&gt;
    show (minBound @Word31) &lt;&gt;
    &quot;, &quot; &lt;&gt;
    show (maxBound @Word31) &lt;&gt;
    &quot;).&quot;

-- GOOD
err =
    &quot;Unable to decode FeePolicy: \
    \Linear equation not in expected format: a + bx + cy \
    \where 'a', 'b', and 'c' are numbers&quot;
</code></pre>
</details>
<h2 id="quickcheck"><a class="header" href="#quickcheck">QuickCheck</a></h2>
<h3 id="see-your-property-fail"><a class="header" href="#see-your-property-fail">See your property fail</a></h3>
<p>This is a general practice in TDD (<strong>T</strong>est <strong>D</strong>riven <strong>D</strong>evelopment) but
even more important in property-based testing.  You want to see <em>how</em> your
property fails and whether, as a developer, you have enough information to
understand the reason of the failure and debug it.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>It is really easy to write all sort of properties which, once they fail, give
close to no details about the reason why they failed. Yet, as with any tests,
one wants to understand what happens. It is therefore important to see
properties failing at least once to see whether the level of details is
sufficient, as well as the efficiency of the shrinkers.</p>
</blockquote>
<h3 id="define-properties-as-separate-functions"><a class="header" href="#define-properties-as-separate-functions">Define properties as separate functions</a></h3>
<p>It is often tempting to write properties inlined with <code>hspec</code> other combinators
instead of having them as separate functions. However, we recommend writing
properties as separate functions, prefixed with a <code>prop_</code> prefix to clearly
identify them.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>It makes for more readable test files where the set of properties can be easily
identified by looking at the top-level exported spec. But more importantly, it
allows for re-using the property with some regression test cases coming from past
failures. Having a separate function makes it easy to simply apply counter examples
yielded by QuickCheck as arguments!</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">-- GOOD
describe &quot;selectCoinsForMigration properties&quot; $ do
    it &quot;Total input UTxO value &gt;= sum of selection change coins&quot; $
        property $ withMaxSuccess 1000 prop_inputsGreaterThanOutputs

describe &quot;selectCoinsForMigration regressions&quot; $ do
    it &quot;regression #1&quot; $ do
        let feeOpts = FeeOptions
                { dustThreshold = Coin 9
                , estimateFee = \s -&gt; Fee
                    $ fromIntegral
                    $ 5 * (length (inputs s) + length (outputs s))
                }
        let batchSize = 1
        let utxo = UTxO $ Map.fromList
                [ ( TxIn { inputId = Hash &quot;|\243^\SUBg\242\231\&amp;1\213\203&quot;, inputIx = 2 }
                  , TxOut { address = Address &quot;ADDR03&quot;, coin = Coin 2 }
                  )
                ]
        property $ prop_inputsGreaterThanOutputs feeOpts batchSize utxo


-- | Total input UTxO value &gt;= sum of selection change coins
prop_inputsGreaterThanOutputs
    :: FeeOptions
    -&gt; Word8
    -&gt; UTxO
    -&gt; Property
prop_inputsGreaterThanOutputs feeOpts batchSize utxo = {- ... -}


-- BAD
it &quot;Eventually converge for decreasing functions&quot; $ do
    property $ \coinselOpts -&gt; do
        let batchSize = idealBatchSize coinselOpts
        label (show batchSize) True
</code></pre>
</details>
<h3 id="provide-readable-counter-examples-on-failures"><a class="header" href="#provide-readable-counter-examples-on-failures">Provide readable counter-examples on failures</a></h3>
<p>Use <a href="https://hackage.haskell.org/package/QuickCheck-2.13.2/docs/Test-QuickCheck.html#v:counterexample">counterexample</a> to display human-readable
counter examples when a test fails; in particular, for data-types which have a <a href="https://hackage.haskell.org/package/fmt-0.6.1.2/docs/Fmt.html#t:Buildable">Buildable</a> instances
that are typically hard to read through their standard <code>Show</code> instance. For monadic properties, this can be used via <a href="https://hackage.haskell.org/package/QuickCheck-2.13.2/docs/Test-QuickCheck-Monadic.html#v:monitor">monitor</a>.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Some property-based tests can use complex combinations of inputs that can be hard to decipher
when printed out to the console using only the stock <code>Show</code> instance. On the other hand, we
want to keep using the stock <code>Show</code> instance in order to be able to easily copy-paste failing
cases and turn them into regression tests. QuickCheck however provides a good set of tools to
display counter examples on failures to ease debbugging.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code class="language-hs">property (Bech32.decode corruptedString `shouldSatisfy` isLeft)
    &amp; counterexample $ unlines
        [ &quot;index of char #1: &quot; &lt;&gt; show index
        , &quot;index of char #2: &quot; &lt;&gt; show (index + 1)
        , &quot;         char #1: &quot; &lt;&gt; show char1
        , &quot;         char #2: &quot; &lt;&gt; show char2
        , &quot; original string: &quot; &lt;&gt; show originalString
        , &quot;corrupted string: &quot; &lt;&gt; show corruptedString
        ]

property (bs' === Just expected)
    &amp; counterexamples $ unlines
        [ &quot;k = &quot; ++ show k
        , &quot;Local chain: &quot; ++ showChain localChain
        , &quot;Node chain:  &quot; ++ showChain nodeChain
        , &quot;Intersects:  &quot; ++ maybe &quot;-&quot; showSlot isect
        , &quot;Expected:    &quot; ++ showBlockHeaders expected
        , &quot;Actual:      &quot; ++ maybe &quot;-&quot; showBlockHeaders bs'
        ]
</code></pre>
</details>
<h3 id="tag-interesting-cases-in-complex-properties"><a class="header" href="#tag-interesting-cases-in-complex-properties">Tag interesting cases in complex properties</a></h3>
<p>Quickcheck provides good tooling for labelling (see <a href="https://hackage.haskell.org/package/QuickCheck-2.13.2/docs/Test-QuickCheck.html#v:label">label</a> and classifying (see <a href="https://hackage.haskell.org/package/QuickCheck-2.13.2/docs/Test-QuickCheck.html#v:classify">classify</a>)
inputs or results of a property. These should be used in properties dealing with several classes of values.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>It is quite common for properties to deal with different class of values and for us developers to get a false sense of
coverage. QuickCheck default generators are typically skewed towards certain edge values to favor bug finding but this
is sometimes counter-intuitive. For example, when testing with lists or maps, it often happens that most of the test cases
are actually testing on empty values. In order to make sure that some interesting test cases are still covered, it is
necessary to instrument properties so that they can mesure how often certain cases appear in a particular property.</p>
</blockquote>
<details>
  <summary>See Examples</summary>
<pre><code class="language-hs">prop_sync :: S -&gt; Property
prop_sync s0 = monadicIO $ do
    {- ... -}
    monitor (label (intersectionHitRate consumer))
    monitor (classify (initialChainLength (const (== 1))) &quot;started with an empty chain&quot;)
    monitor (classify (initialChainLength (\k -&gt; (&gt; k))) &quot;started with more than k blocks&quot;)
    monitor (classify addMoreThanK &quot;advanced more than k blocks&quot;)
    monitor (classify rollbackK &quot;rolled back full k&quot;)
    monitor (classify (switchChain (&lt;)) &quot;switched to a longer chain&quot;)
    monitor (classify (switchChain (&gt;)) &quot;switched to a shorter chain&quot;)
    monitor (classify (switchChain (const (== 0))) &quot;rewinded without switch&quot;)
    monitor (classify (recoveredFromGenesis s) &quot;recovered from genesis&quot;)
    monitor (classify (startedFromScratch c0Cps) &quot;started from scratch&quot;)
    {- ... -}

-- Syncs with mock node
--   64.709% started from scratch
--   55.969% advanced more than k blocks
--   53.260% started with an empty chain
--   41.094% started with more than k blocks
--   10.421% switched to a shorter chain
--    7.195% switched to a longer chain
--    6.773% rewinded without switch
--    0.880% rolled back full k
--
--   57.516% Intersection hit rate GREAT (75% - 100%)
--   32.183% Intersection hit rate GOOD  (50% - 75%)
--   10.292% Intersection hit rate POOR  (10% - 50%)
--    0.009% Intersection hit rate BAD   (0%  - 10%)


prop_rollbackPools db pairs = monadicIO $ do
    {- ... -}
    Monitor $ classify (any (&gt; sl) beforeRollback) &quot;something to roll back&quot;
    Monitor $ classify (all (&lt;= sl) beforeRollback) &quot;nothing to roll back&quot;
    {- ... -}

-- Rollback of stake pool production
--   57% nothing to roll back
--   43% something to roll back

prop_accuracy r = withMaxSuccess 1000 $ monadicIO $ do
    {- ... -}
    monitor $ label $ accuracy dust balance balance'
  where
    accuracy :: Coin -&gt; Natural -&gt; Natural -&gt; String
    accuracy (Coin dust) sup real
        | a &gt;= 1.0 =
            &quot;PERFECT  (== 100%)&quot;
        | a &gt; 0.99 || (sup - real) &lt; fromIntegral dust =
            &quot;OKAY     (&gt;   99%)&quot;
        | otherwise =
            &quot;MEDIOCRE (&lt;=  99%)&quot;
      where
        a = double real / double sup

-- Accuracy of selectCoinsForMigration
--   dust=1%
--     +++ OK, passed 1000 tests (100.0% PERFECT  (== 100%)).
--   dust=5%
--     +++ OK, passed 1000 tests (100.0% PERFECT  (== 100%)).
--   dust=10%
--     +++ OK, passed 1000 tests:
--     99.8% PERFECT  (== 100%)
--      0.2% OKAY     (&gt;   99%)
--   dust=25%
--     +++ OK, passed 1000 tests:
--     99.6% PERFECT  (== 100%)
--      0.4% OKAY     (&gt;   99%)
--   dust=50%
--     +++ OK, passed 1000 tests:
--     98.8% PERFECT  (== 100%)
--      1.2% OKAY     (&gt;   99%)
</code></pre>
</details>
<h3 id="write-properties-to-assert-the-validity-of-complex-generators-and-shrinkers"><a class="header" href="#write-properties-to-assert-the-validity-of-complex-generators-and-shrinkers">Write properties to assert the validity of complex generators (and shrinkers)</a></h3>
<p>Arbitrary generators, and in particular complex ones, should be tested independently
to make sure they yield correct values. This also includes shrinkers associated with
the generator which can often break some invariants enforced by the generator itself.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Generators and shrinkers are at the heart of property-based testing. Writing properties
using clunky generators will lead to poor or wrong results. Above all, it may take an
important amount of time to debug failures due to an invalid generator. So it's best
to start by verifying the a given generator is somewhat correct. Often enough, generators
are obvious, but when they are slightly more engineered, testing them is a must.</p>
</blockquote>
<details>
    <summary>See Examples</summary>
<pre><code class="language-hs">--| Checks that generated mock node test cases are valid
prop_MockNodeGenerator :: S -&gt; Property
prop_MockNodeGenerator (S n0 ops _ _) =
    prop_continuous .&amp;&amp;. prop_uniqueIds
  where
    prop_continuous :: Property
    prop_continuous =
        conjoin (follow &lt;$&gt; scanl (flip applyNodeOp) n0 (concat ops))

    prop_uniqueIds :: Property
    prop_uniqueIds =
        length (nub bids) === length bids
            &amp; counterexample (&quot;Non-unique ID: &quot; ++ show bids)
      where
        bids = concat [map mockBlockId bs | NodeAddBlocks bs &lt;- concat ops]

prop_nonSingletonRangeGenerator :: NonSingletonRange Int -&gt; Property
prop_nonSingletonRangeGenerator = property $ \(nsr :: NonSingletonRange Int) -&gt;
    isValidNonSingleton nsr .&amp;&amp;. all isValidNonSingleton (shrink nsr)
  where
    isValidNonSingleton (NonSingletonRange r) =
        rangeIsValid r &amp;&amp; not (rangeIsSingleton r) in
</code></pre>
</details>
<h3 id="use-checkcoverage-to-measure-coverage-requirements"><a class="header" href="#use-checkcoverage-to-measure-coverage-requirements">Use <code>checkCoverage</code> to measure coverage requirements</a></h3>
<p>Using <a href="https://hackage.haskell.org/package/QuickCheck-2.13.2/docs/Test-QuickCheck.html#v:label">label</a> or <a href="https://hackage.haskell.org/package/QuickCheck-2.13.2/docs/Test-QuickCheck.html#v:classify">classify</a>
instruments QuickCheck to gather some metrics about a particular properties and print out results in the console. However,
it also possible to <em>enforce</em> that some collected values stay above a certain threshold using <a href="https://hackage.haskell.org/package/QuickCheck-2.13.2/docs/Test-QuickCheck.html#v:checkCoverage">checkCoverage</a>.
When used, QuickCheck will run the property as many times as necessary until a particular coverage requirement is satisfied, with a certain confidence.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>Labelling and classifying is good but, in an evolving code-base where
generators are sometimes shared between multiple properties, it is possible
for someone to accidentally make a generator worse for an existing property
without noticing it. Therefore, by enforcing clear coverage requirements with
<code>checkCoverage</code>, one can make a property fail if the coverage drops below an
acceptable threshold. For example, a property can measure the proportion of
empty lists its generator yield and require that at least 50% of all generated
list are not empty.</p>
</blockquote>
<details>
    <summary>See examples</summary>
<pre><code class="language-hs">prop_rangeIsValid :: Property
prop_rangeIsValid = property $ \(r :: Range Integer) -&gt;
    rangeIsValid r .&amp;&amp;.  all rangeIsValid (shrink r)
        &amp; cover 10 (rangeIsFinite r) &quot;finite range&quot; $
        &amp; checkCoverage

spec :: Spec
spec = do
    describe &quot;Coin selection properties : shuffle&quot; $ do
        it &quot;every non-empty list can be shuffled, ultimately&quot; $
            checkCoverageWith lowerConfidence prop_shuffleCanShuffle
        it &quot;shuffle is non-deterministic&quot; $
            checkCoverageWith lowerConfidence prop_shuffleNotDeterministic
        it &quot;sort (shuffled xs) == sort xs&quot; $
            checkCoverageWith lowerConfidence prop_shufflePreserveElements
  where
    lowerConfidence :: Confidence
    lowerConfidence = Confidence (10^(6 :: Integer)) 0.75
</code></pre>
</details>
<h3 id="avoid-liftio-in-monadic-properties"><a class="header" href="#avoid-liftio-in-monadic-properties">Avoid <code>liftIO</code> in monadic properties</a></h3>
<p>When running monadic properties in IO, it is often required to lift a
particular IO action.  Unfortunately, the <code>PropertyM</code> monad in which the
monadic properties are defined have a <code>MonadIO</code> instance so using <code>liftIO</code> is
tempting. However, one should use <a href="https://hackage.haskell.org/package/QuickCheck-2.13.2/docs/Test-QuickCheck-Monadic.html#v:run">run</a>
in order to lift operation in the property monad.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>This is very important if the property also contains calls to <code>monitor</code>, <code>label</code>, <code>counterexample</code>
and so forth... Using <code>liftIO</code> actually breaks the abstraction boundary of the property monad which
then makes the reporting with these combinator ineffective. Using <code>run</code> however correctly inserts
monadic operations and preserve reporting and measures done during the property.</p>
</blockquote>
<details>
    <summary>See examples</summary>
<pre><code class="language-hs">-- GOOD
setup wid meta = run $ do
    cleanDB db
    unsafeRunExceptT $ createWallet db wid cp0 meta mempty
    unsafeRunExceptT $ putTxHistory db wid txs0

prop wid point = do
    run $ unsafeRunExceptT $ rollbackTo db wid point
    txs &lt;- run $ readTxHistory db wid Descending wholeRange Nothing
    monitor $ counterexample $ &quot;\nTx history after rollback: \n&quot; &lt;&gt; fmt txs
    {- ... -}

-- BAD
prop_createWalletTwice db (key@(PrimaryKey wid), cp, meta) =
    monadicIO (setup &gt;&gt; prop)
  where
    setup = liftIO (cleanDB db)
    prop = liftIO $ do
        let err = ErrWalletAlreadyExists wid
        runExceptT (createWallet db key cp meta mempty) `shouldReturn` Right ()
        runExceptT (createWallet db key cp meta mempty) `shouldReturn` Left err
</code></pre>
</details>
<h2 id="testing-2"><a class="header" href="#testing-2">Testing</a></h2>
<h3 id="test-files-are-separated-and-self-contained"><a class="header" href="#test-files-are-separated-and-self-contained">Test files are separated and self-contained</a></h3>
<p>Test files do not import other test files. Arbitrary instances are not shared
across test files and are defined locally. If we do observe a recurring pattern
in tests (like for instance, testing roundtrips), we may consider making this a
library that test can import.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>It is really easy to make the testing code more complex than the actual code
it's initially testing. Limiting the interaction between test modules helps
keeping a good maintainability and a rather low overhead when it comes to
extend, modify, read or comprehend some tests. Also, in many cases, we do
actually want to have different arbitrary generators for different test cases
so sharing instances is risky and cumbersome.</p>
</blockquote>
<h3 id="unit-test-files-names-match-their-corresponding-module"><a class="header" href="#unit-test-files-names-match-their-corresponding-module">Unit test files names match their corresponding module</a></h3>
<p>Every module from a library has a corresponding test file, within the same
folder architecture, and, sharing a same name prefix. Test files are postfixed
with 'Spec' to distinguish them from their corresponding sources.</p>
<blockquote>
<p><strong>Why</strong></p>
<p>It is much easier to find the corresponding test to a module if they share
a same name. Also, this gives consistency and a clear pattern for naming
tests in order to avoid chaos.</p>
</blockquote>
<details>
  <summary>See examples</summary>
<pre><code>src/
├── Cardano
│   ├── Environment.hs
│   └── Wallet
│       ├── Binary
│       │   └── HttpBridge.hs
│       ├── Compatibility
│       │   └── HttpBridge.hs
│       ├── Network
│       │   ├── HttpBridge
│       │   │   └── Api.hs
│       │   └── HttpBridge.hs
│       └── Transaction
│           └── HttpBridge.hs
├── Data
│   └── Packfile.hs
└── Servant
    └── Extra
        └── ContentTypes.hs
test/unit/
├── Cardano
│   ├── EnvironmentSpec.hs
│   └── Wallet
│       ├── Binary
│       │   └── HttpBridgeSpec.hs
│       ├── Network
│       │   ├── HttpBridge
│       │   │   └── ApiSpec.hs
│       │   └── HttpBridgeSpec.hs
│       └── Transaction
│           └── HttpBridgeSpec.hs
├── Data
│   └── PackfileSpec.hs
└── Servant
    └── Extra
        └── ContentTypesSpec.hs
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logging-guidelines"><a class="header" href="#logging-guidelines">Logging Guidelines</a></h1>
<p>Logs are primarily for <em>users</em> of the cardano-wallet, not its
developers. Such users could be:</p>
<ul>
<li>Engineers who will be running the cardano-wallet in production.</li>
<li>Developers integrating cardano-wallet into their own software.</li>
<li>Technical support staff who need to help solve end users' problems.</li>
</ul>
<p>Users of logging will have a reasonable understanding of how the
cardano-wallet works, but won't be familiar with the code. They need
enough information to be able scan the logs and see if the application
is running normally, or if they need to do some action to fix their
problem.</p>
<h2 id="logging-levels"><a class="header" href="#logging-levels">Logging levels</a></h2>
<p>The <a href="https://github.com/input-output-hk/iohk-monitoring-framework">iohk-monitoring-framework</a> defines a number of <a href="https://github.com/input-output-hk/iohk-monitoring-framework/blob/b0ea8317ba5a887d46969e9b3040862a10e6efb3/iohk-monitoring/src/Cardano/BM/Data/Severity.lhs#L33-L44">severity levels</a>:</p>
<div class="table-wrapper"><table><thead><tr><th><strong>Severity Level</strong></th><th><strong>Meaning</strong></th></tr></thead><tbody>
<tr><td>Debug</td><td>detailed information about values and decision flow</td></tr>
<tr><td>Info</td><td>general information of events; progressing properly</td></tr>
<tr><td>Notice</td><td>needs attention; something not progressing properly</td></tr>
<tr><td>Warning</td><td>may continue into an error condition if continued</td></tr>
<tr><td>Error</td><td>unexpected set of event or condition occurred</td></tr>
<tr><td>Critical</td><td>error condition causing degrade of operation</td></tr>
<tr><td>Alert</td><td>a subsystem is no longer operating correctly, likely requires manual intervention</td></tr>
<tr><td>Emergency</td><td>at this point, the system can never progress without additional intervention</td></tr>
</tbody></table>
</div>
<p>This design was influenced by the <a href="https://en.wikipedia.org/wiki/Syslog#Severity_level"><code>syslog</code> severity
level</a> taxonomy.</p>
<p>These are probably more than we need. To keep things simple, we
usually only log with the first 5:</p>
<div class="table-wrapper"><table><thead><tr><th><strong>Severity Level</strong></th><th><strong>Meaning</strong></th></tr></thead><tbody>
<tr><td>Debug</td><td>Messages that contain information normally of use only when debugging a program.</td></tr>
<tr><td>Info</td><td>Informational messages.</td></tr>
<tr><td>Notice</td><td>Normal but significant conditions.</td></tr>
<tr><td>Warning</td><td>A situation that may become an error.</td></tr>
<tr><td>Error</td><td>Unexpected problem.</td></tr>
</tbody></table>
</div>
<h3 id="debug"><a class="header" href="#debug">Debug</a></h3>
<p>Debug logging will not be enabled by default in production. Therefore,
you should not log information directly relevant to production
operations at this level.</p>
<p>However, the technical support desk may request users enable debug
logging for certain components to get more detail while trying to
diagnose problems in the field.</p>
<p>Such logging might contain:</p>
<ul>
<li>Information about which program decisions were made and why.</li>
</ul>
<p>Don't debug log too much rubbish because somebody will need to read
it. Don't log so much data that the program will malfunction if debug
logging has been enabled.</p>
<p>It is useful to have debug logging of about how the wallet
interacts with other systems. Examples of such logs:</p>
<ul>
<li>Network requests made to node backend.</li>
<li>SQL query logs -- log the queries but not the values.</li>
</ul>
<p>Note from Alexander Diemand:</p>
<blockquote>
<p>Another feature that might help reduce logging volume:
monitoring can watch an observable and compare it to a set
threshold. Once this is exceeded it can create an action: i.e. an
alert message or change the severity filter of a named context or
globally. So one would start up the node with logging filter set to
&quot;Warning&quot; and only change it to &quot;Info&quot; when some monitored observable
has exceeded its threshold</p>
<p>For an exchange that runs the node for ages: another monitor could
also restore the severity filter to e.g. &quot;Warning&quot; if the observed
values return into a normal behaviour range of values.</p>
</blockquote>
<h3 id="info"><a class="header" href="#info">Info</a></h3>
<p>Normal activity within the application. We do need to ensure that INFO
logs are pertinent, and there are not pages and pages of logs per
slot.</p>
<p>Examples:</p>
<ul>
<li>HTTP requests</li>
<li>Wallet-related events
<ul>
<li>A block was applied</li>
<li>New wallet was created</li>
<li>Wallet restoration status</li>
<li>Payment was sent</li>
<li>Payment was received</li>
</ul>
</li>
<li>Network-related events
<ul>
<li>Sync state</li>
</ul>
</li>
<li>Information about the configuration, such as config file location,
or how the wallet was started.</li>
</ul>
<h3 id="notice"><a class="header" href="#notice">Notice</a></h3>
<p>These are occasional messages about significant events for the program.</p>
<p>Examples:</p>
<ul>
<li>The start up message, including the application version.</li>
<li>What TCP port the API server is listening on.</li>
<li>Normal shut down.</li>
<li>Creating a new database file or migrating data.</li>
</ul>
<h3 id="warning"><a class="header" href="#warning">Warning</a></h3>
<p>A warning situation could lead to a future error, or other undesirable
behaviour. The user should be able to do something to make the warning
go away.</p>
<p>Examples:</p>
<ul>
<li>NTP drift?</li>
<li>Low disk space?</li>
</ul>
<h3 id="error"><a class="header" href="#error">Error</a></h3>
<p>This is a serious system problem.
It should not happen under normal circumstances.
Some action is required to rectify the situation.
The wallet might well exit after logging an error message.</p>
<p>Examples:</p>
<ul>
<li>Unexpected error communicating with node backend.</li>
<li>IO error writing database or other state.</li>
<li>Bad user input which means that the action cannot complete.</li>
<li>Unhandled exception.</li>
</ul>
<h2 id="mapping-of-log-levels-to-appearance"><a class="header" href="#mapping-of-log-levels-to-appearance">Mapping of log levels to appearance</a></h2>
<h3 id="cli-tools"><a class="header" href="#cli-tools">CLI tools</a></h3>
<p>Logging from the CLI should not be cluttered with timestamps and other
metadata. It should just look like a normal print statements in a
program. Nonetheless, using the logging framework for CLI output helps
because error messages can be automatically coloured.</p>
<div class="table-wrapper"><table><thead><tr><th><strong>Severity</strong></th><th><strong>Format</strong></th></tr></thead><tbody>
<tr><td>Debug</td><td>Hidden unless enabled by the user</td></tr>
<tr><td>Info</td><td>Printed normally on <code>stdout</code></td></tr>
<tr><td>Notice</td><td>Printed in bold on <code>stdout</code></td></tr>
<tr><td>Warning</td><td>Printed in bold colour on <code>stderr</code> prefixed by <code>Warning: </code></td></tr>
<tr><td>Error</td><td>Printed in bold red on <code>stderr</code> prefixed by <code>ERROR: </code></td></tr>
</tbody></table>
</div>
<h3 id="server"><a class="header" href="#server">Server</a></h3>
<div class="table-wrapper"><table><thead><tr><th><strong>Severity</strong></th><th><strong>Format</strong></th></tr></thead><tbody>
<tr><td>Debug</td><td>Hidden unless enabled by the user</td></tr>
<tr><td>The rest</td><td>As per defaults for <a href="https://github.com/input-output-hk/iohk-monitoring-framework">iohk-monitoring-framework</a></td></tr>
</tbody></table>
</div>
<p>The server will support also support a log config file where the
output location and format can be fully customised.</p>
<h3 id="colour"><a class="header" href="#colour">Colour</a></h3>
<p>If the log output file is not a terminal, do not output ANSI colour
codes. These escape codes make it difficult to analyse log files.</p>
<h3 id="json"><a class="header" href="#json">JSON</a></h3>
<p>JSON (one object per line) is an OK format for log files, but it's
pretty bad for printing the terminal. For example, consider how
difficult it would be to read through JSON messages within <code>journalctl -u cardano-wallet.service</code>. Therefore, log messages to
<code>stdout</code>/<code>stderr</code> should be formatted as text, unless otherwise
configured by the user.</p>
<h2 id="context"><a class="header" href="#context">Context</a></h2>
<p>Some context may be applicable to log events:</p>
<ul>
<li>Current slot number.</li>
<li>Wallet ID.</li>
<li>A request ID for the API, so that requests, their handlers, and
responses can be cross-referenced.</li>
</ul>
<h3 id="logging-hierarchy"><a class="header" href="#logging-hierarchy">Logging Hierarchy</a></h3>
<p>Log <em>Traces</em> can have context added such as a new name. Different
subsystems of the wallet (such as network, database, api) should use
<code>appendName</code> to create subtraces.</p>
<h2 id="observables"><a class="header" href="#observables">Observables</a></h2>
<p>The following are examples of things which should be easy and useful
to log as micro-benchmarks (<code>bracketObserveIO</code>).</p>
<ul>
<li>Time taken for API to respond to request.</li>
<li>Time taken to execute SQL query.</li>
<li>Time taken for node backend to respond to request.</li>
</ul>
<h2 id="privacy"><a class="header" href="#privacy">Privacy</a></h2>
<p><a href="https://github.com/input-output-hk/iohk-monitoring-framework">iohk-monitoring-framework</a> provides &quot;sensitive&quot; variants of log
functions (e.g. <code>logInfoS</code>). These allow sensitive information to be
logged into separate files. Then users may send their logs to the
technical support desk with a reasonable assurance of privacy.</p>
<p><strong>Note</strong>: The privacy guidelines are under discussion. We are
considering making it simpler and only having two classifications:
&quot;Log&quot; or &quot;Do Not Log&quot;.</p>
<h3 id="public-information"><a class="header" href="#public-information">Public information</a></h3>
<ul>
<li>Wallet ID.</li>
<li>Dates and times that events occurred.</li>
<li>Total number of addresses/transactions/UTxOs/etc.</li>
<li>IP addresses of other nodes that network nodes are communicating
with.</li>
</ul>
<h3 id="private-information"><a class="header" href="#private-information">Private information</a></h3>
<ul>
<li>Transaction ID.</li>
<li>Address.</li>
<li>Public key material.</li>
<li>Quantities of Ada.</li>
</ul>
<h3 id="unknown-1"><a class="header" href="#unknown-1">Unknown</a></h3>
<p>Undecided about which category these fall into.</p>
<ul>
<li>Wallet name</li>
</ul>
<h3 id="never-log"><a class="header" href="#never-log">Never log</a></h3>
<p>This information should <em>never</em> be included in log messages (including
DEBUG messages):</p>
<ul>
<li>Private key material.</li>
<li>Mnemonic sentences.</li>
<li>Passphrases.</li>
<li>The values used or returned by SQL queries.</li>
<li>Raw data sent to or received from the network backend.</li>
<li>Raw, un-filtered API request or response bodies.</li>
</ul>
<h2 id="increasing-logging-detail"><a class="header" href="#increasing-logging-detail">Increasing logging detail</a></h2>
<p><a href="https://github.com/input-output-hk/iohk-monitoring-framework">iohk-monitoring-framework</a> provides a facility for adjusting log
levels at runtime on a component by component basis.</p>
<p>However it's probably OK for now to change log levels by restarting
cardano-wallet with different command-line options.</p>
<h2 id="structured-logging-tutorial"><a class="header" href="#structured-logging-tutorial">Structured logging tutorial</a></h2>
<p>Rather than logging unstructured text, define a type for log messages
of a module.</p>
<pre><code class="language-haskell">data FooMsg
    = LogFooInit
    | LogFooError FooError
    | LogFooIncomingEvent Int
    deriving (Show, Eq)
</code></pre>
<p>Then for human-readable logs use our <code>ToText</code> class.</p>
<pre><code class="language-haskell">import Data.Text.Class
    ( ToText (..) )

instance ToText FooMsg where
    toText msg = case msg of
        LogFooInit -&gt; &quot;The foo has started&quot;
        LogFooError e -&gt; &quot;foo error: &quot; &lt;&gt; T.pack (show e)
        LogFooIncomingEvent -&gt; &quot;Incoming foo event &quot; &lt;&gt;  T.pack (show e)
</code></pre>
<p>Finally, define the metadata which the switchboard needs to route
these traces.</p>
<pre><code class="language-haskell">import Cardano.BM.Data.LogItem
    ( LoggerName, PrivacyAnnotation (..) )
import Cardano.BM.Data.Severity
    ( Severity (..) )
import Cardano.BM.Data.Tracer
    ( DefinePrivacyAnnotation (..), DefineSeverity (..) )

-- Everything is public by default
instance DefinePrivacyAnnotation FooMsg

instance DefineSeverity FooMsg
    defineSeverity msg = case msg of
        LogFooInit -&gt; Debug
        LogFooError _ -&gt; Error
        LogFooIncomingEvent -&gt; Info
</code></pre>
<p>To use the logging in the <code>doFoo</code> function:</p>
<pre><code class="language-haskell">import Cardano.BM.Trace
    ( Trace )
import Cardano.Wallet.Logging
    ( logTrace )

doFoo :: Trace IO FooMsg -&gt; IO ()
doFoo tr = do
    logTrace tr LogFooInit
    onFooEvent $ \ev -&gt; case ev of
       Right n -&gt; logTrace tr $ LogFooIncomingEvent n
       Left e -&gt; logTrace tr $ LogFooError e
</code></pre>
<p>To convert to <code>Trace m FooMsg</code> to <code>Trace m Text</code> (well actually - the
other way around), use <code>Cardano.Wallet.Logging.transformTextTrace</code>,
like so:</p>
<pre><code class="language-haskell">import Control.Tracer
    ( contramap )
import Cardano.Wallet.Logging
    ( transformTextTrace )
import Foo (doFoo)

mainApp :: Trace IO Text -&gt; IO ()
mainApp tr = doFoo (transformTextTrace tr)
</code></pre>
<p>To convert a <code>Trace m FooMsg</code> to anything else, use <code>contramap</code>.</p>
<pre><code class="language-haskell">data AppMsg
    = FooMsg FooMsg
    | BarMsg BarMsg
    | TextMsg Text

mainApp :: Trace IO AppMsg -&gt; IO ()
mainApp tr = doFoo (contramap (fmap FooMsg) tr)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="swagger"><a class="header" href="#swagger">Swagger</a></h1>
<p>The OpenAPI 3.0 (Swagger) specification of cardano-wallet is located at <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/specifications/api/swagger.yaml">specifications/api/swagger.yaml</a>.</p>
<h2 id="viewing-online"><a class="header" href="#viewing-online">Viewing online</a></h2>
<p>To view the file online, use:</p>
<ul>
<li>
<p><a href="contributor/what/../user-guide/http-api.html">http-api</a>
for the latest released version.</p>
</li>
<li>
<p><a href="https://redocly.github.io/redoc/?url=https://raw.githubusercontent.com/cardano-foundation/cardano-wallet/master/specifications/api/swagger.yaml">ReDoc viewer</a> for the <code>master</code> branch version.</p>
</li>
</ul>
<h2 id="validating-locally"><a class="header" href="#validating-locally">Validating locally</a></h2>
<p>To validate from your local git working tree, use this command. It is the same as what <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/.buildkite/pipeline.yml">Buildkite</a> runs.</p>
<pre><code>openapi-spec-validator --schema 3.0.0 specifications/api/swagger.yaml
</code></pre>
<p>If you don't have the validator tool installed, it is available within <code>nix-shell</code>.</p>
<p>It may also be convenient to edit the YAML while validating under the <a href="https://github.com/schell/steeloverseer#readme">Steel Overseer</a> file watching tool:</p>
<pre><code>sos specifications/api/swagger.yaml -c 'openapi-spec-validator --schema 3.0.0 \0'
</code></pre>
<h2 id="references-1"><a class="header" href="#references-1">References</a></h2>
<ul>
<li>
<p><a href="https://swagger.io/docs/">Swagger Docs</a></p>
</li>
<li>
<p><a href="http://json-schema.org/understanding-json-schema/index.html">Understanding JSON Schema</a></p>
</li>
<li>
<p><a href="https://yaml.org/spec/1.2/spec.html">YAML spec</a></p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="specifying-exceptions-with-servant-and-swagger"><a class="header" href="#specifying-exceptions-with-servant-and-swagger">Specifying Exceptions with Servant and Swagger</a></h1>
<h2 id="contents"><a class="header" href="#contents">Contents</a></h2>
<ul>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#specifying-exceptions-with-servant-and-swagger">Specifying Exceptions with Servant and Swagger</a>
<ul>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#contents">Contents</a></li>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#goal">Goal</a></li>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#background">Background</a></li>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#example">Example</a></li>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#what-do-we-really-want">What do we really want?</a></li>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#how-can-we-achieve-this">How can we achieve this?</a>
<ul>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#adding-custom-errors-to-the-generated-swagger-output">Adding custom errors to the generated Swagger output</a></li>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#removing-default-errors-from-the-generated-swagger-output">Removing default errors from the generated Swagger output</a></li>
</ul>
</li>
<li><a href="contributor/what/specifying-exceptions-with-servant-and-swagger.html#complete-working-example-project">Complete working example project</a></li>
</ul>
</li>
</ul>
<h2 id="goal"><a class="header" href="#goal">Goal</a></h2>
<p>To be able to exert fine-grained control over errors defined in Swagger API specifications.</p>
<h2 id="background-1"><a class="header" href="#background-1">Background</a></h2>
<p>Our API is defined in Haskell with <a href="https://haskell-servant.github.io/">Servant</a>, and translated into <a href="https://swagger.io/">Swagger</a> format using the <a href="http://hackage.haskell.org/package/servant-swagger"><code>servant-swagger</code></a> library.</p>
<p>Swagger makes it possible to specify that an endpoint can return one or more errors. For example, the following specification states that the endpoint can return a <code>404</code> (not found) error:</p>
<pre><code class="language-JSON">&quot;responses&quot; :
  { &quot;200&quot; : { &quot;schema&quot; : {&quot;$ref&quot; : &quot;#/definitions/Location&quot; }
            , &quot;description&quot; : &quot;the matching location&quot; } }
  , &quot;404&quot; : { &quot;description&quot; : &quot;a matching location was not found&quot; }
</code></pre>
<p>By default, Servant doesn't provide a way for API authors to manually specify errors they might wish to return. However, this might be desirable: consider the case where you'd like to perform validation based on constraints that are not conveniently expressible in the Haskell type system. In this case, you would reject input at run-time, but this would typically not be reflected in the Servant type.</p>
<p>Since Servant itself doesn't provide a way to manually specify errors, and since it is typical to define errors when writing a Swagger specification, <code>servant-swagger</code> takes the approach of <strong>auto-generating</strong> errors when various Servant combinators appear in the API. For example, when a <code>Capture</code> combinator is used, <code>servant-swagger</code> automatically inserts a <code>404</code> (not found) error in the generated Swagger output.</p>
<p>However, auto-generation of error responses has two problems:</p>
<ol>
<li>The generated error responses are sometimes <strong>incomplete</strong>.</li>
<li>The generated error responses are sometimes <strong>inappropriate</strong>.</li>
</ol>
<h2 id="example-3"><a class="header" href="#example-3">Example</a></h2>
<p>Consider the following endpoint, allowing the caller to add a new <code>Location</code> to a location database:</p>
<pre><code class="language-Haskell">type AddLocation = &quot;location&quot;
  :&gt; &quot;add&quot;
  :&gt; Summary &quot;Add a new location&quot;
  :&gt; Capture &quot;locationName&quot; Text
  :&gt; Put '[JSON] Location
</code></pre>
<p>By default, the generated Swagger output includes a 404 error (not found):</p>
<pre><code class="language-JSON">&quot;/location/add/{locationName}&quot; :
  { &quot;put&quot; :
    { &quot;parameters&quot; : [ { &quot;in&quot; : &quot;path&quot;
                       , &quot;type&quot; : &quot;string&quot;
                       , &quot;name&quot; : &quot;locationName&quot;
                       , &quot;required&quot; : true } ]
    , &quot;responses&quot; :
      { &quot;200&quot; : { &quot;schema&quot; : { &quot;$ref&quot; : &quot;#/definitions/Location&quot; }
                , &quot;description&quot; : &quot;the added location&quot; }
      , &quot;404&quot; : { &quot;description&quot; : &quot;`locationName` not found&quot; } }
    , &quot;summary&quot; : &quot;Add a new location&quot;
    , &quot;produces&quot; : [&quot;application/json;charset=utf-8&quot;] } }
</code></pre>
<p>In the above example:</p>
<ol>
<li>The generated error is <strong>inappropriate</strong>. Since we're adding a new location (and not looking up an existing location), we don't want to ever return a <code>404</code>.</li>
<li>The error we really want is <strong>missing</strong>. We'd like to perform various validation checks on the new location name, and possibly return a <code>400</code> error if validation fails. However, this isn't included in the generated Swagger output.</li>
</ol>
<h2 id="what-do-we-really-want"><a class="header" href="#what-do-we-really-want">What do we really want?</a></h2>
<p>Suppose that adding a <code>Location</code> can fail in two ways, either because:</p>
<ul>
<li>the location name is too short; or</li>
<li>the location name contains invalid characters.</li>
</ul>
<p>We'd ideally like for the <code>&quot;responses&quot;</code> section to reflect the above modes of failure:</p>
<pre><code class="language-JSON">&quot;responses&quot; :
  { &quot;200&quot; : { &quot;schema&quot; : { &quot;$ref&quot; : &quot;#/definitions/Location&quot; }
            , &quot;description&quot; : &quot;the added location&quot; }
  , &quot;400&quot; : { &quot;description&quot; :
                &quot;the location name was too short
                 OR
                 the location name contained invalid characters&quot; } }
</code></pre>
<h2 id="how-can-we-achieve-this"><a class="header" href="#how-can-we-achieve-this">How can we achieve this?</a></h2>
<p>The <a href="http://hackage.haskell.org/package/servant-checked-exceptions"><code>servant-checked-exceptions</code></a> package defines the <a href="http://hackage.haskell.org/package/servant-checked-exceptions-core-2.0.0.0/docs/Servant-Checked-Exceptions-Internal-Servant-API.html#t:Throws"><code>Throws</code> combinator</a>, making it possible to specify individual exceptions as part of the endpoint definition.</p>
<p>Let's have a look at how we might use the <code>Throws</code> combinator to define our modes of failure:</p>
<pre><code class="language-Haskell">type AddLocation = &quot;location&quot;
  :&gt; &quot;add&quot;
  :&gt; Summary &quot;Add a new location&quot;
  :&gt; Throws LocationNameHasInvalidCharsError
  :&gt; Throws LocationNameTooShortError
  :&gt; Capture &quot;locationName&quot; Text
  :&gt; Put '[JSON] Location

data LocationNameTooShortError = LocationNameTooShortError
  deriving (Eq, Generic, Read, Show)
data LocationNameHasInvalidCharsError = LocationNameHasInvalidCharsError
  deriving (Eq, Generic, Read, Show)
</code></pre>
<p>The above type specifies an endpoint that can throw two different types of exception.</p>
<p>It's possible to assign specific response codes to individual exceptions by defining <a href="http://hackage.haskell.org/package/servant-checked-exceptions-core-2.0.0.0/docs/Servant-Checked-Exceptions-Internal-Servant-API.html#t:ErrStatus"><code>ErrStatus</code></a> instances. In our example, both exceptions will share the same response code <code>400</code> (bad request):</p>
<pre><code class="language-Haskell">instance ErrStatus LocationNameHasInvalidCharsError where
  toErrStatus _ = toEnum 400
instance ErrStatus LocationNameTooShortError where
  toErrStatus _ = toEnum 400
</code></pre>
<p>For client code that's written in Haskell, the <code>servant-checked-exceptions</code> library provides the very useful <a href="https://hackage.haskell.org/package/servant-checked-exceptions-core/docs/Servant-Checked-Exceptions-Internal-Envelope.html#v:catchesEnvelope"><code>catchesEnvelope</code></a> function, allowing the caller to perform exception case analysis on values returned by an API.</p>
<p>So far so good.</p>
<p>However there are two problems that we need to solve:</p>
<ol>
<li><code>servant-swagger</code> doesn't know what to do with the <code>Throws</code> combinator.</li>
<li><code>servant-swagger</code> inserts its own default error response codes.</li>
</ol>
<p>In the sections below, we attempt to solve these errors.</p>
<h3 id="adding-custom-errors-to-the-generated-swagger-output"><a class="header" href="#adding-custom-errors-to-the-generated-swagger-output">Adding custom errors to the generated Swagger output</a></h3>
<p>Recall that Swagger error definitions include a description:</p>
<pre><code class="language-JSON">&quot;400&quot; : { &quot;description&quot; : &quot;the location name was too short&quot; }
</code></pre>
<p>By default, <code>servant-checked-exceptions</code> doesn't provide a way to define descriptions for exceptions. We can solve this by defining our own <code>ErrDescription</code> class, and providing instances:</p>
<pre><code class="language-Haskell">class ErrDescription e where
  toErrDescription :: e -&gt; Text

instance ErrDescription LocationNameHasInvalidCharsError where
  toErrDescription _ =
    &quot;the location name contained non-alphabetic characters&quot;
instance ErrDescription LocationNameTooShortError where
  toErrDescription _ =
    &quot;the location name was too short&quot;
</code></pre>
<p>To include these descriptions in the generated Swagger output, we need to define a new instance of the <a href="http://hackage.haskell.org/package/servant-swagger-1.1.7/docs/Servant-Swagger-Internal.html"><code>HasSwagger</code></a> type class:</p>
<pre><code class="language-Haskell">type IsErr err = (ErrDescription err, ErrStatus err)

instance (IsErr err, HasSwagger sub) =&gt; HasSwagger (Throws err :&gt; sub)
  where
    toSwagger _ =
      toSwagger (Proxy :: Proxy sub) &amp;
        setResponseWith
          (\old _ -&gt; addDescription old)
          (fromEnum $ toErrStatus (undefined :: err))
          (return $ mempty &amp; description .~ errDescription)
        where
          addDescription = description %~ ((errDescription &lt;&gt; &quot; OR &quot;) &lt;&gt;)
          errDescription = toErrDescription (undefined :: err)
</code></pre>
<p>Note that in the above instance, if multiple errors share the same response code, then we concatenate together the descriptions, separating the descriptions with <code>&quot; OR &quot;</code>.</p>
<p>Let's have a look at the auto-generated output:</p>
<pre><code class="language-JSON">&quot;responses&quot; :
  { &quot;200&quot; : { &quot;schema&quot; : { &quot;$ref&quot; : &quot;#/definitions/Location&quot; }
            , &quot;description&quot; : &quot;the added location&quot; }
  , &quot;400&quot; : { &quot;description&quot; :
                &quot;the location name was too short
                 OR
                 the location name contained invalid characters&quot; }
  , &quot;404&quot; : { &quot;description&quot; : &quot;`locationName` not found&quot; } }
</code></pre>
<p>The <code>400</code> section now contains what we want.</p>
<p>However, the unwanted <code>404</code> section is still there. Recall that this is generated automatically by <code>servant-swagger</code>. How can we remove this default error response?</p>
<h3 id="removing-default-errors-from-the-generated-swagger-output"><a class="header" href="#removing-default-errors-from-the-generated-swagger-output">Removing default errors from the generated Swagger output</a></h3>
<p>Currently, <code>servant-swagger</code> doesn't provide a way to disable the generation of default error responses. There are several possible ways to solve this:</p>
<ol>
<li>
<p>Provide a patch to <code>servant-swagger</code> that adds a configuration option to disable the generation of default error responses. See <a href="https://github.com/jonathanknowles/servant-swagger/tree/jonathanknowles/disable-default-error-responses">here</a> for a simple fork that disables all default error responses.</p>
</li>
<li>
<p>Define a new alternative <code>Capture</code> operator and associated <code>HasSwagger</code> instances that don't generated default error responses. The downside is that this might require us to define instances for multiple other type classes.</p>
</li>
<li>
<p>Amend the <code>HasSwagger</code> instance of <code>Throws</code> to detect and erase any default error responses. This solution would be rather brittle, as it would require the <code>Throws</code> combinator to appear at a particular place in endpoint definition.</p>
</li>
<li>
<p>Add a new combinator that disables the generation of default error responses. This solution would also be rather brittle, as it would require the new combinator to appear at a particular place in the endpoint definition.</p>
</li>
</ol>
<h2 id="complete-working-example-project"><a class="header" href="#complete-working-example-project">Complete working example project</a></h2>
<p>See the following example project for a complete working example:</p>
<p>https://github.com/jonathanknowles/servant-checked-exceptions-example</p>
<p>Note that the above example also uses a <strong>patched</strong> version of <code>servant-client</code>, to allow pattern matching on error responses with the <code>catchesEnvelope</code> function.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-1"><a class="header" href="#nix-1">Nix</a></h1>
<p><a href="https://nixos.org">Nix</a> is a package manager and build tool. It is used in <code>cardano-wallet</code> for:</p>
<ul>
<li>Provisioning dependencies in <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/.buildkite">Buildkite CI</a>.</li>
<li>Reproducible development environments (<a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/flake.nix">nix develop</a>).</li>
</ul>
<p>Nix is not required for <code>cardano-wallet</code> development, but it can help you a lot if you try it.</p>
<h2 id="installingupgrading-nix"><a class="header" href="#installingupgrading-nix">Installing/Upgrading Nix</a></h2>
<p>The minimum required version of Nix is 2.5.</p>
<ul>
<li><a href="https://nixos.org/manual/nix/stable/#ch-installing-binary">Nix Package Manager Guide: Installation</a></li>
<li><a href="https://nixos.org/manual/nix/stable/#ch-upgrading-nix">Nix Package Manager Guide: Upgrading Nix</a></li>
</ul>
<h2 id="binary-cache"><a class="header" href="#binary-cache">Binary cache</a></h2>
<p>To improve build speed, it is <strong>highly recommended</strong> (but not mandatory) to configure the <strong>binary cache maintained by IOG</strong>.</p>
<p>See <a href="https://github.com/input-output-hk/iohk-nix/blob/8b1d65ba294708b12d7b15103ac35431d9b60819/docs/nix.md">iohk-nix/docs/nix.md</a> or <a href="https://github.com/IntersectMBO/cardano-node/blob/468f52e5a6a2f18a2a89218a849d702481819f0b/doc/getting-started/building-the-node-using-nix.md#building-under-nix">cardano-node/doc/getting-started/building-the-node-using-nix.md</a>
for instructions on how to configure the IOG binary cache on your system.</p>
<h2 id="building-with-nix"><a class="header" href="#building-with-nix">Building with Nix</a></h2>
<p>See the
<a href="contributor/what/../developer-guide/building.html#nix">Building</a>
page.</p>
<h2 id="reproducible-development-environment"><a class="header" href="#reproducible-development-environment">Reproducible Development Environment</a></h2>
<p>Run <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-develop.html"><code>nix develop</code></a> to get a build environment which includes all
necessary compilers, libraries, and development tools.</p>
<p>This uses the <code>devShell</code> attribute of <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/flake.nix"><code>flake.nix</code></a>.</p>
<p>Full instructions are on the <a href="contributor/what/../developer-guide/building.html#nix">Building</a>
page.</p>
<h2 id="development-tips"><a class="header" href="#development-tips">Development tips</a></h2>
<h3 id="code-generation"><a class="header" href="#code-generation">Code generation</a></h3>
<p>The Nix build depends on code which is generated from
the Cabal files. If you change these files, then you will probably
need to update the generated files.</p>
<p>To do this, run:</p>
<pre><code>./nix/regenerate.sh
</code></pre>
<p>Then add and commit the files that it creates.</p>
<p>Alternatively, wait for Buildkite to run this same command. It will
produce a patch, and also push a commit with updates back to your
branch.</p>
<h3 id="haskellnix-pin"><a class="header" href="#haskellnix-pin">Haskell.nix pin</a></h3>
<p>The Nix build also depends on the <a href="https://github.com/input-output-hk/haskell.nix">Haskell.nix</a> build infrastructure.
It may be necessary to update <code>haskell.nix</code> when moving to a
new Haskell LTS version or adding Hackage dependencies.</p>
<p>To update to the latest version, run the following command:</p>
<pre><code class="language-console">$ nix flake lock --update-input haskellNix
warning: updating lock file '/home/rodney/iohk/cw/flake/flake.lock':
• Updated input 'haskellNix':
    'github:input-output-hk/haskell.nix/f05b4ce7337cfa833a377a4f7a889cdbc6581103' (2022-01-11)
  → 'github:input-output-hk/haskell.nix/a3c9d33f301715b162b12afe926b4968f2fe573d' (2022-01-17)
• Updated input 'haskellNix/hackage':
    'github:input-output-hk/hackage.nix/d3e03042af2d0c71773965051d29b1e50fbb128e' (2022-01-11)
  → 'github:input-output-hk/hackage.nix/3e64c7f692490cb403a258209e90fd589f2434a0' (2022-01-17)
• Updated input 'haskellNix/stackage':
    'github:input-output-hk/stackage.nix/308844000fafade0754e8c6641d0277768050413' (2022-01-11)
  → 'github:input-output-hk/stackage.nix/3c20ae33c6e59db9ba49b918d69caefb0187a2c5' (2022-01-15)
warning: Git tree '/home/rodney/iohk/cw/flake' is dirty
</code></pre>
<p>Then commit the updated
<a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/flake.lock">flake.lock</a>
file.</p>
<p>When updating Haskell.nix, consult the <a href="https://github.com/input-output-hk/haskell.nix/blob/master/changelog.md#L1">ChangeLog</a> file. There may have been API changes which need corresponding updates in <code>cardano-wallet</code>.</p>
<h3 id="iohk-nix-pin"><a class="header" href="#iohk-nix-pin">iohk-nix pin</a></h3>
<p>The procedure for updating the <a href="https://github.com/input-output-hk/iohk-nix"><code>iohk-nix</code></a> library of common code is much the same as for Haskell.nix. Run this command and commit the updated <code>flake.lock</code> file:</p>
<pre><code class="language-console">$ nix flake lock --update-input iohkNix
</code></pre>
<p>It is not often necessary to update <code>iohk-nix</code>. Before updating, ask devops whether there may be changes which affect our build.</p>
<h2 id="common-problems"><a class="header" href="#common-problems">Common problems</a></h2>
<h3 id="warning-dumping-very-large-path"><a class="header" href="#warning-dumping-very-large-path">Warning: dumping very large path</a></h3>
<pre><code>warning: dumping very large path (&gt; 256 MiB); this may run out of memory
</code></pre>
<p>Make sure you don't have large files or directories in your git worktree.</p>
<p>When building, Nix will copy the project sources into
<code>/nix/store</code>. Generated folders such as <code>dist-newstyle</code> will be filtered
out, but everything else will be copied.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-flake"><a class="header" href="#nix-flake">Nix flake</a></h1>
<h2 id="status"><a class="header" href="#status">Status</a></h2>
<p>Accepted - <a href="https://cardanofoundation.atlassian.net/browse/ADP-983">ADP-983</a></p>
<h2 id="context-1"><a class="header" href="#context-1">Context</a></h2>
<p>The DevOps team have contributed a <a href="https://github.com/cardano-foundation/cardano-wallet/pull/2997">PR</a> which converts the Nix build to the new Nix flake format.</p>
<p>This <a href="https://www.tweag.io/blog/2020-05-25-flakes/">blog series</a> provides some background information on flakes.</p>
<p>DevOps team also wish to convert Daedalus to use Nix flakes.
For this to work well, it's better that Daedalus dependencies
such as cardano-wallet are also defined as flakes.</p>
<p>The <em>tl;dr</em> for flakes is that <code>default.nix</code> and <code>shell.nix</code> are deprecated in favour of <code>flake.nix</code>.
You type <code>nix build .#cardano-wallet</code> instead of <code>nix-build -A cardano-wallet</code> and you type <code>nix develop</code> instead of <code>nix-shell</code>.</p>
<h2 id="decision"><a class="header" href="#decision">Decision</a></h2>
<p>Review and merge <a href="https://github.com/cardano-foundation/cardano-wallet/pull/2997">PR #2997</a>, since flakes seem to be the future and offer some benefits to developers.</p>
<p>This will add a <code>flake.nix</code> file, and replace <code>default.nix</code>, <code>shell.nix</code>, and <code>release.nix</code> with backwards compatibility shims.</p>
<ul>
<li>Pay close attention to any broken builds or CI processes which may result from these changes.</li>
<li>Ensure that the documentation is updated with the new build commands.</li>
<li>Notify developers that the Nix build files have changed, and they may need to modify the commands which they use.</li>
<li>After a while, remove <code>default.nix</code> and <code>shell.nix</code> and associated compatibility code.</li>
</ul>
<h2 id="consequences"><a class="header" href="#consequences">Consequences</a></h2>
<ol>
<li>Developers and users of the Nix build will now need Nix version 2.4 at least - Nix 2.5 is probably better.</li>
<li>The <code>nix build</code> CLI for building with flakes seems nicer than the old <code>nix-build</code>.</li>
<li>Apparently, <code>nix develop</code> has better caching than <code>nix-shell</code>, and so it will be faster to start the dev environment.</li>
<li>The process for updating Nix dependencies (e.g. Haskell.nix) is easier and more sane - <code>nix flake lock</code>.</li>
<li>Other PRs which are open may need to be rebased on latest <code>master</code> for their CI to pass.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how--processes"><a class="header" href="#how--processes">How – Processes</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-3"><a class="header" href="#testing-3">Testing</a></h1>
<h2 id="pre-requisites-for-a-fast-development-cycle"><a class="header" href="#pre-requisites-for-a-fast-development-cycle">Pre-requisites for a fast development cycle</a></h2>
<p>Enter a valid shell with:</p>
<pre><code>nix develop
</code></pre>
<p>before running the tests. This will bring into scope all the necessary tools and dependencies.</p>
<h2 id="unit-tests"><a class="header" href="#unit-tests">Unit Tests</a></h2>
<pre><code>just unit-tests-cabal
</code></pre>
<h3 id="matching-the-test-title"><a class="header" href="#matching-the-test-title">matching the test title</a></h3>
<pre><code>just unit-test-cabal-match &quot;something matching the title&quot;
</code></pre>
<h2 id="integration-tests"><a class="header" href="#integration-tests">Integration Tests</a></h2>
<h2 id="babbage-era"><a class="header" href="#babbage-era">babbage era</a></h2>
<pre><code>just babbage-integration-tests-cabal
</code></pre>
<h3 id="matching-the-test-title-1"><a class="header" href="#matching-the-test-title-1">matching the test title</a></h3>
<pre><code>just babbage-integration-tests-cabal-match &quot;something matching the title&quot;
</code></pre>
<h2 id="conway-era"><a class="header" href="#conway-era">conway era</a></h2>
<pre><code>just conway-integration-tests-cabal
</code></pre>
<h3 id="matching-the-test-title-2"><a class="header" href="#matching-the-test-title-2">matching the test title</a></h3>
<pre><code>just conway-integration-tests-cabal-match &quot;something matching the title&quot;
</code></pre>
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment Variables</a></h2>
<p>Several environment variables control debugging features of the
integration tests and test cluster.</p>
<div class="table-wrapper"><table><thead><tr><th><strong>Variable</strong></th><th><strong>Type</strong></th><th><strong>Meaning</strong></th><th><strong>Default</strong></th></tr></thead><tbody>
<tr><td><code>CARDANO_WALLET_PORT</code></td><td>number</td><td>Set a specific port for the wallet HTTP server</td><td>Random unused port</td></tr>
<tr><td><code>NO_CLEANUP</code></td><td>bool</td><td>Leave the temporary directory after tests have finished.</td><td>Delete directory on exit</td></tr>
<tr><td><code>CARDANO_WALLET_TRACING_MIN_SEVERITY</code></td><td>severity</td><td>Log level for the cardano-wallet server under test.</td><td>Critical</td></tr>
<tr><td><code>CARDANO_NODE_TRACING_MIN_SEVERITY</code></td><td>severity</td><td>Log level for the test cluster nodes</td><td>Info</td></tr>
<tr><td><code>TESTS_TRACING_MIN_SEVERITY</code></td><td>severity</td><td>Log level for test suite and cluster</td><td>Notice</td></tr>
<tr><td><code>TESTS_LOGDIR</code></td><td>path</td><td>Write log files in the given directory</td><td>Log files are written to the tests temp directory</td></tr>
<tr><td><code>TESTS_RETRY_FAILED</code></td><td>bool</td><td>Enable retrying once of failed tests</td><td>No retrying</td></tr>
<tr><td><code>TOKEN_METADATA_SERVER</code></td><td>URL</td><td>Use this URL for querying asset metadata</td><td>Asset metadata fetching disabled</td></tr>
<tr><td><code>NO_CACHE_LISTPOOLS</code></td><td>bool</td><td>Do not cache pool listing retrieved from cardano-node. <em>Testing only. Use <code>--no-cache-listpools</code> command line for executable</em>.</td><td>Stake distribution is cached to improve responsiveness</td></tr>
<tr><td><code>CACHE_LISTPOOLS_TTL</code></td><td>number</td><td>Cache time to live (TTL) for pool listing. <em>Testing only. Use <code>--no-cache-listpools</code> command line for executable</em>.</td><td>6 seconds for test builds</td></tr>
</tbody></table>
</div>
<p>Here are the possible values of different types of environment variables:</p>
<div class="table-wrapper"><table><thead><tr><th><strong>Type</strong></th><th><strong>Values</strong></th></tr></thead><tbody>
<tr><td>bool</td><td>unset or empty ⇒ <em>false</em>, anything else ⇒ <em>true</em></td></tr>
<tr><td>severity</td><td>debug, info, notice, warning, error, critical</td></tr>
</tbody></table>
</div>
<h4 id="logging-and-debugging"><a class="header" href="#logging-and-debugging">Logging and debugging</a></h4>
<p>If your test has failed, viewing the logs often helps. They are
written to file in the integration tests temporary directory.</p>
<p>To inspect this directory after the tests have finished, set the <code>NO_CLEANUP</code>
variable.</p>
<details>
    <summary>Here is an example tree</summary>
<pre><code>/tmp/test-8b0f3d88b6698b51
├── bft
│   ├── cardano-node.log
│   ├── db
│   ├── genesis.json
│   ├── node.config
│   ├── node-kes.skey
│   ├── node.opcert
│   ├── node.socket
│   ├── node.topology
│   └── node-vrf.skey
├── pool-0
│   ├── cardano-node.log
│   ├── db
│   ├── dlg.cert
│   ├── faucet.prv
│   ├── genesis.json
│   ├── kes.prv
│   ├── kes.pub
│   ├── metadata.json
│   ├── node.config
│   ├── node.socket
│   ├── node.topology
│   ├── op.cert
│   ├── op.count
│   ├── op.prv
│   ├── op.pub
│   ├── pool.cert
│   ├── sink.prv
│   ├── sink.pub
│   ├── stake.cert
│   ├── stake.prv
│   ├── stake.pub
│   ├── tx.raw
│   ├── tx.signed
│   ├── vrf.prv
│   └── vrf.pub
├── pool-1
│   ├── cardano-node.log
│   ├── db
│   ├── dlg.cert
│   ├── faucet.prv
│   ├── genesis.json
│   ├── kes.prv
│   ├── kes.pub
│   ├── metadata.json
│   ├── node.config
│   ├── node.socket
│   ├── node.topology
│   ├── op.cert
│   ├── op.count
│   ├── op.prv
│   ├── op.pub
│   ├── pool.cert
│   ├── sink.prv
│   ├── sink.pub
│   ├── stake.cert
│   ├── stake.prv
│   ├── stake.pub
│   ├── tx.raw
│   ├── tx.signed
│   ├── vrf.prv
│   └── vrf.pub
├── pool-2
│   ├── cardano-node.log
│   ├── db
│   ├── dlg.cert
│   ├── faucet.prv
│   ├── genesis.json
│   ├── kes.prv
│   ├── kes.pub
│   ├── metadata.json
│   ├── node.config
│   ├── node.socket
│   ├── node.topology
│   ├── op.cert
│   ├── op.count
│   ├── op.prv
│   ├── op.pub
│   ├── pool.cert
│   ├── sink.prv
│   ├── sink.pub
│   ├── stake.cert
│   ├── stake.prv
│   ├── stake.pub
│   ├── tx.raw
│   ├── tx.signed
│   ├── vrf.prv
│   └── vrf.pub
├── wallets-b33cfce13ce1ac74
│   └── stake-pools.sqlite
├── cluster.log
└── wallet.log

</code></pre>
</details>
<p>The default log level for log files is Info.</p>
<p>Only Error level logs are shown on stdout during test execution. To
change this, set the <code>*_MIN_SEVERITY</code> variables shown above.</p>
<h4 id="common-failures-and-resolution"><a class="header" href="#common-failures-and-resolution">Common Failures and Resolution</a></h4>
<h5 id="no-more-wallets"><a class="header" href="#no-more-wallets">No More Wallets</a></h5>
<p>If your test fails with something like:</p>
<pre><code>user error (No more faucet wallet available in MVar!)
</code></pre>
<p>Generate more wallet mnemonics and populate the appropriate list in <code>lib/wallet/src/Test/Integration/Faucet.hs</code>.</p>
<p>Generate new mnemonics with:</p>
<pre><code>nix build .#cardano-wallet
# Size may vary depending on which array you need to add to.
./result/bin/cardano-wallet recovery-phrase generate --size 15
</code></pre>
<h2 id="mock-servers"><a class="header" href="#mock-servers">Mock servers</a></h2>
<p>Use the <code>cardano-wallet:mock-token-metadata-server</code> executable as a
mock server for asset metadata. See the <code>--help</code> output for full
instructions.</p>
<h2 id="benchmarks-1"><a class="header" href="#benchmarks-1">Benchmarks</a></h2>
<h3 id="database"><a class="header" href="#database">Database</a></h3>
<pre><code>$ cabal bench cardano-wallet:db
</code></pre>
<h3 id="restoration"><a class="header" href="#restoration">Restoration</a></h3>
<h4 id="pre-requisites-11"><a class="header" href="#pre-requisites-11">Pre-requisites</a></h4>
<ol>
<li>
<p>Follow the pre-requisites from <code>integration</code> above</p>
</li>
<li>
<p>(Optional) Install <a href="https://hackage.haskell.org/package/hp2pretty">hp2pretty</a></p>
<pre><code>$ cabal install hp2pretty
</code></pre>
</li>
</ol>
<h4 id="test"><a class="header" href="#test">Test</a></h4>
<div id="admonition-warning" class="admonition warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="contributor/how/testing.html#admonition-warning"></a></p>
</div>
<div>
<p>Restoration benchmarks will catch up with the chain before running which can
take quite a long time in the case of <code>mainnet</code>. For a better experience, make
sure your system isn't too far behind the tip before running.</p>
</div>
</div>
<pre><code>$ cabal bench cardano-wallet:restore
</code></pre>
<p>Alternatively, one can specify a target network (by default, benchmarks run on <code>testnet</code>):</p>
<pre><code>$ cabal bench cardano-wallet:restore --benchmark-options &quot;mainnet&quot;
</code></pre>
<p>Also, it's interesting to look at heap consumption during the running of the benchmark:</p>
<pre><code>$ cabal bench cardano-wallet:restore --benchmark-options &quot;mainnet +RTS -h -RTS&quot;
$ hp2pretty restore.hp
$ eog restore.svg
</code></pre>
<h2 id="code-coverage"><a class="header" href="#code-coverage">Code Coverage</a></h2>
<h4 id="pre-requisites-12"><a class="header" href="#pre-requisites-12">Pre-requisites</a></h4>
<ol>
<li>Follow the pre-requisites from <code>integration</code> above</li>
</ol>
<h4 id="test-1"><a class="header" href="#test-1">Test</a></h4>
<p>Running combined code coverage on all components is pretty easy. This generates code coverage reports in an HTML format as well as a short summary in the console. Note that, because code has to be compiled in a particular way to be &quot;instrumentable&quot; by the code coverage engine, it is recommended to run this command using another working directory (<code>--builddir</code> option) so that one can easily switch between coverage testing and standard testing (faster to run):</p>
<pre><code>$ cabal test all --enable-coverage --builddir .dist-coverage
</code></pre>
<p>Note that, integration tests are excluded from the basic coverage report because the cardano-wallet server runs in a separate process. It it still possible to combine coverage from various sources (see <a href="https://medium.com/@_KtorZ_/continuous-integration-in-haskell-9ad2a73e8e46">this article</a> for some examples / details).</p>
<h2 id="e2e-tests"><a class="header" href="#e2e-tests">E2E Tests</a></h2>
<p>See: <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/test/e2e/README.md">README</a>.</p>
<h2 id="qa-schedule"><a class="header" href="#qa-schedule">QA Schedule</a></h2>
<p>See our Advice Process on Continuous Integration for information on which test is executed when.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="continuous-integration"><a class="header" href="#continuous-integration">Continuous Integration</a></h1>
<p>TODO: Information about our continuous integration pipeline.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-process"><a class="header" href="#release-process">Release Process</a></h1>
<ul>
<li>Create new page on cardano-wallet's <a href="https://github.com/cardano-foundation/cardano-wallet/wiki/_new">wiki</a> called <code>Release vYYYY-MM-DD</code> by copying contents of <a href="contributor/how/release-checklist.html">Release checklist</a>.</li>
<li>Open a thread <code>cardano-wallet vYYYY-MM-DD</code> on <code>#adrestia-releases</code> slack channel notifying the Release Manager.</li>
<li>Follow the <code>Release checklist</code>. Update progress or report obstacles on the thread.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-checklist"><a class="header" href="#release-checklist">Release Checklist</a></h1>
<ul>
<li><input disabled="" type="checkbox"/>
Make a copy of this <code>Release Checklist Template</code> document as a new page on cardano-wallet's wiki called <code>Release vYYYY-MM-DD</code>. Follow all the next steps using that newly created document as a &quot;status tracker&quot;.</li>
</ul>
<h2 id="check-additional-automated-tests"><a class="header" href="#check-additional-automated-tests">Check additional automated tests</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
Verify that the latest E2E tests are fine (See &quot;E2E *&quot; workflows on https://github.com/cardano-foundation/cardano-wallet/actions).</li>
<li><input disabled="" type="checkbox"/>
Verify latest <a href="https://buildkite.com/cardano-foundation/cardano-wallet-nightly">buildkite nightly</a> and make sure the results are fine. <a href="http://ec2-44-197-192-237.compute-1.amazonaws.com:5555">Benchmark charts</a> may be helpful in analysis.</li>
</ul>
<h2 id="prepare-the-release"><a class="header" href="#prepare-the-release">Prepare the release</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
<p>Make sure <code>cardano-wallet</code> points to correct revisions of
dependent low-level libs in <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/cabal.project"><code>cabal.project</code></a>. Use <code>cardano-node</code> as guidance.</p>
<ul>
<li><input disabled="" type="checkbox"/>
<p>Verify that target repositories point to appopriate revisions for <code>persistent</code>, <code>cardano-addresses</code>, <code>bech32</code>, ...)</p>
</li>
<li><input disabled="" type="checkbox"/>
<p>If you have updated <code>cabala.project</code>, execute</p>
</li>
</ul>
<pre><code>./nix/regenerate.sh --cache=/dev/null
# This will fetch and update the sha256 hashes.
</code></pre>
</li>
<li><input disabled="" type="checkbox"/>
<p>Fetch the tip of <code>master</code>:</p>
<pre><code class="language-shell">&gt; git checkout master
&gt; git pull
</code></pre>
</li>
<li><input disabled="" type="checkbox"/>
<p>Create a new branch for the release:</p>
<pre><code class="language-shell">&gt; git checkout -b your-name/bump-release/YYYY-MM-DD
</code></pre>
</li>
<li><input disabled="" type="checkbox"/>
<p>From the <strong>root</strong> of the repository, run:</p>
<pre><code class="language-shell">&gt; ./scripts/make_release.sh
</code></pre>
<p>This will bump the version in <code>.cabal</code> and <code>.nix</code> files, and the
swagger spec files, and generate release notes.</p>
</li>
</ul>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="contributor/how/release-checklist.html#admonition-note"></a></p>
</div>
<div>
<p>If you get GitHub API rate limit errors, you can
set the <code>GITHUB_API_TOKEN</code> environment variable. To create a
<em>personal access token</em>, go to your
<a href="https://github.com/settings/tokens">Github Settings</a>.
No scope is required for this token, only public access (as it
is simply used to read publicly available data from the Github
API).</p>
</div>
</div>
<ul>
<li><input disabled="" type="checkbox"/>
<p>Verify that the script modified the compatibility matrix in README.md correctly.</p>
</li>
<li><input disabled="" type="checkbox"/>
<p>Open a pull request to submit the modified files</p>
</li>
<li><input disabled="" type="checkbox"/>
<p>Get it merged</p>
</li>
<li><input disabled="" type="checkbox"/>
<p>Trigger a release build on CI (GitHub Actions) and wait for the
build artifacts to be published on the GitHub release page.</p>
<pre><code class="language-shell">&gt; git checkout master
&gt; git pull
&gt; git tag --sign -m &quot;vYYYY-MM-DD&quot; vYYYY-MM-DD
&gt; git push origin vYYYY-MM-DD
</code></pre>
<p>Where <code>YYYY-MM-DD</code> should be replaced by the actual date of the release.</p>
</li>
</ul>
<h2 id="create-the-release-notes"><a class="header" href="#create-the-release-notes">Create the release notes</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
Write release notes in the
<a href="https://github.com/cardano-foundation/cardano-wallet/releases">release page</a>
based on <a href="https://docs.google.com/document/d/1jMHvrtZ36_diLzPsAPzu88YvrX8z9YthZ7Xw_-7nanE/edit#heading=h.1ulc1nu4qh1i">Next Release Notes</a></li>
</ul>
<h2 id="verify-release-artifacts"><a class="header" href="#verify-release-artifacts">Verify release artifacts</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
<p>Verify that the documentations have been correctly exported on
<a href="https://github.com/cardano-foundation/cardano-wallet/tree/gh-pages">gh-pages</a></p>
<ul>
<li><input disabled="" type="checkbox"/>
Make a commit with redirects to the documentation for the release like <a href="https://github.com/cardano-foundation/cardano-wallet/commit/3abd8d3fe86bcf279d91d5745b7360892fad1cd4">this one</a>.</li>
</ul>
<pre><code> &gt; git checkout gh-pages
 &gt; git pull origin gh-pages
 &gt; cd releases
 &gt; ./make_redirects.sh vYYYY-MM-DD
 ## push changes to gh-pages after
</code></pre>
</li>
<li><input disabled="" type="checkbox"/>
<p>Make sure the <a href="contributor/how/../user-guide/cli.html">Command-Line Interface</a> manual is up to date.</p>
</li>
</ul>
<h2 id="manual-ad-hoc-verifications"><a class="header" href="#manual-ad-hoc-verifications">Manual ad-hoc verifications</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
<p>Execute all <a href="https://github.com/cardano-foundation/cardano-wallet/tree/master/test/manual">manual scenarios</a> on the binaries to be released.</p>
</li>
<li><input disabled="" type="checkbox"/>
<p>Verify that sensitive fields listed in <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/lib/wallet/api/http/Cardano/Wallet/Api/Http/Shelley/Server.hs#L695">Cardano/Wallet/Api/Server</a> are still accurate and aren't missing any new ones.</p>
<pre><code>sensitive =
    [ &quot;passphrase&quot;
    , &quot;old_passphrase&quot;
    , &quot;new_passphrase&quot;
    , &quot;mnemonic_sentence&quot;
    , &quot;mnemonic_second_factor&quot;
    ]
</code></pre>
</li>
</ul>
<h2 id="publication"><a class="header" href="#publication">Publication</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
<p>Once everyone has signed off (i.e. Tech lead, QA &amp; Release manager), publish the release draft.</p>
</li>
<li><input disabled="" type="checkbox"/>
<p>If there are any changes to the release checklist update this document.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="code-review-guidelines"><a class="header" href="#code-review-guidelines">Code Review Guidelines</a></h1>
<h2 id="table-of-content"><a class="header" href="#table-of-content">Table of Content</a></h2>
<ul>
<li><a href="contributor/how/code-review-guidelines.html#code-review-guidelines">Code Review Guidelines</a>
<ul>
<li><a href="contributor/how/code-review-guidelines.html#table-of-content">Table of Content</a></li>
<li><a href="contributor/how/code-review-guidelines.html#as-a-reviewer-or-author">As a Reviewer or Author</a>
<ul>
<li><a href="contributor/how/code-review-guidelines.html#do-assume-competence">DO: Assume competence.</a></li>
<li><a href="contributor/how/code-review-guidelines.html#do-provide-rationale-or-context">DO: Provide rationale or context</a></li>
<li><a href="contributor/how/code-review-guidelines.html#do-consider-how-comments-may-be-interpreted">DO: Consider how comments may be interpreted.</a></li>
<li><a href="contributor/how/code-review-guidelines.html#dont-criticize-the-person">DON’T: Criticize the person.</a></li>
<li><a href="contributor/how/code-review-guidelines.html#dont-use-harsh-language">DON’T: Use harsh language.</a></li>
</ul>
</li>
<li><a href="contributor/how/code-review-guidelines.html#as-a-reviewer">As a Reviewer</a>
<ul>
<li><a href="contributor/how/code-review-guidelines.html#do-provide-specific-and-actionable-feedback">DO: Provide specific and actionable feedback.</a></li>
<li><a href="contributor/how/code-review-guidelines.html#do-clearly-mark-nitpicks-and-optional-comments">DO: Clearly mark nitpicks and optional comments.</a></li>
</ul>
</li>
<li><a href="contributor/how/code-review-guidelines.html#as-an-author">As an Author</a>
<ul>
<li><a href="contributor/how/code-review-guidelines.html#do-clarify-code-or-reply-to-the-reviewers-comment">DO: Clarify code or reply to the reviewer’s comment.</a></li>
<li><a href="contributor/how/code-review-guidelines.html#do-when-disagreeing-with-feedback-explain-the-advantage-of-your-approach">DO: When disagreeing with feedback, explain the advantage of your approach.</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="as-a-reviewer-or-author"><a class="header" href="#as-a-reviewer-or-author">As a Reviewer or Author</a></h2>
<h3 id="do-assume-competence"><a class="header" href="#do-assume-competence">DO: Assume competence.</a></h3>
<p>An author’s implementation or a reviewer’s recommendation may be due to the other party having different context than you. Start by asking questions to gain understanding.</p>
<h3 id="do-provide-rationale-or-context"><a class="header" href="#do-provide-rationale-or-context">DO: Provide rationale or context</a></h3>
<p>Such as a best practices document, a style guide, or a design document. This can help others understand your decision or provide mentorship.</p>
<h3 id="do-consider-how-comments-may-be-interpreted"><a class="header" href="#do-consider-how-comments-may-be-interpreted">DO: Consider how comments may be interpreted.</a></h3>
<p>Be mindful of the differing ways hyperbole, jokes, and emojis may be perceived.</p>
<p>e.g.:</p>
<div class="table-wrapper"><table><thead><tr><th>Authors Don’t</th><th>Authors Do</th></tr></thead><tbody>
<tr><td>I prefer short names so I’d rather not change this. Unless you make me? :)</td><td>Best practice suggests omitting obvious/generic terms. I’m not sure how to reconcile that advice with this request.</td></tr>
</tbody></table>
</div>
<h3 id="dont-criticize-the-person"><a class="header" href="#dont-criticize-the-person">DON’T: Criticize the person.</a></h3>
<p>Instead, discuss the code. Even the perception that a comment is about a person (e.g., due to using “you” or “your”) distracts from the goal of improving the code.</p>
<p>e.g.:</p>
<div class="table-wrapper"><table><thead><tr><th>Reviewers Don’t</th><th>Reviewers Do</th></tr></thead><tbody>
<tr><td>Why are you using this approach? You’re adding unnecessary complexity.</td><td>This concurrency model appears to be adding complexity to the system without any visible performance benefit.</td></tr>
</tbody></table>
</div>
<h3 id="dont-use-harsh-language"><a class="header" href="#dont-use-harsh-language">DON’T: Use harsh language.</a></h3>
<p>Code review comments with a negative tone are less likely to be useful. For example, prior research found very negative comments were considered useful by authors 57% of the time, while more-neutral comments were useful 79% of the time.</p>
<h2 id="as-a-reviewer"><a class="header" href="#as-a-reviewer">As a Reviewer</a></h2>
<h3 id="do-provide-specific-and-actionable-feedback"><a class="header" href="#do-provide-specific-and-actionable-feedback">DO: Provide specific and actionable feedback.</a></h3>
<p>If you don’t have specific advice, sometimes it’s helpful to ask for clarification on why the author made a decision.</p>
<p>e.g.:</p>
<div class="table-wrapper"><table><thead><tr><th>Reviewers Don’t</th><th>Reviewers Do</th></tr></thead><tbody>
<tr><td>I don’t understand this.</td><td>If this is an optimization, can you please add comments?</td></tr>
</tbody></table>
</div>
<h3 id="do-clearly-mark-nitpicks-and-optional-comments"><a class="header" href="#do-clearly-mark-nitpicks-and-optional-comments">DO: Clearly mark nitpicks and optional comments.</a></h3>
<p>By using prefixes such as ‘Nit’ or ‘Optional’. This allows the author to better gauge the reviewer’s expectations.</p>
<h2 id="as-an-author"><a class="header" href="#as-an-author">As an Author</a></h2>
<h3 id="do-clarify-code-or-reply-to-the-reviewers-comment"><a class="header" href="#do-clarify-code-or-reply-to-the-reviewers-comment">DO: Clarify code or reply to the reviewer’s comment.</a></h3>
<p>In response to feedback, failing to do so can signal a lack of receptiveness to implementing improvements to the code.</p>
<p>e.g.</p>
<div class="table-wrapper"><table><thead><tr><th>Authors Don’t</th><th>Authors Do</th></tr></thead><tbody>
<tr><td>That makes sense in some cases butnot here.</td><td>I added a comment about why it’s implemented that way.</td></tr>
</tbody></table>
</div>
<h3 id="do-when-disagreeing-with-feedback-explain-the-advantage-of-your-approach"><a class="header" href="#do-when-disagreeing-with-feedback-explain-the-advantage-of-your-approach">DO: When disagreeing with feedback, explain the advantage of your approach.</a></h3>
<p>In cases where you can’t reach consensus, bring the discussion on Slack with other peers from the team.</p>
<hr/>
<p>From an original source: https://testing.googleblog.com/2019/11/code-health-respectful-reviews-useful.html</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notes"><a class="header" href="#notes">Notes</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="updating-dependencies"><a class="header" href="#updating-dependencies">Updating Dependencies</a></h1>
<p>If you use <a href="contributor/notes/nix.html">Nix</a>
to manage build and runtime dependencies you can be
confident that you will always have the correct versions for the
branch you are on, and that these will be exactly the same as those
versions used in CI.</p>
<p>It is possible to specify any git revision for the dependency and Nix
will automatically build it -- unless it has already been built
in a nix cache -- in which case the build result will be downloaded instead.</p>
<h2 id="nix-develop"><a class="header" href="#nix-develop">nix develop</a></h2>
<p>The default <code>nix develop</code> contains build tools, utilities and GHC
configured with a global package-db which matches <code>cabal.project</code>. This
is defined in the <code>devShells.default</code> attribute of <code>flake.nix</code>.</p>
<h2 id="nix-flake-lock"><a class="header" href="#nix-flake-lock">nix flake lock</a></h2>
<p><a href="https://nixos.wiki/wiki/Flakes"><code>nix flake</code></a> manages the file <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/flake.lock"><code>flake.lock</code></a>.</p>
<h2 id="updating-node-backends"><a class="header" href="#updating-node-backends">Updating node backends</a></h2>
<h3 id="cardano-node-haskell-dependencies"><a class="header" href="#cardano-node-haskell-dependencies"><code>cardano-node</code> Haskell dependencies</a></h3>
<p>To bump to a new version:</p>
<ol>
<li>In <code>cardano-wallet/cabal.project</code>, update
the dependency revisions to match your chosen version of
<code>cardano-node/cabal.project</code>.</li>
<li>Run <code>./nix/regenerate.sh</code> (or let Buildkite do it)</li>
</ol>
<h3 id="jörmungandr"><a class="header" href="#jörmungandr">Jörmungandr</a></h3>
<p>Follow the instructions in <a href="https://github.com/cardano-foundation/cardano-wallet/blob/master/nix/jormungandr.nix"><code>nix/jormungandr.nix</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="upgrading-the-ghc-version-of-cardano-wallet"><a class="header" href="#upgrading-the-ghc-version-of-cardano-wallet">Upgrading the GHC version of cardano-wallet</a></h1>
<p>Here is a reference PR that upgrades to GHC 8.10.7: https://github.com/cardano-foundation/cardano-wallet/pull/2969</p>
<p><strong>WARNING</strong>: Updating haskell.nix and/or GHC changes a lot of the build environment. You should expect to spend time fixing breakages.</p>
<h2 id="process"><a class="header" href="#process">Process</a></h2>
<ul>
<li>Update &quot;with-compiler&quot; in cabal.project:</li>
</ul>
<pre><code class="language-diff">diff --git a/cabal.project b/cabal.project
index 1ba2edf625..109534719a 100644
--- a/cabal.project
+++ b/cabal.project
@@ -39,7 +39,7 @@
 --------------------------------------------------------------------------------

 index-state: 2021-10-05T00:00:00Z
-with-compiler: ghc-8.10.5
+with-compiler: ghc-8.10.7

 packages:
     lib/wallet/
</code></pre>
<ul>
<li>Update haskell.nix <code>nix flake lock --update-input haskellNix</code>.</li>
</ul>
<h2 id="troubleshooting-1"><a class="header" href="#troubleshooting-1">Troubleshooting</a></h2>
<p>The following is a list of issues encountered so far while executing this process:</p>
<h3 id="compile-time-error-when-building-a-package-or-dependency"><a class="header" href="#compile-time-error-when-building-a-package-or-dependency">Compile-time error when building a package or dependency</a></h3>
<p>For example:</p>
<pre><code>src/Cardano/Config/Git/Rev.hs:33:35: error:
    • Exception when trying to run compile-time code:
        git: readCreateProcessWithExitCode: posix_spawnp: failed (Undefined error: 0)
      Code: gitRevFromGit
    • In the untyped splice: $(gitRevFromGit)
   |
33 |         fromGit = T.strip (T.pack $(gitRevFromGit))
</code></pre>
<p>In this case, the first guess is that git is not in the PATH when compiling the Template Haskell of cardano-config. The following line in our nix/haskell.nix file fixes this, adding a build-time dependency to our downstream dependencies (and one of our own too):</p>
<pre><code class="language-diff">diff --git a/nix/haskell.nix b/nix/haskell.nix
index 8bb80f7e99..8ac227a865 100644
--- a/nix/haskell.nix
+++ b/nix/haskell.nix
@@ -302,6 +302,10 @@ let
  pkg-set = haskell.mkStackPkgSet {
    inherit stack-pkgs;
    modules = [
       # ...
+      {
+        packages.cardano-wallet.components.library.build-tools = [ pkgs.buildPackages.buildPackages.gitMinimal ];
+        packages.cardano-config.components.library.build-tools = [ pkgs.buildPackages.buildPackages.gitMinimal ];
+      }
     ];
   };
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-warnings-deprecations #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# OPTIONS_HADDOCK hide #-}</span><span>
</span><a name="line-4"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Module      :  Network</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow 2001</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- License     :  BSD-style (see the file libraries/network/LICENSE)</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Maintainer  :  libraries@haskell.org</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Stability   :  provisional</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Portability :  portable</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- This module is kept for backwards-compatibility. New users are</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- encouraged to use &quot;Network.Socket&quot; instead.</span><span>
</span><a name="line-16"></a><span class="hs-comment">--</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- &quot;Network&quot; was intended as a \&quot;higher-level\&quot; interface to networking</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- facilities, and only supports TCP.</span><span>
</span><a name="line-19"></a><span class="hs-comment">--</span><span>
</span><a name="line-20"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-cpp">#include &quot;HsNetworkConfig.h&quot;
</span><span>
</span><a name="line-24"></a><span class="hs-cpp">#ifdef HAVE_GETADDRINFO
</span><span class="hs-comment">-- Use IPv6-capable function definitions if the OS supports it.</span><span>
</span><a name="line-26"></a><span class="hs-cpp">#define IPV6_SOCKET_SUPPORT 1
#endif
</span><span>
</span><a name="line-29"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span> </span><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">&quot;The high level Network interface is no longer supported. Please use Network.Socket.&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-30"></a><span>    </span><span class="hs-special">(</span><span>
</span><a name="line-31"></a><span>    </span><span class="hs-comment">-- * Basic data types</span><span>
</span><a name="line-32"></a><span>      </span><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a><span>
</span><a name="line-33"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.html#PortID"><span class="hs-identifier hs-type">PortID</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Socket.html#HostName"><span class="hs-identifier hs-type">HostName</span></a><span>
</span><a name="line-35"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Socket.Types.html#PortNumber"><span class="hs-identifier hs-type">PortNumber</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-comment">-- * Initialisation</span><span>
</span><a name="line-38"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Socket.Internal.html#withSocketsDo"><span class="hs-identifier hs-var">withSocketsDo</span></a><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>    </span><span class="hs-comment">-- * Server-side connections</span><span>
</span><a name="line-41"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.html#listenOn"><span class="hs-identifier hs-var">listenOn</span></a><span>
</span><a name="line-42"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.html#accept"><span class="hs-identifier hs-var">accept</span></a><span>
</span><a name="line-43"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.html#sClose"><span class="hs-identifier hs-var">sClose</span></a><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span>    </span><span class="hs-comment">-- * Client-side connections</span><span>
</span><a name="line-46"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.html#connectTo"><span class="hs-identifier hs-var">connectTo</span></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span>    </span><span class="hs-comment">-- * Simple sending and receiving</span><span>
</span><a name="line-49"></a><span>    </span><span class="hs-comment">{-$sendrecv-}</span><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.html#sendTo"><span class="hs-identifier hs-var">sendTo</span></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.html#recvFrom"><span class="hs-identifier hs-var">recvFrom</span></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-comment">-- * Miscellaneous</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.html#socketPort"><span class="hs-identifier hs-var">socketPort</span></a><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-comment">-- * Networking Issues</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-comment">-- ** Buffering</span><span>
</span><a name="line-58"></a><span>    </span><span class="hs-comment">{-$buffering-}</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-comment">-- ** Improving I\/O Performance over sockets</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-comment">{-$performance-}</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Network.BSD.html"><span class="hs-identifier">Network.BSD</span></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="Network.Socket.html"><span class="hs-identifier">Network.Socket</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><a href="Network.Socket.html#accept"><span class="hs-identifier hs-var">accept</span></a><span class="hs-special">,</span><span> </span><a href="Network.Socket.html#socketPort"><span class="hs-identifier hs-var">socketPort</span></a><span class="hs-special">,</span><span> </span><a href="Network.Socket.html#recvFrom"><span class="hs-identifier hs-var">recvFrom</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>                              </span><a href="Network.Socket.html#sendTo"><span class="hs-identifier hs-var">sendTo</span></a><span class="hs-special">,</span><span> </span><a href="Network.Socket.Types.html#PortNumber"><span class="hs-identifier hs-type">PortNumber</span></a><span class="hs-special">,</span><span> </span><a href="Network.Socket.html#sClose"><span class="hs-identifier hs-var">sClose</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Network.Socket.html"><span class="hs-identifier">Network.Socket</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Socket</span><span> </span><span class="hs-special">(</span><a href="Network.Socket.html#accept"><span class="hs-identifier hs-var">accept</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- High Level ``Setup'' functions</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-comment">-- If the @PortID@ specifies a unix family socket and the @Hostname@</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- differs from that returned by @getHostname@ then an error is</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- raised. Alternatively an empty string may be given to @connectTo@</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- signalling that the current hostname applies.</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-keyword">data</span><span> </span><a name="PortID"><a href="Network.html#PortID"><span class="hs-identifier">PortID</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-83"></a><span>          </span><a name="Service"><a href="Network.html#Service"><span class="hs-identifier">Service</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>                </span><span class="hs-comment">-- Service Name eg &quot;ftp&quot;</span><span>
</span><a name="line-84"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a name="PortNumber"><a href="Network.html#PortNumber"><span class="hs-identifier">PortNumber</span></a></a><span> </span><a href="Network.Socket.Types.html#PortNumber"><span class="hs-identifier hs-type">PortNumber</span></a><span>         </span><span class="hs-comment">-- User defined Port Number</span><span>
</span><a name="line-85"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><span>        </span><span class="hs-glyph">|</span><span> </span><a name="UnixSocket"><a href="Network.html#UnixSocket"><span class="hs-identifier">UnixSocket</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>             </span><span class="hs-comment">-- Unix family socket in file system</span><span>
</span><a name="line-87"></a><span class="hs-cpp">#endif
</span><span>        </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">-- | Calling 'connectTo' creates a client side socket which is</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- connected to the given host and port.  The Protocol and socket type is</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- derived from the given port identifier.  If a port number is given</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- then the result is always an internet family 'Stream' socket.</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-identifier">connectTo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Socket.html#HostName"><span class="hs-identifier hs-type">HostName</span></a><span>           </span><span class="hs-comment">-- Hostname</span><span>
</span><a name="line-96"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.html#PortID"><span class="hs-identifier hs-type">PortID</span></a><span>             </span><span class="hs-comment">-- Port Identifier</span><span>
</span><a name="line-97"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Handle</span><span>          </span><span class="hs-comment">-- Connected Socket</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-cpp">#if defined(IPV6_SOCKET_SUPPORT)
</span><span class="hs-comment">-- IPv6 and IPv4.</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><a name="connectTo"><a href="Network.html#connectTo"><span class="hs-identifier">connectTo</span></a></a><span> </span><a name="local-6989586621679059431"><a href="#local-6989586621679059431"><span class="hs-identifier">hostname</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.html#Service"><span class="hs-identifier hs-var">Service</span></a><span> </span><a name="local-6989586621679059432"><a href="#local-6989586621679059432"><span class="hs-identifier">serv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.html#connect%27"><span class="hs-identifier hs-var">connect'</span></a><span> </span><span class="hs-string">&quot;Network.connectTo&quot;</span><span> </span><a href="#local-6989586621679059431"><span class="hs-identifier hs-var">hostname</span></a><span> </span><a href="#local-6989586621679059432"><span class="hs-identifier hs-var">serv</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-identifier">connectTo</span><span> </span><a name="local-6989586621679059433"><a href="#local-6989586621679059433"><span class="hs-identifier">hostname</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.html#PortNumber"><span class="hs-identifier hs-var">PortNumber</span></a><span> </span><a name="local-6989586621679059434"><a href="#local-6989586621679059434"><span class="hs-identifier">port</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.html#connect%27"><span class="hs-identifier hs-var">connect'</span></a><span> </span><span class="hs-string">&quot;Network.connectTo&quot;</span><span> </span><a href="#local-6989586621679059433"><span class="hs-identifier hs-var">hostname</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679059434"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span class="hs-cpp">#else
</span><span class="hs-comment">-- IPv4 only.</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-identifier">connectTo</span><span> </span><span class="hs-identifier">hostname</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Service</span><span> </span><span class="hs-identifier">serv</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getProtocolNumber</span><span> </span><span class="hs-string">&quot;tcp&quot;</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-identifier">bracketOnError</span><span>
</span><a name="line-111"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">socket</span><span> </span><span class="hs-identifier">AF_INET</span><span> </span><span class="hs-identifier">Stream</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">sClose</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- only done if there's an error</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">sock</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-114"></a><span>          </span><span class="hs-identifier">port</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getServicePortNumber</span><span> </span><span class="hs-identifier">serv</span><span>
</span><a name="line-115"></a><span>          </span><span class="hs-identifier">he</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getHostByName</span><span> </span><span class="hs-identifier">hostname</span><span>
</span><a name="line-116"></a><span>          </span><span class="hs-identifier">connect</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SockAddrInet</span><span> </span><span class="hs-identifier">port</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hostAddress</span><span> </span><span class="hs-identifier">he</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>          </span><span class="hs-identifier">socketToHandle</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-identifier">ReadWriteMode</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-identifier">connectTo</span><span> </span><span class="hs-identifier">hostname</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">PortNumber</span><span> </span><span class="hs-identifier">port</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-121"></a><span>    </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getProtocolNumber</span><span> </span><span class="hs-string">&quot;tcp&quot;</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier">bracketOnError</span><span>
</span><a name="line-123"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">socket</span><span> </span><span class="hs-identifier">AF_INET</span><span> </span><span class="hs-identifier">Stream</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">sClose</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- only done if there's an error</span><span>
</span><a name="line-125"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">sock</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-126"></a><span>          </span><span class="hs-identifier">he</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getHostByName</span><span> </span><span class="hs-identifier">hostname</span><span>
</span><a name="line-127"></a><span>          </span><span class="hs-identifier">connect</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SockAddrInet</span><span> </span><span class="hs-identifier">port</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hostAddress</span><span> </span><span class="hs-identifier">he</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>          </span><span class="hs-identifier">socketToHandle</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-identifier">ReadWriteMode</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-132"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><span class="hs-identifier">connectTo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Network.html#UnixSocket"><span class="hs-identifier hs-var">UnixSocket</span></a><span> </span><a name="local-6989586621679059435"><a href="#local-6989586621679059435"><span class="hs-identifier">path</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-134"></a><span>    </span><a href="Network.html#bracketOnError"><span class="hs-identifier hs-var">bracketOnError</span></a><span>
</span><a name="line-135"></a><span>        </span><span class="hs-special">(</span><a href="Network.Socket.html#socket"><span class="hs-identifier hs-var">socket</span></a><span> </span><a href="Network.Socket.Types.html#AF_UNIX"><span class="hs-identifier hs-var">AF_UNIX</span></a><span> </span><a href="Network.Socket.Types.html#Stream"><span class="hs-identifier hs-var">Stream</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>        </span><span class="hs-special">(</span><a href="Network.html#sClose"><span class="hs-identifier hs-var">sClose</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679059436"><a href="#local-6989586621679059436"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-138"></a><span>          </span><a href="Network.Socket.html#connect"><span class="hs-identifier hs-var">connect</span></a><span> </span><a href="#local-6989586621679059436"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-special">(</span><a href="Network.Socket.Types.html#SockAddrUnix"><span class="hs-identifier hs-var">SockAddrUnix</span></a><span> </span><a href="#local-6989586621679059435"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>          </span><a href="Network.Socket.html#socketToHandle"><span class="hs-identifier hs-var">socketToHandle</span></a><span> </span><a href="#local-6989586621679059436"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-identifier hs-var">ReadWriteMode</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-143"></a><span class="hs-cpp">#if defined(IPV6_SOCKET_SUPPORT)
</span><span class="hs-identifier">connect'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Socket.html#HostName"><span class="hs-identifier hs-type">HostName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Socket.html#ServiceName"><span class="hs-identifier hs-type">ServiceName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Handle</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><a name="connect%27"><a href="Network.html#connect%27"><span class="hs-identifier">connect'</span></a></a><span> </span><a name="local-6989586621679059437"><a href="#local-6989586621679059437"><span class="hs-identifier">caller</span></a></a><span> </span><a name="local-6989586621679059438"><a href="#local-6989586621679059438"><span class="hs-identifier">host</span></a></a><span> </span><a name="local-6989586621679059439"><a href="#local-6989586621679059439"><span class="hs-identifier">serv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-147"></a><span>    </span><a name="local-6989586621679059443"><a href="#local-6989586621679059443"><span class="hs-identifier">proto</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.BSD.html#getProtocolNumber"><span class="hs-identifier hs-var">getProtocolNumber</span></a><span> </span><span class="hs-string">&quot;tcp&quot;</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679059444"><a href="#local-6989586621679059444"><span class="hs-identifier">hints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Socket.html#defaultHints"><span class="hs-identifier hs-var">defaultHints</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">addrFlags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Network.Socket.html#AI_ADDRCONFIG"><span class="hs-identifier hs-var">AI_ADDRCONFIG</span></a><span class="hs-special">]</span><span>
</span><a name="line-149"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">addrProtocol</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679059443"><span class="hs-identifier hs-var">proto</span></a><span>
</span><a name="line-150"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">addrSocketType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Socket.Types.html#Stream"><span class="hs-identifier hs-var">Stream</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-151"></a><span>    </span><a name="local-6989586621679059445"><a href="#local-6989586621679059445"><span class="hs-identifier">addrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#getAddrInfo"><span class="hs-identifier hs-var">getAddrInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679059444"><span class="hs-identifier hs-var">hints</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679059438"><span class="hs-identifier hs-var">host</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679059439"><span class="hs-identifier hs-var">serv</span></a><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>    </span><a href="Network.html#firstSuccessful"><span class="hs-identifier hs-var">firstSuccessful</span></a><span> </span><a href="#local-6989586621679059437"><span class="hs-identifier hs-var">caller</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679059440"><span class="hs-identifier hs-var">tryToConnect</span></a><span> </span><a href="#local-6989586621679059445"><span class="hs-identifier hs-var">addrs</span></a><span>
</span><a name="line-153"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-154"></a><span>  </span><a name="local-6989586621679059440"><a href="#local-6989586621679059440"><span class="hs-identifier">tryToConnect</span></a></a><span> </span><a name="local-6989586621679059441"><a href="#local-6989586621679059441"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-155"></a><span>    </span><a href="Network.html#bracketOnError"><span class="hs-identifier hs-var">bracketOnError</span></a><span>
</span><a name="line-156"></a><span>        </span><span class="hs-special">(</span><a href="Network.Socket.html#socket"><span class="hs-identifier hs-var">socket</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrFamily</span><span> </span><a href="#local-6989586621679059441"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrSocketType</span><span> </span><a href="#local-6989586621679059441"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrProtocol</span><span> </span><a href="#local-6989586621679059441"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>        </span><span class="hs-special">(</span><a href="Network.html#sClose"><span class="hs-identifier hs-var">sClose</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- only done if there's an error</span><span>
</span><a name="line-158"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679059442"><a href="#local-6989586621679059442"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-159"></a><span>          </span><a href="Network.Socket.html#connect"><span class="hs-identifier hs-var">connect</span></a><span> </span><a href="#local-6989586621679059442"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrAddress</span><span> </span><a href="#local-6989586621679059441"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>          </span><a href="Network.Socket.html#socketToHandle"><span class="hs-identifier hs-var">socketToHandle</span></a><span> </span><a href="#local-6989586621679059442"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-identifier hs-var">ReadWriteMode</span><span>
</span><a name="line-161"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- | Creates the server side socket which has been bound to the</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- specified port.</span><span>
</span><a name="line-166"></a><span class="hs-comment">--</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- 'maxListenQueue' (typically 128) is specified to the listen queue.</span><span>
</span><a name="line-168"></a><span class="hs-comment">-- This is good enough for normal network servers but is too small</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- for high performance servers.</span><span>
</span><a name="line-170"></a><span class="hs-comment">--</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- To avoid the \&quot;Address already in use\&quot; problems,</span><span>
</span><a name="line-172"></a><span class="hs-comment">-- the 'ReuseAddr' socket option is set on the listening socket.</span><span>
</span><a name="line-173"></a><span class="hs-comment">--</span><span>
</span><a name="line-174"></a><span class="hs-comment">-- If available, the 'IPv6Only' socket option is set to 0</span><span>
</span><a name="line-175"></a><span class="hs-comment">-- so that both IPv4 and IPv6 can be accepted with this socket.</span><span>
</span><a name="line-176"></a><span class="hs-comment">--</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- If you don't like the behavior above, please use the lower level</span><span>
</span><a name="line-178"></a><span class="hs-comment">-- 'Network.Socket.listen' instead.</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-identifier">listenOn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.html#PortID"><span class="hs-identifier hs-type">PortID</span></a><span>      </span><span class="hs-comment">-- ^ Port Identifier</span><span>
</span><a name="line-181"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a><span>   </span><span class="hs-comment">-- ^ Listening Socket</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-cpp">#if defined(IPV6_SOCKET_SUPPORT)
</span><span class="hs-comment">-- IPv6 and IPv4.</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><a name="listenOn"><a href="Network.html#listenOn"><span class="hs-identifier">listenOn</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.html#Service"><span class="hs-identifier hs-var">Service</span></a><span> </span><a name="local-6989586621679059446"><a href="#local-6989586621679059446"><span class="hs-identifier">serv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.html#listen%27"><span class="hs-identifier hs-var">listen'</span></a><span> </span><a href="#local-6989586621679059446"><span class="hs-identifier hs-var">serv</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-identifier">listenOn</span><span> </span><span class="hs-special">(</span><a href="Network.html#PortNumber"><span class="hs-identifier hs-var">PortNumber</span></a><span> </span><a name="local-6989586621679059447"><a href="#local-6989586621679059447"><span class="hs-identifier">port</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.html#listen%27"><span class="hs-identifier hs-var">listen'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679059447"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span class="hs-cpp">#else
</span><span class="hs-comment">-- IPv4 only.</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-identifier">listenOn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Service</span><span> </span><span class="hs-identifier">serv</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getProtocolNumber</span><span> </span><span class="hs-string">&quot;tcp&quot;</span><span>
</span><a name="line-194"></a><span>    </span><span class="hs-identifier">bracketOnError</span><span>
</span><a name="line-195"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">socket</span><span> </span><span class="hs-identifier">AF_INET</span><span> </span><span class="hs-identifier">Stream</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">sClose</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">sock</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-198"></a><span>            </span><span class="hs-identifier">port</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getServicePortNumber</span><span> </span><span class="hs-identifier">serv</span><span>
</span><a name="line-199"></a><span>            </span><span class="hs-identifier">setSocketOption</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-identifier">ReuseAddr</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-200"></a><span>            </span><span class="hs-identifier">bind</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SockAddrInet</span><span> </span><span class="hs-identifier">port</span><span> </span><span class="hs-identifier">iNADDR_ANY</span><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>            </span><span class="hs-identifier">listen</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-identifier">maxListenQueue</span><span>
</span><a name="line-202"></a><span>            </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">sock</span><span>
</span><a name="line-203"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-identifier">listenOn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">PortNumber</span><span> </span><span class="hs-identifier">port</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getProtocolNumber</span><span> </span><span class="hs-string">&quot;tcp&quot;</span><span>
</span><a name="line-207"></a><span>    </span><span class="hs-identifier">bracketOnError</span><span>
</span><a name="line-208"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">socket</span><span> </span><span class="hs-identifier">AF_INET</span><span> </span><span class="hs-identifier">Stream</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">sClose</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">sock</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-211"></a><span>            </span><span class="hs-identifier">setSocketOption</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-identifier">ReuseAddr</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-212"></a><span>            </span><span class="hs-identifier">bind</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SockAddrInet</span><span> </span><span class="hs-identifier">port</span><span> </span><span class="hs-identifier">iNADDR_ANY</span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>            </span><span class="hs-identifier">listen</span><span> </span><span class="hs-identifier">sock</span><span> </span><span class="hs-identifier">maxListenQueue</span><span>
</span><a name="line-214"></a><span>            </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">sock</span><span>
</span><a name="line-215"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-218"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><span class="hs-identifier">listenOn</span><span> </span><span class="hs-special">(</span><a href="Network.html#UnixSocket"><span class="hs-identifier hs-var">UnixSocket</span></a><span> </span><a name="local-6989586621679059448"><a href="#local-6989586621679059448"><span class="hs-identifier">path</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-220"></a><span>    </span><a href="Network.html#bracketOnError"><span class="hs-identifier hs-var">bracketOnError</span></a><span>
</span><a name="line-221"></a><span>        </span><span class="hs-special">(</span><a href="Network.Socket.html#socket"><span class="hs-identifier hs-var">socket</span></a><span> </span><a href="Network.Socket.Types.html#AF_UNIX"><span class="hs-identifier hs-var">AF_UNIX</span></a><span> </span><a href="Network.Socket.Types.html#Stream"><span class="hs-identifier hs-var">Stream</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>        </span><span class="hs-special">(</span><a href="Network.html#sClose"><span class="hs-identifier hs-var">sClose</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679059449"><a href="#local-6989586621679059449"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-224"></a><span>            </span><a href="Network.Socket.html#setSocketOption"><span class="hs-identifier hs-var">setSocketOption</span></a><span> </span><a href="#local-6989586621679059449"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="Network.Socket.html#ReuseAddr"><span class="hs-identifier hs-var">ReuseAddr</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-225"></a><span>            </span><a href="Network.Socket.html#bind"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621679059449"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-special">(</span><a href="Network.Socket.Types.html#SockAddrUnix"><span class="hs-identifier hs-var">SockAddrUnix</span></a><span> </span><a href="#local-6989586621679059448"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>            </span><a href="Network.Socket.html#listen"><span class="hs-identifier hs-var">listen</span></a><span> </span><a href="#local-6989586621679059449"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="Network.Socket.html#maxListenQueue"><span class="hs-identifier hs-var">maxListenQueue</span></a><span>
</span><a name="line-227"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679059449"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-228"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-231"></a><span class="hs-cpp">#if defined(IPV6_SOCKET_SUPPORT)
</span><span class="hs-identifier">listen'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Socket.html#ServiceName"><span class="hs-identifier hs-type">ServiceName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><a name="listen%27"><a href="Network.html#listen%27"><span class="hs-identifier">listen'</span></a></a><span> </span><a name="local-6989586621679059450"><a href="#local-6989586621679059450"><span class="hs-identifier">serv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-235"></a><span>    </span><a name="local-6989586621679059451"><a href="#local-6989586621679059451"><span class="hs-identifier">proto</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.BSD.html#getProtocolNumber"><span class="hs-identifier hs-var">getProtocolNumber</span></a><span> </span><span class="hs-string">&quot;tcp&quot;</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-comment">-- We should probably specify addrFamily = AF_INET6 and the filter</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-comment">-- code below should be removed. AI_ADDRCONFIG is probably not</span><span>
</span><a name="line-238"></a><span>    </span><span class="hs-comment">-- necessary. But this code is well-tested. So, let's keep it.</span><span>
</span><a name="line-239"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679059452"><a href="#local-6989586621679059452"><span class="hs-identifier">hints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Socket.html#defaultHints"><span class="hs-identifier hs-var">defaultHints</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">addrFlags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Network.Socket.html#AI_ADDRCONFIG"><span class="hs-identifier hs-var">AI_ADDRCONFIG</span></a><span class="hs-special">,</span><span> </span><a href="Network.Socket.html#AI_PASSIVE"><span class="hs-identifier hs-var">AI_PASSIVE</span></a><span class="hs-special">]</span><span>
</span><a name="line-240"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">addrSocketType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Socket.Types.html#Stream"><span class="hs-identifier hs-var">Stream</span></a><span>
</span><a name="line-241"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">addrProtocol</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679059451"><span class="hs-identifier hs-var">proto</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-242"></a><span>    </span><a name="local-6989586621679059453"><a href="#local-6989586621679059453"><span class="hs-identifier">addrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#getAddrInfo"><span class="hs-identifier hs-var">getAddrInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679059452"><span class="hs-identifier hs-var">hints</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679059450"><span class="hs-identifier hs-var">serv</span></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>    </span><span class="hs-comment">-- Choose an IPv6 socket if exists.  This ensures the socket can</span><span>
</span><a name="line-244"></a><span>    </span><span class="hs-comment">-- handle both IPv4 and IPv6 if v6only is false.</span><span>
</span><a name="line-245"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679059454"><a href="#local-6989586621679059454"><span class="hs-identifier">addrs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679059456"><a href="#local-6989586621679059456"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">addrFamily</span><span> </span><a href="#local-6989586621679059456"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Network.Socket.Types.html#AF_INET6"><span class="hs-identifier hs-var">AF_INET6</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679059453"><span class="hs-identifier hs-var">addrs</span></a><span>
</span><a name="line-246"></a><span>        </span><a name="local-6989586621679059455"><a href="#local-6989586621679059455"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679059454"><span class="hs-identifier hs-var">addrs'</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679059453"><span class="hs-identifier hs-var">addrs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679059454"><span class="hs-identifier hs-var">addrs'</span></a><span>
</span><a name="line-247"></a><span>    </span><a href="Network.html#bracketOnError"><span class="hs-identifier hs-var">bracketOnError</span></a><span>
</span><a name="line-248"></a><span>        </span><span class="hs-special">(</span><a href="Network.Socket.html#socket"><span class="hs-identifier hs-var">socket</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrFamily</span><span> </span><a href="#local-6989586621679059455"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrSocketType</span><span> </span><a href="#local-6989586621679059455"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrProtocol</span><span> </span><a href="#local-6989586621679059455"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>        </span><span class="hs-special">(</span><a href="Network.html#sClose"><span class="hs-identifier hs-var">sClose</span></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679059457"><a href="#local-6989586621679059457"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-251"></a><span>            </span><a href="Network.Socket.html#setSocketOption"><span class="hs-identifier hs-var">setSocketOption</span></a><span> </span><a href="#local-6989586621679059457"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="Network.Socket.html#ReuseAddr"><span class="hs-identifier hs-var">ReuseAddr</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-252"></a><span>            </span><a href="Network.Socket.html#bind"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621679059457"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">addrAddress</span><span> </span><a href="#local-6989586621679059455"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>            </span><a href="Network.Socket.html#listen"><span class="hs-identifier hs-var">listen</span></a><span> </span><a href="#local-6989586621679059457"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="Network.Socket.html#maxListenQueue"><span class="hs-identifier hs-var">maxListenQueue</span></a><span>
</span><a name="line-254"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679059457"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-255"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- accept</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-comment">-- | Accept a connection on a socket created by 'listenOn'.  Normal</span><span>
</span><a name="line-262"></a><span class="hs-comment">-- I\/O operations (see &quot;System.IO&quot;) can be used on the 'Handle'</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- returned to communicate with the client.</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- Notice that although you can pass any Socket to Network.accept,</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- only sockets of either AF_UNIX, AF_INET, or AF_INET6 will work</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- (this shouldn't be a problem, though). When using AF_UNIX, HostName</span><span>
</span><a name="line-267"></a><span class="hs-comment">-- will be set to the path of the socket and PortNumber to -1.</span><span>
</span><a name="line-268"></a><span class="hs-comment">--</span><span>
</span><a name="line-269"></a><span class="hs-identifier">accept</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a><span>                </span><span class="hs-comment">-- ^ Listening Socket</span><span>
</span><a name="line-270"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Handle</span><span class="hs-special">,</span><span>
</span><a name="line-271"></a><span>              </span><a href="Network.Socket.html#HostName"><span class="hs-identifier hs-type">HostName</span></a><span class="hs-special">,</span><span>
</span><a name="line-272"></a><span>              </span><a href="Network.Socket.Types.html#PortNumber"><span class="hs-identifier hs-type">PortNumber</span></a><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- ^ Triple of: read\/write 'Handle' for</span><span>
</span><a name="line-273"></a><span>                                </span><span class="hs-comment">-- communicating with the client,</span><span>
</span><a name="line-274"></a><span>                                </span><span class="hs-comment">-- the 'HostName' of the peer socket, and</span><span>
</span><a name="line-275"></a><span>                                </span><span class="hs-comment">-- the 'PortNumber' of the remote connection.</span><span>
</span><a name="line-276"></a><a name="accept"><a href="Network.html#accept"><span class="hs-identifier">accept</span></a></a><span> </span><a name="local-6989586621679059458"><a href="#local-6989586621679059458"><span class="hs-identifier">sock</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Network.Socket.Types.html#MkSocket"><span class="hs-identifier hs-var">MkSocket</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="Network.Socket.Types.html#AF_INET"><span class="hs-identifier hs-var">AF_INET</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-277"></a><span> </span><span class="hs-glyph">~</span><span class="hs-special">(</span><a name="local-6989586621679059459"><a href="#local-6989586621679059459"><span class="hs-identifier">sock'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Network.Socket.Types.html#SockAddrInet"><span class="hs-identifier hs-var">SockAddrInet</span></a><span> </span><a name="local-6989586621679059460"><a href="#local-6989586621679059460"><span class="hs-identifier">port</span></a></a><span> </span><a name="local-6989586621679059461"><a href="#local-6989586621679059461"><span class="hs-identifier">haddr</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#accept"><span class="hs-identifier hs-var">Socket.accept</span></a><span> </span><a href="#local-6989586621679059458"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-278"></a><span> </span><a name="local-6989586621679059464"><a href="#local-6989586621679059464"><span class="hs-identifier">peer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.html#catchIO"><span class="hs-identifier hs-var">catchIO</span></a><span>
</span><a name="line-279"></a><span>          </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-280"></a><span>             </span><span class="hs-special">(</span><a href="Network.BSD.html#HostEntry"><span class="hs-identifier hs-var">HostEntry</span></a><span> </span><a name="local-6989586621679059462"><a href="#local-6989586621679059462"><span class="hs-identifier">peer</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.BSD.html#getHostByAddr"><span class="hs-identifier hs-var">getHostByAddr</span></a><span> </span><a href="Network.Socket.Types.html#AF_INET"><span class="hs-identifier hs-var">AF_INET</span></a><span> </span><a href="#local-6989586621679059461"><span class="hs-identifier hs-var">haddr</span></a><span>
</span><a name="line-281"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679059462"><span class="hs-identifier hs-var">peer</span></a><span>
</span><a name="line-282"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679059463"><a href="#local-6989586621679059463"><span class="hs-identifier">_e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Socket.html#inet_ntoa"><span class="hs-identifier hs-var">inet_ntoa</span></a><span> </span><a href="#local-6989586621679059461"><span class="hs-identifier hs-var">haddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>                </span><span class="hs-comment">-- if getHostByName fails, we fall back to the IP address</span><span>
</span><a name="line-285"></a><span> </span><a name="local-6989586621679059465"><a href="#local-6989586621679059465"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#socketToHandle"><span class="hs-identifier hs-var">socketToHandle</span></a><span> </span><a href="#local-6989586621679059459"><span class="hs-identifier hs-var">sock'</span></a><span> </span><span class="hs-identifier hs-var">ReadWriteMode</span><span>
</span><a name="line-286"></a><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679059465"><span class="hs-identifier hs-var">handle</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679059464"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679059460"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span class="hs-cpp">#if defined(IPV6_SOCKET_SUPPORT)
</span><span class="hs-identifier">accept</span><span> </span><a name="local-6989586621679059466"><a href="#local-6989586621679059466"><span class="hs-identifier">sock</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Network.Socket.Types.html#MkSocket"><span class="hs-identifier hs-var">MkSocket</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="Network.Socket.Types.html#AF_INET6"><span class="hs-identifier hs-var">AF_INET6</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-289"></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679059467"><a href="#local-6989586621679059467"><span class="hs-identifier">sock'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679059468"><a href="#local-6989586621679059468"><span class="hs-identifier">addr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#accept"><span class="hs-identifier hs-var">Socket.accept</span></a><span> </span><a href="#local-6989586621679059466"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-290"></a><span> </span><a name="local-6989586621679059472"><a href="#local-6989586621679059472"><span class="hs-identifier">peer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.html#catchIO"><span class="hs-identifier hs-var">catchIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Network.Socket.html#getNameInfo"><span class="hs-identifier hs-var">getNameInfo</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679059468"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-291"></a><span>         </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679059468"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-292"></a><span>                 </span><a href="Network.Socket.Types.html#SockAddrInet"><span class="hs-identifier hs-var">SockAddrInet</span></a><span>  </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621679059469"><a href="#local-6989586621679059469"><span class="hs-identifier">a</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Socket.html#inet_ntoa"><span class="hs-identifier hs-var">inet_ntoa</span></a><span> </span><a href="#local-6989586621679059469"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-293"></a><span>                 </span><a href="Network.Socket.Types.html#SockAddrInet6"><span class="hs-identifier hs-var">SockAddrInet6</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679059470"><a href="#local-6989586621679059470"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679059470"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>                 </span><span class="hs-identifier">SockAddrUnix</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ioError</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">userError</span><span> </span><span class="hs-string">&quot;Network.accept: peer socket address 'SockAddrUnix' not supported on this platform.&quot;</span><span>
</span><a name="line-296"></a><span class="hs-cpp">#else
</span><span>                 </span><a href="Network.Socket.Types.html#SockAddrUnix"><span class="hs-identifier hs-var">SockAddrUnix</span></a><span>      </span><a name="local-6989586621679059471"><a href="#local-6989586621679059471"><span class="hs-identifier">a</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679059471"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-298"></a><span class="hs-cpp">#endif
#if defined(CAN_SOCKET_SUPPORT)
</span><span>                 </span><span class="hs-identifier">SockAddrCan</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ioError</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">userError</span><span> </span><span class="hs-string">&quot;Network.accept: peer socket address 'SockAddrCan' not supported.&quot;</span><span>
</span><a name="line-301"></a><span class="hs-cpp">#else
</span><span>                 </span><a href="Network.Socket.Types.html#SockAddrCan"><span class="hs-identifier hs-var">SockAddrCan</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-string">&quot;Network.accept: peer socket address 'SockAddrCan' not supported on this platform.&quot;</span><span>
</span><a name="line-303"></a><span class="hs-cpp">#endif
</span><span> </span><a name="local-6989586621679059473"><a href="#local-6989586621679059473"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#socketToHandle"><span class="hs-identifier hs-var">socketToHandle</span></a><span> </span><a href="#local-6989586621679059467"><span class="hs-identifier hs-var">sock'</span></a><span> </span><span class="hs-identifier hs-var">ReadWriteMode</span><span>
</span><a name="line-305"></a><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679059474"><a href="#local-6989586621679059474"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679059468"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-306"></a><span>              </span><a href="Network.Socket.Types.html#SockAddrInet"><span class="hs-identifier hs-var">SockAddrInet</span></a><span>  </span><a name="local-6989586621679059475"><a href="#local-6989586621679059475"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679059475"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-307"></a><span>              </span><a href="Network.Socket.Types.html#SockAddrInet6"><span class="hs-identifier hs-var">SockAddrInet6</span></a><span> </span><a name="local-6989586621679059476"><a href="#local-6989586621679059476"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679059476"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-308"></a><span>              </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span>
</span><a name="line-309"></a><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679059473"><span class="hs-identifier hs-var">handle</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679059472"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679059474"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span class="hs-cpp">#endif
#if !defined(mingw32_HOST_OS)
</span><span class="hs-identifier">accept</span><span> </span><a name="local-6989586621679059477"><a href="#local-6989586621679059477"><span class="hs-identifier">sock</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Network.Socket.Types.html#MkSocket"><span class="hs-identifier hs-var">MkSocket</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="Network.Socket.Types.html#AF_UNIX"><span class="hs-identifier hs-var">AF_UNIX</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-313"></a><span> </span><span class="hs-glyph">~</span><span class="hs-special">(</span><a name="local-6989586621679059478"><a href="#local-6989586621679059478"><span class="hs-identifier">sock'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Network.Socket.Types.html#SockAddrUnix"><span class="hs-identifier hs-var">SockAddrUnix</span></a><span> </span><a name="local-6989586621679059479"><a href="#local-6989586621679059479"><span class="hs-identifier">path</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#accept"><span class="hs-identifier hs-var">Socket.accept</span></a><span> </span><a href="#local-6989586621679059477"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-314"></a><span> </span><a name="local-6989586621679059480"><a href="#local-6989586621679059480"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#socketToHandle"><span class="hs-identifier hs-var">socketToHandle</span></a><span> </span><a href="#local-6989586621679059478"><span class="hs-identifier hs-var">sock'</span></a><span> </span><span class="hs-identifier hs-var">ReadWriteMode</span><span>
</span><a name="line-315"></a><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679059480"><span class="hs-identifier hs-var">handle</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679059479"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span class="hs-cpp">#endif
</span><span class="hs-identifier">accept</span><span> </span><span class="hs-special">(</span><a href="Network.Socket.Types.html#MkSocket"><span class="hs-identifier hs-var">MkSocket</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-keyword">family</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-318"></a><span>  </span><span class="hs-identifier hs-var">ioError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Network.accept: address family '&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-319"></a><span>    </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-keyword">family</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;' not supported.&quot;</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-comment">-- | Close the socket. Sending data to or receiving data from closed socket</span><span>
</span><a name="line-323"></a><span class="hs-comment">-- may lead to undefined behaviour.</span><span>
</span><a name="line-324"></a><span class="hs-identifier">sClose</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-325"></a><a name="sClose"><a href="Network.html#sClose"><span class="hs-identifier">sClose</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Socket.html#close"><span class="hs-identifier hs-var">close</span></a><span> </span><span class="hs-comment">-- Explicit redefinition because Network.sClose is deprecated,</span><span>
</span><a name="line-326"></a><span>               </span><span class="hs-comment">-- hence the re-export would also be marked as such.</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-329"></a><span class="hs-comment">-- sendTo/recvFrom</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-comment">{-$sendrecv
Send and receive data from\/to the given host and port number.  These
should normally only be used where the socket will not be required for
further calls. Also, note that due to the use of 'hGetContents' in 'recvFrom'
the socket will remain open (i.e. not available) even if the function already
returned. Their use is strongly discouraged except for small test-applications
or invocations from the command line.
-}</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span class="hs-identifier">sendTo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Socket.html#HostName"><span class="hs-identifier hs-type">HostName</span></a><span>      </span><span class="hs-comment">-- Hostname</span><span>
</span><a name="line-341"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.html#PortID"><span class="hs-identifier hs-type">PortID</span></a><span>        </span><span class="hs-comment">-- Port Number</span><span>
</span><a name="line-342"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>        </span><span class="hs-comment">-- Message to send</span><span>
</span><a name="line-343"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><a name="sendTo"><a href="Network.html#sendTo"><span class="hs-identifier">sendTo</span></a></a><span> </span><a name="local-6989586621679059482"><a href="#local-6989586621679059482"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679059483"><a href="#local-6989586621679059483"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679059484"><a href="#local-6989586621679059484"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-345"></a><span>  </span><a name="local-6989586621679059485"><a href="#local-6989586621679059485"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.html#connectTo"><span class="hs-identifier hs-var">connectTo</span></a><span> </span><a href="#local-6989586621679059482"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679059483"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-346"></a><span>  </span><span class="hs-identifier hs-var">hPutStr</span><span> </span><a href="#local-6989586621679059485"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679059484"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-347"></a><span>  </span><span class="hs-identifier hs-var">hClose</span><span> </span><a href="#local-6989586621679059485"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span class="hs-identifier">recvFrom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Socket.html#HostName"><span class="hs-identifier hs-type">HostName</span></a><span>    </span><span class="hs-comment">-- Hostname</span><span>
</span><a name="line-350"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.html#PortID"><span class="hs-identifier hs-type">PortID</span></a><span>      </span><span class="hs-comment">-- Port Number</span><span>
</span><a name="line-351"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>   </span><span class="hs-comment">-- Received Data</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-cpp">#if defined(IPV6_SOCKET_SUPPORT)
</span><a name="recvFrom"><a href="Network.html#recvFrom"><span class="hs-identifier">recvFrom</span></a></a><span> </span><a name="local-6989586621679059486"><a href="#local-6989586621679059486"><span class="hs-identifier">host</span></a></a><span> </span><a name="local-6989586621679059487"><a href="#local-6989586621679059487"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-355"></a><span>    </span><a name="local-6989586621679059497"><a href="#local-6989586621679059497"><span class="hs-identifier">proto</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.BSD.html#getProtocolNumber"><span class="hs-identifier hs-var">getProtocolNumber</span></a><span> </span><span class="hs-string">&quot;tcp&quot;</span><span>
</span><a name="line-356"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679059498"><a href="#local-6989586621679059498"><span class="hs-identifier">hints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Socket.html#defaultHints"><span class="hs-identifier hs-var">defaultHints</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">addrFlags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Network.Socket.html#AI_ADDRCONFIG"><span class="hs-identifier hs-var">AI_ADDRCONFIG</span></a><span class="hs-special">]</span><span>
</span><a name="line-357"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">addrProtocol</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679059497"><span class="hs-identifier hs-var">proto</span></a><span>
</span><a name="line-358"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">addrSocketType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Socket.Types.html#Stream"><span class="hs-identifier hs-var">Stream</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-359"></a><span>    </span><a name="local-6989586621679059499"><a href="#local-6989586621679059499"><span class="hs-identifier">allowed</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">addrAddress</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Network.Socket.html#getAddrInfo"><span class="hs-identifier hs-var">getAddrInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679059498"><span class="hs-identifier hs-var">hints</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679059486"><span class="hs-identifier hs-var">host</span></a><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>                                                   </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-361"></a><span>    </span><a name="local-6989586621679059500"><a href="#local-6989586621679059500"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.html#listenOn"><span class="hs-identifier hs-var">listenOn</span></a><span> </span><a href="#local-6989586621679059487"><span class="hs-identifier hs-var">port</span></a><span>
</span><a name="line-362"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679059501"><a href="#local-6989586621679059501"><span class="hs-identifier">waiting</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-363"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679059502"><a href="#local-6989586621679059502"><span class="hs-identifier">s'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679059503"><a href="#local-6989586621679059503"><span class="hs-identifier">addr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#accept"><span class="hs-identifier hs-var">Socket.accept</span></a><span> </span><a href="#local-6989586621679059500"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-364"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679059503"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679059488"><span class="hs-identifier hs-var">oneOf</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679059499"><span class="hs-identifier hs-var">allowed</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>         </span><span class="hs-keyword">then</span><span> </span><a href="Network.html#sClose"><span class="hs-identifier hs-var">sClose</span></a><span> </span><a href="#local-6989586621679059502"><span class="hs-identifier hs-var">s'</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="#local-6989586621679059501"><span class="hs-identifier hs-var">waiting</span></a><span>
</span><a name="line-366"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="Network.Socket.html#socketToHandle"><span class="hs-identifier hs-var">socketToHandle</span></a><span> </span><a href="#local-6989586621679059502"><span class="hs-identifier hs-var">s'</span></a><span> </span><span class="hs-identifier hs-var">ReadMode</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">hGetContents</span><span>
</span><a name="line-367"></a><span>    </span><a href="#local-6989586621679059501"><span class="hs-identifier hs-var">waiting</span></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-369"></a><span>    </span><a name="local-6989586621679059489"><a href="#local-6989586621679059489"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Network.Socket.Types.html#SockAddrInet"><span class="hs-identifier hs-var">SockAddrInet</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679059490"><a href="#local-6989586621679059490"><span class="hs-identifier">ha</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a name="local-6989586621679059488"><a href="#local-6989586621679059488"><span class="hs-identifier">oneOf</span></a></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Network.Socket.Types.html#SockAddrInet"><span class="hs-identifier hs-var">SockAddrInet</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679059491"><a href="#local-6989586621679059491"><span class="hs-identifier">hb</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679059492"><a href="#local-6989586621679059492"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679059490"><span class="hs-identifier hs-var">ha</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679059491"><span class="hs-identifier hs-var">hb</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679059489"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679059488"><span class="hs-identifier hs-var">oneOf</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679059492"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-372"></a><span>    </span><a name="local-6989586621679059493"><a href="#local-6989586621679059493"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Network.Socket.Types.html#SockAddrInet6"><span class="hs-identifier hs-var">SockAddrInet6</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679059494"><a href="#local-6989586621679059494"><span class="hs-identifier">ha</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">oneOf</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Network.Socket.Types.html#SockAddrInet6"><span class="hs-identifier hs-var">SockAddrInet6</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679059495"><a href="#local-6989586621679059495"><span class="hs-identifier">hb</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679059496"><a href="#local-6989586621679059496"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679059494"><span class="hs-identifier hs-var">ha</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679059495"><span class="hs-identifier hs-var">hb</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679059493"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679059488"><span class="hs-identifier hs-var">oneOf</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679059496"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-375"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">oneOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-376"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">recvFrom</span><span> </span><span class="hs-identifier">host</span><span> </span><span class="hs-identifier">port</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-378"></a><span> </span><span class="hs-identifier">ip</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getHostByName</span><span> </span><span class="hs-identifier">host</span><span>
</span><a name="line-379"></a><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">ipHs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hostAddresses</span><span> </span><span class="hs-identifier">ip</span><span>
</span><a name="line-380"></a><span> </span><span class="hs-identifier">s</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">listenOn</span><span> </span><span class="hs-identifier">port</span><span>
</span><a name="line-381"></a><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-382"></a><span>  </span><span class="hs-identifier">waiting</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-383"></a><span>     </span><span class="hs-glyph">~</span><span class="hs-special">(</span><span class="hs-identifier">s'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">SockAddrInet</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">haddr</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span>  </span><span class="hs-identifier">Socket.accept</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-384"></a><span>     </span><span class="hs-identifier">he</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getHostByAddr</span><span> </span><span class="hs-identifier">AF_INET</span><span> </span><span class="hs-identifier">haddr</span><span>
</span><a name="line-385"></a><span>     </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ipHs</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hostAddresses</span><span> </span><span class="hs-identifier">he</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-387"></a><span>         </span><span class="hs-identifier">sClose</span><span> </span><span class="hs-identifier">s'</span><span>
</span><a name="line-388"></a><span>         </span><span class="hs-identifier">waiting</span><span>
</span><a name="line-389"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-390"></a><span>        </span><span class="hs-identifier">h</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">socketToHandle</span><span> </span><span class="hs-identifier">s'</span><span> </span><span class="hs-identifier">ReadMode</span><span>
</span><a name="line-391"></a><span>        </span><span class="hs-identifier">msg</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hGetContents</span><span> </span><span class="hs-identifier">h</span><span>
</span><a name="line-392"></a><span>        </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">msg</span><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span> </span><span class="hs-identifier">message</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">waiting</span><span>
</span><a name="line-395"></a><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">message</span><span>
</span><a name="line-396"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-398"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- Access function returning the port type/id of socket.</span><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span class="hs-comment">-- | Returns the 'PortID' associated with a given socket.</span><span>
</span><a name="line-402"></a><span class="hs-identifier">socketPort</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Network.html#PortID"><span class="hs-identifier hs-type">PortID</span></a><span>
</span><a name="line-403"></a><a name="socketPort"><a href="Network.html#socketPort"><span class="hs-identifier">socketPort</span></a></a><span> </span><a name="local-6989586621679059504"><a href="#local-6989586621679059504"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-404"></a><span>    </span><a name="local-6989586621679059505"><a href="#local-6989586621679059505"><span class="hs-identifier">sockaddr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Socket.html#getSocketName"><span class="hs-identifier hs-var">getSocketName</span></a><span> </span><a href="#local-6989586621679059504"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-405"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679059505"><span class="hs-identifier hs-var">sockaddr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-406"></a><span>      </span><a href="Network.Socket.Types.html#SockAddrInet"><span class="hs-identifier hs-var">SockAddrInet</span></a><span> </span><a name="local-6989586621679059506"><a href="#local-6989586621679059506"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.html#PortNumber"><span class="hs-identifier hs-var">PortNumber</span></a><span> </span><a href="#local-6989586621679059506"><span class="hs-identifier hs-var">port</span></a><span>
</span><a name="line-407"></a><span class="hs-cpp">#if defined(IPV6_SOCKET_SUPPORT)
</span><span>      </span><a href="Network.Socket.Types.html#SockAddrInet6"><span class="hs-identifier hs-var">SockAddrInet6</span></a><span> </span><a name="local-6989586621679059507"><a href="#local-6989586621679059507"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.html#PortNumber"><span class="hs-identifier hs-var">PortNumber</span></a><span> </span><a href="#local-6989586621679059507"><span class="hs-identifier hs-var">port</span></a><span>
</span><a name="line-409"></a><span class="hs-cpp">#else
</span><span>      </span><span class="hs-identifier">SockAddrInet6</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ioError</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">userError</span><span> </span><span class="hs-string">&quot;Network.socketPort: socket address 'SockAddrInet6' not supported on this platform.&quot;</span><span>
</span><a name="line-411"></a><span class="hs-cpp">#endif
#if defined(mingw32_HOST_OS)
</span><span>      </span><span class="hs-identifier">SockAddrUnix</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ioError</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">userError</span><span> </span><span class="hs-string">&quot;Network.socketPort: socket address 'SockAddrUnix' not supported on this platform.&quot;</span><span>
</span><a name="line-414"></a><span class="hs-cpp">#else
</span><span>      </span><a href="Network.Socket.Types.html#SockAddrUnix"><span class="hs-identifier hs-var">SockAddrUnix</span></a><span> </span><a name="local-6989586621679059508"><a href="#local-6989586621679059508"><span class="hs-identifier">path</span></a></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.html#UnixSocket"><span class="hs-identifier hs-var">UnixSocket</span></a><span> </span><a href="#local-6989586621679059508"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-416"></a><span class="hs-cpp">#endif
</span><span>      </span><a href="Network.Socket.Types.html#SockAddrCan"><span class="hs-identifier hs-var">SockAddrCan</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-string">&quot;Network.socketPort: socket address 'SockAddrCan' not supported.&quot;</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-420"></a><span class="hs-comment">-- Utils</span><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span class="hs-comment">-- Like bracket, but only performs the final action if there was an</span><span>
</span><a name="line-423"></a><span class="hs-comment">-- exception raised by the middle bit.</span><span>
</span><a name="line-424"></a><span class="hs-identifier">bracketOnError</span><span>
</span><a name="line-425"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059428"><span class="hs-identifier hs-type">a</span></a><span>         </span><span class="hs-comment">-- ^ computation to run first (\&quot;acquire resource\&quot;)</span><span>
</span><a name="line-426"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679059428"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059429"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ computation to run last (\&quot;release resource\&quot;)</span><span>
</span><a name="line-427"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679059428"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059430"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ computation to run in-between</span><span>
</span><a name="line-428"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059430"><span class="hs-identifier hs-type">c</span></a><span>         </span><span class="hs-comment">-- returns the value from the in-between computation</span><span>
</span><a name="line-429"></a><a name="bracketOnError"><a href="Network.html#bracketOnError"><span class="hs-identifier">bracketOnError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Exception.bracketOnError</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- Extra documentation</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-comment">{-$buffering

The 'Handle' returned by 'connectTo' and 'accept' is 'NoBuffering' by
default.  For an interactive application you may want to set the
buffering mode on the 'Handle' to
'LineBuffering' or 'BlockBuffering', like so:

&gt; h &lt;- connectTo host port
&gt; hSetBuffering h LineBuffering
-}</span><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span class="hs-comment">{-$performance

For really fast I\/O, it might be worth looking at the 'hGetBuf' and
'hPutBuf' family of functions in &quot;System.IO&quot;.
-}</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-identifier">catchIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059427"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception.IOException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059427"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059427"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-452"></a><span class="hs-cpp">#if MIN_VERSION_base(4,0,0)
</span><a name="catchIO"><a href="Network.html#catchIO"><span class="hs-identifier">catchIO</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Exception.catch</span><span>
</span><a name="line-454"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">catchIO</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Exception.catchJust</span><span> </span><span class="hs-identifier">Exception.ioErrors</span><span>
</span><a name="line-456"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-458"></a><span class="hs-comment">-- Version of try implemented in terms of the locally defined catchIO</span><span>
</span><a name="line-459"></a><span class="hs-identifier">tryIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059426"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Exception.IOException</span><span> </span><a href="#local-6989586621679059426"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-460"></a><a name="tryIO"><a href="Network.html#tryIO"><span class="hs-identifier">tryIO</span></a></a><span> </span><a name="local-6989586621679059509"><a href="#local-6989586621679059509"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.html#catchIO"><span class="hs-identifier hs-var">catchIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679059509"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Left</span><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span class="hs-comment">-- Returns the first action from a list which does not throw an exception.</span><span>
</span><a name="line-463"></a><span class="hs-comment">-- If all the actions throw exceptions (and the list of actions is not empty),</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- the last exception is thrown.</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- The operations are run outside of the catchIO cleanup handler because</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- catchIO masks asynchronous exceptions in the cleanup handler.</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- In the case of complete failure, the last exception is actually thrown.</span><span>
</span><a name="line-468"></a><span class="hs-identifier">firstSuccessful</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059425"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679059425"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-469"></a><a name="firstSuccessful"><a href="Network.html#firstSuccessful"><span class="hs-identifier">firstSuccessful</span></a></a><span> </span><a name="local-6989586621679059510"><a href="#local-6989586621679059510"><span class="hs-identifier">caller</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679059511"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-470"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-471"></a><span>  </span><span class="hs-comment">-- Attempt the next operation, remember exception on failure</span><span>
</span><a name="line-472"></a><span>  </span><a name="local-6989586621679059511"><a href="#local-6989586621679059511"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679059512"><a href="#local-6989586621679059512"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679059513"><a href="#local-6989586621679059513"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-473"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679059514"><a href="#local-6989586621679059514"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.html#tryIO"><span class="hs-identifier hs-var">tryIO</span></a><span> </span><a href="#local-6989586621679059512"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-474"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679059514"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-475"></a><span>         </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679059515"><a href="#local-6989586621679059515"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679059515"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-476"></a><span>         </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679059516"><a href="#local-6989586621679059516"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679059511"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679059516"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679059513"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span>  </span><span class="hs-comment">-- All operations failed, throw error if one exists</span><span>
</span><a name="line-479"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679059510"><span class="hs-identifier hs-var">caller</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: firstSuccessful: empty list&quot;</span><span>
</span><a name="line-480"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679059517"><a href="#local-6989586621679059517"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Exception.throwIO</span><span> </span><a href="#local-6989586621679059517"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-481"></a></pre></body></html>
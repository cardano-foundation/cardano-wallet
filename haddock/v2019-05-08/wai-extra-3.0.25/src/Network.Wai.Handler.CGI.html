<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RankNTypes, CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- | Backend for Common Gateway Interface. Almost all users should use the</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- 'run' function.</span><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.Wai.Handler.CGI</span><span>
</span><a name="line-5"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Network.Wai.Handler.CGI.html#run"><span class="hs-identifier hs-var">run</span></a><span>
</span><a name="line-6"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Wai.Handler.CGI.html#runSendfile"><span class="hs-identifier hs-var">runSendfile</span></a><span>
</span><a name="line-7"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Wai.Handler.CGI.html#runGeneric"><span class="hs-identifier hs-var">runGeneric</span></a><span>
</span><a name="line-8"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Wai.Handler.CGI.html#requestBodyFunc"><span class="hs-identifier hs-var">requestBodyFunc</span></a><span>
</span><a name="line-9"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network.Wai</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network.Wai.Internal</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network.Socket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getAddrInfo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">addrAddress</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">L</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">***</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toLower</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.String</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">String</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString.Builder</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">byteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toLazyByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">char7</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">string8</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString.Builder.Extra</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flush</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy.Internal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultChunkSize</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Handle</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network.HTTP.Types</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Status</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hRange</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hContentType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hContentLength</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network.HTTP.Types</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">H</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.CaseInsensitive</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CI</span><span>
</span><a name="line-29"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &lt; 710
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mconcat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mempty</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mappend</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Streaming.ByteString.Builder</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Builder</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fix</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">void</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-cpp">#if WINDOWS
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Environment</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getEnvironment</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-cpp">#else
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System.Posix.Env.ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Env</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-identifier">getEnvironment</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-43"></a><a name="getEnvironment"><a href="Network.Wai.Handler.CGI.html#getEnvironment"><span class="hs-identifier">getEnvironment</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B.unpack</span><span> </span><span class="hs-operator hs-var">***</span><span> </span><span class="hs-identifier hs-var">B.unpack</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Env.getEnvironment</span><span>
</span><a name="line-44"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-46"></a><span class="hs-identifier">safeRead</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Read</span><span> </span><a href="#local-6989586621679039403"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679039403"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679039403"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-47"></a><a name="safeRead"><a href="Network.Wai.Handler.CGI.html#safeRead"><span class="hs-identifier">safeRead</span></a></a><span> </span><a name="local-6989586621679040425"><a href="#local-6989586621679040425"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621679040426"><a href="#local-6989586621679040426"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">reads</span><span> </span><a href="#local-6989586621679040426"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679040459"><a href="#local-6989586621679040459"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040459"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040425"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-identifier">lookup'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-53"></a><a name="lookup%27"><a href="Network.Wai.Handler.CGI.html#lookup%27"><span class="hs-identifier">lookup'</span></a></a><span> </span><a name="local-6989586621679040460"><a href="#local-6989586621679040460"><span class="hs-identifier">key</span></a></a><span> </span><a name="local-6989586621679040461"><a href="#local-6989586621679040461"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679040460"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621679040461"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">-- | Run an application using CGI.</span><span>
</span><a name="line-56"></a><span class="hs-identifier">run</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Application</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><a name="run"><a href="Network.Wai.Handler.CGI.html#run"><span class="hs-identifier">run</span></a></a><span> </span><a name="local-6989586621679040648"><a href="#local-6989586621679040648"><span class="hs-identifier">app</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-58"></a><span>    </span><a name="local-6989586621679040649"><a href="#local-6989586621679040649"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Wai.Handler.CGI.html#getEnvironment"><span class="hs-identifier hs-var">getEnvironment</span></a><span>
</span><a name="line-59"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679040650"><a href="#local-6989586621679040650"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wai.Handler.CGI.html#requestBodyHandle"><span class="hs-identifier hs-var">requestBodyHandle</span></a><span> </span><span class="hs-identifier hs-var">System.IO.stdin</span><span>
</span><a name="line-60"></a><span>        </span><a name="local-6989586621679040651"><a href="#local-6989586621679040651"><span class="hs-identifier">output</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B.hPut</span><span> </span><span class="hs-identifier hs-var">System.IO.stdout</span><span>
</span><a name="line-61"></a><span>    </span><a href="Network.Wai.Handler.CGI.html#runGeneric"><span class="hs-identifier hs-var">runGeneric</span></a><span> </span><a href="#local-6989586621679040649"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621679040650"><span class="hs-identifier hs-var">input</span></a><span> </span><a href="#local-6989586621679040651"><span class="hs-identifier hs-var">output</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679040648"><span class="hs-identifier hs-var">app</span></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-comment">-- | Some web servers provide an optimization for sending files via a sendfile</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- system call via a special header. To use this feature, provide that header</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- name here.</span><span>
</span><a name="line-66"></a><span class="hs-identifier">runSendfile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">B.ByteString</span><span> </span><span class="hs-comment">-- ^ sendfile header</span><span>
</span><a name="line-67"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Application</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><a name="runSendfile"><a href="Network.Wai.Handler.CGI.html#runSendfile"><span class="hs-identifier">runSendfile</span></a></a><span> </span><a name="local-6989586621679041018"><a href="#local-6989586621679041018"><span class="hs-identifier">sf</span></a></a><span> </span><a name="local-6989586621679041019"><a href="#local-6989586621679041019"><span class="hs-identifier">app</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-69"></a><span>    </span><a name="local-6989586621679041020"><a href="#local-6989586621679041020"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Wai.Handler.CGI.html#getEnvironment"><span class="hs-identifier hs-var">getEnvironment</span></a><span>
</span><a name="line-70"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679041021"><a href="#local-6989586621679041021"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wai.Handler.CGI.html#requestBodyHandle"><span class="hs-identifier hs-var">requestBodyHandle</span></a><span> </span><span class="hs-identifier hs-var">System.IO.stdin</span><span>
</span><a name="line-71"></a><span>        </span><a name="local-6989586621679041022"><a href="#local-6989586621679041022"><span class="hs-identifier">output</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B.hPut</span><span> </span><span class="hs-identifier hs-var">System.IO.stdout</span><span>
</span><a name="line-72"></a><span>    </span><a href="Network.Wai.Handler.CGI.html#runGeneric"><span class="hs-identifier hs-var">runGeneric</span></a><span> </span><a href="#local-6989586621679041020"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621679041021"><span class="hs-identifier hs-var">input</span></a><span> </span><a href="#local-6989586621679041022"><span class="hs-identifier hs-var">output</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679041018"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679041019"><span class="hs-identifier hs-var">app</span></a><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-comment">-- | A generic CGI helper, which allows other backends (FastCGI and SCGI) to</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- use the same code as CGI. Most users will not need this function, and can</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- stick with 'run' or 'runSendfile'.</span><span>
</span><a name="line-77"></a><span class="hs-identifier">runGeneric</span><span>
</span><a name="line-78"></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ all variables</span><span>
</span><a name="line-79"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">B.ByteString</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ responseBody of input</span><span>
</span><a name="line-80"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">B.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ destination for output</span><span>
</span><a name="line-81"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">B.ByteString</span><span> </span><span class="hs-comment">-- ^ does the server support the X-Sendfile header?</span><span>
</span><a name="line-82"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Application</span><span>
</span><a name="line-83"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><a name="runGeneric"><a href="Network.Wai.Handler.CGI.html#runGeneric"><span class="hs-identifier">runGeneric</span></a></a><span> </span><a name="local-6989586621679041023"><a href="#local-6989586621679041023"><span class="hs-identifier">vars</span></a></a><span> </span><a name="local-6989586621679041024"><a href="#local-6989586621679041024"><span class="hs-identifier">inputH</span></a></a><span> </span><a name="local-6989586621679041025"><a href="#local-6989586621679041025"><span class="hs-identifier">outputH</span></a></a><span> </span><a name="local-6989586621679041026"><a href="#local-6989586621679041026"><span class="hs-identifier">xsendfile</span></a></a><span> </span><a name="local-6989586621679041027"><a href="#local-6989586621679041027"><span class="hs-identifier">app</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679041047"><a href="#local-6989586621679041047"><span class="hs-identifier">rmethod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Wai.Handler.CGI.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><span class="hs-string">&quot;REQUEST_METHOD&quot;</span><span> </span><a href="#local-6989586621679041023"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-86"></a><span>        </span><a name="local-6989586621679041048"><a href="#local-6989586621679041048"><span class="hs-identifier">pinfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wai.Handler.CGI.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><span class="hs-string">&quot;PATH_INFO&quot;</span><span> </span><a href="#local-6989586621679041023"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-87"></a><span>        </span><a name="local-6989586621679041049"><a href="#local-6989586621679041049"><span class="hs-identifier">qstring</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wai.Handler.CGI.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><span class="hs-string">&quot;QUERY_STRING&quot;</span><span> </span><a href="#local-6989586621679041023"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-88"></a><span>        </span><a name="local-6989586621679041050"><a href="#local-6989586621679041050"><span class="hs-identifier">contentLength</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Wai.Handler.CGI.html#safeRead"><span class="hs-identifier hs-var">safeRead</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Wai.Handler.CGI.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><span class="hs-string">&quot;CONTENT_LENGTH&quot;</span><span> </span><a href="#local-6989586621679041023"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-89"></a><span>        </span><a name="local-6989586621679041051"><a href="#local-6989586621679041051"><span class="hs-identifier">remoteHost'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-90"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;REMOTE_ADDR&quot;</span><span> </span><a href="#local-6989586621679041023"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-91"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679041053"><a href="#local-6989586621679041053"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679041053"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-92"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-93"></a><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;REMOTE_HOST&quot;</span><span> </span><a href="#local-6989586621679041023"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-94"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679041054"><a href="#local-6989586621679041054"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679041054"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-95"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-96"></a><span>        </span><a name="local-6989586621679041052"><a href="#local-6989586621679041052"><span class="hs-identifier">isSecure'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-97"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toLower</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Wai.Handler.CGI.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><span class="hs-string">&quot;SERVER_PROTOCOL&quot;</span><span> </span><a href="#local-6989586621679041023"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-98"></a><span>                </span><span class="hs-string">&quot;https&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-99"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-100"></a><span>    </span><a name="local-6989586621679041363"><a href="#local-6989586621679041363"><span class="hs-identifier">addrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getAddrInfo</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679041051"><span class="hs-identifier hs-var">remoteHost'</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-101"></a><span>    </span><a name="local-6989586621679041364"><a href="#local-6989586621679041364"><span class="hs-identifier">requestBody'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679041024"><span class="hs-identifier hs-var">inputH</span></a><span> </span><a href="#local-6989586621679041050"><span class="hs-identifier hs-var">contentLength</span></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679041365"><a href="#local-6989586621679041365"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-103"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679041363"><span class="hs-identifier hs-var">addrs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-104"></a><span>                </span><a name="local-6989586621679041368"><a href="#local-6989586621679041368"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">addrAddress</span><span> </span><a href="#local-6989586621679041368"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-105"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Invalid REMOTE_ADDR or REMOTE_HOST: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679041051"><span class="hs-identifier hs-var">remoteHost'</span></a><span>
</span><a name="line-106"></a><span>        </span><a name="local-6989586621679041366"><a href="#local-6989586621679041366"><span class="hs-identifier">reqHeaders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Network.Wai.Handler.CGI.html#cleanupVarName"><span class="hs-identifier hs-var">cleanupVarName</span></a><span> </span><span class="hs-operator hs-var">***</span><span> </span><span class="hs-identifier hs-var">B.pack</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679041023"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-107"></a><span>        </span><a name="local-6989586621679041367"><a href="#local-6989586621679041367"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Request</span><span>
</span><a name="line-108"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">requestMethod</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679041047"><span class="hs-identifier hs-var">rmethod</span></a><span>
</span><a name="line-109"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rawPathInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B.pack</span><span> </span><a href="#local-6989586621679041048"><span class="hs-identifier hs-var">pinfo</span></a><span>
</span><a name="line-110"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pathInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">H.decodePathSegments</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">B.pack</span><span> </span><a href="#local-6989586621679041048"><span class="hs-identifier hs-var">pinfo</span></a><span>
</span><a name="line-111"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rawQueryString</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B.pack</span><span> </span><a href="#local-6989586621679041049"><span class="hs-identifier hs-var">qstring</span></a><span>
</span><a name="line-112"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">queryString</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">H.parseQuery</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">B.pack</span><span> </span><a href="#local-6989586621679041049"><span class="hs-identifier hs-var">qstring</span></a><span>
</span><a name="line-113"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">requestHeaders</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679041366"><span class="hs-identifier hs-var">reqHeaders</span></a><span>
</span><a name="line-114"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isSecure</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679041052"><span class="hs-identifier hs-var">isSecure'</span></a><span>
</span><a name="line-115"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">remoteHost</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679041365"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-116"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">httpVersion</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">H.http11</span><span> </span><span class="hs-comment">-- FIXME</span><span>
</span><a name="line-117"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">requestBody</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679041364"><span class="hs-identifier hs-var">requestBody'</span></a><span>
</span><a name="line-118"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">vault</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-119"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">requestBodyLength</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">KnownLength</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679041050"><span class="hs-identifier hs-var">contentLength</span></a><span>
</span><a name="line-120"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">requestHeaderHost</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;host&quot;</span><span> </span><a href="#local-6989586621679041366"><span class="hs-identifier hs-var">reqHeaders</span></a><span>
</span><a name="line-121"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">requestHeaderRange</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-identifier hs-var">hRange</span><span> </span><a href="#local-6989586621679041366"><span class="hs-identifier hs-var">reqHeaders</span></a><span>
</span><a name="line-122"></a><span class="hs-cpp">#if MIN_VERSION_wai(3,2,0)
</span><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">requestHeaderReferer</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;referer&quot;</span><span> </span><a href="#local-6989586621679041366"><span class="hs-identifier hs-var">reqHeaders</span></a><span>
</span><a name="line-124"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">requestHeaderUserAgent</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;user-agent&quot;</span><span> </span><a href="#local-6989586621679041366"><span class="hs-identifier hs-var">reqHeaders</span></a><span>
</span><a name="line-125"></a><span class="hs-cpp">#endif
</span><span class="">            }
    void $ app env $ \res -&gt;
        case (xsendfile, res) of
            (Just sf, ResponseFile s hs fp Nothing) -&gt; do
                mapM_ outputH $ L.toChunks $ toLazyByteString $ sfBuilder s hs sf fp
                return ResponseReceived
            _ -&gt; do
                let (s, hs, wb) = responseToStream res
                (blazeRecv, blazeFinish) &lt;- Builder.newBuilderRecv Builder.defaultStrategy
                wb $ \b -&gt; do
                    let sendBuilder builder = do
                            popper &lt;- blazeRecv builder
                            fix $ \loop -&gt; do
                                bs &lt;- popper
                                unless (B.null bs) $ do
                                    outputH bs
                                    loop
                    sendBuilder $ headers s hs `mappend` char7 '\n'
                    b sendBuilder (sendBuilder flush)
                blazeFinish &gt;&gt;= maybe (return ()) outputH
                return ResponseReceived
  where
    headers s hs = mconcat (map header $ status s : map header' (fixHeaders hs))
    status (Status i m) = (byteString &quot;Status&quot;, mconcat
        [ string8 $ show i
        , char7 ' '
        , byteString m
        ])
    header' (x, y) = (byteString $ CI.original x, byteString y)
    header (x, y) = mconcat
        [ x
        , byteString &quot;: &quot;
        , y
        , char7 '\n'
        ]
    sfBuilder s hs sf fp = mconcat
        [ headers s hs
        , header $ (byteString sf, string8 fp)
        , char7 '\n'
        , byteString sf
        , byteString &quot; not supported&quot;
        ]
    fixHeaders h =
        case lookup hContentType h of
            Nothing -&gt; (hContentType, &quot;text/html; charset=utf-8&quot;) : h
            Just _ -&gt; h

cleanupVarName :: String -&gt; CI.CI B.ByteString
cleanupVarName &quot;CONTENT_TYPE&quot; = hContentType
cleanupVarName &quot;CONTENT_LENGTH&quot; = hContentLength
cleanupVarName &quot;SCRIPT_NAME&quot; = &quot;CGI-Script-Name&quot;
cleanupVarName s =
    case s of
        'H':'T':'T':'P':'_':a:as -&gt; String.fromString $ a : helper' as
        _ -&gt; String.fromString s -- FIXME remove?
  where
    helper' ('_':x:rest) = '-' : x : helper' rest
    helper' (x:rest) = toLower x : helper' rest
    helper' [] = []

requestBodyHandle :: Handle -&gt; Int -&gt; IO (IO B.ByteString)
requestBodyHandle h = requestBodyFunc $ \i -&gt; do
    bs &lt;- B.hGet h i
    return $ if B.null bs then Nothing else Just bs

requestBodyFunc :: (Int -&gt; IO (Maybe B.ByteString)) -&gt; Int -&gt; IO (IO B.ByteString)
requestBodyFunc get count0 = do
    ref &lt;- newIORef count0
    return $ do
        count &lt;- readIORef ref
        if count &lt;= 0
            then return B.empty
            else do
                mbs &lt;- get $ min count defaultChunkSize
                writeIORef ref $ count - maybe 0 B.length mbs
                return $ fromMaybe B.empty mbs
</span></pre></body></html>
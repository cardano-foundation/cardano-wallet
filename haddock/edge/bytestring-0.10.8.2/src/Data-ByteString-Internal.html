<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Data/ByteString/Internal.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP, ForeignFunctionInterface, BangPatterns #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE UnliftedFFITypes, MagicHash,
<a name="line-3"></a>            UnboxedTuples, DeriveDataTypeable #-}</span>
<a name="line-4"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt;= 703</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE Unsafe #-}</span>
<a name="line-6"></a><span class='hs-cpp'>#endif</span>
<a name="line-7"></a><span class='hs-comment'>{-# OPTIONS_HADDOCK hide #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>-- |</span>
<a name="line-10"></a><span class='hs-comment'>-- Module      : Data.ByteString.Internal</span>
<a name="line-11"></a><span class='hs-comment'>-- Copyright   : (c) Don Stewart 2006-2008</span>
<a name="line-12"></a><span class='hs-comment'>--               (c) Duncan Coutts 2006-2012</span>
<a name="line-13"></a><span class='hs-comment'>-- License     : BSD-style</span>
<a name="line-14"></a><span class='hs-comment'>-- Maintainer  : dons00@gmail.com, duncan@community.haskell.org</span>
<a name="line-15"></a><span class='hs-comment'>-- Stability   : unstable</span>
<a name="line-16"></a><span class='hs-comment'>-- Portability : non-portable</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-- A module containing semi-public 'ByteString' internals. This exposes the</span>
<a name="line-19"></a><span class='hs-comment'>-- 'ByteString' representation and low level construction functions. As such</span>
<a name="line-20"></a><span class='hs-comment'>-- all the functions in this module are unsafe. The API is also not stable.</span>
<a name="line-21"></a><span class='hs-comment'>--</span>
<a name="line-22"></a><span class='hs-comment'>-- Where possible application should instead use the functions from the normal</span>
<a name="line-23"></a><span class='hs-comment'>-- public interface modules, such as "Data.ByteString.Unsafe". Packages that</span>
<a name="line-24"></a><span class='hs-comment'>-- extend the ByteString system at a low level will need to use this module.</span>
<a name="line-25"></a><span class='hs-comment'>--</span>
<a name="line-26"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data.ByteString.Internal</span> <span class='hs-layout'>(</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-comment'>-- * The @ByteString@ type and representation</span>
<a name="line-29"></a>        <span class='hs-conid'>ByteString</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- instances: Eq, Ord, Show, Read, Data, Typeable</span>
<a name="line-30"></a>
<a name="line-31"></a>        <span class='hs-comment'>-- * Conversion with lists: packing and unpacking</span>
<a name="line-32"></a>        <span class='hs-varid'>packBytes</span><span class='hs-layout'>,</span> <span class='hs-varid'>packUptoLenBytes</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafePackLenBytes</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>packChars</span><span class='hs-layout'>,</span> <span class='hs-varid'>packUptoLenChars</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafePackLenChars</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>unpackBytes</span><span class='hs-layout'>,</span> <span class='hs-varid'>unpackAppendBytesLazy</span><span class='hs-layout'>,</span> <span class='hs-varid'>unpackAppendBytesStrict</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>unpackChars</span><span class='hs-layout'>,</span> <span class='hs-varid'>unpackAppendCharsLazy</span><span class='hs-layout'>,</span> <span class='hs-varid'>unpackAppendCharsStrict</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>unsafePackAddress</span><span class='hs-layout'>,</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-comment'>-- * Low level imperative construction</span>
<a name="line-39"></a>        <span class='hs-varid'>create</span><span class='hs-layout'>,</span>                 <span class='hs-comment'>-- :: Int -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString</span>
<a name="line-40"></a>        <span class='hs-varid'>createUptoN</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- :: Int -&gt; (Ptr Word8 -&gt; IO Int) -&gt; IO ByteString</span>
<a name="line-41"></a>        <span class='hs-varid'>createAndTrim</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- :: Int -&gt; (Ptr Word8 -&gt; IO Int) -&gt; IO  ByteString</span>
<a name="line-42"></a>        <span class='hs-varid'>createAndTrim'</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- :: Int -&gt; (Ptr Word8 -&gt; IO (Int, Int, a)) -&gt; IO (ByteString, a)</span>
<a name="line-43"></a>        <span class='hs-varid'>unsafeCreate</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- :: Int -&gt; (Ptr Word8 -&gt; IO ()) -&gt;  ByteString</span>
<a name="line-44"></a>        <span class='hs-varid'>unsafeCreateUptoN</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- :: Int -&gt; (Ptr Word8 -&gt; IO Int) -&gt;  ByteString</span>
<a name="line-45"></a>        <span class='hs-varid'>mallocByteString</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- :: Int -&gt; IO (ForeignPtr a)</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-comment'>-- * Conversion to and from ForeignPtrs</span>
<a name="line-48"></a>        <span class='hs-varid'>fromForeignPtr</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- :: ForeignPtr Word8 -&gt; Int -&gt; Int -&gt; ByteString</span>
<a name="line-49"></a>        <span class='hs-varid'>toForeignPtr</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- :: ByteString -&gt; (ForeignPtr Word8, Int, Int)</span>
<a name="line-50"></a>
<a name="line-51"></a>        <span class='hs-comment'>-- * Utilities</span>
<a name="line-52"></a>        <span class='hs-varid'>nullForeignPtr</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- :: ForeignPtr Word8</span>
<a name="line-53"></a>        <span class='hs-varid'>checkedAdd</span><span class='hs-layout'>,</span>             <span class='hs-comment'>-- :: String -&gt; Int -&gt; Int -&gt; Int</span>
<a name="line-54"></a>
<a name="line-55"></a>        <span class='hs-comment'>-- * Standard C Functions</span>
<a name="line-56"></a>        <span class='hs-varid'>c_strlen</span><span class='hs-layout'>,</span>               <span class='hs-comment'>-- :: CString -&gt; IO CInt</span>
<a name="line-57"></a>        <span class='hs-varid'>c_free_finalizer</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- :: FunPtr (Ptr Word8 -&gt; IO ())</span>
<a name="line-58"></a>
<a name="line-59"></a>        <span class='hs-varid'>memchr</span><span class='hs-layout'>,</span>                 <span class='hs-comment'>-- :: Ptr Word8 -&gt; Word8 -&gt; CSize -&gt; IO Ptr Word8</span>
<a name="line-60"></a>        <span class='hs-varid'>memcmp</span><span class='hs-layout'>,</span>                 <span class='hs-comment'>-- :: Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO CInt</span>
<a name="line-61"></a>        <span class='hs-varid'>memcpy</span><span class='hs-layout'>,</span>                 <span class='hs-comment'>-- :: Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()</span>
<a name="line-62"></a>        <span class='hs-varid'>memset</span><span class='hs-layout'>,</span>                 <span class='hs-comment'>-- :: Ptr Word8 -&gt; Word8 -&gt; CSize -&gt; IO (Ptr Word8)</span>
<a name="line-63"></a>
<a name="line-64"></a>        <span class='hs-comment'>-- * cbits functions</span>
<a name="line-65"></a>        <span class='hs-varid'>c_reverse</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- :: Ptr Word8 -&gt; Ptr Word8 -&gt; CInt -&gt; IO ()</span>
<a name="line-66"></a>        <span class='hs-varid'>c_intersperse</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- :: Ptr Word8 -&gt; Ptr Word8 -&gt; CInt -&gt; Word8 -&gt; IO ()</span>
<a name="line-67"></a>        <span class='hs-varid'>c_maximum</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- :: Ptr Word8 -&gt; CInt -&gt; IO Word8</span>
<a name="line-68"></a>        <span class='hs-varid'>c_minimum</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- :: Ptr Word8 -&gt; CInt -&gt; IO Word8</span>
<a name="line-69"></a>        <span class='hs-varid'>c_count</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- :: Ptr Word8 -&gt; CInt -&gt; Word8 -&gt; IO CInt</span>
<a name="line-70"></a>
<a name="line-71"></a>        <span class='hs-comment'>-- * Chars</span>
<a name="line-72"></a>        <span class='hs-varid'>w2c</span><span class='hs-layout'>,</span> <span class='hs-varid'>c2w</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSpaceWord8</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSpaceChar8</span><span class='hs-layout'>,</span>
<a name="line-73"></a>
<a name="line-74"></a>        <span class='hs-comment'>-- * Deprecated and unmentionable</span>
<a name="line-75"></a>        <span class='hs-varid'>accursedUnutterablePerformIO</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- :: IO a -&gt; a</span>
<a name="line-76"></a>        <span class='hs-varid'>inlinePerformIO</span>               <span class='hs-comment'>-- :: IO a -&gt; a</span>
<a name="line-77"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span><span class='hs-layout'>,</span> <span class='hs-varid'>null</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.List</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>List</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.ForeignPtr</span>       <span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtr</span><span class='hs-layout'>,</span> <span class='hs-varid'>withForeignPtr</span><span class='hs-layout'>)</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.Ptr</span>              <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span><span class='hs-layout'>,</span> <span class='hs-conid'>FunPtr</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusPtr</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.Storable</span>         <span class='hs-layout'>(</span><span class='hs-conid'>Storable</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a><span class='hs-cpp'>#if MIN_VERSION_base(4,5,0) || __GLASGOW_HASKELL__ &gt;= 703</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.C.Types</span>          <span class='hs-layout'>(</span><span class='hs-conid'>CInt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CSize</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CULong</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-cpp'>#else</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.C.Types</span>          <span class='hs-layout'>(</span><span class='hs-conid'>CInt</span><span class='hs-layout'>,</span> <span class='hs-conid'>CSize</span><span class='hs-layout'>,</span> <span class='hs-conid'>CULong</span><span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-cpp'>#endif</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.C.String</span>         <span class='hs-layout'>(</span><span class='hs-conid'>CString</span><span class='hs-layout'>)</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-cpp'>#if MIN_VERSION_base(4,9,0)</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Semigroup</span>           <span class='hs-layout'>(</span><span class='hs-conid'>Semigroup</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-96"></a><span class='hs-cpp'>#endif</span>
<a name="line-97"></a><span class='hs-cpp'>#if !(MIN_VERSION_base(4,8,0))</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Monoid</span>              <span class='hs-layout'>(</span><span class='hs-conid'>Monoid</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-cpp'>#endif</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.DeepSeq</span>          <span class='hs-layout'>(</span><span class='hs-conid'>NFData</span><span class='hs-layout'>(</span><span class='hs-varid'>rnf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.String</span>              <span class='hs-layout'>(</span><span class='hs-conid'>IsString</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Exception</span>        <span class='hs-layout'>(</span><span class='hs-varid'>assert</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Char</span>                <span class='hs-layout'>(</span><span class='hs-varid'>ord</span><span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Word</span>                <span class='hs-layout'>(</span><span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Typeable</span>            <span class='hs-layout'>(</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Data</span>                <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNoRepType</span><span class='hs-layout'>)</span>
<a name="line-112"></a>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Base</span>                 <span class='hs-layout'>(</span><span class='hs-varid'>nullAddr</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span><span class='hs-varid'>realWorld</span><span class='hs-cpp'>#</span><span class='hs-layout'>,</span><span class='hs-varid'>unsafeChr</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-cpp'>#if MIN_VERSION_base(4,4,0)</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CString</span>              <span class='hs-layout'>(</span><span class='hs-varid'>unpackCString</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-117"></a><span class='hs-cpp'>#else</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Base</span>                 <span class='hs-layout'>(</span><span class='hs-varid'>unpackCString</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-119"></a><span class='hs-cpp'>#endif</span>
<a name="line-120"></a>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prim</span>                 <span class='hs-layout'>(</span><span class='hs-conid'>Addr</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt;= 611</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO</span>                   <span class='hs-layout'>(</span><span class='hs-conid'>IO</span><span class='hs-layout'>(</span><span class='hs-conid'>IO</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>unsafeDupablePerformIO</span><span class='hs-layout'>)</span>
<a name="line-125"></a><span class='hs-cpp'>#else</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IOBase</span>               <span class='hs-layout'>(</span><span class='hs-conid'>IO</span><span class='hs-layout'>(</span><span class='hs-conid'>IO</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-conid'>RawBuffer</span><span class='hs-layout'>,</span><span class='hs-varid'>unsafeDupablePerformIO</span><span class='hs-layout'>)</span>
<a name="line-127"></a><span class='hs-cpp'>#endif</span>
<a name="line-128"></a>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.ForeignPtr</span>           <span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtr</span><span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtr</span><span class='hs-layout'>)</span>
<a name="line-130"></a>                                <span class='hs-layout'>,</span><span class='hs-varid'>newForeignPtr_</span><span class='hs-layout'>,</span> <span class='hs-varid'>mallocPlainForeignPtrBytes</span><span class='hs-layout'>)</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Ptr</span>                  <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>castPtr</span><span class='hs-layout'>)</span>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-comment'>-- CFILES stuff is Hugs only</span>
<a name="line-134"></a><span class='hs-comment'>{-# CFILES cbits/fpstring.c #-}</span>
<a name="line-135"></a>
<a name="line-136"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-137"></a>
<a name="line-138"></a><a name="ByteString"></a><span class='hs-comment'>-- | A space-efficient representation of a 'Word8' vector, supporting many</span>
<a name="line-139"></a><a name="ByteString"></a><span class='hs-comment'>-- efficient operations.</span>
<a name="line-140"></a><a name="ByteString"></a><span class='hs-comment'>--</span>
<a name="line-141"></a><a name="ByteString"></a><span class='hs-comment'>-- A 'ByteString' contains 8-bit bytes, or by using the operations from</span>
<a name="line-142"></a><a name="ByteString"></a><span class='hs-comment'>-- "Data.ByteString.Char8" it can be interpreted as containing 8-bit</span>
<a name="line-143"></a><a name="ByteString"></a><span class='hs-comment'>-- characters.</span>
<a name="line-144"></a><a name="ByteString"></a><span class='hs-comment'>--</span>
<a name="line-145"></a><a name="ByteString"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- payload</span>
<a name="line-146"></a>                     <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>                <span class='hs-comment'>-- offset</span>
<a name="line-147"></a>                     <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>                <span class='hs-comment'>-- length</span>
<a name="line-148"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="instance%20Eq%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span>  <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-151"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq</span>
<a name="line-152"></a>
<a name="line-153"></a><a name="instance%20Ord%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-154"></a>    <span class='hs-varid'>compare</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareBytes</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-cpp'>#if MIN_VERSION_base(4,9,0)</span>
<a name="line-157"></a><a name="instance%20Semigroup%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Semigroup</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-158"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&lt;&gt;</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>append</span>
<a name="line-159"></a><span class='hs-cpp'>#endif</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="instance%20Monoid%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monoid</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-162"></a>    <span class='hs-varid'>mempty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>nullForeignPtr</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span>
<a name="line-163"></a><span class='hs-cpp'>#if MIN_VERSION_base(4,9,0)</span>
<a name="line-164"></a>    <span class='hs-varid'>mappend</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;&gt;</span><span class='hs-layout'>)</span>
<a name="line-165"></a><span class='hs-cpp'>#else</span>
<a name="line-166"></a>    <span class='hs-varid'>mappend</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>append</span>
<a name="line-167"></a><span class='hs-cpp'>#endif</span>
<a name="line-168"></a>    <span class='hs-varid'>mconcat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="instance%20NFData%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NFData</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-171"></a>    <span class='hs-varid'>rnf</span> <span class='hs-conid'>PS</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-172"></a>
<a name="line-173"></a><a name="instance%20Show%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-174"></a>    <span class='hs-varid'>showsPrec</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showsPrec</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>unpackChars</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span>
<a name="line-175"></a>
<a name="line-176"></a><a name="instance%20Read%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Read</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-177"></a>    <span class='hs-varid'>readsPrec</span> <span class='hs-varid'>p</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>packChars</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readsPrec</span> <span class='hs-varid'>p</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>]</span>
<a name="line-178"></a>
<a name="line-179"></a><a name="instance%20IsString%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>IsString</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-180"></a>    <span class='hs-varid'>fromString</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>packChars</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="instance%20Data%20ByteString"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>where</span>
<a name="line-183"></a>  <span class='hs-varid'>gfoldl</span> <span class='hs-varid'>f</span> <span class='hs-varid'>z</span> <span class='hs-varid'>txt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span> <span class='hs-varid'>packBytes</span> <span class='hs-varop'>`f`</span> <span class='hs-varid'>unpackBytes</span> <span class='hs-varid'>txt</span>
<a name="line-184"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Data.ByteString.ByteString.toConstr"</span>
<a name="line-185"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Data.ByteString.ByteString.gunfold"</span>
<a name="line-186"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"Data.ByteString.ByteString"</span>
<a name="line-187"></a>
<a name="line-188"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-189"></a><span class='hs-comment'>-- Packing and unpacking from lists</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="packBytes"></a><span class='hs-definition'>packBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-192"></a><span class='hs-definition'>packBytes</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePackLenBytes</span> <span class='hs-layout'>(</span><span class='hs-conid'>List.length</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span> <span class='hs-varid'>ws</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="packChars"></a><span class='hs-definition'>packChars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-195"></a><span class='hs-definition'>packChars</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePackLenChars</span> <span class='hs-layout'>(</span><span class='hs-conid'>List.length</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-196"></a>
<a name="line-197"></a><span class='hs-comment'>{-# INLINE [0] packChars #-}</span>
<a name="line-198"></a>
<a name="line-199"></a><span class='hs-comment'>{-# RULES
<a name="line-200"></a>"ByteString packChars/packAddress" forall s .
<a name="line-201"></a>   packChars (unpackCString# s) = accursedUnutterablePerformIO (unsafePackAddress s)
<a name="line-202"></a> #-}</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="unsafePackLenBytes"></a><span class='hs-definition'>unsafePackLenBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-205"></a><span class='hs-definition'>unsafePackLenBytes</span> <span class='hs-varid'>len</span> <span class='hs-varid'>xs0</span> <span class='hs-keyglyph'>=</span>
<a name="line-206"></a>    <span class='hs-varid'>unsafeCreate</span> <span class='hs-varid'>len</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>xs0</span>
<a name="line-207"></a>  <span class='hs-keyword'>where</span>
<a name="line-208"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-209"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>p</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-210"></a>
<a name="line-211"></a><a name="unsafePackLenChars"></a><span class='hs-definition'>unsafePackLenChars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-212"></a><span class='hs-definition'>unsafePackLenChars</span> <span class='hs-varid'>len</span> <span class='hs-varid'>cs0</span> <span class='hs-keyglyph'>=</span>
<a name="line-213"></a>    <span class='hs-varid'>unsafeCreate</span> <span class='hs-varid'>len</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>cs0</span>
<a name="line-214"></a>  <span class='hs-keyword'>where</span>
<a name="line-215"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-216"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>c2w</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-217"></a>
<a name="line-218"></a>
<a name="line-219"></a><a name="unsafePackAddress"></a><span class='hs-comment'>-- | /O(n)/ Pack a null-terminated sequence of bytes, pointed to by an</span>
<a name="line-220"></a><span class='hs-comment'>-- Addr\# (an arbitrary machine address assumed to point outside the</span>
<a name="line-221"></a><span class='hs-comment'>-- garbage-collected heap) into a @ByteString@. A much faster way to</span>
<a name="line-222"></a><span class='hs-comment'>-- create an Addr\# is with an unboxed string literal, than to pack a</span>
<a name="line-223"></a><span class='hs-comment'>-- boxed string. A unboxed string literal is compiled to a static @char</span>
<a name="line-224"></a><span class='hs-comment'>-- []@ by GHC. Establishing the length of the string requires a call to</span>
<a name="line-225"></a><span class='hs-comment'>-- @strlen(3)@, so the Addr# must point to a null-terminated buffer (as</span>
<a name="line-226"></a><span class='hs-comment'>-- is the case with "string"# literals in GHC). Use 'unsafePackAddressLen'</span>
<a name="line-227"></a><span class='hs-comment'>-- if you know the length of the string statically.</span>
<a name="line-228"></a><span class='hs-comment'>--</span>
<a name="line-229"></a><span class='hs-comment'>-- An example:</span>
<a name="line-230"></a><span class='hs-comment'>--</span>
<a name="line-231"></a><span class='hs-comment'>-- &gt; literalFS = unsafePackAddress "literal"#</span>
<a name="line-232"></a><span class='hs-comment'>--</span>
<a name="line-233"></a><span class='hs-comment'>-- This function is /unsafe/. If you modify the buffer pointed to by the</span>
<a name="line-234"></a><span class='hs-comment'>-- original Addr# this modification will be reflected in the resulting</span>
<a name="line-235"></a><span class='hs-comment'>-- @ByteString@, breaking referential transparency.</span>
<a name="line-236"></a><span class='hs-comment'>--</span>
<a name="line-237"></a><span class='hs-comment'>-- Note this also won't work if your Addr# has embedded '\0' characters in</span>
<a name="line-238"></a><span class='hs-comment'>-- the string, as @strlen@ will return too short a length.</span>
<a name="line-239"></a><span class='hs-comment'>--</span>
<a name="line-240"></a><span class='hs-definition'>unsafePackAddress</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Addr</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ByteString</span>
<a name="line-241"></a><span class='hs-definition'>unsafePackAddress</span> <span class='hs-varid'>addr</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-242"></a>    <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newForeignPtr_</span> <span class='hs-layout'>(</span><span class='hs-varid'>castPtr</span> <span class='hs-varid'>cstr</span><span class='hs-layout'>)</span>
<a name="line-243"></a>    <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>c_strlen</span> <span class='hs-varid'>cstr</span>
<a name="line-244"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>p</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-245"></a>  <span class='hs-keyword'>where</span>
<a name="line-246"></a>    <span class='hs-varid'>cstr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CString</span>
<a name="line-247"></a>    <span class='hs-varid'>cstr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>addr</span><span class='hs-cpp'>#</span>
<a name="line-248"></a><span class='hs-comment'>{-# INLINE unsafePackAddress #-}</span>
<a name="line-249"></a>
<a name="line-250"></a>
<a name="line-251"></a><a name="packUptoLenBytes"></a><span class='hs-definition'>packUptoLenBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-252"></a><span class='hs-definition'>packUptoLenBytes</span> <span class='hs-varid'>len</span> <span class='hs-varid'>xs0</span> <span class='hs-keyglyph'>=</span>
<a name="line-253"></a>    <span class='hs-varid'>unsafeCreateUptoN'</span> <span class='hs-varid'>len</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>len</span> <span class='hs-varid'>xs0</span>
<a name="line-254"></a>  <span class='hs-keyword'>where</span>
<a name="line-255"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-varid'>n</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span><span class='hs-comment'>-</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-256"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-num'>0</span> <span class='hs-varid'>xs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span><span class='hs-layout'>,</span>   <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-257"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-varop'>!</span><span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>p</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-258"></a>
<a name="line-259"></a><a name="packUptoLenChars"></a><span class='hs-definition'>packUptoLenChars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-260"></a><span class='hs-definition'>packUptoLenChars</span> <span class='hs-varid'>len</span> <span class='hs-varid'>cs0</span> <span class='hs-keyglyph'>=</span>
<a name="line-261"></a>    <span class='hs-varid'>unsafeCreateUptoN'</span> <span class='hs-varid'>len</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>len</span> <span class='hs-varid'>cs0</span>
<a name="line-262"></a>  <span class='hs-keyword'>where</span>
<a name="line-263"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-varid'>n</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span><span class='hs-comment'>-</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-264"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-keyword'>_</span> <span class='hs-varop'>!</span><span class='hs-num'>0</span> <span class='hs-varid'>cs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span><span class='hs-layout'>,</span>   <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-265"></a>    <span class='hs-varid'>go</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-varop'>!</span><span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>c2w</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-266"></a>
<a name="line-267"></a><span class='hs-comment'>-- Unpacking bytestrings into lists effeciently is a tradeoff: on the one hand</span>
<a name="line-268"></a><span class='hs-comment'>-- we would like to write a tight loop that just blats the list into memory, on</span>
<a name="line-269"></a><span class='hs-comment'>-- the other hand we want it to be unpacked lazily so we don't end up with a</span>
<a name="line-270"></a><span class='hs-comment'>-- massive list data structure in memory.</span>
<a name="line-271"></a><span class='hs-comment'>--</span>
<a name="line-272"></a><span class='hs-comment'>-- Our strategy is to combine both: we will unpack lazily in reasonable sized</span>
<a name="line-273"></a><span class='hs-comment'>-- chunks, where each chunk is unpacked strictly.</span>
<a name="line-274"></a><span class='hs-comment'>--</span>
<a name="line-275"></a><span class='hs-comment'>-- unpackBytes and unpackChars do the lazy loop, while unpackAppendBytes and</span>
<a name="line-276"></a><span class='hs-comment'>-- unpackAppendChars do the chunks strictly.</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="unpackBytes"></a><span class='hs-definition'>unpackBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span>
<a name="line-279"></a><span class='hs-definition'>unpackBytes</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackAppendBytesLazy</span> <span class='hs-varid'>bs</span> <span class='hs-conid'>[]</span>
<a name="line-280"></a>
<a name="line-281"></a><a name="unpackChars"></a><span class='hs-definition'>unpackChars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span>
<a name="line-282"></a><span class='hs-definition'>unpackChars</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackAppendCharsLazy</span> <span class='hs-varid'>bs</span> <span class='hs-conid'>[]</span>
<a name="line-283"></a>
<a name="line-284"></a><a name="unpackAppendBytesLazy"></a><span class='hs-definition'>unpackAppendBytesLazy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span>
<a name="line-285"></a><span class='hs-definition'>unpackAppendBytesLazy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-286"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>len</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>100</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackAppendBytesStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-287"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackAppendBytesStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-num'>100</span><span class='hs-layout'>)</span> <span class='hs-varid'>remainder</span>
<a name="line-288"></a>  <span class='hs-keyword'>where</span>
<a name="line-289"></a>    <span class='hs-varid'>remainder</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackAppendBytesLazy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-varop'>+</span><span class='hs-num'>100</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span><span class='hs-comment'>-</span><span class='hs-num'>100</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-290"></a>
<a name="line-291"></a>  <span class='hs-comment'>-- Why 100 bytes you ask? Because on a 64bit machine the list we allocate</span>
<a name="line-292"></a>  <span class='hs-comment'>-- takes just shy of 4k which seems like a reasonable amount.</span>
<a name="line-293"></a>  <span class='hs-comment'>-- (5 words per list element, 8 bytes per word, 100 elements = 4000 bytes)</span>
<a name="line-294"></a>
<a name="line-295"></a><a name="unpackAppendCharsLazy"></a><span class='hs-definition'>unpackAppendCharsLazy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span>
<a name="line-296"></a><span class='hs-definition'>unpackAppendCharsLazy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-297"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>len</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>100</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackAppendCharsStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-298"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackAppendCharsStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-num'>100</span><span class='hs-layout'>)</span> <span class='hs-varid'>remainder</span>
<a name="line-299"></a>  <span class='hs-keyword'>where</span>
<a name="line-300"></a>    <span class='hs-varid'>remainder</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackAppendCharsLazy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-varop'>+</span><span class='hs-num'>100</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span><span class='hs-comment'>-</span><span class='hs-num'>100</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span>
<a name="line-301"></a>
<a name="line-302"></a><span class='hs-comment'>-- For these unpack functions, since we're unpacking the whole list strictly we</span>
<a name="line-303"></a><span class='hs-comment'>-- build up the result list in an accumulator. This means we have to build up</span>
<a name="line-304"></a><span class='hs-comment'>-- the list starting at the end. So our traversal starts at the end of the</span>
<a name="line-305"></a><span class='hs-comment'>-- buffer and loops down until we hit the sentinal:</span>
<a name="line-306"></a>
<a name="line-307"></a><a name="unpackAppendBytesStrict"></a><span class='hs-definition'>unpackAppendBytesStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span>
<a name="line-308"></a><span class='hs-definition'>unpackAppendBytesStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span>
<a name="line-309"></a>    <span class='hs-varid'>accursedUnutterablePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>base</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-310"></a>      <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>base</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>base</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-varop'>+</span><span class='hs-varid'>len</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-311"></a>  <span class='hs-keyword'>where</span>
<a name="line-312"></a>    <span class='hs-varid'>loop</span> <span class='hs-varop'>!</span><span class='hs-varid'>sentinal</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-varid'>acc</span>
<a name="line-313"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>p</span> <span class='hs-varop'>==</span> <span class='hs-varid'>sentinal</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>acc</span>
<a name="line-314"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peek</span> <span class='hs-varid'>p</span>
<a name="line-315"></a>                           <span class='hs-varid'>loop</span> <span class='hs-varid'>sentinal</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-316"></a>
<a name="line-317"></a><a name="unpackAppendCharsStrict"></a><span class='hs-definition'>unpackAppendCharsStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Char</span><span class='hs-keyglyph'>]</span>
<a name="line-318"></a><span class='hs-definition'>unpackAppendCharsStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span>
<a name="line-319"></a>    <span class='hs-varid'>accursedUnutterablePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>base</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-320"></a>      <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>base</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>base</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-varop'>+</span><span class='hs-varid'>len</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-321"></a>  <span class='hs-keyword'>where</span>
<a name="line-322"></a>    <span class='hs-varid'>loop</span> <span class='hs-varop'>!</span><span class='hs-varid'>sentinal</span> <span class='hs-varop'>!</span><span class='hs-varid'>p</span> <span class='hs-varid'>acc</span>
<a name="line-323"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>p</span> <span class='hs-varop'>==</span> <span class='hs-varid'>sentinal</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>acc</span>
<a name="line-324"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peek</span> <span class='hs-varid'>p</span>
<a name="line-325"></a>                           <span class='hs-varid'>loop</span> <span class='hs-varid'>sentinal</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>w2c</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-326"></a>
<a name="line-327"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-328"></a>
<a name="line-329"></a><a name="nullForeignPtr"></a><span class='hs-comment'>-- | The 0 pointer. Used to indicate the empty Bytestring.</span>
<a name="line-330"></a><span class='hs-definition'>nullForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<a name="line-331"></a><span class='hs-definition'>nullForeignPtr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>nullAddr</span><span class='hs-cpp'>#</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-str'>"nullForeignPtr"</span><span class='hs-layout'>)</span> <span class='hs-comment'>--TODO: should ForeignPtrContents be strict?</span>
<a name="line-332"></a>
<a name="line-333"></a><span class='hs-comment'>-- ---------------------------------------------------------------------</span>
<a name="line-334"></a><span class='hs-comment'>-- Low level constructors</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="fromForeignPtr"></a><span class='hs-comment'>-- | /O(1)/ Build a ByteString from a ForeignPtr.</span>
<a name="line-337"></a><span class='hs-comment'>--</span>
<a name="line-338"></a><span class='hs-comment'>-- If you do not need the offset parameter then you do should be using</span>
<a name="line-339"></a><span class='hs-comment'>-- 'Data.ByteString.Unsafe.unsafePackCStringLen' or</span>
<a name="line-340"></a><span class='hs-comment'>-- 'Data.ByteString.Unsafe.unsafePackCStringFinalizer' instead.</span>
<a name="line-341"></a><span class='hs-comment'>--</span>
<a name="line-342"></a><span class='hs-definition'>fromForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<a name="line-343"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Offset</span>
<a name="line-344"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Length</span>
<a name="line-345"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-346"></a><span class='hs-definition'>fromForeignPtr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span>
<a name="line-347"></a><span class='hs-comment'>{-# INLINE fromForeignPtr #-}</span>
<a name="line-348"></a>
<a name="line-349"></a><a name="toForeignPtr"></a><span class='hs-comment'>-- | /O(1)/ Deconstruct a ForeignPtr from a ByteString</span>
<a name="line-350"></a><span class='hs-definition'>toForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ (ptr, offset, length)</span>
<a name="line-351"></a><span class='hs-definition'>toForeignPtr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-352"></a><span class='hs-comment'>{-# INLINE toForeignPtr #-}</span>
<a name="line-353"></a>
<a name="line-354"></a><a name="unsafeCreate"></a><span class='hs-comment'>-- | A way of creating ByteStrings outside the IO monad. The @Int@</span>
<a name="line-355"></a><span class='hs-comment'>-- argument gives the final size of the ByteString.</span>
<a name="line-356"></a><span class='hs-definition'>unsafeCreate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-357"></a><span class='hs-definition'>unsafeCreate</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeDupablePerformIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>create</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-358"></a><span class='hs-comment'>{-# INLINE unsafeCreate #-}</span>
<a name="line-359"></a>
<a name="line-360"></a><a name="unsafeCreateUptoN"></a><span class='hs-comment'>-- | Like 'unsafeCreate' but instead of giving the final size of the</span>
<a name="line-361"></a><span class='hs-comment'>-- ByteString, it is just an upper bound. The inner action returns</span>
<a name="line-362"></a><span class='hs-comment'>-- the actual size. Unlike 'createAndTrim' the ByteString is not</span>
<a name="line-363"></a><span class='hs-comment'>-- reallocated if the final size is less than the estimated size.</span>
<a name="line-364"></a><span class='hs-definition'>unsafeCreateUptoN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-365"></a><span class='hs-definition'>unsafeCreateUptoN</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeDupablePerformIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>createUptoN</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-366"></a><span class='hs-comment'>{-# INLINE unsafeCreateUptoN #-}</span>
<a name="line-367"></a>
<a name="line-368"></a><a name="unsafeCreateUptoN'"></a><span class='hs-definition'>unsafeCreateUptoN'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-369"></a><span class='hs-definition'>unsafeCreateUptoN'</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeDupablePerformIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>createUptoN'</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-370"></a><span class='hs-comment'>{-# INLINE unsafeCreateUptoN' #-}</span>
<a name="line-371"></a>
<a name="line-372"></a><a name="create"></a><span class='hs-comment'>-- | Create ByteString of size @l@ and use action @f@ to fill it's contents.</span>
<a name="line-373"></a><span class='hs-definition'>create</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ByteString</span>
<a name="line-374"></a><span class='hs-definition'>create</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-375"></a>    <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocByteString</span> <span class='hs-varid'>l</span>
<a name="line-376"></a>    <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>p</span>
<a name="line-377"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>0</span> <span class='hs-varid'>l</span>
<a name="line-378"></a><span class='hs-comment'>{-# INLINE create #-}</span>
<a name="line-379"></a>
<a name="line-380"></a><a name="createUptoN"></a><span class='hs-comment'>-- | Create ByteString of up to size size @l@ and use action @f@ to fill it's</span>
<a name="line-381"></a><span class='hs-comment'>-- contents which returns its true size.</span>
<a name="line-382"></a><span class='hs-definition'>createUptoN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ByteString</span>
<a name="line-383"></a><span class='hs-definition'>createUptoN</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-384"></a>    <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocByteString</span> <span class='hs-varid'>l</span>
<a name="line-385"></a>    <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>p</span>
<a name="line-386"></a>    <span class='hs-varid'>assert</span> <span class='hs-layout'>(</span><span class='hs-varid'>l'</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>0</span> <span class='hs-varid'>l'</span>
<a name="line-387"></a><span class='hs-comment'>{-# INLINE createUptoN #-}</span>
<a name="line-388"></a>
<a name="line-389"></a><a name="createUptoN'"></a><span class='hs-comment'>-- | Create ByteString of up to size @l@ and use action @f@ to fill it's contents which returns its true size.</span>
<a name="line-390"></a><span class='hs-definition'>createUptoN'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-391"></a><span class='hs-definition'>createUptoN'</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-392"></a>    <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocByteString</span> <span class='hs-varid'>l</span>
<a name="line-393"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>l'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>p</span>
<a name="line-394"></a>    <span class='hs-varid'>assert</span> <span class='hs-layout'>(</span><span class='hs-varid'>l'</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>0</span> <span class='hs-varid'>l'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-395"></a><span class='hs-comment'>{-# INLINE createUptoN' #-}</span>
<a name="line-396"></a>
<a name="line-397"></a><a name="createAndTrim"></a><span class='hs-comment'>-- | Given the maximum size needed and a function to make the contents</span>
<a name="line-398"></a><span class='hs-comment'>-- of a ByteString, createAndTrim makes the 'ByteString'. The generating</span>
<a name="line-399"></a><span class='hs-comment'>-- function is required to return the actual final size (&lt;= the maximum</span>
<a name="line-400"></a><span class='hs-comment'>-- size), and the resulting byte array is realloced to this size.</span>
<a name="line-401"></a><span class='hs-comment'>--</span>
<a name="line-402"></a><span class='hs-comment'>-- createAndTrim is the main mechanism for creating custom, efficient</span>
<a name="line-403"></a><span class='hs-comment'>-- ByteString functions, using Haskell or C functions to fill the space.</span>
<a name="line-404"></a><span class='hs-comment'>--</span>
<a name="line-405"></a><span class='hs-definition'>createAndTrim</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ByteString</span>
<a name="line-406"></a><span class='hs-definition'>createAndTrim</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-407"></a>    <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocByteString</span> <span class='hs-varid'>l</span>
<a name="line-408"></a>    <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-409"></a>        <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>p</span>
<a name="line-410"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>assert</span> <span class='hs-layout'>(</span><span class='hs-varid'>l'</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>l'</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>l</span>
<a name="line-411"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>0</span> <span class='hs-varid'>l</span>
<a name="line-412"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>create</span> <span class='hs-varid'>l'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>memcpy</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>p</span> <span class='hs-varid'>l'</span>
<a name="line-413"></a><span class='hs-comment'>{-# INLINE createAndTrim #-}</span>
<a name="line-414"></a>
<a name="line-415"></a><a name="createAndTrim'"></a><span class='hs-definition'>createAndTrim'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-416"></a><span class='hs-definition'>createAndTrim'</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-417"></a>    <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocByteString</span> <span class='hs-varid'>l</span>
<a name="line-418"></a>    <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-419"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-layout'>,</span> <span class='hs-varid'>l'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>p</span>
<a name="line-420"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>assert</span> <span class='hs-layout'>(</span><span class='hs-varid'>l'</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>l'</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>l</span>
<a name="line-421"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>0</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-422"></a>            <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>create</span> <span class='hs-varid'>l'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-423"></a>                            <span class='hs-varid'>memcpy</span> <span class='hs-varid'>p'</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-varid'>l'</span>
<a name="line-424"></a>                    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-425"></a>
<a name="line-426"></a><a name="mallocByteString"></a><span class='hs-comment'>-- | Wrapper of 'mallocForeignPtrBytes' with faster implementation for GHC</span>
<a name="line-427"></a><span class='hs-comment'>--</span>
<a name="line-428"></a><span class='hs-definition'>mallocByteString</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-429"></a><span class='hs-definition'>mallocByteString</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mallocPlainForeignPtrBytes</span>
<a name="line-430"></a><span class='hs-comment'>{-# INLINE mallocByteString #-}</span>
<a name="line-431"></a>
<a name="line-432"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-433"></a><span class='hs-comment'>-- Implementations for Eq, Ord and Monoid instances</span>
<a name="line-434"></a>
<a name="line-435"></a><a name="eq"></a><span class='hs-definition'>eq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-436"></a><span class='hs-definition'>eq</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp'</span> <span class='hs-varid'>off'</span> <span class='hs-varid'>len'</span><span class='hs-layout'>)</span>
<a name="line-437"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>len</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>len'</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>    <span class='hs-comment'>-- short cut on length</span>
<a name="line-438"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>==</span> <span class='hs-varid'>fp'</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>off</span> <span class='hs-varop'>==</span> <span class='hs-varid'>off'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>     <span class='hs-comment'>-- short cut for the same string</span>
<a name="line-439"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareBytes</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varop'>==</span> <span class='hs-conid'>EQ</span>
<a name="line-440"></a><span class='hs-comment'>{-# INLINE eq #-}</span>
<a name="line-441"></a><span class='hs-comment'>-- ^ still needed</span>
<a name="line-442"></a>
<a name="line-443"></a><a name="compareBytes"></a><span class='hs-definition'>compareBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-444"></a><span class='hs-definition'>compareBytes</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>    <span class='hs-num'>0</span><span class='hs-layout'>)</span>    <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>    <span class='hs-num'>0</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>  <span class='hs-comment'>-- short cut for empty strings</span>
<a name="line-445"></a><span class='hs-definition'>compareBytes</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp1</span> <span class='hs-varid'>off1</span> <span class='hs-varid'>len1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp2</span> <span class='hs-varid'>off2</span> <span class='hs-varid'>len2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-446"></a>    <span class='hs-varid'>accursedUnutterablePerformIO</span> <span class='hs-varop'>$</span>
<a name="line-447"></a>      <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp1</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p1</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-448"></a>      <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp2</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-449"></a>        <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>memcmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>p1</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>off1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>p2</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>off2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>min</span> <span class='hs-varid'>len1</span> <span class='hs-varid'>len2</span><span class='hs-layout'>)</span>
<a name="line-450"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>i</span> <span class='hs-varop'>`compare`</span> <span class='hs-num'>0</span> <span class='hs-keyword'>of</span>
<a name="line-451"></a>                    <span class='hs-conid'>EQ</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>len1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>len2</span>
<a name="line-452"></a>                    <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-453"></a>
<a name="line-454"></a><a name="append"></a><span class='hs-definition'>append</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-455"></a><span class='hs-definition'>append</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>    <span class='hs-num'>0</span><span class='hs-layout'>)</span>    <span class='hs-varid'>b</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span>
<a name="line-456"></a><span class='hs-definition'>append</span> <span class='hs-varid'>a</span>                  <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>    <span class='hs-num'>0</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span>
<a name="line-457"></a><span class='hs-definition'>append</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp1</span> <span class='hs-varid'>off1</span> <span class='hs-varid'>len1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp2</span> <span class='hs-varid'>off2</span> <span class='hs-varid'>len2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-458"></a>    <span class='hs-varid'>unsafeCreate</span> <span class='hs-layout'>(</span><span class='hs-varid'>len1</span><span class='hs-varop'>+</span><span class='hs-varid'>len2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>destptr1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-459"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>destptr2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>destptr1</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>len1</span>
<a name="line-460"></a>      <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp1</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>memcpy</span> <span class='hs-varid'>destptr1</span> <span class='hs-layout'>(</span><span class='hs-varid'>p1</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>off1</span><span class='hs-layout'>)</span> <span class='hs-varid'>len1</span>
<a name="line-461"></a>      <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp2</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>memcpy</span> <span class='hs-varid'>destptr2</span> <span class='hs-layout'>(</span><span class='hs-varid'>p2</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>off2</span><span class='hs-layout'>)</span> <span class='hs-varid'>len2</span>
<a name="line-462"></a>
<a name="line-463"></a><a name="concat"></a><span class='hs-definition'>concat</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteString</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<a name="line-464"></a><span class='hs-definition'>concat</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>bss0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>goLen0</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>bss0</span>
<a name="line-465"></a>    <span class='hs-comment'>-- The idea here is we first do a pass over the input list to determine:</span>
<a name="line-466"></a>    <span class='hs-comment'>--</span>
<a name="line-467"></a>    <span class='hs-comment'>--  1. is a copy necessary? e.g. @concat []@, @concat [mempty, "hello"]@,</span>
<a name="line-468"></a>    <span class='hs-comment'>--     and @concat ["hello", mempty, mempty]@ can all be handled without</span>
<a name="line-469"></a>    <span class='hs-comment'>--     copying.</span>
<a name="line-470"></a>    <span class='hs-comment'>--  2. if a copy is necessary, how large is the result going to be?</span>
<a name="line-471"></a>    <span class='hs-comment'>--</span>
<a name="line-472"></a>    <span class='hs-comment'>-- If a copy is necessary then we create a buffer of the appropriate size</span>
<a name="line-473"></a>    <span class='hs-comment'>-- and do another pass over the input list, copying the chunks into the</span>
<a name="line-474"></a>    <span class='hs-comment'>-- buffer. Also, since foreign calls aren't entirely free we skip over</span>
<a name="line-475"></a>    <span class='hs-comment'>-- empty chunks while copying.</span>
<a name="line-476"></a>    <span class='hs-comment'>--</span>
<a name="line-477"></a>    <span class='hs-comment'>-- We pass the original [ByteString] (bss0) through as an argument through</span>
<a name="line-478"></a>    <span class='hs-comment'>-- goLen0, goLen1, and goLen since we will need it again in goCopy. Passing</span>
<a name="line-479"></a>    <span class='hs-comment'>-- it as an explicit argument avoids capturing it in these functions'</span>
<a name="line-480"></a>    <span class='hs-comment'>-- closures which would result in unnecessary closure allocation.</span>
<a name="line-481"></a>  <span class='hs-keyword'>where</span>
<a name="line-482"></a>    <span class='hs-comment'>-- It's still possible that the result is empty</span>
<a name="line-483"></a>    <span class='hs-varid'>goLen0</span> <span class='hs-keyword'>_</span>    <span class='hs-conid'>[]</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>
<a name="line-484"></a>    <span class='hs-varid'>goLen0</span> <span class='hs-varid'>bss0</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-num'>0</span>     <span class='hs-conop'>:</span><span class='hs-varid'>bss</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goLen0</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>bss</span>
<a name="line-485"></a>    <span class='hs-varid'>goLen0</span> <span class='hs-varid'>bss0</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span>           <span class='hs-conop'>:</span><span class='hs-varid'>bss</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goLen1</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>bss</span>
<a name="line-486"></a>
<a name="line-487"></a>    <span class='hs-comment'>-- It's still possible that the result is a single chunk</span>
<a name="line-488"></a>    <span class='hs-varid'>goLen1</span> <span class='hs-keyword'>_</span>    <span class='hs-varid'>bs</span> <span class='hs-conid'>[]</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bs</span>
<a name="line-489"></a>    <span class='hs-varid'>goLen1</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-num'>0</span>  <span class='hs-conop'>:</span><span class='hs-varid'>bss</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goLen1</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>bss</span>
<a name="line-490"></a>    <span class='hs-varid'>goLen1</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>len</span><span class='hs-conop'>:</span><span class='hs-varid'>bss</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goLen</span> <span class='hs-varid'>bss0</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkedAdd</span> <span class='hs-str'>"concat"</span> <span class='hs-varid'>len'</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-varid'>bss</span>
<a name="line-491"></a>      <span class='hs-keyword'>where</span> <span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>len'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bs</span>
<a name="line-492"></a>
<a name="line-493"></a>    <span class='hs-comment'>-- General case, just find the total length we'll need</span>
<a name="line-494"></a>    <span class='hs-varid'>goLen</span> <span class='hs-varid'>bss0</span> <span class='hs-varop'>!</span><span class='hs-varid'>total</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>len</span><span class='hs-conop'>:</span><span class='hs-varid'>bss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goLen</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>total'</span> <span class='hs-varid'>bss</span>
<a name="line-495"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>total'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkedAdd</span> <span class='hs-str'>"concat"</span> <span class='hs-varid'>total</span> <span class='hs-varid'>len</span>
<a name="line-496"></a>    <span class='hs-varid'>goLen</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>total</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span>
<a name="line-497"></a>      <span class='hs-varid'>unsafeCreate</span> <span class='hs-varid'>total</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ptr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>goCopy</span> <span class='hs-varid'>bss0</span> <span class='hs-varid'>ptr</span>
<a name="line-498"></a>
<a name="line-499"></a>    <span class='hs-comment'>-- Copy the data</span>
<a name="line-500"></a>    <span class='hs-varid'>goCopy</span> <span class='hs-conid'>[]</span>                  <span class='hs-varop'>!</span><span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-501"></a>    <span class='hs-varid'>goCopy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>   <span class='hs-num'>0</span>  <span class='hs-conop'>:</span><span class='hs-varid'>bss</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-varid'>ptr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goCopy</span> <span class='hs-varid'>bss</span> <span class='hs-varid'>ptr</span>
<a name="line-502"></a>    <span class='hs-varid'>goCopy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>off</span> <span class='hs-varid'>len</span><span class='hs-conop'>:</span><span class='hs-varid'>bss</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span><span class='hs-varid'>ptr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-503"></a>      <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>memcpy</span> <span class='hs-varid'>ptr</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-varid'>len</span>
<a name="line-504"></a>      <span class='hs-varid'>goCopy</span> <span class='hs-varid'>bss</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptr</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span>
<a name="line-505"></a><span class='hs-comment'>{-# NOINLINE concat #-}</span>
<a name="line-506"></a>
<a name="line-507"></a><span class='hs-comment'>{-# RULES
<a name="line-508"></a>"ByteString concat [] -&gt; mempty"
<a name="line-509"></a>   concat [] = mempty
<a name="line-510"></a>"ByteString concat [bs] -&gt; bs" forall x.
<a name="line-511"></a>   concat [x] = x
<a name="line-512"></a> #-}</span>
<a name="line-513"></a>
<a name="line-514"></a><a name="checkedAdd"></a><span class='hs-comment'>-- | Add two non-negative numbers. Errors out on overflow.</span>
<a name="line-515"></a><span class='hs-definition'>checkedAdd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-516"></a><span class='hs-definition'>checkedAdd</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span>
<a name="line-517"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>r</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-518"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>overflowError</span> <span class='hs-varid'>fun</span>
<a name="line-519"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-varid'>y</span>
<a name="line-520"></a><span class='hs-comment'>{-# INLINE checkedAdd #-}</span>
<a name="line-521"></a>
<a name="line-522"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-523"></a>
<a name="line-524"></a><a name="w2c"></a><span class='hs-comment'>-- | Conversion between 'Word8' and 'Char'. Should compile to a no-op.</span>
<a name="line-525"></a><span class='hs-definition'>w2c</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Char</span>
<a name="line-526"></a><span class='hs-definition'>w2c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeChr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-527"></a><span class='hs-comment'>{-# INLINE w2c #-}</span>
<a name="line-528"></a>
<a name="line-529"></a><a name="c2w"></a><span class='hs-comment'>-- | Unsafe conversion between 'Char' and 'Word8'. This is a no-op and</span>
<a name="line-530"></a><span class='hs-comment'>-- silently truncates to 8 bits Chars &gt; '\255'. It is provided as</span>
<a name="line-531"></a><span class='hs-comment'>-- convenience for ByteString construction.</span>
<a name="line-532"></a><span class='hs-definition'>c2w</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Char</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span>
<a name="line-533"></a><span class='hs-definition'>c2w</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ord</span>
<a name="line-534"></a><span class='hs-comment'>{-# INLINE c2w #-}</span>
<a name="line-535"></a>
<a name="line-536"></a><a name="isSpaceWord8"></a><span class='hs-comment'>-- | Selects words corresponding to white-space characters in the Latin-1 range</span>
<a name="line-537"></a><span class='hs-comment'>-- ordered by frequency.</span>
<a name="line-538"></a><span class='hs-definition'>isSpaceWord8</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-539"></a><span class='hs-definition'>isSpaceWord8</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span>
<a name="line-540"></a>    <span class='hs-varid'>w</span> <span class='hs-varop'>==</span> <span class='hs-num'>0x20</span> <span class='hs-varop'>||</span>
<a name="line-541"></a>    <span class='hs-varid'>w</span> <span class='hs-varop'>==</span> <span class='hs-num'>0x0A</span> <span class='hs-varop'>||</span> <span class='hs-comment'>-- LF, \n</span>
<a name="line-542"></a>    <span class='hs-varid'>w</span> <span class='hs-varop'>==</span> <span class='hs-num'>0x09</span> <span class='hs-varop'>||</span> <span class='hs-comment'>-- HT, \t</span>
<a name="line-543"></a>    <span class='hs-varid'>w</span> <span class='hs-varop'>==</span> <span class='hs-num'>0x0C</span> <span class='hs-varop'>||</span> <span class='hs-comment'>-- FF, \f</span>
<a name="line-544"></a>    <span class='hs-varid'>w</span> <span class='hs-varop'>==</span> <span class='hs-num'>0x0D</span> <span class='hs-varop'>||</span> <span class='hs-comment'>-- CR, \r</span>
<a name="line-545"></a>    <span class='hs-varid'>w</span> <span class='hs-varop'>==</span> <span class='hs-num'>0x0B</span> <span class='hs-varop'>||</span> <span class='hs-comment'>-- VT, \v</span>
<a name="line-546"></a>    <span class='hs-varid'>w</span> <span class='hs-varop'>==</span> <span class='hs-num'>0xA0</span>    <span class='hs-comment'>-- spotted by QC..</span>
<a name="line-547"></a><span class='hs-comment'>{-# INLINE isSpaceWord8 #-}</span>
<a name="line-548"></a>
<a name="line-549"></a><a name="isSpaceChar8"></a><span class='hs-comment'>-- | Selects white-space characters in the Latin-1 range</span>
<a name="line-550"></a><span class='hs-definition'>isSpaceChar8</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Char</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-551"></a><span class='hs-definition'>isSpaceChar8</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span>
<a name="line-552"></a>    <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>' '</span>     <span class='hs-varop'>||</span>
<a name="line-553"></a>    <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>'\t'</span>    <span class='hs-varop'>||</span>
<a name="line-554"></a>    <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>'\n'</span>    <span class='hs-varop'>||</span>
<a name="line-555"></a>    <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>'\r'</span>    <span class='hs-varop'>||</span>
<a name="line-556"></a>    <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>'\f'</span>    <span class='hs-varop'>||</span>
<a name="line-557"></a>    <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>'\v'</span>    <span class='hs-varop'>||</span>
<a name="line-558"></a>    <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>'\xa0'</span>
<a name="line-559"></a><span class='hs-comment'>{-# INLINE isSpaceChar8 #-}</span>
<a name="line-560"></a>
<a name="line-561"></a><a name="overflowError"></a><span class='hs-definition'>overflowError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-562"></a><span class='hs-definition'>overflowError</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Data.ByteString."</span> <span class='hs-varop'>++</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>++</span> <span class='hs-str'>": size overflow"</span>
<a name="line-563"></a>
<a name="line-564"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-565"></a>
<a name="line-566"></a><a name="accursedUnutterablePerformIO"></a><span class='hs-comment'>-- | This \"function\" has a superficial similarity to 'unsafePerformIO' but</span>
<a name="line-567"></a><span class='hs-comment'>-- it is in fact a malevolent agent of chaos. It unpicks the seams of reality</span>
<a name="line-568"></a><span class='hs-comment'>-- (and the 'IO' monad) so that the normal rules no longer apply. It lulls you</span>
<a name="line-569"></a><span class='hs-comment'>-- into thinking it is reasonable, but when you are not looking it stabs you</span>
<a name="line-570"></a><span class='hs-comment'>-- in the back and aliases all of your mutable buffers. The carcass of many a</span>
<a name="line-571"></a><span class='hs-comment'>-- seasoned Haskell programmer lie strewn at its feet.</span>
<a name="line-572"></a><span class='hs-comment'>--</span>
<a name="line-573"></a><span class='hs-comment'>-- Witness the trail of destruction:</span>
<a name="line-574"></a><span class='hs-comment'>--</span>
<a name="line-575"></a><span class='hs-comment'>-- * &lt;https://github.com/haskell/bytestring/commit/71c4b438c675aa360c79d79acc9a491e7bbc26e7&gt;</span>
<a name="line-576"></a><span class='hs-comment'>--</span>
<a name="line-577"></a><span class='hs-comment'>-- * &lt;https://github.com/haskell/bytestring/commit/210c656390ae617d9ee3b8bcff5c88dd17cef8da&gt;</span>
<a name="line-578"></a><span class='hs-comment'>--</span>
<a name="line-579"></a><span class='hs-comment'>-- * &lt;https://ghc.haskell.org/trac/ghc/ticket/3486&gt;</span>
<a name="line-580"></a><span class='hs-comment'>--</span>
<a name="line-581"></a><span class='hs-comment'>-- * &lt;https://ghc.haskell.org/trac/ghc/ticket/3487&gt;</span>
<a name="line-582"></a><span class='hs-comment'>--</span>
<a name="line-583"></a><span class='hs-comment'>-- * &lt;https://ghc.haskell.org/trac/ghc/ticket/7270&gt;</span>
<a name="line-584"></a><span class='hs-comment'>--</span>
<a name="line-585"></a><span class='hs-comment'>-- Do not talk about \"safe\"! You do not know what is safe!</span>
<a name="line-586"></a><span class='hs-comment'>--</span>
<a name="line-587"></a><span class='hs-comment'>-- Yield not to its blasphemous call! Flee traveller! Flee or you will be</span>
<a name="line-588"></a><span class='hs-comment'>-- corrupted and devoured!</span>
<a name="line-589"></a><span class='hs-comment'>--</span>
<a name="line-590"></a><span class='hs-comment'>{-# INLINE accursedUnutterablePerformIO #-}</span>
<a name="line-591"></a><span class='hs-definition'>accursedUnutterablePerformIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-592"></a><span class='hs-definition'>accursedUnutterablePerformIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-varid'>realWorld</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span>
<a name="line-593"></a>
<a name="line-594"></a><a name="inlinePerformIO"></a><span class='hs-definition'>inlinePerformIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-595"></a><span class='hs-definition'>inlinePerformIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>accursedUnutterablePerformIO</span>
<a name="line-596"></a><span class='hs-comment'>{-# INLINE inlinePerformIO #-}</span>
<a name="line-597"></a><span class='hs-comment'>{-# DEPRECATED inlinePerformIO "If you think you know what you are doing, use 'unsafePerformIO'. If you are sure you know what you are doing, use 'unsafeDupablePerformIO'. If you enjoy sharing an address space with a malevolent agent of chaos, try 'accursedUnutterablePerformIO'." #-}</span>
<a name="line-598"></a>
<a name="line-599"></a><span class='hs-comment'>-- ---------------------------------------------------------------------</span>
<a name="line-600"></a><span class='hs-comment'>--</span>
<a name="line-601"></a><span class='hs-comment'>-- Standard C functions</span>
<a name="line-602"></a><span class='hs-comment'>--</span>
<a name="line-603"></a>
<a name="line-604"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"string.h strlen"</span> <span class='hs-varid'>c_strlen</span>
<a name="line-605"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CSize</span>
<a name="line-606"></a>
<a name="line-607"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"static stdlib.h &amp;free"</span> <span class='hs-varid'>c_free_finalizer</span>
<a name="line-608"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunPtr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-609"></a>
<a name="line-610"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"string.h memchr"</span> <span class='hs-varid'>c_memchr</span>
<a name="line-611"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<a name="line-612"></a>
<a name="line-613"></a><a name="memchr"></a><span class='hs-definition'>memchr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<a name="line-614"></a><span class='hs-definition'>memchr</span> <span class='hs-varid'>p</span> <span class='hs-varid'>w</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c_memchr</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-615"></a>
<a name="line-616"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"string.h memcmp"</span> <span class='hs-varid'>c_memcmp</span>
<a name="line-617"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CInt</span>
<a name="line-618"></a>
<a name="line-619"></a><a name="memcmp"></a><span class='hs-definition'>memcmp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CInt</span>
<a name="line-620"></a><span class='hs-definition'>memcmp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>q</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c_memcmp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>q</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-621"></a>
<a name="line-622"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"string.h memcpy"</span> <span class='hs-varid'>c_memcpy</span>
<a name="line-623"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<a name="line-624"></a>
<a name="line-625"></a><a name="memcpy"></a><span class='hs-definition'>memcpy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-626"></a><span class='hs-definition'>memcpy</span> <span class='hs-varid'>p</span> <span class='hs-varid'>q</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c_memcpy</span> <span class='hs-varid'>p</span> <span class='hs-varid'>q</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-627"></a>
<a name="line-628"></a><span class='hs-comment'>{-
<a name="line-629"></a>foreign import ccall unsafe "string.h memmove" c_memmove
<a name="line-630"></a>    :: Ptr Word8 -&gt; Ptr Word8 -&gt; CSize -&gt; IO (Ptr Word8)
<a name="line-631"></a>
<a name="line-632"></a>memmove :: Ptr Word8 -&gt; Ptr Word8 -&gt; CSize -&gt; IO ()
<a name="line-633"></a>memmove p q s = do c_memmove p q s
<a name="line-634"></a>                   return ()
<a name="line-635"></a>-}</span>
<a name="line-636"></a>
<a name="line-637"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"string.h memset"</span> <span class='hs-varid'>c_memset</span>
<a name="line-638"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<a name="line-639"></a>
<a name="line-640"></a><a name="memset"></a><span class='hs-definition'>memset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<a name="line-641"></a><span class='hs-definition'>memset</span> <span class='hs-varid'>p</span> <span class='hs-varid'>w</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c_memset</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-642"></a>
<a name="line-643"></a><span class='hs-comment'>-- ---------------------------------------------------------------------</span>
<a name="line-644"></a><span class='hs-comment'>--</span>
<a name="line-645"></a><span class='hs-comment'>-- Uses our C code</span>
<a name="line-646"></a><span class='hs-comment'>--</span>
<a name="line-647"></a>
<a name="line-648"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"static fpstring.h fps_reverse"</span> <span class='hs-varid'>c_reverse</span>
<a name="line-649"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CULong</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-650"></a>
<a name="line-651"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"static fpstring.h fps_intersperse"</span> <span class='hs-varid'>c_intersperse</span>
<a name="line-652"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CULong</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-653"></a>
<a name="line-654"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"static fpstring.h fps_maximum"</span> <span class='hs-varid'>c_maximum</span>
<a name="line-655"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CULong</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Word8</span>
<a name="line-656"></a>
<a name="line-657"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"static fpstring.h fps_minimum"</span> <span class='hs-varid'>c_minimum</span>
<a name="line-658"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CULong</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Word8</span>
<a name="line-659"></a>
<a name="line-660"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"static fpstring.h fps_count"</span> <span class='hs-varid'>c_count</span>
<a name="line-661"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CULong</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CULong</span>
</pre></body>
</html>
